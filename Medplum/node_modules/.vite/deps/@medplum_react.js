import {
  require_prop_types
} from "./chunk-RY524VAC.js";
import {
  require_jsx_runtime
} from "./chunk-BX4QH3UP.js";
import {
  ActionIcon,
  Alert,
  Anchor,
  AppShell,
  Avatar,
  Badge,
  Blockquote,
  Box,
  Button,
  Card,
  Center,
  Checkbox,
  Chip,
  Combobox,
  Container,
  CopyButton,
  Divider,
  Flex,
  Grid,
  Group,
  Indicator,
  Input,
  List,
  Loader,
  Menu,
  Modal,
  MultiSelect,
  NativeSelect,
  Notification,
  OptionalPortal,
  Pagination,
  Paper,
  PasswordInput,
  Pill,
  PillsInput,
  Radio,
  RingProgress,
  ScrollArea,
  SegmentedControl,
  SimpleGrid,
  Space,
  Stack,
  Stepper,
  Switch,
  Table,
  Text,
  TextInput,
  Textarea,
  Title,
  Tooltip,
  UnstyledButton,
  _extends,
  _objectWithoutPropertiesLoose,
  createVarsResolver,
  factory,
  getDefaultZIndex,
  randomId,
  rem,
  useClipboard,
  useCombobox,
  useDidUpdate,
  useDisclosure,
  useForceUpdate,
  useMantineColorScheme,
  useMantineTheme,
  useProps,
  useReducedMotion,
  useStyles
} from "./chunk-OINSRMIC.js";
import {
  $,
  $c,
  $t,
  Bc,
  Be,
  C,
  Dp,
  En,
  F,
  Fc,
  G,
  Ge,
  Je,
  Ji,
  Jn,
  Ju,
  Kr,
  Mp,
  Mt,
  Oi,
  P,
  Pi,
  Pr,
  Qr,
  Qu,
  S,
  To,
  Tr,
  Vc,
  Wr,
  X,
  Xc,
  Y,
  Yi,
  Ys,
  Z,
  Zc,
  Ze,
  Zi,
  Zs,
  _,
  bc,
  be,
  bn,
  de,
  di,
  ee,
  er,
  eu,
  fi,
  gc,
  ge,
  hc,
  ir,
  jc,
  je,
  k,
  l,
  ln,
  mt,
  na,
  nr,
  pe,
  qc,
  ro,
  te,
  tr,
  wr,
  y,
  ze,
  zn
} from "./chunk-OUU4FBH3.js";
import {
  require_react_dom
} from "./chunk-GZ55BCQ2.js";
import {
  require_react
} from "./chunk-YZZKIYU7.js";
import {
  __toESM
} from "./chunk-LQ2VYIYD.js";

// node_modules/@medplum/react/dist/esm/index.mjs
var import_react11 = __toESM(require_react(), 1);
var import_react12 = __toESM(require_react(), 1);
var import_jsx_runtime = __toESM(require_jsx_runtime(), 1);
var import_react13 = __toESM(require_react(), 1);
var import_react14 = __toESM(require_react(), 1);
var import_react15 = __toESM(require_react(), 1);
var import_react16 = __toESM(require_react(), 1);
var import_jsx_runtime2 = __toESM(require_jsx_runtime(), 1);
var import_react17 = __toESM(require_react(), 1);
var import_jsx_runtime3 = __toESM(require_jsx_runtime(), 1);
var import_react18 = __toESM(require_react(), 1);
var import_jsx_runtime4 = __toESM(require_jsx_runtime(), 1);

// node_modules/@mantine/store/esm/store.mjs
var import_react = __toESM(require_react(), 1);
function createStore(initialState) {
  let state = initialState;
  let initialized = false;
  const listeners = /* @__PURE__ */ new Set();
  return {
    getState() {
      return state;
    },
    updateState(value) {
      state = typeof value === "function" ? value(state) : value;
    },
    setState(value) {
      this.updateState(value);
      listeners.forEach((listener) => listener(state));
    },
    initialize(value) {
      if (!initialized) {
        state = value;
        initialized = true;
      }
    },
    subscribe(callback) {
      listeners.add(callback);
      return () => listeners.delete(callback);
    }
  };
}
function useStore(store) {
  return (0, import_react.useSyncExternalStore)(
    store.subscribe,
    () => store.getState(),
    () => store.getState()
  );
}

// node_modules/@mantine/notifications/esm/notifications.store.mjs
var createNotificationsStore = () => createStore({
  notifications: [],
  queue: [],
  limit: 5
});
var notificationsStore = createNotificationsStore();
var useNotifications = (store = notificationsStore) => useStore(store);
function updateNotificationsState(store, update) {
  const state = store.getState();
  const notifications2 = update([...state.notifications, ...state.queue]);
  store.setState({
    notifications: notifications2.slice(0, state.limit),
    queue: notifications2.slice(state.limit),
    limit: state.limit
  });
}
function showNotification(notification, store = notificationsStore) {
  const id = notification.id || randomId();
  updateNotificationsState(store, (notifications2) => {
    if (notification.id && notifications2.some((n) => n.id === notification.id)) {
      return notifications2;
    }
    return [...notifications2, { ...notification, id }];
  });
  return id;
}
function hideNotification(id, store = notificationsStore) {
  updateNotificationsState(
    store,
    (notifications2) => notifications2.filter((notification) => {
      var _a;
      if (notification.id === id) {
        (_a = notification.onClose) == null ? void 0 : _a.call(notification, notification);
        return false;
      }
      return true;
    })
  );
  return id;
}
function updateNotification(notification, store = notificationsStore) {
  updateNotificationsState(
    store,
    (notifications2) => notifications2.map((item) => {
      if (item.id === notification.id) {
        return { ...item, ...notification };
      }
      return item;
    })
  );
  return notification.id;
}
function cleanNotifications(store = notificationsStore) {
  updateNotificationsState(store, () => []);
}
function cleanNotificationsQueue(store = notificationsStore) {
  updateNotificationsState(
    store,
    (notifications2) => notifications2.slice(0, store.getState().limit)
  );
}
var notifications = {
  show: showNotification,
  hide: hideNotification,
  update: updateNotification,
  clean: cleanNotifications,
  cleanQueue: cleanNotificationsQueue,
  updateState: updateNotificationsState
};

// node_modules/@mantine/notifications/esm/Notifications.mjs
var import_react10 = __toESM(require_react(), 1);

// node_modules/@babel/runtime/helpers/esm/setPrototypeOf.js
function _setPrototypeOf(o, p) {
  _setPrototypeOf = Object.setPrototypeOf ? Object.setPrototypeOf.bind() : function _setPrototypeOf2(o2, p2) {
    o2.__proto__ = p2;
    return o2;
  };
  return _setPrototypeOf(o, p);
}

// node_modules/@babel/runtime/helpers/esm/inheritsLoose.js
function _inheritsLoose(subClass, superClass) {
  subClass.prototype = Object.create(superClass.prototype);
  subClass.prototype.constructor = subClass;
  _setPrototypeOf(subClass, superClass);
}

// node_modules/react-transition-group/esm/CSSTransition.js
var import_prop_types3 = __toESM(require_prop_types());

// node_modules/dom-helpers/esm/hasClass.js
function hasClass(element, className) {
  if (element.classList)
    return !!className && element.classList.contains(className);
  return (" " + (element.className.baseVal || element.className) + " ").indexOf(" " + className + " ") !== -1;
}

// node_modules/dom-helpers/esm/addClass.js
function addClass(element, className) {
  if (element.classList)
    element.classList.add(className);
  else if (!hasClass(element, className))
    if (typeof element.className === "string")
      element.className = element.className + " " + className;
    else
      element.setAttribute("class", (element.className && element.className.baseVal || "") + " " + className);
}

// node_modules/dom-helpers/esm/removeClass.js
function replaceClassName(origClass, classToRemove) {
  return origClass.replace(new RegExp("(^|\\s)" + classToRemove + "(?:\\s|$)", "g"), "$1").replace(/\s+/g, " ").replace(/^\s*|\s*$/g, "");
}
function removeClass(element, className) {
  if (element.classList) {
    element.classList.remove(className);
  } else if (typeof element.className === "string") {
    element.className = replaceClassName(element.className, className);
  } else {
    element.setAttribute("class", replaceClassName(element.className && element.className.baseVal || "", className));
  }
}

// node_modules/react-transition-group/esm/CSSTransition.js
var import_react4 = __toESM(require_react());

// node_modules/react-transition-group/esm/Transition.js
var import_prop_types2 = __toESM(require_prop_types());
var import_react3 = __toESM(require_react());
var import_react_dom = __toESM(require_react_dom());

// node_modules/react-transition-group/esm/config.js
var config_default = {
  disabled: false
};

// node_modules/react-transition-group/esm/utils/PropTypes.js
var import_prop_types = __toESM(require_prop_types());
var timeoutsShape = true ? import_prop_types.default.oneOfType([import_prop_types.default.number, import_prop_types.default.shape({
  enter: import_prop_types.default.number,
  exit: import_prop_types.default.number,
  appear: import_prop_types.default.number
}).isRequired]) : null;
var classNamesShape = true ? import_prop_types.default.oneOfType([import_prop_types.default.string, import_prop_types.default.shape({
  enter: import_prop_types.default.string,
  exit: import_prop_types.default.string,
  active: import_prop_types.default.string
}), import_prop_types.default.shape({
  enter: import_prop_types.default.string,
  enterDone: import_prop_types.default.string,
  enterActive: import_prop_types.default.string,
  exit: import_prop_types.default.string,
  exitDone: import_prop_types.default.string,
  exitActive: import_prop_types.default.string
})]) : null;

// node_modules/react-transition-group/esm/TransitionGroupContext.js
var import_react2 = __toESM(require_react());
var TransitionGroupContext_default = import_react2.default.createContext(null);

// node_modules/react-transition-group/esm/utils/reflow.js
var forceReflow = function forceReflow2(node) {
  return node.scrollTop;
};

// node_modules/react-transition-group/esm/Transition.js
var UNMOUNTED = "unmounted";
var EXITED = "exited";
var ENTERING = "entering";
var ENTERED = "entered";
var EXITING = "exiting";
var Transition = function(_React$Component) {
  _inheritsLoose(Transition3, _React$Component);
  function Transition3(props, context) {
    var _this;
    _this = _React$Component.call(this, props, context) || this;
    var parentGroup = context;
    var appear = parentGroup && !parentGroup.isMounting ? props.enter : props.appear;
    var initialStatus;
    _this.appearStatus = null;
    if (props.in) {
      if (appear) {
        initialStatus = EXITED;
        _this.appearStatus = ENTERING;
      } else {
        initialStatus = ENTERED;
      }
    } else {
      if (props.unmountOnExit || props.mountOnEnter) {
        initialStatus = UNMOUNTED;
      } else {
        initialStatus = EXITED;
      }
    }
    _this.state = {
      status: initialStatus
    };
    _this.nextCallback = null;
    return _this;
  }
  Transition3.getDerivedStateFromProps = function getDerivedStateFromProps(_ref, prevState) {
    var nextIn = _ref.in;
    if (nextIn && prevState.status === UNMOUNTED) {
      return {
        status: EXITED
      };
    }
    return null;
  };
  var _proto = Transition3.prototype;
  _proto.componentDidMount = function componentDidMount() {
    this.updateStatus(true, this.appearStatus);
  };
  _proto.componentDidUpdate = function componentDidUpdate(prevProps) {
    var nextStatus = null;
    if (prevProps !== this.props) {
      var status = this.state.status;
      if (this.props.in) {
        if (status !== ENTERING && status !== ENTERED) {
          nextStatus = ENTERING;
        }
      } else {
        if (status === ENTERING || status === ENTERED) {
          nextStatus = EXITING;
        }
      }
    }
    this.updateStatus(false, nextStatus);
  };
  _proto.componentWillUnmount = function componentWillUnmount() {
    this.cancelNextCallback();
  };
  _proto.getTimeouts = function getTimeouts() {
    var timeout2 = this.props.timeout;
    var exit, enter, appear;
    exit = enter = appear = timeout2;
    if (timeout2 != null && typeof timeout2 !== "number") {
      exit = timeout2.exit;
      enter = timeout2.enter;
      appear = timeout2.appear !== void 0 ? timeout2.appear : enter;
    }
    return {
      exit,
      enter,
      appear
    };
  };
  _proto.updateStatus = function updateStatus(mounting, nextStatus) {
    if (mounting === void 0) {
      mounting = false;
    }
    if (nextStatus !== null) {
      this.cancelNextCallback();
      if (nextStatus === ENTERING) {
        if (this.props.unmountOnExit || this.props.mountOnEnter) {
          var node = this.props.nodeRef ? this.props.nodeRef.current : import_react_dom.default.findDOMNode(this);
          if (node)
            forceReflow(node);
        }
        this.performEnter(mounting);
      } else {
        this.performExit();
      }
    } else if (this.props.unmountOnExit && this.state.status === EXITED) {
      this.setState({
        status: UNMOUNTED
      });
    }
  };
  _proto.performEnter = function performEnter(mounting) {
    var _this2 = this;
    var enter = this.props.enter;
    var appearing = this.context ? this.context.isMounting : mounting;
    var _ref2 = this.props.nodeRef ? [appearing] : [import_react_dom.default.findDOMNode(this), appearing], maybeNode = _ref2[0], maybeAppearing = _ref2[1];
    var timeouts = this.getTimeouts();
    var enterTimeout = appearing ? timeouts.appear : timeouts.enter;
    if (!mounting && !enter || config_default.disabled) {
      this.safeSetState({
        status: ENTERED
      }, function() {
        _this2.props.onEntered(maybeNode);
      });
      return;
    }
    this.props.onEnter(maybeNode, maybeAppearing);
    this.safeSetState({
      status: ENTERING
    }, function() {
      _this2.props.onEntering(maybeNode, maybeAppearing);
      _this2.onTransitionEnd(enterTimeout, function() {
        _this2.safeSetState({
          status: ENTERED
        }, function() {
          _this2.props.onEntered(maybeNode, maybeAppearing);
        });
      });
    });
  };
  _proto.performExit = function performExit() {
    var _this3 = this;
    var exit = this.props.exit;
    var timeouts = this.getTimeouts();
    var maybeNode = this.props.nodeRef ? void 0 : import_react_dom.default.findDOMNode(this);
    if (!exit || config_default.disabled) {
      this.safeSetState({
        status: EXITED
      }, function() {
        _this3.props.onExited(maybeNode);
      });
      return;
    }
    this.props.onExit(maybeNode);
    this.safeSetState({
      status: EXITING
    }, function() {
      _this3.props.onExiting(maybeNode);
      _this3.onTransitionEnd(timeouts.exit, function() {
        _this3.safeSetState({
          status: EXITED
        }, function() {
          _this3.props.onExited(maybeNode);
        });
      });
    });
  };
  _proto.cancelNextCallback = function cancelNextCallback() {
    if (this.nextCallback !== null) {
      this.nextCallback.cancel();
      this.nextCallback = null;
    }
  };
  _proto.safeSetState = function safeSetState(nextState, callback) {
    callback = this.setNextCallback(callback);
    this.setState(nextState, callback);
  };
  _proto.setNextCallback = function setNextCallback(callback) {
    var _this4 = this;
    var active = true;
    this.nextCallback = function(event) {
      if (active) {
        active = false;
        _this4.nextCallback = null;
        callback(event);
      }
    };
    this.nextCallback.cancel = function() {
      active = false;
    };
    return this.nextCallback;
  };
  _proto.onTransitionEnd = function onTransitionEnd(timeout2, handler) {
    this.setNextCallback(handler);
    var node = this.props.nodeRef ? this.props.nodeRef.current : import_react_dom.default.findDOMNode(this);
    var doesNotHaveTimeoutOrListener = timeout2 == null && !this.props.addEndListener;
    if (!node || doesNotHaveTimeoutOrListener) {
      setTimeout(this.nextCallback, 0);
      return;
    }
    if (this.props.addEndListener) {
      var _ref3 = this.props.nodeRef ? [this.nextCallback] : [node, this.nextCallback], maybeNode = _ref3[0], maybeNextCallback = _ref3[1];
      this.props.addEndListener(maybeNode, maybeNextCallback);
    }
    if (timeout2 != null) {
      setTimeout(this.nextCallback, timeout2);
    }
  };
  _proto.render = function render() {
    var status = this.state.status;
    if (status === UNMOUNTED) {
      return null;
    }
    var _this$props = this.props, children2 = _this$props.children, _in = _this$props.in, _mountOnEnter = _this$props.mountOnEnter, _unmountOnExit = _this$props.unmountOnExit, _appear = _this$props.appear, _enter = _this$props.enter, _exit = _this$props.exit, _timeout = _this$props.timeout, _addEndListener = _this$props.addEndListener, _onEnter = _this$props.onEnter, _onEntering = _this$props.onEntering, _onEntered = _this$props.onEntered, _onExit = _this$props.onExit, _onExiting = _this$props.onExiting, _onExited = _this$props.onExited, _nodeRef = _this$props.nodeRef, childProps = _objectWithoutPropertiesLoose(_this$props, ["children", "in", "mountOnEnter", "unmountOnExit", "appear", "enter", "exit", "timeout", "addEndListener", "onEnter", "onEntering", "onEntered", "onExit", "onExiting", "onExited", "nodeRef"]);
    return (
      // allows for nested Transitions
      import_react3.default.createElement(TransitionGroupContext_default.Provider, {
        value: null
      }, typeof children2 === "function" ? children2(status, childProps) : import_react3.default.cloneElement(import_react3.default.Children.only(children2), childProps))
    );
  };
  return Transition3;
}(import_react3.default.Component);
Transition.contextType = TransitionGroupContext_default;
Transition.propTypes = true ? {
  /**
   * A React reference to DOM element that need to transition:
   * https://stackoverflow.com/a/51127130/4671932
   *
   *   - When `nodeRef` prop is used, `node` is not passed to callback functions
   *      (e.g. `onEnter`) because user already has direct access to the node.
   *   - When changing `key` prop of `Transition` in a `TransitionGroup` a new
   *     `nodeRef` need to be provided to `Transition` with changed `key` prop
   *     (see
   *     [test/CSSTransition-test.js](https://github.com/reactjs/react-transition-group/blob/13435f897b3ab71f6e19d724f145596f5910581c/test/CSSTransition-test.js#L362-L437)).
   */
  nodeRef: import_prop_types2.default.shape({
    current: typeof Element === "undefined" ? import_prop_types2.default.any : function(propValue, key, componentName, location, propFullName, secret) {
      var value = propValue[key];
      return import_prop_types2.default.instanceOf(value && "ownerDocument" in value ? value.ownerDocument.defaultView.Element : Element)(propValue, key, componentName, location, propFullName, secret);
    }
  }),
  /**
   * A `function` child can be used instead of a React element. This function is
   * called with the current transition status (`'entering'`, `'entered'`,
   * `'exiting'`, `'exited'`), which can be used to apply context
   * specific props to a component.
   *
   * ```jsx
   * <Transition in={this.state.in} timeout={150}>
   *   {state => (
   *     <MyComponent className={`fade fade-${state}`} />
   *   )}
   * </Transition>
   * ```
   */
  children: import_prop_types2.default.oneOfType([import_prop_types2.default.func.isRequired, import_prop_types2.default.element.isRequired]).isRequired,
  /**
   * Show the component; triggers the enter or exit states
   */
  in: import_prop_types2.default.bool,
  /**
   * By default the child component is mounted immediately along with
   * the parent `Transition` component. If you want to "lazy mount" the component on the
   * first `in={true}` you can set `mountOnEnter`. After the first enter transition the component will stay
   * mounted, even on "exited", unless you also specify `unmountOnExit`.
   */
  mountOnEnter: import_prop_types2.default.bool,
  /**
   * By default the child component stays mounted after it reaches the `'exited'` state.
   * Set `unmountOnExit` if you'd prefer to unmount the component after it finishes exiting.
   */
  unmountOnExit: import_prop_types2.default.bool,
  /**
   * By default the child component does not perform the enter transition when
   * it first mounts, regardless of the value of `in`. If you want this
   * behavior, set both `appear` and `in` to `true`.
   *
   * > **Note**: there are no special appear states like `appearing`/`appeared`, this prop
   * > only adds an additional enter transition. However, in the
   * > `<CSSTransition>` component that first enter transition does result in
   * > additional `.appear-*` classes, that way you can choose to style it
   * > differently.
   */
  appear: import_prop_types2.default.bool,
  /**
   * Enable or disable enter transitions.
   */
  enter: import_prop_types2.default.bool,
  /**
   * Enable or disable exit transitions.
   */
  exit: import_prop_types2.default.bool,
  /**
   * The duration of the transition, in milliseconds.
   * Required unless `addEndListener` is provided.
   *
   * You may specify a single timeout for all transitions:
   *
   * ```jsx
   * timeout={500}
   * ```
   *
   * or individually:
   *
   * ```jsx
   * timeout={{
   *  appear: 500,
   *  enter: 300,
   *  exit: 500,
   * }}
   * ```
   *
   * - `appear` defaults to the value of `enter`
   * - `enter` defaults to `0`
   * - `exit` defaults to `0`
   *
   * @type {number | { enter?: number, exit?: number, appear?: number }}
   */
  timeout: function timeout(props) {
    var pt = timeoutsShape;
    if (!props.addEndListener)
      pt = pt.isRequired;
    for (var _len = arguments.length, args = new Array(_len > 1 ? _len - 1 : 0), _key = 1; _key < _len; _key++) {
      args[_key - 1] = arguments[_key];
    }
    return pt.apply(void 0, [props].concat(args));
  },
  /**
   * Add a custom transition end trigger. Called with the transitioning
   * DOM node and a `done` callback. Allows for more fine grained transition end
   * logic. Timeouts are still used as a fallback if provided.
   *
   * **Note**: when `nodeRef` prop is passed, `node` is not passed.
   *
   * ```jsx
   * addEndListener={(node, done) => {
   *   // use the css transitionend event to mark the finish of a transition
   *   node.addEventListener('transitionend', done, false);
   * }}
   * ```
   */
  addEndListener: import_prop_types2.default.func,
  /**
   * Callback fired before the "entering" status is applied. An extra parameter
   * `isAppearing` is supplied to indicate if the enter stage is occurring on the initial mount
   *
   * **Note**: when `nodeRef` prop is passed, `node` is not passed.
   *
   * @type Function(node: HtmlElement, isAppearing: bool) -> void
   */
  onEnter: import_prop_types2.default.func,
  /**
   * Callback fired after the "entering" status is applied. An extra parameter
   * `isAppearing` is supplied to indicate if the enter stage is occurring on the initial mount
   *
   * **Note**: when `nodeRef` prop is passed, `node` is not passed.
   *
   * @type Function(node: HtmlElement, isAppearing: bool)
   */
  onEntering: import_prop_types2.default.func,
  /**
   * Callback fired after the "entered" status is applied. An extra parameter
   * `isAppearing` is supplied to indicate if the enter stage is occurring on the initial mount
   *
   * **Note**: when `nodeRef` prop is passed, `node` is not passed.
   *
   * @type Function(node: HtmlElement, isAppearing: bool) -> void
   */
  onEntered: import_prop_types2.default.func,
  /**
   * Callback fired before the "exiting" status is applied.
   *
   * **Note**: when `nodeRef` prop is passed, `node` is not passed.
   *
   * @type Function(node: HtmlElement) -> void
   */
  onExit: import_prop_types2.default.func,
  /**
   * Callback fired after the "exiting" status is applied.
   *
   * **Note**: when `nodeRef` prop is passed, `node` is not passed.
   *
   * @type Function(node: HtmlElement) -> void
   */
  onExiting: import_prop_types2.default.func,
  /**
   * Callback fired after the "exited" status is applied.
   *
   * **Note**: when `nodeRef` prop is passed, `node` is not passed
   *
   * @type Function(node: HtmlElement) -> void
   */
  onExited: import_prop_types2.default.func
} : {};
function noop() {
}
Transition.defaultProps = {
  in: false,
  mountOnEnter: false,
  unmountOnExit: false,
  appear: false,
  enter: true,
  exit: true,
  onEnter: noop,
  onEntering: noop,
  onEntered: noop,
  onExit: noop,
  onExiting: noop,
  onExited: noop
};
Transition.UNMOUNTED = UNMOUNTED;
Transition.EXITED = EXITED;
Transition.ENTERING = ENTERING;
Transition.ENTERED = ENTERED;
Transition.EXITING = EXITING;
var Transition_default = Transition;

// node_modules/react-transition-group/esm/CSSTransition.js
var _addClass = function addClass2(node, classes2) {
  return node && classes2 && classes2.split(" ").forEach(function(c) {
    return addClass(node, c);
  });
};
var removeClass2 = function removeClass3(node, classes2) {
  return node && classes2 && classes2.split(" ").forEach(function(c) {
    return removeClass(node, c);
  });
};
var CSSTransition = function(_React$Component) {
  _inheritsLoose(CSSTransition2, _React$Component);
  function CSSTransition2() {
    var _this;
    for (var _len = arguments.length, args = new Array(_len), _key = 0; _key < _len; _key++) {
      args[_key] = arguments[_key];
    }
    _this = _React$Component.call.apply(_React$Component, [this].concat(args)) || this;
    _this.appliedClasses = {
      appear: {},
      enter: {},
      exit: {}
    };
    _this.onEnter = function(maybeNode, maybeAppearing) {
      var _this$resolveArgument = _this.resolveArguments(maybeNode, maybeAppearing), node = _this$resolveArgument[0], appearing = _this$resolveArgument[1];
      _this.removeClasses(node, "exit");
      _this.addClass(node, appearing ? "appear" : "enter", "base");
      if (_this.props.onEnter) {
        _this.props.onEnter(maybeNode, maybeAppearing);
      }
    };
    _this.onEntering = function(maybeNode, maybeAppearing) {
      var _this$resolveArgument2 = _this.resolveArguments(maybeNode, maybeAppearing), node = _this$resolveArgument2[0], appearing = _this$resolveArgument2[1];
      var type = appearing ? "appear" : "enter";
      _this.addClass(node, type, "active");
      if (_this.props.onEntering) {
        _this.props.onEntering(maybeNode, maybeAppearing);
      }
    };
    _this.onEntered = function(maybeNode, maybeAppearing) {
      var _this$resolveArgument3 = _this.resolveArguments(maybeNode, maybeAppearing), node = _this$resolveArgument3[0], appearing = _this$resolveArgument3[1];
      var type = appearing ? "appear" : "enter";
      _this.removeClasses(node, type);
      _this.addClass(node, type, "done");
      if (_this.props.onEntered) {
        _this.props.onEntered(maybeNode, maybeAppearing);
      }
    };
    _this.onExit = function(maybeNode) {
      var _this$resolveArgument4 = _this.resolveArguments(maybeNode), node = _this$resolveArgument4[0];
      _this.removeClasses(node, "appear");
      _this.removeClasses(node, "enter");
      _this.addClass(node, "exit", "base");
      if (_this.props.onExit) {
        _this.props.onExit(maybeNode);
      }
    };
    _this.onExiting = function(maybeNode) {
      var _this$resolveArgument5 = _this.resolveArguments(maybeNode), node = _this$resolveArgument5[0];
      _this.addClass(node, "exit", "active");
      if (_this.props.onExiting) {
        _this.props.onExiting(maybeNode);
      }
    };
    _this.onExited = function(maybeNode) {
      var _this$resolveArgument6 = _this.resolveArguments(maybeNode), node = _this$resolveArgument6[0];
      _this.removeClasses(node, "exit");
      _this.addClass(node, "exit", "done");
      if (_this.props.onExited) {
        _this.props.onExited(maybeNode);
      }
    };
    _this.resolveArguments = function(maybeNode, maybeAppearing) {
      return _this.props.nodeRef ? [_this.props.nodeRef.current, maybeNode] : [maybeNode, maybeAppearing];
    };
    _this.getClassNames = function(type) {
      var classNames = _this.props.classNames;
      var isStringClassNames = typeof classNames === "string";
      var prefix = isStringClassNames && classNames ? classNames + "-" : "";
      var baseClassName = isStringClassNames ? "" + prefix + type : classNames[type];
      var activeClassName = isStringClassNames ? baseClassName + "-active" : classNames[type + "Active"];
      var doneClassName = isStringClassNames ? baseClassName + "-done" : classNames[type + "Done"];
      return {
        baseClassName,
        activeClassName,
        doneClassName
      };
    };
    return _this;
  }
  var _proto = CSSTransition2.prototype;
  _proto.addClass = function addClass3(node, type, phase) {
    var className = this.getClassNames(type)[phase + "ClassName"];
    var _this$getClassNames = this.getClassNames("enter"), doneClassName = _this$getClassNames.doneClassName;
    if (type === "appear" && phase === "done" && doneClassName) {
      className += " " + doneClassName;
    }
    if (phase === "active") {
      if (node)
        forceReflow(node);
    }
    if (className) {
      this.appliedClasses[type][phase] = className;
      _addClass(node, className);
    }
  };
  _proto.removeClasses = function removeClasses(node, type) {
    var _this$appliedClasses$ = this.appliedClasses[type], baseClassName = _this$appliedClasses$.base, activeClassName = _this$appliedClasses$.active, doneClassName = _this$appliedClasses$.done;
    this.appliedClasses[type] = {};
    if (baseClassName) {
      removeClass2(node, baseClassName);
    }
    if (activeClassName) {
      removeClass2(node, activeClassName);
    }
    if (doneClassName) {
      removeClass2(node, doneClassName);
    }
  };
  _proto.render = function render() {
    var _this$props = this.props, _3 = _this$props.classNames, props = _objectWithoutPropertiesLoose(_this$props, ["classNames"]);
    return import_react4.default.createElement(Transition_default, _extends({}, props, {
      onEnter: this.onEnter,
      onEntered: this.onEntered,
      onEntering: this.onEntering,
      onExit: this.onExit,
      onExiting: this.onExiting,
      onExited: this.onExited
    }));
  };
  return CSSTransition2;
}(import_react4.default.Component);
CSSTransition.defaultProps = {
  classNames: ""
};
CSSTransition.propTypes = true ? _extends({}, Transition_default.propTypes, {
  /**
   * The animation classNames applied to the component as it appears, enters,
   * exits or has finished the transition. A single name can be provided, which
   * will be suffixed for each stage, e.g. `classNames="fade"` applies:
   *
   * - `fade-appear`, `fade-appear-active`, `fade-appear-done`
   * - `fade-enter`, `fade-enter-active`, `fade-enter-done`
   * - `fade-exit`, `fade-exit-active`, `fade-exit-done`
   *
   * A few details to note about how these classes are applied:
   *
   * 1. They are _joined_ with the ones that are already defined on the child
   *    component, so if you want to add some base styles, you can use
   *    `className` without worrying that it will be overridden.
   *
   * 2. If the transition component mounts with `in={false}`, no classes are
   *    applied yet. You might be expecting `*-exit-done`, but if you think
   *    about it, a component cannot finish exiting if it hasn't entered yet.
   *
   * 2. `fade-appear-done` and `fade-enter-done` will _both_ be applied. This
   *    allows you to define different behavior for when appearing is done and
   *    when regular entering is done, using selectors like
   *    `.fade-enter-done:not(.fade-appear-done)`. For example, you could apply
   *    an epic entrance animation when element first appears in the DOM using
   *    [Animate.css](https://daneden.github.io/animate.css/). Otherwise you can
   *    simply use `fade-enter-done` for defining both cases.
   *
   * Each individual classNames can also be specified independently like:
   *
   * ```js
   * classNames={{
   *  appear: 'my-appear',
   *  appearActive: 'my-active-appear',
   *  appearDone: 'my-done-appear',
   *  enter: 'my-enter',
   *  enterActive: 'my-active-enter',
   *  enterDone: 'my-done-enter',
   *  exit: 'my-exit',
   *  exitActive: 'my-active-exit',
   *  exitDone: 'my-done-exit',
   * }}
   * ```
   *
   * If you want to set these classes using CSS Modules:
   *
   * ```js
   * import styles from './styles.css';
   * ```
   *
   * you might want to use camelCase in your CSS file, that way could simply
   * spread them instead of listing them one by one:
   *
   * ```js
   * classNames={{ ...styles }}
   * ```
   *
   * @type {string | {
   *  appear?: string,
   *  appearActive?: string,
   *  appearDone?: string,
   *  enter?: string,
   *  enterActive?: string,
   *  enterDone?: string,
   *  exit?: string,
   *  exitActive?: string,
   *  exitDone?: string,
   * }}
   */
  classNames: classNamesShape,
  /**
   * A `<Transition>` callback fired immediately after the 'enter' or 'appear' class is
   * applied.
   *
   * **Note**: when `nodeRef` prop is passed, `node` is not passed.
   *
   * @type Function(node: HtmlElement, isAppearing: bool)
   */
  onEnter: import_prop_types3.default.func,
  /**
   * A `<Transition>` callback fired immediately after the 'enter-active' or
   * 'appear-active' class is applied.
   *
   * **Note**: when `nodeRef` prop is passed, `node` is not passed.
   *
   * @type Function(node: HtmlElement, isAppearing: bool)
   */
  onEntering: import_prop_types3.default.func,
  /**
   * A `<Transition>` callback fired immediately after the 'enter' or
   * 'appear' classes are **removed** and the `done` class is added to the DOM node.
   *
   * **Note**: when `nodeRef` prop is passed, `node` is not passed.
   *
   * @type Function(node: HtmlElement, isAppearing: bool)
   */
  onEntered: import_prop_types3.default.func,
  /**
   * A `<Transition>` callback fired immediately after the 'exit' class is
   * applied.
   *
   * **Note**: when `nodeRef` prop is passed, `node` is not passed
   *
   * @type Function(node: HtmlElement)
   */
  onExit: import_prop_types3.default.func,
  /**
   * A `<Transition>` callback fired immediately after the 'exit-active' is applied.
   *
   * **Note**: when `nodeRef` prop is passed, `node` is not passed
   *
   * @type Function(node: HtmlElement)
   */
  onExiting: import_prop_types3.default.func,
  /**
   * A `<Transition>` callback fired immediately after the 'exit' classes
   * are **removed** and the `exit-done` class is added to the DOM node.
   *
   * **Note**: when `nodeRef` prop is passed, `node` is not passed
   *
   * @type Function(node: HtmlElement)
   */
  onExited: import_prop_types3.default.func
}) : {};

// node_modules/react-transition-group/esm/ReplaceTransition.js
var import_prop_types5 = __toESM(require_prop_types());
var import_react7 = __toESM(require_react());
var import_react_dom2 = __toESM(require_react_dom());

// node_modules/@babel/runtime/helpers/esm/assertThisInitialized.js
function _assertThisInitialized(self) {
  if (self === void 0) {
    throw new ReferenceError("this hasn't been initialised - super() hasn't been called");
  }
  return self;
}

// node_modules/react-transition-group/esm/TransitionGroup.js
var import_prop_types4 = __toESM(require_prop_types());
var import_react6 = __toESM(require_react());

// node_modules/react-transition-group/esm/utils/ChildMapping.js
var import_react5 = __toESM(require_react());
function getChildMapping(children2, mapFn) {
  var mapper = function mapper2(child) {
    return mapFn && (0, import_react5.isValidElement)(child) ? mapFn(child) : child;
  };
  var result = /* @__PURE__ */ Object.create(null);
  if (children2)
    import_react5.Children.map(children2, function(c) {
      return c;
    }).forEach(function(child) {
      result[child.key] = mapper(child);
    });
  return result;
}
function mergeChildMappings(prev, next) {
  prev = prev || {};
  next = next || {};
  function getValueForKey(key) {
    return key in next ? next[key] : prev[key];
  }
  var nextKeysPending = /* @__PURE__ */ Object.create(null);
  var pendingKeys = [];
  for (var prevKey in prev) {
    if (prevKey in next) {
      if (pendingKeys.length) {
        nextKeysPending[prevKey] = pendingKeys;
        pendingKeys = [];
      }
    } else {
      pendingKeys.push(prevKey);
    }
  }
  var i;
  var childMapping = {};
  for (var nextKey in next) {
    if (nextKeysPending[nextKey]) {
      for (i = 0; i < nextKeysPending[nextKey].length; i++) {
        var pendingNextKey = nextKeysPending[nextKey][i];
        childMapping[nextKeysPending[nextKey][i]] = getValueForKey(pendingNextKey);
      }
    }
    childMapping[nextKey] = getValueForKey(nextKey);
  }
  for (i = 0; i < pendingKeys.length; i++) {
    childMapping[pendingKeys[i]] = getValueForKey(pendingKeys[i]);
  }
  return childMapping;
}
function getProp(child, prop, props) {
  return props[prop] != null ? props[prop] : child.props[prop];
}
function getInitialChildMapping(props, onExited) {
  return getChildMapping(props.children, function(child) {
    return (0, import_react5.cloneElement)(child, {
      onExited: onExited.bind(null, child),
      in: true,
      appear: getProp(child, "appear", props),
      enter: getProp(child, "enter", props),
      exit: getProp(child, "exit", props)
    });
  });
}
function getNextChildMapping(nextProps, prevChildMapping, onExited) {
  var nextChildMapping = getChildMapping(nextProps.children);
  var children2 = mergeChildMappings(prevChildMapping, nextChildMapping);
  Object.keys(children2).forEach(function(key) {
    var child = children2[key];
    if (!(0, import_react5.isValidElement)(child))
      return;
    var hasPrev = key in prevChildMapping;
    var hasNext = key in nextChildMapping;
    var prevChild = prevChildMapping[key];
    var isLeaving = (0, import_react5.isValidElement)(prevChild) && !prevChild.props.in;
    if (hasNext && (!hasPrev || isLeaving)) {
      children2[key] = (0, import_react5.cloneElement)(child, {
        onExited: onExited.bind(null, child),
        in: true,
        exit: getProp(child, "exit", nextProps),
        enter: getProp(child, "enter", nextProps)
      });
    } else if (!hasNext && hasPrev && !isLeaving) {
      children2[key] = (0, import_react5.cloneElement)(child, {
        in: false
      });
    } else if (hasNext && hasPrev && (0, import_react5.isValidElement)(prevChild)) {
      children2[key] = (0, import_react5.cloneElement)(child, {
        onExited: onExited.bind(null, child),
        in: prevChild.props.in,
        exit: getProp(child, "exit", nextProps),
        enter: getProp(child, "enter", nextProps)
      });
    }
  });
  return children2;
}

// node_modules/react-transition-group/esm/TransitionGroup.js
var values = Object.values || function(obj) {
  return Object.keys(obj).map(function(k2) {
    return obj[k2];
  });
};
var defaultProps = {
  component: "div",
  childFactory: function childFactory(child) {
    return child;
  }
};
var TransitionGroup = function(_React$Component) {
  _inheritsLoose(TransitionGroup2, _React$Component);
  function TransitionGroup2(props, context) {
    var _this;
    _this = _React$Component.call(this, props, context) || this;
    var handleExited = _this.handleExited.bind(_assertThisInitialized(_this));
    _this.state = {
      contextValue: {
        isMounting: true
      },
      handleExited,
      firstRender: true
    };
    return _this;
  }
  var _proto = TransitionGroup2.prototype;
  _proto.componentDidMount = function componentDidMount() {
    this.mounted = true;
    this.setState({
      contextValue: {
        isMounting: false
      }
    });
  };
  _proto.componentWillUnmount = function componentWillUnmount() {
    this.mounted = false;
  };
  TransitionGroup2.getDerivedStateFromProps = function getDerivedStateFromProps(nextProps, _ref) {
    var prevChildMapping = _ref.children, handleExited = _ref.handleExited, firstRender = _ref.firstRender;
    return {
      children: firstRender ? getInitialChildMapping(nextProps, handleExited) : getNextChildMapping(nextProps, prevChildMapping, handleExited),
      firstRender: false
    };
  };
  _proto.handleExited = function handleExited(child, node) {
    var currentChildMapping = getChildMapping(this.props.children);
    if (child.key in currentChildMapping)
      return;
    if (child.props.onExited) {
      child.props.onExited(node);
    }
    if (this.mounted) {
      this.setState(function(state) {
        var children2 = _extends({}, state.children);
        delete children2[child.key];
        return {
          children: children2
        };
      });
    }
  };
  _proto.render = function render() {
    var _this$props = this.props, Component2 = _this$props.component, childFactory2 = _this$props.childFactory, props = _objectWithoutPropertiesLoose(_this$props, ["component", "childFactory"]);
    var contextValue = this.state.contextValue;
    var children2 = values(this.state.children).map(childFactory2);
    delete props.appear;
    delete props.enter;
    delete props.exit;
    if (Component2 === null) {
      return import_react6.default.createElement(TransitionGroupContext_default.Provider, {
        value: contextValue
      }, children2);
    }
    return import_react6.default.createElement(TransitionGroupContext_default.Provider, {
      value: contextValue
    }, import_react6.default.createElement(Component2, props, children2));
  };
  return TransitionGroup2;
}(import_react6.default.Component);
TransitionGroup.propTypes = true ? {
  /**
   * `<TransitionGroup>` renders a `<div>` by default. You can change this
   * behavior by providing a `component` prop.
   * If you use React v16+ and would like to avoid a wrapping `<div>` element
   * you can pass in `component={null}`. This is useful if the wrapping div
   * borks your css styles.
   */
  component: import_prop_types4.default.any,
  /**
   * A set of `<Transition>` components, that are toggled `in` and out as they
   * leave. the `<TransitionGroup>` will inject specific transition props, so
   * remember to spread them through if you are wrapping the `<Transition>` as
   * with our `<Fade>` example.
   *
   * While this component is meant for multiple `Transition` or `CSSTransition`
   * children, sometimes you may want to have a single transition child with
   * content that you want to be transitioned out and in when you change it
   * (e.g. routes, images etc.) In that case you can change the `key` prop of
   * the transition child as you change its content, this will cause
   * `TransitionGroup` to transition the child out and back in.
   */
  children: import_prop_types4.default.node,
  /**
   * A convenience prop that enables or disables appear animations
   * for all children. Note that specifying this will override any defaults set
   * on individual children Transitions.
   */
  appear: import_prop_types4.default.bool,
  /**
   * A convenience prop that enables or disables enter animations
   * for all children. Note that specifying this will override any defaults set
   * on individual children Transitions.
   */
  enter: import_prop_types4.default.bool,
  /**
   * A convenience prop that enables or disables exit animations
   * for all children. Note that specifying this will override any defaults set
   * on individual children Transitions.
   */
  exit: import_prop_types4.default.bool,
  /**
   * You may need to apply reactive updates to a child as it is exiting.
   * This is generally done by using `cloneElement` however in the case of an exiting
   * child the element has already been removed and not accessible to the consumer.
   *
   * If you do need to update a child as it leaves you can provide a `childFactory`
   * to wrap every child, even the ones that are leaving.
   *
   * @type Function(child: ReactElement) -> ReactElement
   */
  childFactory: import_prop_types4.default.func
} : {};
TransitionGroup.defaultProps = defaultProps;
var TransitionGroup_default = TransitionGroup;

// node_modules/react-transition-group/esm/ReplaceTransition.js
var ReplaceTransition = function(_React$Component) {
  _inheritsLoose(ReplaceTransition2, _React$Component);
  function ReplaceTransition2() {
    var _this;
    for (var _len = arguments.length, _args = new Array(_len), _key = 0; _key < _len; _key++) {
      _args[_key] = arguments[_key];
    }
    _this = _React$Component.call.apply(_React$Component, [this].concat(_args)) || this;
    _this.handleEnter = function() {
      for (var _len2 = arguments.length, args = new Array(_len2), _key2 = 0; _key2 < _len2; _key2++) {
        args[_key2] = arguments[_key2];
      }
      return _this.handleLifecycle("onEnter", 0, args);
    };
    _this.handleEntering = function() {
      for (var _len3 = arguments.length, args = new Array(_len3), _key3 = 0; _key3 < _len3; _key3++) {
        args[_key3] = arguments[_key3];
      }
      return _this.handleLifecycle("onEntering", 0, args);
    };
    _this.handleEntered = function() {
      for (var _len4 = arguments.length, args = new Array(_len4), _key4 = 0; _key4 < _len4; _key4++) {
        args[_key4] = arguments[_key4];
      }
      return _this.handleLifecycle("onEntered", 0, args);
    };
    _this.handleExit = function() {
      for (var _len5 = arguments.length, args = new Array(_len5), _key5 = 0; _key5 < _len5; _key5++) {
        args[_key5] = arguments[_key5];
      }
      return _this.handleLifecycle("onExit", 1, args);
    };
    _this.handleExiting = function() {
      for (var _len6 = arguments.length, args = new Array(_len6), _key6 = 0; _key6 < _len6; _key6++) {
        args[_key6] = arguments[_key6];
      }
      return _this.handleLifecycle("onExiting", 1, args);
    };
    _this.handleExited = function() {
      for (var _len7 = arguments.length, args = new Array(_len7), _key7 = 0; _key7 < _len7; _key7++) {
        args[_key7] = arguments[_key7];
      }
      return _this.handleLifecycle("onExited", 1, args);
    };
    return _this;
  }
  var _proto = ReplaceTransition2.prototype;
  _proto.handleLifecycle = function handleLifecycle(handler, idx, originalArgs) {
    var _child$props;
    var children2 = this.props.children;
    var child = import_react7.default.Children.toArray(children2)[idx];
    if (child.props[handler])
      (_child$props = child.props)[handler].apply(_child$props, originalArgs);
    if (this.props[handler]) {
      var maybeNode = child.props.nodeRef ? void 0 : import_react_dom2.default.findDOMNode(this);
      this.props[handler](maybeNode);
    }
  };
  _proto.render = function render() {
    var _this$props = this.props, children2 = _this$props.children, inProp = _this$props.in, props = _objectWithoutPropertiesLoose(_this$props, ["children", "in"]);
    var _React$Children$toArr = import_react7.default.Children.toArray(children2), first = _React$Children$toArr[0], second = _React$Children$toArr[1];
    delete props.onEnter;
    delete props.onEntering;
    delete props.onEntered;
    delete props.onExit;
    delete props.onExiting;
    delete props.onExited;
    return import_react7.default.createElement(TransitionGroup_default, props, inProp ? import_react7.default.cloneElement(first, {
      key: "first",
      onEnter: this.handleEnter,
      onEntering: this.handleEntering,
      onEntered: this.handleEntered
    }) : import_react7.default.cloneElement(second, {
      key: "second",
      onEnter: this.handleExit,
      onEntering: this.handleExiting,
      onEntered: this.handleExited
    }));
  };
  return ReplaceTransition2;
}(import_react7.default.Component);
ReplaceTransition.propTypes = true ? {
  in: import_prop_types5.default.bool.isRequired,
  children: function children(props, propName) {
    if (import_react7.default.Children.count(props[propName]) !== 2)
      return new Error('"' + propName + '" must be exactly two transition components.');
    return null;
  }
} : {};

// node_modules/react-transition-group/esm/SwitchTransition.js
var import_react8 = __toESM(require_react());
var import_prop_types6 = __toESM(require_prop_types());
var _leaveRenders;
var _enterRenders;
function areChildrenDifferent(oldChildren, newChildren) {
  if (oldChildren === newChildren)
    return false;
  if (import_react8.default.isValidElement(oldChildren) && import_react8.default.isValidElement(newChildren) && oldChildren.key != null && oldChildren.key === newChildren.key) {
    return false;
  }
  return true;
}
var modes = {
  out: "out-in",
  in: "in-out"
};
var callHook = function callHook2(element, name, cb) {
  return function() {
    var _element$props;
    element.props[name] && (_element$props = element.props)[name].apply(_element$props, arguments);
    cb();
  };
};
var leaveRenders = (_leaveRenders = {}, _leaveRenders[modes.out] = function(_ref) {
  var current = _ref.current, changeState = _ref.changeState;
  return import_react8.default.cloneElement(current, {
    in: false,
    onExited: callHook(current, "onExited", function() {
      changeState(ENTERING, null);
    })
  });
}, _leaveRenders[modes.in] = function(_ref2) {
  var current = _ref2.current, changeState = _ref2.changeState, children2 = _ref2.children;
  return [current, import_react8.default.cloneElement(children2, {
    in: true,
    onEntered: callHook(children2, "onEntered", function() {
      changeState(ENTERING);
    })
  })];
}, _leaveRenders);
var enterRenders = (_enterRenders = {}, _enterRenders[modes.out] = function(_ref3) {
  var children2 = _ref3.children, changeState = _ref3.changeState;
  return import_react8.default.cloneElement(children2, {
    in: true,
    onEntered: callHook(children2, "onEntered", function() {
      changeState(ENTERED, import_react8.default.cloneElement(children2, {
        in: true
      }));
    })
  });
}, _enterRenders[modes.in] = function(_ref4) {
  var current = _ref4.current, children2 = _ref4.children, changeState = _ref4.changeState;
  return [import_react8.default.cloneElement(current, {
    in: false,
    onExited: callHook(current, "onExited", function() {
      changeState(ENTERED, import_react8.default.cloneElement(children2, {
        in: true
      }));
    })
  }), import_react8.default.cloneElement(children2, {
    in: true
  })];
}, _enterRenders);
var SwitchTransition = function(_React$Component) {
  _inheritsLoose(SwitchTransition2, _React$Component);
  function SwitchTransition2() {
    var _this;
    for (var _len = arguments.length, args = new Array(_len), _key = 0; _key < _len; _key++) {
      args[_key] = arguments[_key];
    }
    _this = _React$Component.call.apply(_React$Component, [this].concat(args)) || this;
    _this.state = {
      status: ENTERED,
      current: null
    };
    _this.appeared = false;
    _this.changeState = function(status, current) {
      if (current === void 0) {
        current = _this.state.current;
      }
      _this.setState({
        status,
        current
      });
    };
    return _this;
  }
  var _proto = SwitchTransition2.prototype;
  _proto.componentDidMount = function componentDidMount() {
    this.appeared = true;
  };
  SwitchTransition2.getDerivedStateFromProps = function getDerivedStateFromProps(props, state) {
    if (props.children == null) {
      return {
        current: null
      };
    }
    if (state.status === ENTERING && props.mode === modes.in) {
      return {
        status: ENTERING
      };
    }
    if (state.current && areChildrenDifferent(state.current, props.children)) {
      return {
        status: EXITING
      };
    }
    return {
      current: import_react8.default.cloneElement(props.children, {
        in: true
      })
    };
  };
  _proto.render = function render() {
    var _this$props = this.props, children2 = _this$props.children, mode = _this$props.mode, _this$state = this.state, status = _this$state.status, current = _this$state.current;
    var data2 = {
      children: children2,
      current,
      changeState: this.changeState,
      status
    };
    var component;
    switch (status) {
      case ENTERING:
        component = enterRenders[mode](data2);
        break;
      case EXITING:
        component = leaveRenders[mode](data2);
        break;
      case ENTERED:
        component = current;
    }
    return import_react8.default.createElement(TransitionGroupContext_default.Provider, {
      value: {
        isMounting: !this.appeared
      }
    }, component);
  };
  return SwitchTransition2;
}(import_react8.default.Component);
SwitchTransition.propTypes = true ? {
  /**
   * Transition modes.
   * `out-in`: Current element transitions out first, then when complete, the new element transitions in.
   * `in-out`: New element transitions in first, then when complete, the current element transitions out.
   *
   * @type {'out-in'|'in-out'}
   */
  mode: import_prop_types6.default.oneOf([modes.in, modes.out]),
  /**
   * Any `Transition` or `CSSTransition` component.
   */
  children: import_prop_types6.default.oneOfType([import_prop_types6.default.element.isRequired])
} : {};
SwitchTransition.defaultProps = {
  mode: modes.out
};

// node_modules/@mantine/notifications/esm/get-notification-state-styles.mjs
var transforms = {
  left: "translateX(-100%)",
  right: "translateX(100%)",
  "top-center": "translateY(-100%)",
  "bottom-center": "translateY(100%)"
};
var noTransform = {
  left: "translateX(0)",
  right: "translateX(0)",
  "top-center": "translateY(0)",
  "bottom-center": "translateY(0)"
};
function getNotificationStateStyles({
  state,
  maxHeight,
  position,
  transitionDuration
}) {
  const [vertical, horizontal] = position.split("-");
  const property = horizontal === "center" ? `${vertical}-center` : horizontal;
  const commonStyles = {
    opacity: 0,
    maxHeight,
    transform: transforms[property],
    transitionDuration: `${transitionDuration}ms, ${transitionDuration}ms, ${transitionDuration}ms`,
    transitionTimingFunction: "cubic-bezier(.51,.3,0,1.21), cubic-bezier(.51,.3,0,1.21), linear",
    transitionProperty: "opacity, transform, max-height"
  };
  const inState = {
    opacity: 1,
    transform: noTransform[property]
  };
  const outState = {
    opacity: 0,
    maxHeight: 0,
    transform: transforms[property]
  };
  const transitionStyles = {
    entering: inState,
    entered: inState,
    exiting: outState,
    exited: outState
  };
  return { ...commonStyles, ...transitionStyles[state] };
}

// node_modules/@mantine/notifications/esm/NotificationContainer.mjs
var import_react9 = __toESM(require_react(), 1);

// node_modules/@mantine/notifications/esm/get-auto-close/get-auto-close.mjs
function getAutoClose(autoClose, notificationAutoClose) {
  if (typeof notificationAutoClose === "number") {
    return notificationAutoClose;
  }
  if (notificationAutoClose === false || autoClose === false) {
    return false;
  }
  return autoClose;
}

// node_modules/@mantine/notifications/esm/NotificationContainer.mjs
var NotificationContainer = (0, import_react9.forwardRef)(
  ({ data: data2, onHide, autoClose, ...others }, ref) => {
    const { autoClose: _autoClose, message, ...notificationProps } = data2;
    const autoCloseDuration = getAutoClose(autoClose, data2.autoClose);
    const autoCloseTimeout = (0, import_react9.useRef)();
    const cancelAutoClose = () => window.clearTimeout(autoCloseTimeout.current);
    const handleHide = () => {
      onHide(data2.id);
      cancelAutoClose();
    };
    const handleAutoClose = () => {
      if (typeof autoCloseDuration === "number") {
        autoCloseTimeout.current = window.setTimeout(handleHide, autoCloseDuration);
      }
    };
    (0, import_react9.useEffect)(() => {
      var _a;
      (_a = data2.onOpen) == null ? void 0 : _a.call(data2, data2);
    }, []);
    (0, import_react9.useEffect)(() => {
      handleAutoClose();
      return cancelAutoClose;
    }, [autoCloseDuration]);
    return import_react9.default.createElement(
      Notification,
      {
        ...others,
        ...notificationProps,
        onClose: handleHide,
        ref,
        onMouseEnter: cancelAutoClose,
        onMouseLeave: handleAutoClose
      },
      message
    );
  }
);
NotificationContainer.displayName = "@mantine/notifications/NotificationContainer";

// node_modules/@mantine/notifications/esm/Notifications.module.css.mjs
var classes = { "root": "m-b37d9ac7", "notification": "m-5ed0edd0" };

// node_modules/@mantine/notifications/esm/Notifications.mjs
var Transition2 = Transition_default;
var defaultProps2 = {
  position: "bottom-right",
  autoClose: 4e3,
  transitionDuration: 250,
  containerWidth: 440,
  notificationMaxHeight: 200,
  limit: 5,
  zIndex: getDefaultZIndex("overlay"),
  store: notificationsStore,
  withinPortal: true
};
var varsResolver = createVarsResolver(
  (_3, { zIndex, position, containerWidth }) => {
    const [vertical, horizontal] = position.split("-");
    return {
      root: {
        "--notifications-z-index": zIndex == null ? void 0 : zIndex.toString(),
        "--notifications-top": vertical === "top" ? "var(--mantine-spacing-md)" : void 0,
        "--notifications-bottom": vertical === "bottom" ? "var(--mantine-spacing-md)" : void 0,
        "--notifications-left": horizontal === "left" ? "var(--mantine-spacing-md)" : horizontal === "center" ? "50%" : void 0,
        "--notifications-right": horizontal === "right" ? "var(--mantine-spacing-md)" : void 0,
        "--notifications-transform": horizontal === "center" ? "translateX(-50%)" : void 0,
        "--notifications-container-width": rem(containerWidth)
      }
    };
  }
);
var Notifications = factory((_props, ref) => {
  const props = useProps("Notifications", defaultProps2, _props);
  const {
    classNames,
    className,
    style,
    styles,
    unstyled,
    vars,
    position,
    autoClose,
    transitionDuration,
    containerWidth,
    notificationMaxHeight,
    limit,
    zIndex,
    store,
    portalProps,
    withinPortal,
    ...others
  } = props;
  const theme = useMantineTheme();
  const data2 = useNotifications(store);
  const forceUpdate = useForceUpdate();
  const shouldReduceMotion = useReducedMotion();
  const refs = (0, import_react10.useRef)({});
  const previousLength = (0, import_react10.useRef)(0);
  const reduceMotion = theme.respectReducedMotion ? shouldReduceMotion : false;
  const duration = reduceMotion ? 1 : transitionDuration;
  const getStyles = useStyles({
    name: "Notifications",
    classes,
    props,
    className,
    style,
    classNames,
    styles,
    unstyled,
    vars,
    varsResolver
  });
  (0, import_react10.useEffect)(() => {
    store == null ? void 0 : store.updateState((current) => ({ ...current, limit: limit || 5 }));
  }, [limit]);
  useDidUpdate(() => {
    if (data2.notifications.length > previousLength.current) {
      setTimeout(() => forceUpdate(), 0);
    }
    previousLength.current = data2.notifications.length;
  }, [data2.notifications]);
  const items = data2.notifications.map(({ style: notificationStyle, ...notification }) => import_react10.default.createElement(
    Transition2,
    {
      key: notification.id,
      timeout: duration,
      onEnter: () => refs.current[notification.id].offsetHeight,
      nodeRef: { current: refs.current[notification.id] }
    },
    (state) => import_react10.default.createElement(
      NotificationContainer,
      {
        ref: (node) => {
          refs.current[notification.id] = node;
        },
        data: notification,
        onHide: (id) => hideNotification(id, store),
        autoClose,
        ...getStyles("notification", {
          style: {
            ...getNotificationStateStyles({
              state,
              position,
              transitionDuration: duration,
              maxHeight: notificationMaxHeight
            }),
            ...notificationStyle
          }
        })
      }
    )
  ));
  return import_react10.default.createElement(OptionalPortal, { withinPortal, ...portalProps }, import_react10.default.createElement(Box, { ...getStyles("root"), ref, ...others }, import_react10.default.createElement(TransitionGroup_default, null, items)));
});
Notifications.classes = classes;
Notifications.displayName = "@mantine/notifications/Notifications";
Notifications.show = notifications.show;
Notifications.hide = notifications.hide;
Notifications.update = notifications.update;
Notifications.clean = notifications.clean;
Notifications.cleanQueue = notifications.cleanQueue;
Notifications.updateState = notifications.updateState;

// node_modules/@medplum/react/dist/esm/index.mjs
var import_react19 = __toESM(require_react(), 1);
var import_react20 = __toESM(require_react(), 1);
var import_prop_types7 = __toESM(require_prop_types(), 1);
var import_react21 = __toESM(require_react(), 1);
var import_jsx_runtime5 = __toESM(require_jsx_runtime(), 1);
var import_jsx_runtime6 = __toESM(require_jsx_runtime(), 1);
var import_react22 = __toESM(require_react(), 1);
var import_jsx_runtime7 = __toESM(require_jsx_runtime(), 1);
var import_jsx_runtime8 = __toESM(require_jsx_runtime(), 1);
var import_jsx_runtime9 = __toESM(require_jsx_runtime(), 1);
var import_jsx_runtime10 = __toESM(require_jsx_runtime(), 1);
var import_react23 = __toESM(require_react(), 1);
var import_react24 = __toESM(require_react(), 1);
var import_jsx_runtime11 = __toESM(require_jsx_runtime(), 1);
var import_jsx_runtime12 = __toESM(require_jsx_runtime(), 1);
var import_jsx_runtime13 = __toESM(require_jsx_runtime(), 1);
var import_react25 = __toESM(require_react(), 1);
var import_jsx_runtime14 = __toESM(require_jsx_runtime(), 1);
var import_jsx_runtime15 = __toESM(require_jsx_runtime(), 1);
var import_react26 = __toESM(require_react(), 1);
var import_react27 = __toESM(require_react(), 1);
var import_react28 = __toESM(require_react(), 1);
var import_jsx_runtime16 = __toESM(require_jsx_runtime(), 1);
var import_jsx_runtime17 = __toESM(require_jsx_runtime(), 1);
var import_jsx_runtime18 = __toESM(require_jsx_runtime(), 1);
var import_jsx_runtime19 = __toESM(require_jsx_runtime(), 1);
var import_jsx_runtime20 = __toESM(require_jsx_runtime(), 1);
var import_jsx_runtime21 = __toESM(require_jsx_runtime(), 1);
var import_jsx_runtime22 = __toESM(require_jsx_runtime(), 1);
var import_jsx_runtime23 = __toESM(require_jsx_runtime(), 1);
var import_react29 = __toESM(require_react(), 1);
var import_react30 = __toESM(require_react(), 1);
var import_jsx_runtime24 = __toESM(require_jsx_runtime(), 1);
var import_jsx_runtime25 = __toESM(require_jsx_runtime(), 1);
var import_react31 = __toESM(require_react(), 1);
var import_jsx_runtime26 = __toESM(require_jsx_runtime(), 1);
var import_jsx_runtime27 = __toESM(require_jsx_runtime(), 1);
var import_jsx_runtime28 = __toESM(require_jsx_runtime(), 1);
var import_jsx_runtime29 = __toESM(require_jsx_runtime(), 1);
var import_jsx_runtime30 = __toESM(require_jsx_runtime(), 1);
var import_jsx_runtime31 = __toESM(require_jsx_runtime(), 1);
var import_jsx_runtime32 = __toESM(require_jsx_runtime(), 1);
var import_jsx_runtime33 = __toESM(require_jsx_runtime(), 1);
var import_jsx_runtime34 = __toESM(require_jsx_runtime(), 1);
var import_jsx_runtime35 = __toESM(require_jsx_runtime(), 1);
var import_jsx_runtime36 = __toESM(require_jsx_runtime(), 1);
var import_react32 = __toESM(require_react(), 1);
var import_react33 = __toESM(require_react(), 1);
var import_react34 = __toESM(require_react(), 1);
var import_jsx_runtime37 = __toESM(require_jsx_runtime(), 1);
var import_jsx_runtime38 = __toESM(require_jsx_runtime(), 1);
var import_jsx_runtime39 = __toESM(require_jsx_runtime(), 1);
var import_react35 = __toESM(require_react(), 1);
var import_jsx_runtime40 = __toESM(require_jsx_runtime(), 1);
var import_jsx_runtime41 = __toESM(require_jsx_runtime(), 1);
var import_react36 = __toESM(require_react(), 1);
var import_jsx_runtime42 = __toESM(require_jsx_runtime(), 1);
var import_react37 = __toESM(require_react(), 1);
var import_react38 = __toESM(require_react(), 1);
var import_react39 = __toESM(require_react(), 1);
var import_jsx_runtime43 = __toESM(require_jsx_runtime(), 1);
var import_react40 = __toESM(require_react(), 1);
var import_jsx_runtime44 = __toESM(require_jsx_runtime(), 1);
var import_react41 = __toESM(require_react(), 1);
var import_react42 = __toESM(require_react(), 1);
var import_jsx_runtime45 = __toESM(require_jsx_runtime(), 1);
var import_react43 = __toESM(require_react(), 1);
var import_jsx_runtime46 = __toESM(require_jsx_runtime(), 1);
var import_react44 = __toESM(require_react(), 1);
var import_react45 = __toESM(require_react(), 1);
var import_jsx_runtime47 = __toESM(require_jsx_runtime(), 1);
var import_jsx_runtime48 = __toESM(require_jsx_runtime(), 1);
var import_jsx_runtime49 = __toESM(require_jsx_runtime(), 1);
var import_react46 = __toESM(require_react(), 1);
var import_jsx_runtime50 = __toESM(require_jsx_runtime(), 1);
var import_react47 = __toESM(require_react(), 1);
var import_jsx_runtime51 = __toESM(require_jsx_runtime(), 1);
var import_react48 = __toESM(require_react(), 1);
var import_jsx_runtime52 = __toESM(require_jsx_runtime(), 1);
var import_react49 = __toESM(require_react(), 1);
var import_jsx_runtime53 = __toESM(require_jsx_runtime(), 1);
var import_react50 = __toESM(require_react(), 1);
var import_jsx_runtime54 = __toESM(require_jsx_runtime(), 1);
var import_react51 = __toESM(require_react(), 1);
var import_jsx_runtime55 = __toESM(require_jsx_runtime(), 1);
var import_react52 = __toESM(require_react(), 1);
var import_jsx_runtime56 = __toESM(require_jsx_runtime(), 1);
var import_react53 = __toESM(require_react(), 1);
var import_jsx_runtime57 = __toESM(require_jsx_runtime(), 1);
var import_react54 = __toESM(require_react(), 1);
var import_react55 = __toESM(require_react(), 1);
var import_jsx_runtime58 = __toESM(require_jsx_runtime(), 1);
var import_jsx_runtime59 = __toESM(require_jsx_runtime(), 1);
var import_react56 = __toESM(require_react(), 1);
var import_react57 = __toESM(require_react(), 1);
var import_jsx_runtime60 = __toESM(require_jsx_runtime(), 1);
var import_jsx_runtime61 = __toESM(require_jsx_runtime(), 1);
var import_jsx_runtime62 = __toESM(require_jsx_runtime(), 1);
var import_jsx_runtime63 = __toESM(require_jsx_runtime(), 1);
var import_react58 = __toESM(require_react(), 1);
var import_jsx_runtime64 = __toESM(require_jsx_runtime(), 1);
var import_react59 = __toESM(require_react(), 1);
var import_jsx_runtime65 = __toESM(require_jsx_runtime(), 1);
var import_jsx_runtime66 = __toESM(require_jsx_runtime(), 1);
var import_jsx_runtime67 = __toESM(require_jsx_runtime(), 1);
var import_jsx_runtime68 = __toESM(require_jsx_runtime(), 1);
var import_react60 = __toESM(require_react(), 1);
var import_jsx_runtime69 = __toESM(require_jsx_runtime(), 1);
var import_jsx_runtime70 = __toESM(require_jsx_runtime(), 1);
var import_react61 = __toESM(require_react(), 1);
var import_react62 = __toESM(require_react(), 1);
var import_jsx_runtime71 = __toESM(require_jsx_runtime(), 1);
var import_react63 = __toESM(require_react(), 1);
var import_jsx_runtime72 = __toESM(require_jsx_runtime(), 1);
var import_jsx_runtime73 = __toESM(require_jsx_runtime(), 1);
var import_jsx_runtime74 = __toESM(require_jsx_runtime(), 1);
var import_jsx_runtime75 = __toESM(require_jsx_runtime(), 1);
var import_jsx_runtime76 = __toESM(require_jsx_runtime(), 1);
var import_react64 = __toESM(require_react(), 1);
var import_jsx_runtime77 = __toESM(require_jsx_runtime(), 1);
var import_react65 = __toESM(require_react(), 1);
var import_jsx_runtime78 = __toESM(require_jsx_runtime(), 1);
var import_jsx_runtime79 = __toESM(require_jsx_runtime(), 1);
var import_jsx_runtime80 = __toESM(require_jsx_runtime(), 1);
var import_jsx_runtime81 = __toESM(require_jsx_runtime(), 1);
var import_jsx_runtime82 = __toESM(require_jsx_runtime(), 1);
var import_jsx_runtime83 = __toESM(require_jsx_runtime(), 1);
var import_react66 = __toESM(require_react(), 1);
var import_jsx_runtime84 = __toESM(require_jsx_runtime(), 1);
var import_react67 = __toESM(require_react(), 1);
var import_jsx_runtime85 = __toESM(require_jsx_runtime(), 1);
var import_react68 = __toESM(require_react(), 1);
var import_jsx_runtime86 = __toESM(require_jsx_runtime(), 1);
var import_jsx_runtime87 = __toESM(require_jsx_runtime(), 1);
var import_react69 = __toESM(require_react(), 1);
var import_jsx_runtime88 = __toESM(require_jsx_runtime(), 1);
var import_jsx_runtime89 = __toESM(require_jsx_runtime(), 1);
var import_jsx_runtime90 = __toESM(require_jsx_runtime(), 1);
var import_react70 = __toESM(require_react(), 1);
var import_jsx_runtime91 = __toESM(require_jsx_runtime(), 1);
var import_jsx_runtime92 = __toESM(require_jsx_runtime(), 1);
var import_jsx_runtime93 = __toESM(require_jsx_runtime(), 1);
var import_jsx_runtime94 = __toESM(require_jsx_runtime(), 1);
var import_jsx_runtime95 = __toESM(require_jsx_runtime(), 1);
var import_jsx_runtime96 = __toESM(require_jsx_runtime(), 1);
var import_jsx_runtime97 = __toESM(require_jsx_runtime(), 1);
var import_react71 = __toESM(require_react(), 1);
var import_jsx_runtime98 = __toESM(require_jsx_runtime(), 1);
var import_jsx_runtime99 = __toESM(require_jsx_runtime(), 1);
var import_react72 = __toESM(require_react(), 1);
var import_react73 = __toESM(require_react(), 1);
var import_jsx_runtime100 = __toESM(require_jsx_runtime(), 1);
var import_react74 = __toESM(require_react(), 1);
var import_jsx_runtime101 = __toESM(require_jsx_runtime(), 1);
var import_react75 = __toESM(require_react(), 1);
var import_jsx_runtime102 = __toESM(require_jsx_runtime(), 1);
var import_react76 = __toESM(require_react(), 1);
var import_jsx_runtime103 = __toESM(require_jsx_runtime(), 1);
var import_react77 = __toESM(require_react(), 1);
var import_jsx_runtime104 = __toESM(require_jsx_runtime(), 1);
var import_jsx_runtime105 = __toESM(require_jsx_runtime(), 1);
var import_react78 = __toESM(require_react(), 1);
var import_jsx_runtime106 = __toESM(require_jsx_runtime(), 1);
var import_react79 = __toESM(require_react(), 1);
var import_jsx_runtime107 = __toESM(require_jsx_runtime(), 1);
var import_react80 = __toESM(require_react(), 1);
var import_react81 = __toESM(require_react(), 1);
var import_react82 = __toESM(require_react(), 1);
var import_jsx_runtime108 = __toESM(require_jsx_runtime(), 1);
var import_jsx_runtime109 = __toESM(require_jsx_runtime(), 1);
var import_react83 = __toESM(require_react(), 1);
var import_react84 = __toESM(require_react(), 1);
var import_jsx_runtime110 = __toESM(require_jsx_runtime(), 1);
var import_react85 = __toESM(require_react(), 1);
var import_jsx_runtime111 = __toESM(require_jsx_runtime(), 1);
var import_jsx_runtime112 = __toESM(require_jsx_runtime(), 1);
var import_jsx_runtime113 = __toESM(require_jsx_runtime(), 1);
var import_react86 = __toESM(require_react(), 1);
var import_jsx_runtime114 = __toESM(require_jsx_runtime(), 1);
var import_react87 = __toESM(require_react(), 1);
var import_jsx_runtime115 = __toESM(require_jsx_runtime(), 1);
var import_react88 = __toESM(require_react(), 1);
var import_jsx_runtime116 = __toESM(require_jsx_runtime(), 1);
var import_jsx_runtime117 = __toESM(require_jsx_runtime(), 1);
var import_react89 = __toESM(require_react(), 1);
var import_jsx_runtime118 = __toESM(require_jsx_runtime(), 1);
var import_react90 = __toESM(require_react(), 1);
var import_jsx_runtime119 = __toESM(require_jsx_runtime(), 1);
var import_react91 = __toESM(require_react(), 1);
var import_jsx_runtime120 = __toESM(require_jsx_runtime(), 1);
var import_jsx_runtime121 = __toESM(require_jsx_runtime(), 1);
var import_jsx_runtime122 = __toESM(require_jsx_runtime(), 1);
var import_react92 = __toESM(require_react(), 1);
var import_react93 = __toESM(require_react(), 1);
var import_jsx_runtime123 = __toESM(require_jsx_runtime(), 1);
var import_react94 = __toESM(require_react(), 1);
var import_react95 = __toESM(require_react(), 1);
var import_jsx_runtime124 = __toESM(require_jsx_runtime(), 1);
var import_jsx_runtime125 = __toESM(require_jsx_runtime(), 1);
var import_jsx_runtime126 = __toESM(require_jsx_runtime(), 1);
var import_react96 = __toESM(require_react(), 1);
var import_react97 = __toESM(require_react(), 1);
var import_jsx_runtime127 = __toESM(require_jsx_runtime(), 1);
var import_react98 = __toESM(require_react(), 1);
var import_jsx_runtime128 = __toESM(require_jsx_runtime(), 1);
var import_jsx_runtime129 = __toESM(require_jsx_runtime(), 1);
var import_react99 = __toESM(require_react(), 1);
var import_jsx_runtime130 = __toESM(require_jsx_runtime(), 1);
var import_jsx_runtime131 = __toESM(require_jsx_runtime(), 1);
var __create = Object.create;
var __defProp = Object.defineProperty;
var __getOwnPropDesc = Object.getOwnPropertyDescriptor;
var __getOwnPropNames = Object.getOwnPropertyNames;
var __getProtoOf = Object.getPrototypeOf;
var __hasOwnProp = Object.prototype.hasOwnProperty;
var __commonJS = (cb, mod) => function() {
  return mod || (0, cb[__getOwnPropNames(cb)[0]])((mod = { exports: {} }).exports, mod), mod.exports;
};
var __copyProps = (to, from, except, desc) => {
  if (from && typeof from == "object" || typeof from == "function")
    for (let key of __getOwnPropNames(from))
      !__hasOwnProp.call(to, key) && key !== except && __defProp(to, key, { get: () => from[key], enumerable: !(desc = __getOwnPropDesc(from, key)) || desc.enumerable });
  return to;
};
var __toESM2 = (mod, isNodeMode, target) => (target = mod != null ? __create(__getProtoOf(mod)) : {}, __copyProps(isNodeMode || !mod || !mod.__esModule ? __defProp(target, "default", { value: mod, enumerable: true }) : target, mod));
var require_pointer = __commonJS({ "../../node_modules/rfc6902/pointer.js"(exports) {
  "use strict";
  Object.defineProperty(exports, "__esModule", { value: true });
  exports.Pointer = void 0;
  function unescape(token) {
    return token.replace(/~1/g, "/").replace(/~0/g, "~");
  }
  function escape(token) {
    return token.replace(/~/g, "~0").replace(/\//g, "~1");
  }
  var Pointer = function() {
    function Pointer2(tokens) {
      tokens === void 0 && (tokens = [""]), this.tokens = tokens;
    }
    return Pointer2.fromJSON = function(path) {
      var tokens = path.split("/").map(unescape);
      if (tokens[0] !== "")
        throw new Error("Invalid JSON Pointer: ".concat(path));
      return new Pointer2(tokens);
    }, Pointer2.prototype.toString = function() {
      return this.tokens.map(escape).join("/");
    }, Pointer2.prototype.evaluate = function(object) {
      for (var parent = null, key = "", value = object, i = 1, l2 = this.tokens.length; i < l2; i++)
        parent = value, key = this.tokens[i], !(key == "__proto__" || key == "constructor" || key == "prototype") && (value = (parent || {})[key]);
      return { parent, key, value };
    }, Pointer2.prototype.get = function(object) {
      return this.evaluate(object).value;
    }, Pointer2.prototype.set = function(object, value) {
      var endpoint = this.evaluate(object);
      endpoint.parent && (endpoint.parent[endpoint.key] = value);
    }, Pointer2.prototype.push = function(token) {
      this.tokens.push(token);
    }, Pointer2.prototype.add = function(token) {
      var tokens = this.tokens.concat(String(token));
      return new Pointer2(tokens);
    }, Pointer2;
  }();
  exports.Pointer = Pointer;
} });
var require_util = __commonJS({ "../../node_modules/rfc6902/util.js"(exports) {
  "use strict";
  Object.defineProperty(exports, "__esModule", { value: true });
  exports.clone = exports.objectType = exports.hasOwnProperty = void 0;
  exports.hasOwnProperty = Object.prototype.hasOwnProperty;
  function objectType(object) {
    return object === void 0 ? "undefined" : object === null ? "null" : Array.isArray(object) ? "array" : typeof object;
  }
  exports.objectType = objectType;
  function isNonPrimitive(value) {
    return value != null && typeof value == "object";
  }
  function clone(source) {
    if (!isNonPrimitive(source))
      return source;
    if (source.constructor == Array) {
      for (var length_1 = source.length, arrayTarget = new Array(length_1), i = 0; i < length_1; i++)
        arrayTarget[i] = clone(source[i]);
      return arrayTarget;
    }
    if (source.constructor == Date) {
      var dateTarget = /* @__PURE__ */ new Date(+source);
      return dateTarget;
    }
    var objectTarget = {};
    for (var key in source)
      exports.hasOwnProperty.call(source, key) && (objectTarget[key] = clone(source[key]));
    return objectTarget;
  }
  exports.clone = clone;
} });
var require_diff = __commonJS({ "../../node_modules/rfc6902/diff.js"(exports) {
  "use strict";
  Object.defineProperty(exports, "__esModule", { value: true });
  exports.diffAny = exports.diffObjects = exports.diffArrays = exports.intersection = exports.subtract = exports.isDestructive = void 0;
  var util_1 = require_util();
  function isDestructive(_a) {
    var op = _a.op;
    return op === "remove" || op === "replace" || op === "copy" || op === "move";
  }
  exports.isDestructive = isDestructive;
  function subtract(minuend, subtrahend) {
    var obj = {};
    for (var add_key in minuend)
      util_1.hasOwnProperty.call(minuend, add_key) && minuend[add_key] !== void 0 && (obj[add_key] = 1);
    for (var del_key in subtrahend)
      util_1.hasOwnProperty.call(subtrahend, del_key) && subtrahend[del_key] !== void 0 && delete obj[del_key];
    return Object.keys(obj);
  }
  exports.subtract = subtract;
  function intersection(objects) {
    for (var length = objects.length, counter = {}, i = 0; i < length; i++) {
      var object = objects[i];
      for (var key in object)
        util_1.hasOwnProperty.call(object, key) && object[key] !== void 0 && (counter[key] = (counter[key] || 0) + 1);
    }
    for (var key in counter)
      counter[key] < length && delete counter[key];
    return Object.keys(counter);
  }
  exports.intersection = intersection;
  function isArrayAdd(array_operation) {
    return array_operation.op === "add";
  }
  function isArrayRemove(array_operation) {
    return array_operation.op === "remove";
  }
  function appendArrayOperation(base, operation) {
    return { operations: base.operations.concat(operation), cost: base.cost + 1 };
  }
  function diffArrays(input, output, ptr, diff2) {
    diff2 === void 0 && (diff2 = diffAny);
    var memo3 = { "0,0": { operations: [], cost: 0 } };
    function dist(i, j2) {
      var memo_key = "".concat(i, ",").concat(j2), memoized = memo3[memo_key];
      if (memoized === void 0) {
        if (i > 0 && j2 > 0 && !diff2(input[i - 1], output[j2 - 1], ptr.add(String(i - 1))).length)
          memoized = dist(i - 1, j2 - 1);
        else {
          var alternatives = [];
          if (i > 0) {
            var remove_base = dist(i - 1, j2), remove_operation = { op: "remove", index: i - 1 };
            alternatives.push(appendArrayOperation(remove_base, remove_operation));
          }
          if (j2 > 0) {
            var add_base = dist(i, j2 - 1), add_operation = { op: "add", index: i - 1, value: output[j2 - 1] };
            alternatives.push(appendArrayOperation(add_base, add_operation));
          }
          if (i > 0 && j2 > 0) {
            var replace_base = dist(i - 1, j2 - 1), replace_operation = { op: "replace", index: i - 1, original: input[i - 1], value: output[j2 - 1] };
            alternatives.push(appendArrayOperation(replace_base, replace_operation));
          }
          var best = alternatives.sort(function(a2, b2) {
            return a2.cost - b2.cost;
          })[0];
          memoized = best;
        }
        memo3[memo_key] = memoized;
      }
      return memoized;
    }
    var input_length = isNaN(input.length) || input.length <= 0 ? 0 : input.length, output_length = isNaN(output.length) || output.length <= 0 ? 0 : output.length, array_operations = dist(input_length, output_length).operations, padded_operations = array_operations.reduce(function(_a, array_operation) {
      var operations = _a[0], padding = _a[1];
      if (isArrayAdd(array_operation)) {
        var padded_index = array_operation.index + 1 + padding, index_token = padded_index < input_length + padding ? String(padded_index) : "-", operation = { op: array_operation.op, path: ptr.add(index_token).toString(), value: array_operation.value };
        return [operations.concat(operation), padding + 1];
      } else if (isArrayRemove(array_operation)) {
        var operation = { op: array_operation.op, path: ptr.add(String(array_operation.index + padding)).toString() };
        return [operations.concat(operation), padding - 1];
      } else {
        var replace_ptr = ptr.add(String(array_operation.index + padding)), replace_operations = diff2(array_operation.original, array_operation.value, replace_ptr);
        return [operations.concat.apply(operations, replace_operations), padding];
      }
    }, [[], 0])[0];
    return padded_operations;
  }
  exports.diffArrays = diffArrays;
  function diffObjects(input, output, ptr, diff2) {
    diff2 === void 0 && (diff2 = diffAny);
    var operations = [];
    return subtract(input, output).forEach(function(key) {
      operations.push({ op: "remove", path: ptr.add(key).toString() });
    }), subtract(output, input).forEach(function(key) {
      operations.push({ op: "add", path: ptr.add(key).toString(), value: output[key] });
    }), intersection([input, output]).forEach(function(key) {
      operations.push.apply(operations, diff2(input[key], output[key], ptr.add(key)));
    }), operations;
  }
  exports.diffObjects = diffObjects;
  function diffAny(input, output, ptr, diff2) {
    if (diff2 === void 0 && (diff2 = diffAny), input === output)
      return [];
    var input_type = (0, util_1.objectType)(input), output_type = (0, util_1.objectType)(output);
    return input_type == "array" && output_type == "array" ? diffArrays(input, output, ptr, diff2) : input_type == "object" && output_type == "object" ? diffObjects(input, output, ptr, diff2) : [{ op: "replace", path: ptr.toString(), value: output }];
  }
  exports.diffAny = diffAny;
} });
var require_patch = __commonJS({ "../../node_modules/rfc6902/patch.js"(exports) {
  "use strict";
  var __extends = exports && exports.__extends || /* @__PURE__ */ function() {
    var extendStatics = function(d, b2) {
      return extendStatics = Object.setPrototypeOf || { __proto__: [] } instanceof Array && function(d2, b3) {
        d2.__proto__ = b3;
      } || function(d2, b3) {
        for (var p in b3)
          Object.prototype.hasOwnProperty.call(b3, p) && (d2[p] = b3[p]);
      }, extendStatics(d, b2);
    };
    return function(d, b2) {
      if (typeof b2 != "function" && b2 !== null)
        throw new TypeError("Class extends value " + String(b2) + " is not a constructor or null");
      extendStatics(d, b2);
      function __() {
        this.constructor = d;
      }
      d.prototype = b2 === null ? Object.create(b2) : (__.prototype = b2.prototype, new __());
    };
  }();
  Object.defineProperty(exports, "__esModule", { value: true });
  exports.apply = exports.InvalidOperationError = exports.test = exports.copy = exports.move = exports.replace = exports.remove = exports.add = exports.TestError = exports.MissingError = void 0;
  var pointer_1 = require_pointer(), util_1 = require_util(), diff_1 = require_diff(), MissingError = function(_super) {
    __extends(MissingError2, _super);
    function MissingError2(path) {
      var _this = _super.call(this, "Value required at path: ".concat(path)) || this;
      return _this.path = path, _this.name = "MissingError", _this;
    }
    return MissingError2;
  }(Error);
  exports.MissingError = MissingError;
  var TestError = function(_super) {
    __extends(TestError2, _super);
    function TestError2(actual, expected) {
      var _this = _super.call(this, "Test failed: ".concat(actual, " != ").concat(expected)) || this;
      return _this.actual = actual, _this.expected = expected, _this.name = "TestError", _this;
    }
    return TestError2;
  }(Error);
  exports.TestError = TestError;
  function _add(object, key, value) {
    if (Array.isArray(object))
      if (key == "-")
        object.push(value);
      else {
        var index = parseInt(key, 10);
        object.splice(index, 0, value);
      }
    else
      object[key] = value;
  }
  function _remove(object, key) {
    if (Array.isArray(object)) {
      var index = parseInt(key, 10);
      object.splice(index, 1);
    } else
      delete object[key];
  }
  function add(object, operation) {
    var endpoint = pointer_1.Pointer.fromJSON(operation.path).evaluate(object);
    return endpoint.parent === void 0 ? new MissingError(operation.path) : (_add(endpoint.parent, endpoint.key, (0, util_1.clone)(operation.value)), null);
  }
  exports.add = add;
  function remove(object, operation) {
    var endpoint = pointer_1.Pointer.fromJSON(operation.path).evaluate(object);
    return endpoint.value === void 0 ? new MissingError(operation.path) : (_remove(endpoint.parent, endpoint.key), null);
  }
  exports.remove = remove;
  function replace(object, operation) {
    var endpoint = pointer_1.Pointer.fromJSON(operation.path).evaluate(object);
    if (endpoint.parent === null)
      return new MissingError(operation.path);
    if (Array.isArray(endpoint.parent)) {
      if (parseInt(endpoint.key, 10) >= endpoint.parent.length)
        return new MissingError(operation.path);
    } else if (endpoint.value === void 0)
      return new MissingError(operation.path);
    return endpoint.parent[endpoint.key] = (0, util_1.clone)(operation.value), null;
  }
  exports.replace = replace;
  function move(object, operation) {
    var from_endpoint = pointer_1.Pointer.fromJSON(operation.from).evaluate(object);
    if (from_endpoint.value === void 0)
      return new MissingError(operation.from);
    var endpoint = pointer_1.Pointer.fromJSON(operation.path).evaluate(object);
    return endpoint.parent === void 0 ? new MissingError(operation.path) : (_remove(from_endpoint.parent, from_endpoint.key), _add(endpoint.parent, endpoint.key, from_endpoint.value), null);
  }
  exports.move = move;
  function copy(object, operation) {
    var from_endpoint = pointer_1.Pointer.fromJSON(operation.from).evaluate(object);
    if (from_endpoint.value === void 0)
      return new MissingError(operation.from);
    var endpoint = pointer_1.Pointer.fromJSON(operation.path).evaluate(object);
    return endpoint.parent === void 0 ? new MissingError(operation.path) : (_add(endpoint.parent, endpoint.key, (0, util_1.clone)(from_endpoint.value)), null);
  }
  exports.copy = copy;
  function test(object, operation) {
    var endpoint = pointer_1.Pointer.fromJSON(operation.path).evaluate(object);
    return (0, diff_1.diffAny)(endpoint.value, operation.value, new pointer_1.Pointer()).length ? new TestError(endpoint.value, operation.value) : null;
  }
  exports.test = test;
  var InvalidOperationError = function(_super) {
    __extends(InvalidOperationError2, _super);
    function InvalidOperationError2(operation) {
      var _this = _super.call(this, "Invalid operation: ".concat(operation.op)) || this;
      return _this.operation = operation, _this.name = "InvalidOperationError", _this;
    }
    return InvalidOperationError2;
  }(Error);
  exports.InvalidOperationError = InvalidOperationError;
  function apply(object, operation) {
    switch (operation.op) {
      case "add":
        return add(object, operation);
      case "remove":
        return remove(object, operation);
      case "replace":
        return replace(object, operation);
      case "move":
        return move(object, operation);
      case "copy":
        return copy(object, operation);
      case "test":
        return test(object, operation);
    }
    return new InvalidOperationError(operation);
  }
  exports.apply = apply;
} });
var require_rfc6902 = __commonJS({ "../../node_modules/rfc6902/index.js"(exports) {
  "use strict";
  Object.defineProperty(exports, "__esModule", { value: true });
  exports.createTests = exports.createPatch = exports.applyPatch = exports.Pointer = void 0;
  var pointer_1 = require_pointer();
  Object.defineProperty(exports, "Pointer", { enumerable: true, get: function() {
    return pointer_1.Pointer;
  } });
  var patch_1 = require_patch(), diff_1 = require_diff();
  function applyPatch(object, patch) {
    return patch.map(function(operation) {
      return (0, patch_1.apply)(object, operation);
    });
  }
  exports.applyPatch = applyPatch;
  function wrapVoidableDiff(diff2) {
    function wrappedDiff(input, output, ptr) {
      var custom_patch = diff2(input, output, ptr);
      return Array.isArray(custom_patch) ? custom_patch : (0, diff_1.diffAny)(input, output, ptr, wrappedDiff);
    }
    return wrappedDiff;
  }
  function createPatch2(input, output, diff2) {
    var ptr = new pointer_1.Pointer();
    return (diff2 ? wrapVoidableDiff(diff2) : diff_1.diffAny)(input, output, ptr);
  }
  exports.createPatch = createPatch2;
  function createTest(input, path) {
    var endpoint = pointer_1.Pointer.fromJSON(path).evaluate(input);
    if (endpoint !== void 0)
      return { op: "test", path, value: endpoint.value };
  }
  function createTests(input, patch) {
    var tests = new Array();
    return patch.filter(diff_1.isDestructive).forEach(function(operation) {
      var pathTest = createTest(input, operation.path);
      if (pathTest && tests.push(pathTest), "from" in operation) {
        var fromTest = createTest(input, operation.from);
        fromTest && tests.push(fromTest);
      }
    }), tests;
  }
  exports.createTests = createTests;
} });
var R = (0, import_react12.createContext)(void 0);
function x() {
  return (0, import_react12.useContext)(R);
}
function a() {
  return x().medplum;
}
function G2() {
  return x().navigate;
}
function H() {
  return x().profile;
}
function j(e) {
  let t = e.medplum, n = e.navigate ?? I, [o, u] = (0, import_react11.useState)({ profile: t.getProfile(), loading: !t.isInitialized });
  (0, import_react11.useEffect)(() => {
    t && (t.isInitialized || (u((r2) => ({ ...r2, loading: true })), t.getInitPromise().then(() => u((r2) => ({ ...r2, loading: false }))).catch(console.error)));
  }, [t, t.isInitialized]), (0, import_react11.useEffect)(() => {
    function r2() {
      u({ ...o, profile: t.getProfile() });
    }
    return t.addEventListener("change", r2), () => t.removeEventListener("change", r2);
  }, [t, o]);
  let i = (0, import_react11.useMemo)(() => ({ ...o, medplum: t, navigate: n }), [o, t, n]);
  return (0, import_jsx_runtime.jsx)(R.Provider, { value: i, children: e.children });
}
function I(e) {
  window.location.assign(e);
}
var C2 = /* @__PURE__ */ new Map();
var re = (e) => (0, import_react13.useMemo)(() => {
  if (!e)
    return;
  let t = e.split("?")[0];
  if (!t)
    return e;
  let n;
  try {
    n = new URLSearchParams(new URL(e).search);
  } catch {
    return e;
  }
  if (!n.has("Key-Pair-Id") || !n.has("Signature"))
    return e;
  let o = n.get("Expires");
  if (!o || o.length > 13)
    return e;
  let u = C2.get(t);
  if (u) {
    let r2 = new URLSearchParams(new URL(u).search).get("Expires");
    if (r2 && parseInt(r2, 10) * 1e3 - 5e3 > Date.now())
      return u;
  }
  return C2.set(t, e), e;
}, [e]);
function ce(e, t) {
  let n = a(), [o, u] = (0, import_react14.useState)(y2(n, e)), i = (0, import_react14.useCallback)((r2) => {
    Ge(r2, o) || u(r2);
  }, [o, u]);
  return (0, import_react14.useEffect)(() => {
    i(y2(n, e));
  }, [n, e, i]), (0, import_react14.useEffect)(() => {
    let r2 = true;
    return Y(e) && n.readReference(e).then((s) => {
      r2 && i(s);
    }).catch((s) => {
      r2 && (i(void 0), t && t(Be(s)));
    }), () => r2 = false;
  }, [n, o, e, i, t]), o;
}
function y2(e, t) {
  if (t) {
    if (_(t))
      return t;
    if (Y(t))
      return e.getCachedReference(t);
  }
}
function Re(e, t) {
  return g("search", e, t);
}
function xe(e, t) {
  return g("searchOne", e, t);
}
function ge2(e, t) {
  return g("searchResources", e, t);
}
function g(e, t, n) {
  let o = a(), [u, i] = (0, import_react15.useState)(), [r2, s] = (0, import_react15.useState)(false), [d, c] = (0, import_react15.useState)(), [p, h] = (0, import_react15.useState)();
  return (0, import_react15.useEffect)(() => {
    let M = o.fhirSearchUrl(t, n).toString();
    M !== u && (i(M), o[e](t, n).then((l2) => {
      s(false), c(l2), h(na);
    }).catch((l2) => {
      s(false), c(void 0), h(Be(l2));
    }));
  }, [o, e, t, n, u]), [d, r2, p];
}
var J = 3e3;
function Ce(e, t) {
  let n = a(), [o, u] = (0, import_react16.useState)(), i = (0, import_react16.useRef)(false), r2 = (0, import_react16.useRef)(), s = (0, import_react16.useRef)(), d = (0, import_react16.useRef)();
  d.current = t, (0, import_react16.useEffect)(() => (r2.current && (clearTimeout(r2.current), r2.current = void 0), s.current !== e && u(n.subscribeToCriteria(e)), s.current = e, () => {
    r2.current = setTimeout(() => {
      u(void 0), n.unsubscribeFromCriteria(e);
    }, J);
  }), [n, e]);
  let c = (0, import_react16.useCallback)((p) => {
    var _a;
    (_a = d.current) == null ? void 0 : _a.call(d, p.payload);
  }, []);
  (0, import_react16.useEffect)(() => o ? (i.current || (o.addEventListener("message", c), i.current = true), () => {
    i.current = false, o.removeEventListener("message", c);
  }) : () => {
  }, [o, c]);
}
function AddressDisplay(props) {
  let address = props.value;
  return address ? (0, import_jsx_runtime2.jsx)(import_jsx_runtime2.Fragment, { children: Fc(address) }) : null;
}
function getLine(address, index) {
  return address.line && address.line.length > index ? address.line[index] : "";
}
function setLine(address, index, str) {
  let line = address.line || [];
  for (; line.length <= index; )
    line.push("");
  return line[index] = str, { ...address, line };
}
function AddressInput(props) {
  let [value, setValue] = (0, import_react17.useState)(props.defaultValue || {}), valueRef = (0, import_react17.useRef)();
  valueRef.current = value;
  function setValueWrapper(newValue) {
    setValue(newValue), props.onChange && props.onChange(newValue);
  }
  function setUse(use) {
    setValueWrapper({ ...valueRef.current, use });
  }
  function setType(type) {
    setValueWrapper({ ...valueRef.current, type });
  }
  function setLine1(line1) {
    setValueWrapper(setLine(valueRef.current || {}, 0, line1));
  }
  function setLine2(line2) {
    setValueWrapper(setLine(valueRef.current || {}, 1, line2));
  }
  function setCity(city) {
    setValueWrapper({ ...valueRef.current, city });
  }
  function setState(state) {
    setValueWrapper({ ...valueRef.current, state });
  }
  function setPostalCode(postalCode) {
    setValueWrapper({ ...valueRef.current, postalCode });
  }
  return (0, import_jsx_runtime3.jsxs)(Group, { gap: "xs", wrap: "nowrap", grow: true, children: [(0, import_jsx_runtime3.jsx)(NativeSelect, { "data-testid": "address-use", defaultValue: value.use, onChange: (e) => setUse(e.currentTarget.value), data: ["", "home", "work", "temp", "old", "billing"] }), (0, import_jsx_runtime3.jsx)(NativeSelect, { "data-testid": "address-type", defaultValue: value.type, onChange: (e) => setType(e.currentTarget.value), data: ["", "postal", "physical", "both"] }), (0, import_jsx_runtime3.jsx)(TextInput, { placeholder: "Line 1", defaultValue: getLine(value, 0), onChange: (e) => setLine1(e.currentTarget.value) }), (0, import_jsx_runtime3.jsx)(TextInput, { placeholder: "Line 2", defaultValue: getLine(value, 1), onChange: (e) => setLine2(e.currentTarget.value) }), (0, import_jsx_runtime3.jsx)(TextInput, { placeholder: "City", defaultValue: value.city, onChange: (e) => setCity(e.currentTarget.value) }), (0, import_jsx_runtime3.jsx)(TextInput, { placeholder: "State", defaultValue: value.state, onChange: (e) => setState(e.currentTarget.value) }), (0, import_jsx_runtime3.jsx)(TextInput, { placeholder: "Postal Code", defaultValue: value.postalCode, onChange: (e) => setPostalCode(e.currentTarget.value) })] });
}
function AnnotationInput(props) {
  let author = H(), [value, setValue] = (0, import_react18.useState)(props.defaultValue || {});
  function setText(text) {
    let newValue = text ? { text, authorReference: author && Z(author), time: (/* @__PURE__ */ new Date()).toISOString() } : {};
    setValue(newValue), props.onChange && props.onChange(newValue);
  }
  return (0, import_jsx_runtime4.jsx)(TextInput, { name: props.name, placeholder: "Annotation text", defaultValue: value.text, onChange: (e) => setText(e.currentTarget.value) });
}
var defaultAttributes = { xmlns: "http://www.w3.org/2000/svg", width: 24, height: 24, viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: 2, strokeLinecap: "round", strokeLinejoin: "round" };
var __defProp2 = Object.defineProperty;
var __defProps = Object.defineProperties;
var __getOwnPropDescs = Object.getOwnPropertyDescriptors;
var __getOwnPropSymbols = Object.getOwnPropertySymbols;
var __hasOwnProp2 = Object.prototype.hasOwnProperty;
var __propIsEnum = Object.prototype.propertyIsEnumerable;
var __defNormalProp = (obj, key, value) => key in obj ? __defProp2(obj, key, { enumerable: true, configurable: true, writable: true, value }) : obj[key] = value;
var __spreadValues = (a2, b2) => {
  for (var prop in b2 || (b2 = {}))
    __hasOwnProp2.call(b2, prop) && __defNormalProp(a2, prop, b2[prop]);
  if (__getOwnPropSymbols)
    for (var prop of __getOwnPropSymbols(b2))
      __propIsEnum.call(b2, prop) && __defNormalProp(a2, prop, b2[prop]);
  return a2;
};
var __spreadProps = (a2, b2) => __defProps(a2, __getOwnPropDescs(b2));
var __objRest = (source, exclude) => {
  var target = {};
  for (var prop in source)
    __hasOwnProp2.call(source, prop) && exclude.indexOf(prop) < 0 && (target[prop] = source[prop]);
  if (source != null && __getOwnPropSymbols)
    for (var prop of __getOwnPropSymbols(source))
      exclude.indexOf(prop) < 0 && __propIsEnum.call(source, prop) && (target[prop] = source[prop]);
  return target;
};
var createReactComponent = (iconName, iconNamePascal, iconNode) => {
  let Component2 = (0, import_react20.forwardRef)((_a, ref) => {
    var _b = _a, { color = "currentColor", size = 24, stroke = 2, children: children2 } = _b, rest = __objRest(_b, ["color", "size", "stroke", "children"]);
    return (0, import_react20.createElement)("svg", __spreadValues(__spreadProps(__spreadValues({ ref }, defaultAttributes), { width: size, height: size, stroke: color, strokeWidth: stroke, className: `tabler-icon tabler-icon-${iconName}` }), rest), [...iconNode.map(([tag, attrs]) => (0, import_react20.createElement)(tag, attrs)), ...children2 || []]);
  });
  return Component2.propTypes = { color: import_prop_types7.default.string, size: import_prop_types7.default.oneOfType([import_prop_types7.default.string, import_prop_types7.default.number]), stroke: import_prop_types7.default.oneOfType([import_prop_types7.default.string, import_prop_types7.default.number]) }, Component2.displayName = `${iconNamePascal}`, Component2;
};
var IconAdjustmentsHorizontal = createReactComponent("adjustments-horizontal", "IconAdjustmentsHorizontal", [["path", { d: "M14 6m-2 0a2 2 0 1 0 4 0a2 2 0 1 0 -4 0", key: "svg-0" }], ["path", { d: "M4 6l8 0", key: "svg-1" }], ["path", { d: "M16 6l4 0", key: "svg-2" }], ["path", { d: "M8 12m-2 0a2 2 0 1 0 4 0a2 2 0 1 0 -4 0", key: "svg-3" }], ["path", { d: "M4 12l2 0", key: "svg-4" }], ["path", { d: "M10 12l10 0", key: "svg-5" }], ["path", { d: "M17 18m-2 0a2 2 0 1 0 4 0a2 2 0 1 0 -4 0", key: "svg-6" }], ["path", { d: "M4 18l11 0", key: "svg-7" }], ["path", { d: "M19 18l1 0", key: "svg-8" }]]);
var IconAlertCircle = createReactComponent("alert-circle", "IconAlertCircle", [["path", { d: "M3 12a9 9 0 1 0 18 0a9 9 0 0 0 -18 0", key: "svg-0" }], ["path", { d: "M12 8v4", key: "svg-1" }], ["path", { d: "M12 16h.01", key: "svg-2" }]]);
var IconArrowDown = createReactComponent("arrow-down", "IconArrowDown", [["path", { d: "M12 5l0 14", key: "svg-0" }], ["path", { d: "M18 13l-6 6", key: "svg-1" }], ["path", { d: "M6 13l6 6", key: "svg-2" }]]);
var IconArrowUp = createReactComponent("arrow-up", "IconArrowUp", [["path", { d: "M12 5l0 14", key: "svg-0" }], ["path", { d: "M18 11l-6 -6", key: "svg-1" }], ["path", { d: "M6 11l6 -6", key: "svg-2" }]]);
var IconBleachOff = createReactComponent("bleach-off", "IconBleachOff", [["path", { d: "M5 19h14m1.986 -1.977a2 2 0 0 0 -.146 -.773l-7.1 -12.25a2 2 0 0 0 -3.5 0l-.815 1.405m-1.488 2.568l-4.797 8.277a2 2 0 0 0 1.75 2.75", key: "svg-0" }], ["path", { d: "M3 3l18 18", key: "svg-1" }]]);
var IconBleach = createReactComponent("bleach", "IconBleach", [["path", { d: "M5 19h14a2 2 0 0 0 1.84 -2.75l-7.1 -12.25a2 2 0 0 0 -3.5 0l-7.1 12.25a2 2 0 0 0 1.75 2.75", key: "svg-0" }]]);
var IconBoxMultiple = createReactComponent("box-multiple", "IconBoxMultiple", [["path", { d: "M7 3m0 2a2 2 0 0 1 2 -2h10a2 2 0 0 1 2 2v10a2 2 0 0 1 -2 2h-10a2 2 0 0 1 -2 -2z", key: "svg-0" }], ["path", { d: "M17 17v2a2 2 0 0 1 -2 2h-10a2 2 0 0 1 -2 -2v-10a2 2 0 0 1 2 -2h2", key: "svg-1" }]]);
var IconBracketsContain = createReactComponent("brackets-contain", "IconBracketsContain", [["path", { d: "M7 4h-4v16h4", key: "svg-0" }], ["path", { d: "M17 4h4v16h-4", key: "svg-1" }], ["path", { d: "M8 16h.01", key: "svg-2" }], ["path", { d: "M12 16h.01", key: "svg-3" }], ["path", { d: "M16 16h.01", key: "svg-4" }]]);
var IconBucketOff = createReactComponent("bucket-off", "IconBucketOff", [["path", { d: "M5.029 5.036c-.655 .58 -1.029 1.25 -1.029 1.964c0 2.033 3.033 3.712 6.96 3.967m3.788 -.21c3.064 -.559 5.252 -2.029 5.252 -3.757c0 -2.21 -3.582 -4 -8 -4c-1.605 0 -3.1 .236 -4.352 .643", key: "svg-0" }], ["path", { d: "M4 7c0 .664 .088 1.324 .263 1.965l2.737 10.035c.5 1.5 2.239 2 5 2s4.5 -.5 5 -2c.1 -.3 .252 -.812 .457 -1.535m.862 -3.146c.262 -.975 .735 -2.76 1.418 -5.354a7.45 7.45 0 0 0 .263 -1.965", key: "svg-1" }], ["path", { d: "M3 3l18 18", key: "svg-2" }]]);
var IconBucket = createReactComponent("bucket", "IconBucket", [["path", { d: "M12 7m-8 0a8 4 0 1 0 16 0a8 4 0 1 0 -16 0", key: "svg-0" }], ["path", { d: "M4 7c0 .664 .088 1.324 .263 1.965l2.737 10.035c.5 1.5 2.239 2 5 2s4.5 -.5 5 -2c.333 -1 1.246 -4.345 2.737 -10.035a7.45 7.45 0 0 0 .263 -1.965", key: "svg-1" }]]);
var IconCalendar = createReactComponent("calendar", "IconCalendar", [["path", { d: "M4 7a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v12a2 2 0 0 1 -2 2h-12a2 2 0 0 1 -2 -2v-12z", key: "svg-0" }], ["path", { d: "M16 3v4", key: "svg-1" }], ["path", { d: "M8 3v4", key: "svg-2" }], ["path", { d: "M4 11h16", key: "svg-3" }], ["path", { d: "M11 15h1", key: "svg-4" }], ["path", { d: "M12 15v3", key: "svg-5" }]]);
var IconCheck = createReactComponent("check", "IconCheck", [["path", { d: "M5 12l5 5l10 -10", key: "svg-0" }]]);
var IconCheckbox = createReactComponent("checkbox", "IconCheckbox", [["path", { d: "M9 11l3 3l8 -8", key: "svg-0" }], ["path", { d: "M20 12v6a2 2 0 0 1 -2 2h-12a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h9", key: "svg-1" }]]);
var IconChevronDown = createReactComponent("chevron-down", "IconChevronDown", [["path", { d: "M6 9l6 6l6 -6", key: "svg-0" }]]);
var IconCircleMinus = createReactComponent("circle-minus", "IconCircleMinus", [["path", { d: "M12 12m-9 0a9 9 0 1 0 18 0a9 9 0 1 0 -18 0", key: "svg-0" }], ["path", { d: "M9 12l6 0", key: "svg-1" }]]);
var IconCirclePlus = createReactComponent("circle-plus", "IconCirclePlus", [["path", { d: "M3 12a9 9 0 1 0 18 0a9 9 0 0 0 -18 0", key: "svg-0" }], ["path", { d: "M9 12h6", key: "svg-1" }], ["path", { d: "M12 9v6", key: "svg-2" }]]);
var IconCloudUpload = createReactComponent("cloud-upload", "IconCloudUpload", [["path", { d: "M7 18a4.6 4.4 0 0 1 0 -9a5 4.5 0 0 1 11 2h1a3.5 3.5 0 0 1 0 7h-1", key: "svg-0" }], ["path", { d: "M9 15l3 -3l3 3", key: "svg-1" }], ["path", { d: "M12 12l0 9", key: "svg-2" }]]);
var IconColumns = createReactComponent("columns", "IconColumns", [["path", { d: "M4 6l5.5 0", key: "svg-0" }], ["path", { d: "M4 10l5.5 0", key: "svg-1" }], ["path", { d: "M4 14l5.5 0", key: "svg-2" }], ["path", { d: "M4 18l5.5 0", key: "svg-3" }], ["path", { d: "M14.5 6l5.5 0", key: "svg-4" }], ["path", { d: "M14.5 10l5.5 0", key: "svg-5" }], ["path", { d: "M14.5 14l5.5 0", key: "svg-6" }], ["path", { d: "M14.5 18l5.5 0", key: "svg-7" }]]);
var IconCopy = createReactComponent("copy", "IconCopy", [["path", { d: "M7 7m0 2.667a2.667 2.667 0 0 1 2.667 -2.667h8.666a2.667 2.667 0 0 1 2.667 2.667v8.666a2.667 2.667 0 0 1 -2.667 2.667h-8.666a2.667 2.667 0 0 1 -2.667 -2.667z", key: "svg-0" }], ["path", { d: "M4.012 16.737a2.005 2.005 0 0 1 -1.012 -1.737v-10c0 -1.1 .9 -2 2 -2h10c.75 0 1.158 .385 1.5 1", key: "svg-1" }]]);
var IconCurrencyDollar = createReactComponent("currency-dollar", "IconCurrencyDollar", [["path", { d: "M16.7 8a3 3 0 0 0 -2.7 -2h-4a3 3 0 0 0 0 6h4a3 3 0 0 1 0 6h-4a3 3 0 0 1 -2.7 -2", key: "svg-0" }], ["path", { d: "M12 3v3m0 12v3", key: "svg-1" }]]);
var IconDots = createReactComponent("dots", "IconDots", [["path", { d: "M5 12m-1 0a1 1 0 1 0 2 0a1 1 0 1 0 -2 0", key: "svg-0" }], ["path", { d: "M12 12m-1 0a1 1 0 1 0 2 0a1 1 0 1 0 -2 0", key: "svg-1" }], ["path", { d: "M19 12m-1 0a1 1 0 1 0 2 0a1 1 0 1 0 -2 0", key: "svg-2" }]]);
var IconEdit = createReactComponent("edit", "IconEdit", [["path", { d: "M7 7h-1a2 2 0 0 0 -2 2v9a2 2 0 0 0 2 2h9a2 2 0 0 0 2 -2v-1", key: "svg-0" }], ["path", { d: "M20.385 6.585a2.1 2.1 0 0 0 -2.97 -2.97l-8.415 8.385v3h3l8.385 -8.415z", key: "svg-1" }], ["path", { d: "M16 5l3 3", key: "svg-2" }]]);
var IconEqualNot = createReactComponent("equal-not", "IconEqualNot", [["path", { d: "M5 10h14", key: "svg-0" }], ["path", { d: "M5 14h14", key: "svg-1" }], ["path", { d: "M5 19l14 -14", key: "svg-2" }]]);
var IconEqual = createReactComponent("equal", "IconEqual", [["path", { d: "M5 10h14", key: "svg-0" }], ["path", { d: "M5 14h14", key: "svg-1" }]]);
var IconFileAlert = createReactComponent("file-alert", "IconFileAlert", [["path", { d: "M14 3v4a1 1 0 0 0 1 1h4", key: "svg-0" }], ["path", { d: "M17 21h-10a2 2 0 0 1 -2 -2v-14a2 2 0 0 1 2 -2h7l5 5v11a2 2 0 0 1 -2 2z", key: "svg-1" }], ["path", { d: "M12 17l.01 0", key: "svg-2" }], ["path", { d: "M12 11l0 3", key: "svg-3" }]]);
var IconFilePlus = createReactComponent("file-plus", "IconFilePlus", [["path", { d: "M14 3v4a1 1 0 0 0 1 1h4", key: "svg-0" }], ["path", { d: "M17 21h-10a2 2 0 0 1 -2 -2v-14a2 2 0 0 1 2 -2h7l5 5v11a2 2 0 0 1 -2 2z", key: "svg-1" }], ["path", { d: "M12 11l0 6", key: "svg-2" }], ["path", { d: "M9 14l6 0", key: "svg-3" }]]);
var IconFilter = createReactComponent("filter", "IconFilter", [["path", { d: "M4 4h16v2.172a2 2 0 0 1 -.586 1.414l-4.414 4.414v7l-6 2v-8.5l-4.48 -4.928a2 2 0 0 1 -.52 -1.345v-2.227z", key: "svg-0" }]]);
var IconGenderFemale = createReactComponent("gender-female", "IconGenderFemale", [["path", { d: "M12 9m-5 0a5 5 0 1 0 10 0a5 5 0 1 0 -10 0", key: "svg-0" }], ["path", { d: "M12 14v7", key: "svg-1" }], ["path", { d: "M9 18h6", key: "svg-2" }]]);
var IconListDetails = createReactComponent("list-details", "IconListDetails", [["path", { d: "M13 5h8", key: "svg-0" }], ["path", { d: "M13 9h5", key: "svg-1" }], ["path", { d: "M13 15h8", key: "svg-2" }], ["path", { d: "M13 19h5", key: "svg-3" }], ["path", { d: "M3 4m0 1a1 1 0 0 1 1 -1h4a1 1 0 0 1 1 1v4a1 1 0 0 1 -1 1h-4a1 1 0 0 1 -1 -1z", key: "svg-4" }], ["path", { d: "M3 14m0 1a1 1 0 0 1 1 -1h4a1 1 0 0 1 1 1v4a1 1 0 0 1 -1 1h-4a1 1 0 0 1 -1 -1z", key: "svg-5" }]]);
var IconLogout = createReactComponent("logout", "IconLogout", [["path", { d: "M14 8v-2a2 2 0 0 0 -2 -2h-7a2 2 0 0 0 -2 2v12a2 2 0 0 0 2 2h7a2 2 0 0 0 2 -2v-2", key: "svg-0" }], ["path", { d: "M9 12h12l-3 -3", key: "svg-1" }], ["path", { d: "M18 15l3 -3", key: "svg-2" }]]);
var IconMathGreater = createReactComponent("math-greater", "IconMathGreater", [["path", { d: "M5 18l14 -6l-14 -6", key: "svg-0" }]]);
var IconMathLower = createReactComponent("math-lower", "IconMathLower", [["path", { d: "M19 18l-14 -6l14 -6", key: "svg-0" }]]);
var IconMessage = createReactComponent("message", "IconMessage", [["path", { d: "M8 9h8", key: "svg-0" }], ["path", { d: "M8 13h6", key: "svg-1" }], ["path", { d: "M18 4a3 3 0 0 1 3 3v8a3 3 0 0 1 -3 3h-5l-5 3v-3h-2a3 3 0 0 1 -3 -3v-8a3 3 0 0 1 3 -3h12z", key: "svg-2" }]]);
var IconPin = createReactComponent("pin", "IconPin", [["path", { d: "M15 4.5l-4 4l-4 1.5l-1.5 1.5l7 7l1.5 -1.5l1.5 -4l4 -4", key: "svg-0" }], ["path", { d: "M9 15l-4.5 4.5", key: "svg-1" }], ["path", { d: "M14.5 4l5.5 5.5", key: "svg-2" }]]);
var IconPinnedOff = createReactComponent("pinned-off", "IconPinnedOff", [["path", { d: "M3 3l18 18", key: "svg-0" }], ["path", { d: "M15 4.5l-3.249 3.249m-2.57 1.433l-2.181 .818l-1.5 1.5l7 7l1.5 -1.5l.82 -2.186m1.43 -2.563l3.25 -3.251", key: "svg-1" }], ["path", { d: "M9 15l-4.5 4.5", key: "svg-2" }], ["path", { d: "M14.5 4l5.5 5.5", key: "svg-3" }]]);
var IconPlus = createReactComponent("plus", "IconPlus", [["path", { d: "M12 5l0 14", key: "svg-0" }], ["path", { d: "M5 12l14 0", key: "svg-1" }]]);
var IconRefresh = createReactComponent("refresh", "IconRefresh", [["path", { d: "M20 11a8.1 8.1 0 0 0 -15.5 -2m-.5 -4v4h4", key: "svg-0" }], ["path", { d: "M4 13a8.1 8.1 0 0 0 15.5 2m.5 4v-4h-4", key: "svg-1" }]]);
var IconSearch = createReactComponent("search", "IconSearch", [["path", { d: "M10 10m-7 0a7 7 0 1 0 14 0a7 7 0 1 0 -14 0", key: "svg-0" }], ["path", { d: "M21 21l-6 -6", key: "svg-1" }]]);
var IconSettings = createReactComponent("settings", "IconSettings", [["path", { d: "M10.325 4.317c.426 -1.756 2.924 -1.756 3.35 0a1.724 1.724 0 0 0 2.573 1.066c1.543 -.94 3.31 .826 2.37 2.37a1.724 1.724 0 0 0 1.065 2.572c1.756 .426 1.756 2.924 0 3.35a1.724 1.724 0 0 0 -1.066 2.573c.94 1.543 -.826 3.31 -2.37 2.37a1.724 1.724 0 0 0 -2.572 1.065c-.426 1.756 -2.924 1.756 -3.35 0a1.724 1.724 0 0 0 -2.573 -1.066c-1.543 .94 -3.31 -.826 -2.37 -2.37a1.724 1.724 0 0 0 -1.065 -2.572c-1.756 -.426 -1.756 -2.924 0 -3.35a1.724 1.724 0 0 0 1.066 -2.573c-.94 -1.543 .826 -3.31 2.37 -2.37c1 .608 2.296 .07 2.572 -1.065z", key: "svg-0" }], ["path", { d: "M9 12a3 3 0 1 0 6 0a3 3 0 0 0 -6 0", key: "svg-1" }]]);
var IconSortAscending = createReactComponent("sort-ascending", "IconSortAscending", [["path", { d: "M4 6l7 0", key: "svg-0" }], ["path", { d: "M4 12l7 0", key: "svg-1" }], ["path", { d: "M4 18l9 0", key: "svg-2" }], ["path", { d: "M15 9l3 -3l3 3", key: "svg-3" }], ["path", { d: "M18 6l0 12", key: "svg-4" }]]);
var IconSortDescending = createReactComponent("sort-descending", "IconSortDescending", [["path", { d: "M4 6l9 0", key: "svg-0" }], ["path", { d: "M4 12l7 0", key: "svg-1" }], ["path", { d: "M4 18l7 0", key: "svg-2" }], ["path", { d: "M15 15l3 3l3 -3", key: "svg-3" }], ["path", { d: "M18 6l0 12", key: "svg-4" }]]);
var IconSquare = createReactComponent("square", "IconSquare", [["path", { d: "M3 3m0 2a2 2 0 0 1 2 -2h14a2 2 0 0 1 2 2v14a2 2 0 0 1 -2 2h-14a2 2 0 0 1 -2 -2z", key: "svg-0" }]]);
var IconStethoscope = createReactComponent("stethoscope", "IconStethoscope", [["path", { d: "M6 4h-1a2 2 0 0 0 -2 2v3.5h0a5.5 5.5 0 0 0 11 0v-3.5a2 2 0 0 0 -2 -2h-1", key: "svg-0" }], ["path", { d: "M8 15a6 6 0 1 0 12 0v-3", key: "svg-1" }], ["path", { d: "M11 3v2", key: "svg-2" }], ["path", { d: "M6 3v2", key: "svg-3" }], ["path", { d: "M20 10m-2 0a2 2 0 1 0 4 0a2 2 0 1 0 -4 0", key: "svg-4" }]]);
var IconSwitchHorizontal = createReactComponent("switch-horizontal", "IconSwitchHorizontal", [["path", { d: "M16 3l4 4l-4 4", key: "svg-0" }], ["path", { d: "M10 7l10 0", key: "svg-1" }], ["path", { d: "M8 13l-4 4l4 4", key: "svg-2" }], ["path", { d: "M4 17l9 0", key: "svg-3" }]]);
var IconTableExport = createReactComponent("table-export", "IconTableExport", [["path", { d: "M12.5 21h-7.5a2 2 0 0 1 -2 -2v-14a2 2 0 0 1 2 -2h14a2 2 0 0 1 2 2v7.5", key: "svg-0" }], ["path", { d: "M3 10h18", key: "svg-1" }], ["path", { d: "M10 3v18", key: "svg-2" }], ["path", { d: "M16 19h6", key: "svg-3" }], ["path", { d: "M19 16l3 3l-3 3", key: "svg-4" }]]);
var IconTrash = createReactComponent("trash", "IconTrash", [["path", { d: "M4 7l16 0", key: "svg-0" }], ["path", { d: "M10 11l0 6", key: "svg-1" }], ["path", { d: "M14 11l0 6", key: "svg-2" }], ["path", { d: "M5 7l1 12a2 2 0 0 0 2 2h8a2 2 0 0 0 2 -2l1 -12", key: "svg-3" }], ["path", { d: "M9 7v-3a1 1 0 0 1 1 -1h4a1 1 0 0 1 1 1v3", key: "svg-4" }]]);
var IconUserSquare = createReactComponent("user-square", "IconUserSquare", [["path", { d: "M9 10a3 3 0 1 0 6 0a3 3 0 0 0 -6 0", key: "svg-0" }], ["path", { d: "M6 21v-1a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v1", key: "svg-1" }], ["path", { d: "M3 5a2 2 0 0 1 2 -2h14a2 2 0 0 1 2 2v14a2 2 0 0 1 -2 2h-14a2 2 0 0 1 -2 -2v-14z", key: "svg-2" }]]);
var IconX = createReactComponent("x", "IconX", [["path", { d: "M18 6l-12 12", key: "svg-0" }], ["path", { d: "M6 6l12 12", key: "svg-1" }]]);
var ErrorBoundary = class extends import_react21.Component {
  constructor(props) {
    super(props), this.state = { lastLocation: window.location.toString() };
  }
  static getDerivedStateFromError(error) {
    return { error, lastLocation: window.location.toString() };
  }
  componentDidUpdate(_prevProps, _prevState) {
    window.location.toString() !== this.state.lastLocation && this.setState({ lastLocation: window.location.toString(), error: void 0 });
  }
  shouldComponentUpdate(nextProps, nextState) {
    return !!(this.props.children !== nextProps.children || nextState.error && !this.state.error || this.state.lastLocation !== window.location.toString());
  }
  componentDidCatch(error, errorInfo) {
    console.error("Uncaught error:", error, errorInfo);
  }
  render() {
    return this.state.error ? (0, import_jsx_runtime5.jsx)(Alert, { icon: (0, import_jsx_runtime5.jsx)(IconAlertCircle, { size: 16 }), title: "Something went wrong", color: "red", children: di(this.state.error) }) : this.props.children;
  }
};
function Loading() {
  return (0, import_jsx_runtime6.jsx)(Center, { style: { width: "100%", height: "100vh" }, children: (0, import_jsx_runtime6.jsx)(Loader, {}) });
}
var AppShell_default = { main: "AppShell_main" };
function r(e) {
  var t, f2, n = "";
  if (typeof e == "string" || typeof e == "number")
    n += e;
  else if (typeof e == "object")
    if (Array.isArray(e))
      for (t = 0; t < e.length; t++)
        e[t] && (f2 = r(e[t])) && (n && (n += " "), n += f2);
    else
      for (t in e)
        e[t] && (n && (n += " "), n += t);
  return n;
}
function clsx() {
  for (var e, t, f2 = 0, n = ""; f2 < arguments.length; )
    (e = arguments[f2++]) && (t = r(e)) && (n && (n += " "), n += t);
  return n;
}
var clsx_m_default = clsx;
function killEvent(e) {
  e.preventDefault(), e.stopPropagation();
}
function isCheckboxCell(el) {
  if (isCheckboxElement(el))
    return true;
  if (el instanceof HTMLTableCellElement) {
    let children2 = el.children;
    if (children2.length === 1 && isCheckboxElement(children2[0]))
      return true;
  }
  return false;
}
function isCheckboxElement(el) {
  return el instanceof HTMLInputElement && el.type === "checkbox";
}
function MedplumLink(props) {
  let navigate = G2(), { to, suffix, label, onClick, children: children2, ...rest } = props, href = getHref(to);
  return suffix && (href += "/" + suffix), (0, import_jsx_runtime7.jsx)(Anchor, { href, "aria-label": label, onClick: (e) => {
    killEvent(e), onClick ? onClick(e) : to && navigate(href);
  }, ...rest, children: children2 });
}
function getHref(to) {
  if (to) {
    if (typeof to == "string")
      return getStringHref(to);
    if (_(to))
      return getResourceHref(to);
    if (Y(to))
      return getReferenceHref(to);
  }
  return "#";
}
function getStringHref(to) {
  return to.startsWith("http://") || to.startsWith("https://") || to.startsWith("/") ? to : "/" + to;
}
function getResourceHref(to) {
  return `/${to.resourceType}/${to.id}`;
}
function getReferenceHref(to) {
  return `/${to.reference}`;
}
function getInitials(input) {
  let words = input.split(" ").filter(Boolean);
  return words.length > 1 ? words[0][0] + words[words.length - 1][0] : words.length === 1 ? words[0][0] : "";
}
function ResourceAvatar(props) {
  let resource = ce(props.value), text = resource ? Oi(resource) : props.alt ?? "", initials = getInitials(text), uncachedImageUrl = (resource && hc(resource)) ?? props.src, imageUrl = re(uncachedImageUrl ?? void 0), radius = props.radius ?? "xl", avatarProps = { ...props };
  return delete avatarProps.value, delete avatarProps.link, props.link ? (0, import_jsx_runtime8.jsx)(MedplumLink, { to: resource, children: (0, import_jsx_runtime8.jsx)(Avatar, { src: imageUrl, alt: text, radius, ...avatarProps, children: initials }) }) : (0, import_jsx_runtime8.jsx)(Avatar, { src: imageUrl, alt: text, radius, ...avatarProps, children: initials });
}
var Header_default = { logoButton: "Header_logoButton", user: "Header_user", userName: "Header_userName", userActive: "Header_userActive" };
function HumanNameDisplay(props) {
  let name = props.value;
  return name ? (0, import_jsx_runtime9.jsx)(import_jsx_runtime9.Fragment, { children: Ze(name, props.options) }) : null;
}
function HeaderDropdown(props) {
  var _a, _b, _c;
  let context = x(), { medplum, profile, navigate } = context, logins = medplum.getLogins(), { colorScheme, setColorScheme } = useMantineColorScheme();
  return (0, import_jsx_runtime10.jsxs)(import_jsx_runtime10.Fragment, { children: [(0, import_jsx_runtime10.jsxs)(Stack, { align: "center", p: "xl", children: [(0, import_jsx_runtime10.jsx)(ResourceAvatar, { size: "xl", radius: 100, value: context.profile }), (0, import_jsx_runtime10.jsx)(HumanNameDisplay, { value: (_b = (_a = context.profile) == null ? void 0 : _a.name) == null ? void 0 : _b[0] }), (0, import_jsx_runtime10.jsx)(Text, { c: "dimmed", size: "xs", children: (_c = medplum.getActiveLogin()) == null ? void 0 : _c.project.display })] }), logins.length > 1 && (0, import_jsx_runtime10.jsx)(Menu.Divider, {}), logins.map((login) => login.profile.reference !== X(context.profile) && (0, import_jsx_runtime10.jsx)(Menu.Item, { onClick: () => {
    medplum.setActiveLogin(login).then(() => window.location.reload()).catch(console.log);
  }, children: (0, import_jsx_runtime10.jsxs)(Group, { children: [(0, import_jsx_runtime10.jsx)(Avatar, { radius: "xl" }), (0, import_jsx_runtime10.jsxs)("div", { style: { flex: 1 }, children: [(0, import_jsx_runtime10.jsx)(Text, { size: "sm", fw: 500, children: login.profile.display }), (0, import_jsx_runtime10.jsx)(Text, { c: "dimmed", size: "xs", children: login.project.display })] })] }) }, login.profile.reference)), (0, import_jsx_runtime10.jsx)(Menu.Divider, {}), (0, import_jsx_runtime10.jsx)(Group, { justify: "center", children: (0, import_jsx_runtime10.jsx)(SegmentedControl, { size: "xs", value: colorScheme, onChange: (newValue) => setColorScheme(newValue), data: [{ label: "Light", value: "light" }, { label: "Dark", value: "dark" }, { label: "Auto", value: "auto" }] }) }), (0, import_jsx_runtime10.jsx)(Menu.Divider, {}), (0, import_jsx_runtime10.jsx)(Menu.Item, { leftSection: (0, import_jsx_runtime10.jsx)(IconSwitchHorizontal, { size: 14, stroke: 1.5 }), onClick: () => navigate("/signin"), children: "Add another account" }), (0, import_jsx_runtime10.jsx)(Menu.Item, { leftSection: (0, import_jsx_runtime10.jsx)(IconSettings, { size: 14, stroke: 1.5 }), onClick: () => navigate(`/${X(profile)}`), children: "Account settings" }), (0, import_jsx_runtime10.jsx)(Menu.Item, { leftSection: (0, import_jsx_runtime10.jsx)(IconLogout, { size: 14, stroke: 1.5 }), onClick: async () => {
    await medplum.signOut(), navigate("/signin");
  }, children: "Sign out" }), (0, import_jsx_runtime10.jsx)(Text, { size: "xs", c: "dimmed", ta: "center", children: props.version })] });
}
function AsyncAutocomplete(props) {
  let combobox = useCombobox({ onDropdownClose: () => combobox.resetSelectedOption(), onDropdownOpen: () => combobox.updateSelectedOptionIndex("active") }), { name, label, description, error, defaultValue: defaultValue2, toOption: toOption4, loadOptions, itemComponent, onChange, onCreate, creatable, clearable, required, placeholder, leftSection, maxValues, ...rest } = props, defaultItems = toDefaultItems(defaultValue2), [search, setSearch] = (0, import_react24.useState)(""), [timer, setTimer] = (0, import_react24.useState)(), [abortController, setAbortController] = (0, import_react24.useState)(), [autoSubmit, setAutoSubmit] = (0, import_react24.useState)(), [selected, setSelected] = (0, import_react24.useState)(defaultItems.map(toOption4)), [options, setOptions] = (0, import_react24.useState)([]), ItemComponent4 = itemComponent ?? DefaultItemComponent, searchRef = (0, import_react24.useRef)();
  searchRef.current = search;
  let lastLoadOptionsRef = (0, import_react24.useRef)(), lastValueRef = (0, import_react24.useRef)(), timerRef = (0, import_react24.useRef)();
  timerRef.current = timer;
  let abortControllerRef = (0, import_react24.useRef)();
  abortControllerRef.current = abortController;
  let autoSubmitRef = (0, import_react24.useRef)();
  autoSubmitRef.current = autoSubmit;
  let optionsRef = (0, import_react24.useRef)();
  optionsRef.current = options;
  let handleTimer = (0, import_react24.useCallback)(() => {
    if (setTimer(void 0), searchRef.current === lastValueRef.current && loadOptions === lastLoadOptionsRef.current)
      return;
    lastValueRef.current = searchRef.current, lastLoadOptionsRef.current = loadOptions;
    let newAbortController = new AbortController();
    setAbortController(newAbortController), loadOptions(searchRef.current ?? "", newAbortController.signal).then((newValues) => {
      newAbortController.signal.aborted || (setOptions(newValues.map(toOption4)), setAbortController(void 0), autoSubmitRef.current ? (newValues.length > 0 && onChange(newValues.slice(0, 1)), setAutoSubmit(false)) : newValues.length > 0 && combobox.openDropdown());
    }).catch((err) => {
      newAbortController.signal.aborted || err.message.includes("aborted") || showNotification({ color: "red", message: di(err) });
    });
  }, [combobox, loadOptions, onChange, toOption4]), handleSearchChange = (0, import_react24.useCallback)((e) => {
    options && options.length > 0 && combobox.openDropdown(), combobox.updateSelectedOptionIndex(), setSearch(e.currentTarget.value), abortControllerRef.current && (abortControllerRef.current.abort(), setAbortController(void 0)), timerRef.current !== void 0 && window.clearTimeout(timerRef.current);
    let newTimer = window.setTimeout(() => handleTimer(), 100);
    setTimer(newTimer);
  }, [combobox, options, handleTimer]), addSelected = (0, import_react24.useCallback)((newValue) => {
    let result = [], newSelected = [...selected], option = options == null ? void 0 : options.find((option2) => option2.value === newValue), item = option == null ? void 0 : option.resource;
    if (!item && creatable !== false && onCreate && (item = onCreate(newValue), option = toOption4(item)), item && result.push(item), option && newSelected.push(option), maxValues !== void 0)
      for (; newSelected.length > maxValues; )
        newSelected.shift();
    onChange(result), setSelected(newSelected);
  }, [creatable, options, selected, maxValues, onChange, onCreate, toOption4]), handleValueSelect = (val) => {
    setSearch(""), setOptions([]), combobox.closeDropdown(), lastValueRef.current = void 0, addSelected(val === "$create" ? search : val);
  }, handleValueRemove = (0, import_react24.useCallback)((item) => {
    let newSelected = selected.filter((v2) => v2.value !== item.value);
    onChange(newSelected.map((v2) => v2.resource)), setSelected(newSelected);
  }, [selected, onChange]), handleKeyDown = (0, import_react24.useCallback)((e) => {
    e.key === "Enter" ? !timer && !abortController ? (killEvent(e), options && options.length > 0 && (setOptions(options.slice(0, 1)), addSelected(options[0].value))) : setAutoSubmit(true) : e.key === "Backspace" && search.length === 0 && (killEvent(e), handleValueRemove(selected[selected.length - 1]));
  }, [search, selected, options, timer, abortController, addSelected, handleValueRemove]);
  (0, import_react24.useEffect)(() => () => {
    abortControllerRef.current && abortControllerRef.current.abort();
  }, []);
  let clearButton = clearable && selected.length > 0 && (0, import_jsx_runtime11.jsx)(Combobox.ClearButton, { title: "Clear all", size: 16, onClear: () => {
    setSearch(""), setSelected([]), onChange([]), combobox.closeDropdown();
  } });
  return (0, import_jsx_runtime11.jsxs)(Combobox, { store: combobox, onOptionSubmit: handleValueSelect, withinPortal: true, shadow: "xl", ...rest, children: [(0, import_jsx_runtime11.jsx)(Combobox.DropdownTarget, { children: (0, import_jsx_runtime11.jsx)(PillsInput, { label, description, error, className: props.className, leftSection, rightSection: abortController ? (0, import_jsx_runtime11.jsx)(Loader, { size: 16 }) : clearButton, required, children: (0, import_jsx_runtime11.jsxs)(Pill.Group, { children: [selected.map((item) => (0, import_jsx_runtime11.jsx)(Pill, { withRemoveButton: true, onRemove: () => handleValueRemove(item), children: item.label }, item.value)), (maxValues === void 0 || maxValues === 0 || selected.length < maxValues) && (0, import_jsx_runtime11.jsx)(Combobox.EventsTarget, { children: (0, import_jsx_runtime11.jsx)(PillsInput.Field, { role: "searchbox", name, value: search, placeholder, onFocus: handleSearchChange, onBlur: () => combobox.closeDropdown(), onKeyDown: handleKeyDown, onChange: handleSearchChange }) })] }) }) }), (0, import_jsx_runtime11.jsx)(Combobox.Dropdown, { children: (0, import_jsx_runtime11.jsxs)(Combobox.Options, { children: [options.map((item) => (0, import_jsx_runtime11.jsx)(Combobox.Option, { value: item.value, active: selected.includes(item), children: (0, import_jsx_runtime11.jsx)(ItemComponent4, { ...item }) }, item.value)), creatable && search.trim().length > 0 && (0, import_jsx_runtime11.jsxs)(Combobox.Option, { value: "$create", children: ["+ Create ", search] }), !creatable && search.trim().length > 0 && options.length === 0 && (0, import_jsx_runtime11.jsx)(Combobox.Empty, { children: "Nothing found" })] }) })] });
}
function toDefaultItems(defaultValue2) {
  return defaultValue2 ? Array.isArray(defaultValue2) ? defaultValue2 : [defaultValue2] : [];
}
function DefaultItemComponent(props) {
  return (0, import_jsx_runtime11.jsx)(Group, { gap: "sm", children: (0, import_jsx_runtime11.jsx)("span", { children: props.label }) });
}
var HeaderSearchInput_default = { searchInput: "HeaderSearchInput_searchInput" };
function toOption(resource) {
  return { value: resource.id, label: Oi(resource), resource };
}
function HeaderSearchInput(props) {
  let navigate = G2(), medplum = a(), loadData = (0, import_react23.useCallback)(async (input, signal) => {
    let query = buildGraphQLQuery(input), options = { signal }, response = await medplum.graphql(query, void 0, void 0, options);
    return getResourcesFromResponse(response, input);
  }, [medplum]), handleSelect = (0, import_react23.useCallback)((item) => {
    item.length > 0 && navigate(`/${X(item[0])}`);
  }, [navigate]);
  return (0, import_jsx_runtime12.jsx)(AsyncAutocomplete, { size: "sm", radius: "md", className: HeaderSearchInput_default.searchInput, leftSection: (0, import_jsx_runtime12.jsx)(IconSearch, { size: 16 }), placeholder: "Search", itemComponent: ItemComponent, toOption, onChange: handleSelect, loadOptions: loadData, maxValues: 0, clearable: false }, `${props.pathname}?${props.searchParams}`);
}
var ItemComponent = (0, import_react23.forwardRef)(({ resource, ...others }, ref) => {
  var _a;
  let helpText;
  return resource.resourceType === "Patient" ? helpText = resource.birthDate : resource.resourceType === "ServiceRequest" && (helpText = (_a = resource.subject) == null ? void 0 : _a.display), (0, import_jsx_runtime12.jsx)("div", { ref, ...others, children: (0, import_jsx_runtime12.jsxs)(Group, { wrap: "nowrap", children: [(0, import_jsx_runtime12.jsx)(ResourceAvatar, { value: resource }), (0, import_jsx_runtime12.jsxs)("div", { children: [(0, import_jsx_runtime12.jsx)(Text, { children: Oi(resource) }), (0, import_jsx_runtime12.jsx)(Text, { size: "xs", c: "dimmed", children: helpText })] })] }) });
});
function buildGraphQLQuery(input) {
  let escaped = JSON.stringify(input);
  return bc(input) ? `{
      Patients1: PatientList(_id: ${escaped}, _count: 1) {
        resourceType
        id
        identifier {
          system
          value
        }
        name {
          given
          family
        }
        birthDate
      }
      ServiceRequestList(_id: ${escaped}, _count: 1) {
        resourceType
        id
        identifier {
          system
          value
        }
        subject {
          display
        }
      }
    }`.replace(/\s+/g, " ") : `{
    Patients1: PatientList(name: ${escaped}, _count: 5) {
      resourceType
      id
      identifier {
        system
        value
      }
      name {
        given
        family
      }
      birthDate
    }
    Patients2: PatientList(identifier: ${escaped}, _count: 5) {
      resourceType
      id
      identifier {
        system
        value
      }
      name {
        given
        family
      }
      birthDate
    }
    ServiceRequestList(identifier: ${escaped}, _count: 5) {
      resourceType
      id
      identifier {
        system
        value
      }
      subject {
        display
      }
    }
  }`.replace(/\s+/g, " ");
}
function getResourcesFromResponse(response, query) {
  let resources = [];
  return response.data.Patients1 && resources.push(...response.data.Patients1), response.data.Patients2 && resources.push(...response.data.Patients2), response.data.ServiceRequestList && resources.push(...response.data.ServiceRequestList), sortByRelevance(dedupeResources(resources), query).slice(0, 5);
}
function dedupeResources(resources) {
  let ids = /* @__PURE__ */ new Set(), result = [];
  for (let resource of resources)
    ids.has(resource.id) || (ids.add(resource.id), result.push(resource));
  return result;
}
function sortByRelevance(resources, query) {
  return resources.sort((a2, b2) => getResourceScore(b2, query) - getResourceScore(a2, query));
}
function getResourceScore(resource, query) {
  let bestScore = 0;
  if (resource.identifier)
    for (let identifier of resource.identifier)
      bestScore = Math.max(bestScore, getStringScore(identifier.value, query));
  if (resource.resourceType === "Patient" && resource.name)
    for (let name of resource.name)
      bestScore = Math.max(bestScore, getStringScore(Ze(name), query));
  return bestScore;
}
function getStringScore(str, query) {
  if (!str)
    return 0;
  let index = str.toLowerCase().indexOf(query.toLowerCase());
  return index < 0 ? 0 : 100 - index;
}
function Header(props) {
  var _a;
  let profile = H(), [userMenuOpened, setUserMenuOpened] = (0, import_react22.useState)(false);
  return (0, import_jsx_runtime13.jsx)(AppShell.Header, { p: 8, style: { zIndex: 101 }, children: (0, import_jsx_runtime13.jsxs)(Group, { justify: "space-between", children: [(0, import_jsx_runtime13.jsxs)(Group, { gap: "xs", children: [(0, import_jsx_runtime13.jsx)(UnstyledButton, { className: Header_default.logoButton, onClick: props.navbarToggle, children: props.logo }), !props.headerSearchDisabled && (0, import_jsx_runtime13.jsx)(HeaderSearchInput, { pathname: props.pathname, searchParams: props.searchParams })] }), (0, import_jsx_runtime13.jsxs)(Group, { gap: "lg", pr: "sm", children: [props.notifications, (0, import_jsx_runtime13.jsxs)(Menu, { width: 260, shadow: "xl", position: "bottom-end", transitionProps: { transition: "pop-top-right" }, opened: userMenuOpened, onClose: () => setUserMenuOpened(false), children: [(0, import_jsx_runtime13.jsx)(Menu.Target, { children: (0, import_jsx_runtime13.jsx)(UnstyledButton, { className: clsx_m_default(Header_default.user, { [Header_default.userActive]: userMenuOpened }), onClick: () => setUserMenuOpened((o) => !o), children: (0, import_jsx_runtime13.jsxs)(Group, { gap: 7, children: [(0, import_jsx_runtime13.jsx)(ResourceAvatar, { value: profile, radius: "xl", size: 24 }), (0, import_jsx_runtime13.jsx)(Text, { size: "sm", className: Header_default.userName, children: Ze((_a = profile == null ? void 0 : profile.name) == null ? void 0 : _a[0]) }), (0, import_jsx_runtime13.jsx)(IconChevronDown, { size: 12, stroke: 1.5 })] }) }) }), (0, import_jsx_runtime13.jsx)(Menu.Dropdown, { children: (0, import_jsx_runtime13.jsx)(HeaderDropdown, { version: props.version }) })] })] })] }) });
}
function parseForm(form) {
  let result = {};
  for (let element of Array.from(form.elements))
    element instanceof HTMLInputElement ? parseInputElement(result, element) : element instanceof HTMLTextAreaElement ? result[element.name] = element.value : element instanceof HTMLSelectElement && parseSelectElement(result, element);
  return result;
}
function parseInputElement(result, el) {
  el.disabled || (el.type === "checkbox" || el.type === "radio") && !el.checked || (result[el.name] = el.value);
}
function parseSelectElement(result, el) {
  result[el.name] = el.value;
}
function Form(props) {
  return (0, import_jsx_runtime14.jsx)("form", { style: props.style, "data-testid": props.testid, onSubmit: (e) => {
    e.preventDefault();
    let formData = parseForm(e.target);
    props.onSubmit && props.onSubmit(formData);
  }, children: props.children });
}
function BookmarkDialog(props) {
  let medplum = a(), config = medplum.getUserConfiguration();
  function submitHandler(formData) {
    var _a, _b, _c;
    let { menuname, bookmarkname: name } = formData, target = `${props.pathname}?${props.searchParams.toString()}`, newConfig = ee(config);
    (_c = (_b = (_a = newConfig.menu) == null ? void 0 : _a.find(({ title }) => title === menuname)) == null ? void 0 : _b.link) == null ? void 0 : _c.push({ name, target }), medplum.updateResource(newConfig).then((res) => {
      config.menu = res.menu, medplum.dispatchEvent({ type: "change" }), showNotification({ color: "green", message: "Success" }), props.onOk();
    }).catch((err) => {
      showNotification({ color: "red", message: di(err) });
    });
  }
  return (0, import_jsx_runtime15.jsx)(Modal, { title: "Add Bookmark", closeButtonProps: { "aria-label": "Close" }, opened: props.visible, onClose: props.onCancel, children: (0, import_jsx_runtime15.jsx)(Form, { onSubmit: submitHandler, children: (0, import_jsx_runtime15.jsxs)(Stack, { children: [(0, import_jsx_runtime15.jsx)(SelectMenu, { config }), (0, import_jsx_runtime15.jsx)(TextInput, { label: "Bookmark Name", type: "text", name: "bookmarkname", placeholder: "Bookmark Name", withAsterisk: true }), (0, import_jsx_runtime15.jsx)(Group, { justify: "flex-end", children: (0, import_jsx_runtime15.jsx)(Button, { mt: "sm", type: "submit", children: "OK" }) })] }) }) });
}
function SelectMenu(props) {
  function userConfigToMenu(config) {
    var _a;
    return (_a = config == null ? void 0 : config.menu) == null ? void 0 : _a.map((menu) => menu.title);
  }
  let menus = userConfigToMenu(props.config);
  return (0, import_jsx_runtime15.jsx)(NativeSelect, { name: "menuname", defaultValue: menus[0], label: "Select Menu Option", data: menus, withAsterisk: true });
}
function toKey(element) {
  return typeof element.code == "string" ? element.code : JSON.stringify(element);
}
function getDisplay(item) {
  return typeof item.display == "string" ? item.display : toKey(item);
}
function toOption2(element) {
  return { value: toKey(element), label: getDisplay(element), resource: element };
}
function createValue(input) {
  return { code: input, display: input };
}
function ValueSetAutocomplete(props) {
  let medplum = a(), { binding, creatable, clearable, expandParams, withHelpText, ...rest } = props, loadValues = (0, import_react28.useCallback)(async (input, signal) => {
    var _a;
    if (!binding)
      return [];
    let valueSetElements = (_a = (await medplum.valueSetExpand({ ...expandParams, url: binding, filter: input }, { signal })).expansion) == null ? void 0 : _a.contains, newData = [];
    for (let valueSetElement of valueSetElements)
      valueSetElement.code && !newData.some((item) => item.code === valueSetElement.code) && newData.push(valueSetElement);
    return newData;
  }, [medplum, expandParams, binding]);
  return (0, import_jsx_runtime16.jsx)(AsyncAutocomplete, { ...rest, creatable: creatable ?? true, clearable: clearable ?? true, toOption: toOption2, loadOptions: loadValues, onCreate: createValue, itemComponent: withHelpText ? ItemComponent2 : void 0 });
}
var ItemComponent2 = (0, import_react28.forwardRef)(({ label, resource, ...others }, ref) => (0, import_jsx_runtime16.jsx)("div", { ref, ...others, children: (0, import_jsx_runtime16.jsx)(Group, { wrap: "nowrap", children: (0, import_jsx_runtime16.jsxs)("div", { children: [(0, import_jsx_runtime16.jsx)(Text, { children: label }), (0, import_jsx_runtime16.jsx)(Text, { size: "xs", c: "dimmed", children: `${resource.system}#${resource.code}` })] }) }) }));
function CodeInput(props) {
  let { defaultValue: defaultValue2, onChange, withHelpText, ...rest } = props, [value, setValue] = (0, import_react27.useState)(defaultValue2);
  function handleChange(newValues) {
    let newValue = newValues[0], newCode = valueSetElementToCode(newValue);
    setValue(newCode), onChange && onChange(newCode);
  }
  return (0, import_jsx_runtime17.jsx)(ValueSetAutocomplete, { defaultValue: codeToValueSetElement(value), onChange: handleChange, withHelpText: withHelpText ?? true, ...rest });
}
function codeToValueSetElement(code) {
  return code ? { code } : void 0;
}
function valueSetElementToCode(element) {
  return element == null ? void 0 : element.code;
}
function ResourceTypeInput(props) {
  let [resourceType, setResourceType] = (0, import_react26.useState)(props.defaultValue), onChange = props.onChange, setResourceTypeWrapper = (0, import_react26.useCallback)((newResourceType) => {
    setResourceType(newResourceType), onChange && onChange(newResourceType);
  }, [onChange]);
  return (0, import_jsx_runtime18.jsx)(CodeInput, { "data-autofocus": props.autoFocus, "data-testid": props.testId, defaultValue: resourceType, onChange: setResourceTypeWrapper, name: props.name, placeholder: props.placeholder, binding: "https://medplum.com/fhir/ValueSet/resource-types", creatable: false, maxValues: props.maxValues ?? 1, clearable: false, withHelpText: false });
}
var Navbar_default = { menuTitle: "Navbar_menuTitle", link: "Navbar_link", linkActive: "Navbar_linkActive" };
function Navbar(props) {
  var _a;
  let navigate = G2(), activeLink = getActiveLink(props.pathname, props.searchParams, props.menus), [bookmarkDialogVisible, setBookmarkDialogVisible] = (0, import_react25.useState)(false);
  function onLinkClick(e, to) {
    e.stopPropagation(), e.preventDefault(), navigate(to), window.innerWidth < 768 && props.closeNavbar();
  }
  function navigateResourceType(resourceType) {
    resourceType && navigate(`/${resourceType}`);
  }
  return (0, import_jsx_runtime19.jsxs)(import_jsx_runtime19.Fragment, { children: [(0, import_jsx_runtime19.jsx)(AppShell.Navbar, { children: (0, import_jsx_runtime19.jsxs)(ScrollArea, { p: "xs", children: [!props.resourceTypeSearchDisabled && (0, import_jsx_runtime19.jsx)(AppShell.Section, { mb: "sm", children: (0, import_jsx_runtime19.jsx)(ResourceTypeInput, { name: "resourceType", placeholder: "Resource Type", maxValues: 0, onChange: (newValue) => navigateResourceType(newValue) }, window.location.pathname) }), (0, import_jsx_runtime19.jsxs)(AppShell.Section, { grow: true, children: [(_a = props.menus) == null ? void 0 : _a.map((menu) => {
    var _a2;
    return (0, import_jsx_runtime19.jsxs)(import_react25.Fragment, { children: [(0, import_jsx_runtime19.jsx)(Text, { className: Navbar_default.menuTitle, children: menu.title }), (_a2 = menu.links) == null ? void 0 : _a2.map((link) => (0, import_jsx_runtime19.jsxs)(NavbarLink, { to: link.href, active: link.href === (activeLink == null ? void 0 : activeLink.href), onClick: (e) => onLinkClick(e, link.href), children: [(0, import_jsx_runtime19.jsx)(NavLinkIcon, { to: link.href, icon: link.icon }), (0, import_jsx_runtime19.jsx)("span", { children: link.label })] }, link.href))] }, `menu-${menu.title}`);
  }), props.displayAddBookmark && (0, import_jsx_runtime19.jsx)(Button, { variant: "subtle", size: "xs", mt: "xl", leftSection: (0, import_jsx_runtime19.jsx)(IconPlus, { size: "0.75rem" }), onClick: () => setBookmarkDialogVisible(true), children: "Add Bookmark" })] })] }) }), props.pathname && props.searchParams && (0, import_jsx_runtime19.jsx)(BookmarkDialog, { pathname: props.pathname, searchParams: props.searchParams, visible: bookmarkDialogVisible, onOk: () => setBookmarkDialogVisible(false), onCancel: () => setBookmarkDialogVisible(false) })] });
}
function NavbarLink(props) {
  return (0, import_jsx_runtime19.jsx)(MedplumLink, { onClick: props.onClick, to: props.to, className: clsx_m_default(Navbar_default.link, { [Navbar_default.linkActive]: props.active }), children: props.children });
}
function NavLinkIcon(props) {
  return props.icon ? props.icon : (0, import_jsx_runtime19.jsx)(Space, { w: 30 });
}
function getActiveLink(currentPathname, currentSearchParams, menus) {
  if (!currentPathname || !currentSearchParams || !menus)
    return;
  let bestLink, bestScore = 0;
  for (let menu of menus)
    if (menu.links)
      for (let link of menu.links) {
        let score = getLinkScore(currentPathname, currentSearchParams, link.href);
        score > bestScore && (bestScore = score, bestLink = link);
      }
  return bestLink;
}
function getLinkScore(currentPathname, currentSearchParams, linkHref) {
  let linkUrl = new URL(linkHref, "https://example.com");
  if (currentPathname !== linkUrl.pathname)
    return 0;
  let ignoredParams = ["_count", "_offset"];
  for (let [key, value] of linkUrl.searchParams.entries())
    if (!ignoredParams.includes(key) && currentSearchParams.get(key) !== value)
      return 0;
  let count = 1;
  for (let [key, value] of currentSearchParams.entries())
    ignoredParams.includes(key) || linkUrl.searchParams.get(key) === value && count++;
  return count;
}
function AppShell2(props) {
  let [navbarOpen, setNavbarOpen] = (0, import_react19.useState)(localStorage.navbarOpen === "true"), medplum = a(), profile = H();
  (0, import_react19.useEffect)(() => {
    function eventListener() {
      showNotification({ color: "red", message: "No connection to server", autoClose: false });
    }
    return medplum.addEventListener("offline", eventListener), () => medplum.removeEventListener("offline", eventListener);
  }, [medplum]);
  function setNavbarOpenWrapper(open) {
    localStorage.navbarOpen = open.toString(), setNavbarOpen(open);
  }
  function closeNavbar() {
    setNavbarOpenWrapper(false);
  }
  function toggleNavbar() {
    setNavbarOpenWrapper(!navbarOpen);
  }
  return medplum.isLoading() ? (0, import_jsx_runtime20.jsx)(Loading, {}) : (0, import_jsx_runtime20.jsxs)(AppShell, { header: { height: 60 }, navbar: { width: 250, breakpoint: "sm", collapsed: { desktop: !profile || !navbarOpen, mobile: !profile || !navbarOpen } }, padding: 0, children: [profile && (0, import_jsx_runtime20.jsx)(Header, { pathname: props.pathname, searchParams: props.searchParams, headerSearchDisabled: props.headerSearchDisabled, logo: props.logo, version: props.version, navbarToggle: toggleNavbar, notifications: props.notifications }), profile && navbarOpen ? (0, import_jsx_runtime20.jsx)(Navbar, { pathname: props.pathname, searchParams: props.searchParams, menus: props.menus, closeNavbar, displayAddBookmark: props.displayAddBookmark, resourceTypeSearchDisabled: props.resourceTypeSearchDisabled }) : void 0, (0, import_jsx_runtime20.jsx)(AppShell.Main, { className: AppShell_default.main, children: (0, import_jsx_runtime20.jsx)(ErrorBoundary, { children: (0, import_jsx_runtime20.jsx)(import_react19.Suspense, { fallback: (0, import_jsx_runtime20.jsx)(Loading, {}), children: props.children }) }) })] });
}
function AttachmentDisplay(props) {
  let { contentType, url: uncachedUrl, title } = props.value ?? {}, url = re(uncachedUrl);
  return url ? (0, import_jsx_runtime21.jsxs)("div", { "data-testid": "attachment-display", children: [(contentType == null ? void 0 : contentType.startsWith("image/")) && (0, import_jsx_runtime21.jsx)("img", { "data-testid": "attachment-image", style: { maxWidth: props.maxWidth }, src: url, alt: title }), (contentType == null ? void 0 : contentType.startsWith("video/")) && (0, import_jsx_runtime21.jsx)("video", { "data-testid": "attachment-video", style: { maxWidth: props.maxWidth }, controls: true, children: (0, import_jsx_runtime21.jsx)("source", { type: contentType, src: url }) }), contentType === "application/pdf" && (0, import_jsx_runtime21.jsx)("div", { "data-testid": "attachment-pdf", style: { maxWidth: props.maxWidth, minHeight: 400 }, children: (0, import_jsx_runtime21.jsx)("iframe", { width: "100%", height: "400", src: url + "#navpanes=0", allowFullScreen: true, frameBorder: 0, seamless: true }) }), (0, import_jsx_runtime21.jsx)("div", { "data-testid": "download-link", style: { padding: "2px 16px 16px 16px" }, children: (0, import_jsx_runtime21.jsx)(Anchor, { href: url, "data-testid": "attachment-details", target: "_blank", rel: "noopener noreferrer", download: getDownloadName(title), children: title || "Download" }) })] }) : null;
}
function getDownloadName(title) {
  return (title == null ? void 0 : title.includes(".")) ? title : void 0;
}
var DescriptionList_default = { root: "DescriptionList_root", compact: "DescriptionList_compact" };
function DescriptionList(props) {
  let { children: children2, compact } = props;
  return (0, import_jsx_runtime22.jsx)("dl", { className: clsx_m_default(DescriptionList_default.root, { [DescriptionList_default.compact]: compact }), children: children2 });
}
function DescriptionListEntry(props) {
  return (0, import_jsx_runtime22.jsxs)(import_jsx_runtime22.Fragment, { children: [(0, import_jsx_runtime22.jsx)("dt", { children: props.term }), (0, import_jsx_runtime22.jsx)("dd", { children: props.children })] });
}
function AttachmentArrayDisplay(props) {
  var _a;
  let attachmentElements = (_a = props.values) == null ? void 0 : _a.map((v2, index) => (0, import_jsx_runtime23.jsx)("div", { children: (0, import_jsx_runtime23.jsx)(AttachmentDisplay, { value: v2, maxWidth: props.maxWidth }) }, "attatchment-" + index)), content;
  if (props.includeDescriptionListEntry) {
    if (props.property === void 0)
      throw new Error("props.property is required when includeDescriptionListEntry is true");
    if (!G(props.path))
      throw new Error("props.path is required when includeDescriptionListEntry is true");
    let key = props.path.split(".").pop();
    content = (0, import_jsx_runtime23.jsx)(DescriptionListEntry, { term: eu(key), children: attachmentElements });
  } else
    content = (0, import_jsx_runtime23.jsx)(import_jsx_runtime23.Fragment, { children: attachmentElements });
  return content;
}
function AttachmentButton(props) {
  let medplum = a(), fileInputRef = (0, import_react30.useRef)(null);
  function onClick(e) {
    var _a;
    killEvent(e), (_a = fileInputRef.current) == null ? void 0 : _a.click();
  }
  function onFileChange(e) {
    killEvent(e);
    let files = e.target.files;
    files && Array.from(files).forEach(processFile);
  }
  function processFile(file) {
    if (!file || !file.name)
      return;
    props.onUploadStart && props.onUploadStart();
    let filename = file.name, contentType = file.type || "application/octet-stream";
    medplum.createBinary(file, filename, contentType, props.onUploadProgress).then((binary) => {
      props.onUpload({ contentType: binary.contentType, url: binary.url, title: filename });
    }).catch((err) => {
      props.onUploadError && props.onUploadError(Be(err));
    });
  }
  return (0, import_jsx_runtime24.jsxs)(import_jsx_runtime24.Fragment, { children: [(0, import_jsx_runtime24.jsx)("input", { type: "file", "data-testid": "upload-file-input", style: { display: "none" }, ref: fileInputRef, onChange: (e) => onFileChange(e) }), props.children({ onClick })] });
}
function AttachmentArrayInput(props) {
  let [values2, setValues] = (0, import_react29.useState)(props.defaultValue ?? []), valuesRef = (0, import_react29.useRef)();
  valuesRef.current = values2;
  function setValuesWrapper(newValues) {
    setValues(newValues), props.onChange && props.onChange(newValues);
  }
  return (0, import_jsx_runtime25.jsxs)("table", { style: { width: "100%" }, children: [(0, import_jsx_runtime25.jsxs)("colgroup", { children: [(0, import_jsx_runtime25.jsx)("col", { width: "97%" }), (0, import_jsx_runtime25.jsx)("col", { width: "3%" })] }), (0, import_jsx_runtime25.jsxs)("tbody", { children: [values2.map((v2, index) => (0, import_jsx_runtime25.jsxs)("tr", { children: [(0, import_jsx_runtime25.jsx)("td", { children: (0, import_jsx_runtime25.jsx)(AttachmentDisplay, { value: v2, maxWidth: 200 }) }), (0, import_jsx_runtime25.jsx)("td", { children: (0, import_jsx_runtime25.jsx)(ActionIcon, { title: "Remove", variant: "subtle", size: "sm", color: "gray", onClick: (e) => {
    killEvent(e);
    let copy = values2.slice();
    copy.splice(index, 1), setValuesWrapper(copy);
  }, children: (0, import_jsx_runtime25.jsx)(IconCircleMinus, {}) }) })] }, `${index}-${values2.length}`)), (0, import_jsx_runtime25.jsxs)("tr", { children: [(0, import_jsx_runtime25.jsx)("td", {}), (0, import_jsx_runtime25.jsx)("td", { children: (0, import_jsx_runtime25.jsx)(AttachmentButton, { onUpload: (attachment) => {
    setValuesWrapper([...valuesRef.current, attachment]);
  }, children: (props2) => (0, import_jsx_runtime25.jsx)(ActionIcon, { ...props2, title: "Add", variant: "subtle", size: "sm", color: "green", children: (0, import_jsx_runtime25.jsx)(IconCloudUpload, {}) }) }) })] })] })] });
}
function AttachmentInput(props) {
  let [value, setValue] = (0, import_react31.useState)(props.defaultValue);
  function setValueWrapper(newValue) {
    setValue(newValue), props.onChange && props.onChange(newValue);
  }
  return value ? (0, import_jsx_runtime26.jsxs)(import_jsx_runtime26.Fragment, { children: [(0, import_jsx_runtime26.jsx)(AttachmentDisplay, { value, maxWidth: 200 }), (0, import_jsx_runtime26.jsx)(Button, { onClick: (e) => {
    killEvent(e), setValueWrapper(void 0);
  }, children: "Remove" })] }) : (0, import_jsx_runtime26.jsx)(AttachmentButton, { onUpload: setValueWrapper, children: (props2) => (0, import_jsx_runtime26.jsx)(Button, { ...props2, children: "Upload..." }) });
}
var DEFAULT_IGNORED_PROPERTIES = ["meta", "implicitRules", "contained", "extension", "modifierExtension"];
var DEFAULT_IGNORED_NON_NESTED_PROPERTIES = ["language", "text"];
function CodeableConceptDisplay(props) {
  return (0, import_jsx_runtime27.jsx)(import_jsx_runtime27.Fragment, { children: Ji(props.value) });
}
function CodingDisplay(props) {
  return (0, import_jsx_runtime28.jsx)(import_jsx_runtime28.Fragment, { children: Yi(props.value) });
}
function ContactPointDisplay(props) {
  let contactPoint = props.value;
  if (!contactPoint)
    return null;
  let builder = [];
  return contactPoint.value && builder.push(contactPoint.value), (contactPoint.use || contactPoint.system) && (builder.push(" ["), contactPoint.use && builder.push(contactPoint.use), contactPoint.use && contactPoint.system && builder.push(" "), contactPoint.system && builder.push(contactPoint.system), builder.push("]")), (0, import_jsx_runtime29.jsx)(import_jsx_runtime29.Fragment, { children: builder.join("").trim() });
}
function ContactDetailDisplay(props) {
  var _a;
  let contactDetail = props.value;
  return contactDetail ? (0, import_jsx_runtime30.jsxs)(import_jsx_runtime30.Fragment, { children: [contactDetail.name, contactDetail.name && ": ", (_a = contactDetail.telecom) == null ? void 0 : _a.map((telecom) => (0, import_jsx_runtime30.jsx)(ContactPointDisplay, { value: telecom }, `telecom-${contactDetail.name}-${telecom.value}`))] }) : null;
}
function IdentifierDisplay(props) {
  var _a, _b;
  return (0, import_jsx_runtime31.jsxs)("div", { children: [(_a = props.value) == null ? void 0 : _a.system, ": ", (_b = props.value) == null ? void 0 : _b.value] });
}
function MoneyDisplay(props) {
  return (0, import_jsx_runtime32.jsx)(import_jsx_runtime32.Fragment, { children: $c(props.value) });
}
function QuantityDisplay(props) {
  return (0, import_jsx_runtime33.jsx)(import_jsx_runtime33.Fragment, { children: te(props.value) });
}
function RangeDisplay(props) {
  return (0, import_jsx_runtime34.jsx)(import_jsx_runtime34.Fragment, { children: jc(props.value) });
}
function RatioDisplay(props) {
  let value = props.value;
  return value ? (0, import_jsx_runtime35.jsxs)(import_jsx_runtime35.Fragment, { children: [(0, import_jsx_runtime35.jsx)(QuantityDisplay, { value: value.numerator }), "/", (0, import_jsx_runtime35.jsx)(QuantityDisplay, { value: value.denominator })] }) : null;
}
function ReferenceDisplay(props) {
  if (!props.value)
    return null;
  let displayString = props.value.display || props.value.reference || ln(props.value);
  return props.link !== false && props.value.reference ? (0, import_jsx_runtime36.jsx)(MedplumLink, { to: props.value, children: displayString }) : (0, import_jsx_runtime36.jsx)(import_jsx_runtime36.Fragment, { children: displayString });
}
var ElementsContext = import_react33.default.createContext({ path: "", profileUrl: void 0, elements: /* @__PURE__ */ Object.create(null), elementsByPath: /* @__PURE__ */ Object.create(null), debugMode: false });
ElementsContext.displayName = "ElementsContext";
function assignValuesIntoSlices(values2, slices, slicing, profileUrl) {
  if (!G(slicing == null ? void 0 : slicing.slices))
    return [values2];
  let slicedValues = new Array(slices.length + 1);
  for (let i = 0; i < slicedValues.length; i++)
    slicedValues[i] = [];
  for (let value of values2) {
    let sliceName = Jn(value, slices, slicing.discriminator, profileUrl), sliceIndex = sliceName ? slices.findIndex((slice) => slice.name === sliceName) : -1;
    sliceIndex === -1 && (sliceIndex = slices.length), slicedValues[sliceIndex].push(value);
  }
  return slicedValues;
}
async function prepareSlices({ medplum, property }) {
  return new Promise((resolve, reject) => {
    var _a, _b;
    if (!property.slicing) {
      resolve([]);
      return;
    }
    let supportedSlices = [], profileUrls = [], promises = [];
    for (let slice of property.slicing.slices) {
      if (!zn(slice)) {
        console.debug("Unsupported slice definition", slice);
        continue;
      }
      let profileUrl;
      G(slice.elements) || (profileUrl = (_b = (_a = slice.type[0]) == null ? void 0 : _a.profile) == null ? void 0 : _b[0]), supportedSlices.push(slice), profileUrls.push(profileUrl), profileUrl ? promises.push(medplum.requestProfileSchema(profileUrl)) : promises.push(Promise.resolve([]));
    }
    Promise.all(promises).then(() => {
      for (let i = 0; i < supportedSlices.length; i++) {
        let slice = supportedSlices[i], profileUrl = profileUrls[i];
        if (profileUrl) {
          let typeSchema = Kr(profileUrl);
          slice.typeSchema = typeSchema;
        }
      }
      resolve(supportedSlices);
    }).catch(reject);
  });
}
function maybeWrapWithContext(ContextProvider, contextValue, contents) {
  return contextValue !== void 0 ? (0, import_jsx_runtime37.jsx)(ContextProvider, { value: contextValue, children: contents }) : contents;
}
function SliceDisplay(props) {
  var _a, _b;
  let { slice, property } = props, sliceElements = ((_a = slice.typeSchema) == null ? void 0 : _a.elements) ?? slice.elements, parentContext = (0, import_react34.useContext)(ElementsContext), contextValue = (0, import_react34.useMemo)(() => {
    var _a2;
    if (G(sliceElements))
      return Tr({ parentContext, elements: sliceElements, path: props.path, profileUrl: (_a2 = slice.typeSchema) == null ? void 0 : _a2.url });
  }, [parentContext, props.path, (_b = slice.typeSchema) == null ? void 0 : _b.url, sliceElements]);
  return maybeWrapWithContext(ElementsContext.Provider, contextValue, (0, import_jsx_runtime38.jsx)(import_jsx_runtime38.Fragment, { children: props.value.map((value, valueIndex) => (0, import_jsx_runtime38.jsx)("div", { children: (0, import_jsx_runtime38.jsx)(ResourcePropertyDisplay, { property, path: props.path, arrayElement: true, elementDefinitionType: slice.type[0], propertyType: slice.type[0].code, value, ignoreMissingValues: props.ignoreMissingValues, link: props.link }) }, `${valueIndex}-${props.value.length}`)) }));
}
function ResourceArrayDisplay(props) {
  var _a;
  let { property, propertyType } = props, medplum = a(), values2 = (0, import_react32.useMemo)(() => Array.isArray(props.values) ? props.values : [], [props.values]), [loading, setLoading] = (0, import_react32.useState)(true), [slices, setSlices] = (0, import_react32.useState)([]), [slicedValues, setSlicedValues] = (0, import_react32.useState)(() => [values2]), ctx = (0, import_react32.useContext)(ElementsContext);
  if ((0, import_react32.useEffect)(() => {
    prepareSlices({ medplum, property }).then((slices2) => {
      setSlices(slices2);
      let slicedValues2 = assignValuesIntoSlices(values2, slices2, property.slicing, ctx.profileUrl);
      setSlicedValues(slicedValues2), setLoading(false);
    }).catch((reason) => {
      console.error(reason), setLoading(false);
    });
  }, [medplum, property, ctx.profileUrl, setSlicedValues, values2]), loading)
    return (0, import_jsx_runtime39.jsx)("div", { children: "Loading..." });
  let nonSliceContent;
  if (((_a = property.type[0]) == null ? void 0 : _a.code) !== "Extension") {
    let nonSliceValues = slicedValues[slices.length], nonSliceElements = nonSliceValues.map((value, valueIndex) => (0, import_jsx_runtime39.jsx)("div", { children: (0, import_jsx_runtime39.jsx)(ResourcePropertyDisplay, { path: props.path, arrayElement: true, property, propertyType, value, ignoreMissingValues: props.ignoreMissingValues, link: props.link }) }, `${valueIndex}-${nonSliceValues.length}`));
    if (props.includeDescriptionListEntry) {
      if (!G(props.path))
        throw new Error("props.path is required when includeDescriptionListEntry is true");
      let key = props.path.split(".").pop();
      nonSliceContent = (0, import_jsx_runtime39.jsx)(DescriptionListEntry, { term: eu(key), children: nonSliceElements });
    } else
      nonSliceContent = (0, import_jsx_runtime39.jsx)(import_jsx_runtime39.Fragment, { children: nonSliceElements });
  }
  return (0, import_jsx_runtime39.jsxs)(import_jsx_runtime39.Fragment, { children: [slices.map((slice, sliceIndex) => {
    if (!props.path)
      throw Error(`Displaying a resource property with slices of type ${props.propertyType} requires path`);
    let sliceDisplay = (0, import_jsx_runtime39.jsx)(SliceDisplay, { path: props.path, slice, property, value: slicedValues[sliceIndex], ignoreMissingValues: props.ignoreMissingValues, link: props.link }, slice.name);
    return props.includeDescriptionListEntry && (sliceDisplay = (0, import_jsx_runtime39.jsx)(DescriptionListEntry, { term: eu(slice.name), children: sliceDisplay }, slice.name)), sliceDisplay;
  }), nonSliceContent] });
}
function getValueAndType(context, path, profileUrl) {
  let typedResult = P(context, path, { profileUrl });
  return typedResult ? Array.isArray(typedResult) ? [typedResult.map((e) => e.value), typedResult[0].type] : [typedResult.value, typedResult.type] : [void 0, "undefined"];
}
function getValueAndTypeFromElement(typedValue, path, element) {
  let typedResult = Pi(typedValue, path, element);
  return typedResult ? Array.isArray(typedResult) ? [typedResult.map((e) => e.value), typedResult[0].type] : [typedResult.value, typedResult.type] : [void 0, "undefined"];
}
function ExtensionDisplay(props) {
  var _a;
  let { elementDefinitionType } = props, medplum = a(), ctx = (0, import_react35.useContext)(ElementsContext), [typeSchema, setTypeSchema] = (0, import_react35.useState)(pe("Extension")), profileUrl = (0, import_react35.useMemo)(() => {
    if (G(elementDefinitionType == null ? void 0 : elementDefinitionType.profile))
      return elementDefinitionType.profile[0];
  }, [elementDefinitionType]), [loadingProfile, setLoadingProfile] = (0, import_react35.useState)(profileUrl !== void 0);
  if ((0, import_react35.useEffect)(() => {
    profileUrl && (setLoadingProfile(true), medplum.requestProfileSchema(profileUrl).then(() => {
      let profile = Kr(profileUrl);
      setLoadingProfile(false), profile && setTypeSchema(profile);
    }).catch((reason) => {
      setLoadingProfile(false), console.warn(reason);
    }));
  }, [medplum, profileUrl]), profileUrl && (loadingProfile || !Wr(profileUrl)))
    return (0, import_jsx_runtime40.jsx)("div", { children: "Loading..." });
  if (((_a = typeSchema.elements["value[x]"]) == null ? void 0 : _a.max) !== 0) {
    let [propertyValue, propertyType] = getValueAndType({ type: "Extension", value: props.value }, "value[x]", profileUrl ?? ctx.profileUrl);
    return (0, import_jsx_runtime40.jsx)(ResourcePropertyDisplay, { propertyType, value: propertyValue });
  }
  return (0, import_jsx_runtime40.jsx)(BackboneElementDisplay, { path: props.path, value: { type: typeSchema.name, value: props.value }, compact: props.compact, ignoreMissingValues: props.ignoreMissingValues, link: props.link, profileUrl });
}
function ResourcePropertyDisplay(props) {
  var _a;
  let { property, propertyType, value } = props;
  if ((_a = property == null ? void 0 : property.path) == null ? void 0 : _a.endsWith(".id"))
    return (0, import_jsx_runtime41.jsxs)(Box, { component: "div", style: { display: "flex", gap: 3, alignItems: "center" }, children: [value, !S(value) && (0, import_jsx_runtime41.jsx)(CopyButton, { value, timeout: 2e3, children: ({ copied, copy }) => (0, import_jsx_runtime41.jsx)(Tooltip, { label: copied ? "Copied" : "Copy", withArrow: true, position: "right", children: (0, import_jsx_runtime41.jsx)(ActionIcon, { variant: "subtle", color: copied ? "teal" : "gray", onClick: copy, children: copied ? (0, import_jsx_runtime41.jsx)(IconCheck, { size: "1rem" }) : (0, import_jsx_runtime41.jsx)(IconCopy, { size: "1rem" }) }) }) })] });
  let isArrayElement = !!props.arrayElement;
  if ((property == null ? void 0 : property.max) && property.max > 1 && !isArrayElement)
    return propertyType === l.Attachment ? (0, import_jsx_runtime41.jsx)(AttachmentArrayDisplay, { values: value, maxWidth: props.maxWidth, includeDescriptionListEntry: props.includeArrayDescriptionListEntry, property, path: props.path }) : (0, import_jsx_runtime41.jsx)(ResourceArrayDisplay, { path: props.path, property, propertyType, values: value, includeDescriptionListEntry: props.includeArrayDescriptionListEntry, ignoreMissingValues: props.ignoreMissingValues, link: props.link });
  switch (propertyType) {
    case l.boolean:
      return (0, import_jsx_runtime41.jsx)(import_jsx_runtime41.Fragment, { children: value === void 0 ? "" : (!!value).toString() });
    case l.SystemString:
    case l.string:
      return (0, import_jsx_runtime41.jsx)("div", { style: { whiteSpace: "pre-wrap" }, children: value });
    case l.code:
    case l.date:
    case l.decimal:
    case l.id:
    case l.integer:
    case l.positiveInt:
    case l.unsignedInt:
    case l.uri:
    case l.url:
      return (0, import_jsx_runtime41.jsx)(import_jsx_runtime41.Fragment, { children: value });
    case l.canonical:
      return (0, import_jsx_runtime41.jsx)(ReferenceDisplay, { value: { reference: value }, link: props.link });
    case l.dateTime:
    case l.instant:
      return (0, import_jsx_runtime41.jsx)(import_jsx_runtime41.Fragment, { children: nr(value) });
    case l.markdown:
      return (0, import_jsx_runtime41.jsx)("pre", { children: value });
    case l.Address:
      return (0, import_jsx_runtime41.jsx)(AddressDisplay, { value });
    case l.Annotation:
      return (0, import_jsx_runtime41.jsx)(import_jsx_runtime41.Fragment, { children: value == null ? void 0 : value.text });
    case l.Attachment:
      return (0, import_jsx_runtime41.jsx)(AttachmentDisplay, { value, maxWidth: props.maxWidth });
    case l.CodeableConcept:
      return (0, import_jsx_runtime41.jsx)(CodeableConceptDisplay, { value });
    case l.Coding:
      return (0, import_jsx_runtime41.jsx)(CodingDisplay, { value });
    case l.ContactDetail:
      return (0, import_jsx_runtime41.jsx)(ContactDetailDisplay, { value });
    case l.ContactPoint:
      return (0, import_jsx_runtime41.jsx)(ContactPointDisplay, { value });
    case l.HumanName:
      return (0, import_jsx_runtime41.jsx)(HumanNameDisplay, { value });
    case l.Identifier:
      return (0, import_jsx_runtime41.jsx)(IdentifierDisplay, { value });
    case l.Money:
      return (0, import_jsx_runtime41.jsx)(MoneyDisplay, { value });
    case l.Period:
      return (0, import_jsx_runtime41.jsx)(import_jsx_runtime41.Fragment, { children: Bc(value) });
    case l.Quantity:
    case l.Duration:
      return (0, import_jsx_runtime41.jsx)(QuantityDisplay, { value });
    case l.Range:
      return (0, import_jsx_runtime41.jsx)(RangeDisplay, { value });
    case l.Ratio:
      return (0, import_jsx_runtime41.jsx)(RatioDisplay, { value });
    case l.Reference:
      return (0, import_jsx_runtime41.jsx)(ReferenceDisplay, { value, link: props.link });
    case l.Timing:
      return (0, import_jsx_runtime41.jsx)(import_jsx_runtime41.Fragment, { children: qc(value) });
    case l.Dosage:
    case l.UsageContext:
      if (!props.path)
        throw Error(`Displaying property of type ${props.propertyType} requires path`);
      return (0, import_jsx_runtime41.jsx)(BackboneElementDisplay, { path: props.path, value: { type: propertyType, value }, compact: true, ignoreMissingValues: props.ignoreMissingValues });
    case l.Extension:
      if (!props.path)
        throw Error(`Displaying property of type ${props.propertyType} requires path`);
      return (0, import_jsx_runtime41.jsx)(ExtensionDisplay, { path: props.path, value, compact: true, ignoreMissingValues: props.ignoreMissingValues, elementDefinitionType: props.elementDefinitionType });
    default:
      if (!property)
        throw Error(`Displaying property of type ${props.propertyType} requires element schema`);
      if (!props.path)
        throw Error(`Displaying property of type ${props.propertyType} requires path`);
      return (0, import_jsx_runtime41.jsx)(BackboneElementDisplay, { path: props.path, value: { type: property.type[0].code, value }, compact: true, ignoreMissingValues: props.ignoreMissingValues });
  }
}
var EXTENSION_KEYS = ["extension", "modifierExtension"];
var IGNORED_PROPERTIES = DEFAULT_IGNORED_PROPERTIES.filter((prop) => !EXTENSION_KEYS.includes(prop));
function BackboneElementDisplay(props) {
  let typedValue = props.value, { value, type: typeName } = typedValue, parentElementsContext = (0, import_react36.useContext)(ElementsContext), profileUrl = props.profileUrl ?? (parentElementsContext == null ? void 0 : parentElementsContext.profileUrl), typeSchema = (0, import_react36.useMemo)(() => be(typeName, profileUrl), [profileUrl, typeName]), newElementsContext = (0, import_react36.useMemo)(() => {
    if (typeSchema)
      return Tr({ parentContext: parentElementsContext, elements: typeSchema.elements, path: props.path, profileUrl: typeSchema.url });
  }, [typeSchema, props.path, parentElementsContext]);
  if (S(value))
    return null;
  if (!typeSchema)
    return (0, import_jsx_runtime42.jsxs)("div", { children: [typeName, "not implemented"] });
  if (typeof value == "object" && "name" in value && Object.keys(value).length === 1 && typeof value.name == "string")
    return (0, import_jsx_runtime42.jsx)("div", { children: value.name });
  let elementsContext = newElementsContext ?? parentElementsContext;
  return maybeWrapWithContext(ElementsContext.Provider, newElementsContext, (0, import_jsx_runtime42.jsx)(DescriptionList, { compact: props.compact, children: Object.entries(elementsContext.elements).map(([key, property]) => {
    var _a;
    if (EXTENSION_KEYS.includes(key) && S((_a = property.slicing) == null ? void 0 : _a.slices))
      return null;
    if (IGNORED_PROPERTIES.includes(key))
      return null;
    if (DEFAULT_IGNORED_NON_NESTED_PROPERTIES.includes(key) && property.path.split(".").length === 2 || key.includes("."))
      return null;
    let [propertyValue, propertyType] = getValueAndType(typedValue, key, elementsContext.profileUrl);
    if ((props.ignoreMissingValues || property.max === 0) && S(propertyValue) || props.path.endsWith(".extension") && (key === "url" || key === "id"))
      return null;
    let isArrayProperty = property.max > 1 || property.isArray, resourcePropertyDisplay = (0, import_jsx_runtime42.jsx)(ResourcePropertyDisplay, { property, propertyType, path: props.path + "." + key, value: propertyValue, ignoreMissingValues: props.ignoreMissingValues, includeArrayDescriptionListEntry: isArrayProperty, link: props.link }, key);
    return isArrayProperty ? resourcePropertyDisplay : (0, import_jsx_runtime42.jsx)(DescriptionListEntry, { term: eu(key), children: resourcePropertyDisplay }, key);
  }) }));
}
function CheckboxFormSection(props) {
  let { debugMode } = (0, import_react39.useContext)(ElementsContext), label;
  return debugMode && props.fhirPath ? label = `${props.title} - ${props.fhirPath}` : label = props.title, (0, import_jsx_runtime43.jsxs)(Group, { wrap: "nowrap", "data-testid": props.testId, children: [(0, import_jsx_runtime43.jsx)("div", { children: props.children }), (0, import_jsx_runtime43.jsx)("div", { children: (0, import_jsx_runtime43.jsx)(Input.Wrapper, { id: props.htmlFor, label, description: props.description, withAsterisk: props.withAsterisk, children: null }) })] });
}
function getErrorsForInput(outcome, expression) {
  var _a, _b, _c;
  return (_c = (_b = (_a = outcome == null ? void 0 : outcome.issue) == null ? void 0 : _a.filter((issue) => {
    var _a2;
    return isExpressionMatch((_a2 = issue.expression) == null ? void 0 : _a2[0], expression);
  })) == null ? void 0 : _b.map((issue) => {
    var _a2;
    return (_a2 = issue.details) == null ? void 0 : _a2.text;
  })) == null ? void 0 : _c.join(`
`);
}
function getIssuesForExpression(outcome, expression) {
  var _a;
  return (_a = outcome == null ? void 0 : outcome.issue) == null ? void 0 : _a.filter((issue) => {
    var _a2;
    return isExpressionMatch((_a2 = issue.expression) == null ? void 0 : _a2[0], expression);
  });
}
function isExpressionMatch(expr1, expr2) {
  if (expr1 === expr2)
    return true;
  if (!expr1 || !expr2)
    return false;
  let dot1 = expr1.indexOf(".");
  if (dot1 >= 0 && expr1.substring(dot1 + 1) === expr2)
    return true;
  let dot2 = expr2.indexOf(".");
  return dot2 >= 0 && expr2.substring(dot2 + 1) === expr1;
}
function FormSection(props) {
  let { debugMode } = (0, import_react40.useContext)(ElementsContext), label;
  return debugMode && props.fhirPath ? label = `${props.title} - ${props.fhirPath}` : label = props.title, (0, import_jsx_runtime44.jsx)(Input.Wrapper, { id: props.htmlFor, label, description: props.description, withAsterisk: props.withAsterisk, error: getErrorsForInput(props.outcome, props.htmlFor), "data-testid": props.testId, children: props.children });
}
function setPropertyValue(obj, key, propName, elementDefinition, value) {
  let types = elementDefinition.type;
  if (types.length > 1)
    for (let type of types) {
      let compoundKey = key.replace("[x]", C(type.code));
      compoundKey in obj && delete obj[compoundKey];
    }
  return obj[propName] = value, obj;
}
function isSupportedProfileStructureDefinition(profile) {
  return !!profile && !S(profile.url) && !S(profile.name);
}
function CodeableConceptInput(props) {
  let { defaultValue: defaultValue2, onChange, withHelpText, ...rest } = props, [value, setValue] = (0, import_react42.useState)(defaultValue2);
  function handleChange(newValues) {
    let newConcept = valueSetElementToCodeableConcept(newValues);
    setValue(newConcept), onChange && onChange(newConcept);
  }
  return (0, import_jsx_runtime45.jsx)(ValueSetAutocomplete, { defaultValue: value && codeableConceptToValueSetElement(value), onChange: handleChange, withHelpText: withHelpText ?? true, ...rest });
}
function codeableConceptToValueSetElement(concept) {
  var _a;
  return (_a = concept.coding) == null ? void 0 : _a.map((c) => ({ system: c.system, code: c.code, display: c.display }));
}
function valueSetElementToCodeableConcept(elements) {
  if (elements.length !== 0)
    return { coding: elements.map((e) => ({ system: e.system, code: e.code, display: e.display })) };
}
function CodingInput(props) {
  let { defaultValue: defaultValue2, onChange, withHelpText, ...rest } = props, [value, setValue] = (0, import_react43.useState)(defaultValue2);
  function handleChange(newValues) {
    let newValue = newValues[0], newConcept = newValue && valueSetElementToCoding(newValue);
    setValue(newConcept), onChange && onChange(newConcept);
  }
  return (0, import_jsx_runtime46.jsx)(ValueSetAutocomplete, { defaultValue: value && codingToValueSetElement(value), maxValues: 1, onChange: handleChange, withHelpText: withHelpText ?? true, ...rest });
}
function codingToValueSetElement(coding) {
  return { system: coding.system, code: coding.code, display: coding.display };
}
function valueSetElementToCoding(element) {
  return { system: element.system, code: element.code, display: element.display };
}
function ContactPointInput(props) {
  let { path, outcome } = props, { elementsByPath } = (0, import_react45.useContext)(ElementsContext), [contactPoint, setContactPoint] = (0, import_react45.useState)(props.defaultValue), ref = (0, import_react45.useRef)();
  ref.current = contactPoint;
  let [systemElement, useElement, valueElement] = (0, import_react45.useMemo)(() => ["system", "use", "value"].map((field) => elementsByPath[path + "." + field]), [elementsByPath, path]);
  function setContactPointWrapper(newValue) {
    newValue && Object.keys(newValue).length === 0 && (newValue = void 0), setContactPoint(newValue), props.onChange && props.onChange(newValue);
  }
  function setSystem(system) {
    let newValue = { ...ref.current, system };
    system || delete newValue.system, setContactPointWrapper(newValue);
  }
  function setUse(use) {
    let newValue = { ...ref.current, use };
    use || delete newValue.use, setContactPointWrapper(newValue);
  }
  function setValue(value) {
    let newValue = { ...ref.current, value };
    value || delete newValue.value, setContactPointWrapper(newValue);
  }
  return (0, import_jsx_runtime47.jsxs)(Group, { gap: "xs", grow: true, wrap: "nowrap", align: "flex-start", children: [(0, import_jsx_runtime47.jsx)(NativeSelect, { "data-testid": "system", defaultValue: contactPoint == null ? void 0 : contactPoint.system, required: ((systemElement == null ? void 0 : systemElement.min) ?? 0) > 0, onChange: (e) => setSystem(e.currentTarget.value), data: ["", "email", "phone", "fax", "pager", "sms", "other"], error: getErrorsForInput(outcome, path + ".system") }), (0, import_jsx_runtime47.jsx)(NativeSelect, { "data-testid": "use", defaultValue: contactPoint == null ? void 0 : contactPoint.use, required: ((useElement == null ? void 0 : useElement.min) ?? 0) > 0, onChange: (e) => setUse(e.currentTarget.value), data: ["", "home", "work", "temp", "old", "mobile"], error: getErrorsForInput(outcome, path + ".use") }), (0, import_jsx_runtime47.jsx)(TextInput, { placeholder: "Value", defaultValue: contactPoint == null ? void 0 : contactPoint.value, required: ((valueElement == null ? void 0 : valueElement.min) ?? 0) > 0, onChange: (e) => setValue(e.currentTarget.value), error: getErrorsForInput(outcome, path + ".value") })] });
}
function ContactDetailInput(props) {
  var _a;
  let [contactPoint, setContactDetail] = (0, import_react44.useState)(props.defaultValue), ref = (0, import_react44.useRef)();
  ref.current = contactPoint;
  function setContactDetailWrapper(newValue) {
    setContactDetail(newValue), props.onChange && props.onChange(newValue);
  }
  function setName(name) {
    let newValue = { ...ref.current, name };
    name || delete newValue.name, setContactDetailWrapper(newValue);
  }
  function setTelecom(telecom) {
    let newValue = { ...ref.current, telecom: telecom && [telecom] };
    telecom || delete newValue.telecom, setContactDetailWrapper(newValue);
  }
  return (0, import_jsx_runtime48.jsxs)(Group, { gap: "xs", grow: true, wrap: "nowrap", children: [(0, import_jsx_runtime48.jsx)(TextInput, { "data-testid": props.name + "-name", name: props.name + "-name", placeholder: "Name", style: { width: 180 }, defaultValue: contactPoint == null ? void 0 : contactPoint.name, onChange: (e) => setName(e.currentTarget.value) }), (0, import_jsx_runtime48.jsx)(ContactPointInput, { name: props.name + "-telecom", path: props.path + ".telecom", defaultValue: (_a = contactPoint == null ? void 0 : contactPoint.telecom) == null ? void 0 : _a[0], onChange: setTelecom, outcome: props.outcome })] });
}
function convertIsoToLocal(isoString) {
  if (!isoString)
    return "";
  let date = new Date(isoString);
  return ir(date) ? date.toLocaleDateString("sv") + "T" + date.toLocaleTimeString("sv") : "";
}
function convertLocalToIso(localString) {
  if (!localString)
    return "";
  let date = new Date(localString);
  return ir(date) ? date.toISOString() : "";
}
function DateTimeInput(props) {
  return (0, import_jsx_runtime49.jsx)(TextInput, { id: props.name, name: props.name, "data-autofocus": props.autoFocus, "data-testid": props.name, placeholder: props.placeholder, required: props.required, type: getInputType(), defaultValue: convertIsoToLocal(props.defaultValue), autoFocus: props.autoFocus, error: getErrorsForInput(props.outcome, props.name), onChange: (e) => {
    if (props.onChange) {
      let newValue = e.currentTarget.value;
      props.onChange(convertLocalToIso(newValue));
    }
  } });
}
function getInputType() {
  return "datetime-local";
}
function ExtensionInput(props) {
  let { propertyType } = props, medplum = a(), [typeSchema, setTypeSchema] = (0, import_react46.useState)(), profileUrl = (0, import_react46.useMemo)(() => {
    if (G(propertyType.profile))
      return propertyType.profile[0];
  }, [propertyType]), [loadingProfile, setLoadingProfile] = (0, import_react46.useState)(profileUrl !== void 0);
  return (0, import_react46.useEffect)(() => {
    profileUrl && (setLoadingProfile(true), medplum.requestProfileSchema(profileUrl).then(() => {
      let profile = Kr(profileUrl);
      setLoadingProfile(false), setTypeSchema(profile);
    }).catch((reason) => {
      setLoadingProfile(false), console.warn(reason);
    }));
  }, [medplum, profileUrl]), profileUrl && (loadingProfile || !Wr(profileUrl)) ? (0, import_jsx_runtime50.jsx)("div", { children: "Loading..." }) : (0, import_jsx_runtime50.jsx)(BackboneElementInput, { profileUrl, path: props.path, typeName: (typeSchema == null ? void 0 : typeSchema.name) ?? "Extension", defaultValue: props.defaultValue, onChange: props.onChange });
}
function HumanNameInput(props) {
  var _a, _b, _c;
  let { outcome, path } = props, [value, setValue] = (0, import_react47.useState)(props.defaultValue);
  function setValueWrapper(newValue) {
    setValue(newValue), props.onChange && props.onChange(newValue);
  }
  function setUse(use) {
    setValueWrapper({ ...value, use: use || void 0 });
  }
  function setPrefix(prefix) {
    setValueWrapper({ ...value, prefix: prefix ? prefix.split(" ") : void 0 });
  }
  function setGiven(given) {
    setValueWrapper({ ...value, given: given ? given.split(" ") : void 0 });
  }
  function setFamily(family) {
    setValueWrapper({ ...value, family: family || void 0 });
  }
  function setSuffix(suffix) {
    setValueWrapper({ ...value, suffix: suffix ? suffix.split(" ") : void 0 });
  }
  return (0, import_jsx_runtime51.jsxs)(Group, { gap: "xs", grow: true, wrap: "nowrap", children: [(0, import_jsx_runtime51.jsx)(NativeSelect, { defaultValue: value == null ? void 0 : value.use, name: props.name + "-use", "data-testid": "use", onChange: (e) => setUse(e.currentTarget.value), data: ["", "temp", "old", "usual", "official", "nickname", "anonymous", "maiden"], error: getErrorsForInput(outcome, path + ".use") }), (0, import_jsx_runtime51.jsx)(TextInput, { placeholder: "Prefix", name: props.name + "-prefix", defaultValue: (_a = value == null ? void 0 : value.prefix) == null ? void 0 : _a.join(" "), onChange: (e) => setPrefix(e.currentTarget.value), error: getErrorsForInput(outcome, path + ".prefix") }), (0, import_jsx_runtime51.jsx)(TextInput, { placeholder: "Given", name: props.name + "-given", defaultValue: (_b = value == null ? void 0 : value.given) == null ? void 0 : _b.join(" "), onChange: (e) => setGiven(e.currentTarget.value), error: getErrorsForInput(outcome, path + ".given") }), (0, import_jsx_runtime51.jsx)(TextInput, { name: props.name + "-family", placeholder: "Family", defaultValue: value == null ? void 0 : value.family, onChange: (e) => setFamily(e.currentTarget.value), error: getErrorsForInput(outcome, path + ".family") }), (0, import_jsx_runtime51.jsx)(TextInput, { placeholder: "Suffix", name: props.name + "-suffix", defaultValue: (_c = value == null ? void 0 : value.suffix) == null ? void 0 : _c.join(" "), onChange: (e) => setSuffix(e.currentTarget.value), error: getErrorsForInput(outcome, path + ".suffix") })] });
}
function IdentifierInput(props) {
  let { path, outcome } = props, [value, setValue] = (0, import_react48.useState)(props.defaultValue), { elementsByPath } = (0, import_react48.useContext)(ElementsContext), [systemElement, valueElement] = (0, import_react48.useMemo)(() => ["system", "value"].map((field) => elementsByPath[path + "." + field]), [elementsByPath, path]);
  function setValueWrapper(newValue) {
    setValue(newValue), props.onChange && props.onChange(newValue);
  }
  return (0, import_jsx_runtime52.jsxs)(Group, { gap: "xs", grow: true, wrap: "nowrap", align: "flex-start", children: [(0, import_jsx_runtime52.jsx)(TextInput, { placeholder: "System", required: ((systemElement == null ? void 0 : systemElement.min) ?? 0) > 0, defaultValue: value == null ? void 0 : value.system, onChange: (e) => setValueWrapper({ ...value, system: e.currentTarget.value }), error: getErrorsForInput(outcome, path + ".system") }), (0, import_jsx_runtime52.jsx)(TextInput, { placeholder: "Value", required: ((valueElement == null ? void 0 : valueElement.min) ?? 0) > 0, defaultValue: value == null ? void 0 : value.value, onChange: (e) => setValueWrapper({ ...value, value: e.currentTarget.value }), error: getErrorsForInput(outcome, path + ".value") })] });
}
var data = ["USD", "EUR", "CAD", "GBP", "AUD"];
function MoneyInput(props) {
  var _a;
  let { onChange } = props, [value, setValue] = (0, import_react49.useState)(props.defaultValue), setValueWrapper = (0, import_react49.useCallback)((newValue) => {
    setValue(newValue), onChange && onChange(newValue);
  }, [onChange]), handleCurrencyChange = (0, import_react49.useCallback)((e) => {
    setValueWrapper({ ...value, currency: e.currentTarget.value });
  }, [value, setValueWrapper]), handleValueChange = (0, import_react49.useCallback)((e) => {
    setValueWrapper({ ...value, value: e.currentTarget.valueAsNumber });
  }, [value, setValueWrapper]), select = (0, import_jsx_runtime53.jsx)(NativeSelect, { defaultValue: value == null ? void 0 : value.currency, data, styles: { input: { fontWeight: 500, borderTopLeftRadius: 0, borderBottomLeftRadius: 0, width: 92 } }, onChange: handleCurrencyChange });
  return (0, import_jsx_runtime53.jsx)(TextInput, { type: "number", name: props.name, label: props.label, placeholder: props.placeholder ?? "Value", defaultValue: ((_a = value == null ? void 0 : value.value) == null ? void 0 : _a.toString()) ?? "USD", leftSection: (0, import_jsx_runtime53.jsx)(IconCurrencyDollar, { size: 14 }), rightSection: select, rightSectionWidth: 92, onChange: handleValueChange });
}
function PeriodInput(props) {
  let [value, setValue] = (0, import_react50.useState)(props.defaultValue);
  function setValueWrapper(newValue) {
    setValue(newValue), props.onChange && props.onChange(newValue);
  }
  return (0, import_jsx_runtime54.jsxs)(Group, { gap: "xs", grow: true, wrap: "nowrap", children: [(0, import_jsx_runtime54.jsx)(DateTimeInput, { name: props.name + ".start", placeholder: "Start", defaultValue: value == null ? void 0 : value.start, onChange: (newValue) => setValueWrapper({ ...value, start: newValue }) }), (0, import_jsx_runtime54.jsx)(DateTimeInput, { name: props.name + ".end", placeholder: "End", defaultValue: value == null ? void 0 : value.end, onChange: (newValue) => setValueWrapper({ ...value, end: newValue }) })] });
}
function QuantityInput(props) {
  let [value, setValue] = (0, import_react51.useState)(props.defaultValue);
  function setValueWrapper(newValue) {
    setValue(newValue), props.onChange && props.onChange(newValue);
  }
  return (0, import_jsx_runtime55.jsxs)(Group, { gap: "xs", grow: true, wrap: "nowrap", children: [(0, import_jsx_runtime55.jsx)(NativeSelect, { style: { width: 80 }, "data-testid": props.name + "-comparator", defaultValue: value == null ? void 0 : value.comparator, data: ["", "<", "<=", ">=", ">"], onChange: (e) => setValueWrapper({ ...value, comparator: e.currentTarget.value }) }), (0, import_jsx_runtime55.jsx)(TextInput, { id: props.name, name: props.name, required: props.required, "data-autofocus": props.autoFocus, "data-testid": props.name + "-value", type: "number", placeholder: "Value", defaultValue: value == null ? void 0 : value.value, autoFocus: props.autoFocus, step: "any", onWheel: (e) => {
    props.disableWheel && e.currentTarget.blur();
  }, onChange: (e) => {
    setValueWrapper({ ...value, value: tryParseNumber(e.currentTarget.value) });
  } }), (0, import_jsx_runtime55.jsx)(TextInput, { placeholder: "Unit", "data-testid": props.name + "-unit", defaultValue: value == null ? void 0 : value.unit, onChange: (e) => setValueWrapper({ ...value, unit: e.currentTarget.value }) })] });
}
function tryParseNumber(str) {
  if (str)
    return parseFloat(str);
}
function RangeInput(props) {
  let [value, setValue] = (0, import_react52.useState)(props.defaultValue);
  function setValueWrapper(newValue) {
    setValue(newValue), props.onChange && props.onChange(newValue);
  }
  return (0, import_jsx_runtime56.jsxs)(Group, { gap: "xs", grow: true, wrap: "nowrap", children: [(0, import_jsx_runtime56.jsx)(QuantityInput, { name: props.name + "-low", defaultValue: value == null ? void 0 : value.low, onChange: (v2) => setValueWrapper({ ...value, low: v2 }) }), (0, import_jsx_runtime56.jsx)(QuantityInput, { name: props.name + "-high", defaultValue: value == null ? void 0 : value.high, onChange: (v2) => setValueWrapper({ ...value, high: v2 }) })] });
}
function RatioInput(props) {
  let [value, setValue] = (0, import_react53.useState)(props.defaultValue);
  function setValueWrapper(newValue) {
    setValue(newValue), props.onChange && props.onChange(newValue);
  }
  return (0, import_jsx_runtime57.jsxs)(Group, { gap: "xs", grow: true, wrap: "nowrap", children: [(0, import_jsx_runtime57.jsx)(QuantityInput, { name: props.name + "-numerator", defaultValue: value == null ? void 0 : value.numerator, onChange: (v2) => setValueWrapper({ ...value, numerator: v2 }) }), (0, import_jsx_runtime57.jsx)(QuantityInput, { name: props.name + "-denominator", defaultValue: value == null ? void 0 : value.denominator, onChange: (v2) => setValueWrapper({ ...value, denominator: v2 }) })] });
}
var SEARCH_CODES = { Observation: "code", User: "email:contains" };
var NAME_RESOURCE_TYPES = ["AccessPolicy", "Account", "ActivityDefinition", "Bot", "CapabilityStatement", "CareTeam", "ClientApplication", "CodeSystem", "CompartmentDefinition", "ConceptMap", "EffectEvidenceSynthesis", "Endpoint", "EventDefinition", "Evidence", "EvidenceVariable", "ExampleScenario", "GraphDefinition", "Group", "HealthcareService", "ImplementationGuide", "InsurancePlan", "Library", "Location", "Measure", "MedicinalProduct", "MessageDefinition", "NamingSystem", "OperationDefinition", "Organization", "Patient", "Person", "PlanDefinition", "Practitioner", "Project", "Questionnaire", "RelatedPerson", "ResearchDefinition", "ResearchElementDefinition", "RiskEvidenceSynthesis", "SearchParameter", "StructureDefinition", "StructureMap", "TerminologyCapabilities", "TestScript", "UserConfiguration", "ValueSet"];
function toOption3(resource) {
  return { value: X(resource), label: Oi(resource), resource };
}
function ResourceInput(props) {
  let medplum = a(), { resourceType, searchCriteria } = props, [outcome, setOutcome] = (0, import_react55.useState)(), defaultValue2 = ce(props.defaultValue, setOutcome), onChange = props.onChange, loadValues = (0, import_react55.useCallback)(async (input, signal) => {
    let searchCode = getSearchParamForResourceType(resourceType), searchParams = new URLSearchParams({ [searchCode]: input ?? "", _count: "10", ...searchCriteria });
    return await medplum.searchResources(resourceType, searchParams, { signal });
  }, [medplum, resourceType, searchCriteria]), handleChange = (0, import_react55.useCallback)((newResources) => {
    onChange && onChange(newResources[0]);
  }, [onChange]);
  return G(props.defaultValue) && !outcome && !defaultValue2 ? null : (0, import_jsx_runtime58.jsx)(AsyncAutocomplete, { name: props.name, required: props.required, itemComponent: ItemComponent3, defaultValue: defaultValue2, placeholder: props.placeholder, maxValues: 1, toOption: toOption3, loadOptions: loadValues, onChange: handleChange, clearable: true });
}
var ItemComponent3 = (0, import_react55.forwardRef)(({ label, resource, ...others }, ref) => (0, import_jsx_runtime58.jsx)("div", { ref, ...others, children: (0, import_jsx_runtime58.jsxs)(Group, { wrap: "nowrap", children: [(0, import_jsx_runtime58.jsx)(ResourceAvatar, { value: resource }), (0, import_jsx_runtime58.jsxs)("div", { children: [(0, import_jsx_runtime58.jsx)(Text, { children: label }), (0, import_jsx_runtime58.jsx)(Text, { size: "xs", c: "dimmed", children: resource.birthDate })] })] }) }));
function getSearchParamForResourceType(resourceType) {
  return SEARCH_CODES[resourceType] ?? (NAME_RESOURCE_TYPES.includes(resourceType) ? "name" : "_id");
}
function ReferenceInput(props) {
  let { onChange } = props, medplum = a(), [value, setValue] = (0, import_react54.useState)(props.defaultValue), [targetTypes, setTargetTypes] = (0, import_react54.useState)(() => createTargetTypes(props.targetTypes)), [targetType, setTargetType] = (0, import_react54.useState)(() => getInitialTargetType(props.defaultValue, targetTypes)), promiseCache = (0, import_react54.useRef)(new mt()), searchCriteria = (0, import_react54.useMemo)(() => (targetType == null ? void 0 : targetType.type) === "profile" ? { ...props.searchCriteria, _profile: targetType.value } : props.searchCriteria, [props.searchCriteria, targetType]);
  (0, import_react54.useEffect)(() => {
    let anyToFetch = false, newTargetTypePromises = targetTypes == null ? void 0 : targetTypes.map((tt) => {
      if (!shouldFetchResourceType(tt))
        return Promise.resolve(tt);
      anyToFetch = true;
      let cacheKey = tt.value, cached = promiseCache.current.get(cacheKey);
      if (cached)
        return cached;
      let promise = fetchResourceTypeOfProfile(medplum, tt.value).then((profile) => {
        let newTargetType = { ...tt };
        return profile ? G(profile.type) ? (newTargetType.resourceType = profile.type, newTargetType.name = profile.name, newTargetType.title = profile.title) : (console.error(`StructureDefinition.type missing for ${tt.value}`), newTargetType.error = "StructureDefinition.type missing") : (console.error(`StructureDefinition not found for ${tt.value}`), newTargetType.error = "StructureDefinition not found"), newTargetType;
      }).catch((reason) => (console.error(reason), { ...tt, error: reason })), readablePromise = new k(promise);
      return promiseCache.current.set(cacheKey, readablePromise), readablePromise;
    });
    !newTargetTypePromises || !anyToFetch || Promise.all(newTargetTypePromises).then((newTargetTypes) => {
      if (setTargetTypes(newTargetTypes), !targetType)
        return;
      let index = newTargetTypes.findIndex((tt) => tt.value === targetType.value || tt.resourceType === targetType.resourceType);
      if (index === -1) {
        console.debug(`defaultValue had unexpected resourceType: ${targetType.resourceType}`);
        return;
      }
      setTargetType(newTargetTypes[index]);
    }).catch(console.error);
  }, [medplum, targetType, targetTypes]);
  let setValueHelper = (0, import_react54.useCallback)((item) => {
    let newValue = item ? Z(item) : void 0;
    setValue(newValue), onChange && onChange(newValue);
  }, [onChange]), typeSelectOptions = (0, import_react54.useMemo)(() => targetTypes ? targetTypes.map((tt) => ({ value: tt.value, label: tt.type === "profile" ? tt.title ?? tt.name ?? tt.resourceType ?? tt.value : tt.value })) : [], [targetTypes]);
  return (0, import_jsx_runtime59.jsxs)(Group, { gap: "xs", grow: true, wrap: "nowrap", children: [targetTypes && targetTypes.length > 1 && (0, import_jsx_runtime59.jsx)(NativeSelect, { "data-autofocus": props.autoFocus, "data-testid": "reference-input-resource-type-select", defaultValue: targetType == null ? void 0 : targetType.resourceType, autoFocus: props.autoFocus, onChange: (e) => {
    let newValue = e.currentTarget.value, newTargetType = targetTypes.find((tt) => tt.value === newValue);
    setTargetType(newTargetType);
  }, data: typeSelectOptions }), !targetTypes && (0, import_jsx_runtime59.jsx)(ResourceTypeInput, { autoFocus: props.autoFocus, testId: "reference-input-resource-type-input", defaultValue: targetType == null ? void 0 : targetType.resourceType, onChange: (newResourceType) => {
    setTargetType(newResourceType ? { type: "resourceType", value: newResourceType, resourceType: newResourceType } : void 0);
  }, name: props.name + "-resourceType", placeholder: "Resource Type" }), (0, import_jsx_runtime59.jsx)(ResourceInput, { resourceType: targetType == null ? void 0 : targetType.resourceType, name: props.name + "-id", required: props.required, placeholder: props.placeholder, defaultValue: value, searchCriteria, onChange: setValueHelper })] });
}
function createTargetTypes(resourceTypesAndProfileUrls) {
  if (!resourceTypesAndProfileUrls || resourceTypesAndProfileUrls.length === 0 || resourceTypesAndProfileUrls.length === 1 && resourceTypesAndProfileUrls[0] === "Resource")
    return;
  let results = [];
  for (let value of resourceTypesAndProfileUrls)
    value.includes("/") ? results.push({ type: "profile", value }) : results.push({ type: "resourceType", value, resourceType: value });
  return results;
}
function getInitialTargetType(defaultValue2, targetTypes) {
  var _a;
  let defaultValueResourceType = (_a = defaultValue2 == null ? void 0 : defaultValue2.reference) == null ? void 0 : _a.split("/")[0];
  if (defaultValueResourceType) {
    let targetType = targetTypes == null ? void 0 : targetTypes.find((tt) => tt.resourceType === defaultValueResourceType);
    return targetType || { type: "resourceType", value: defaultValueResourceType, resourceType: defaultValueResourceType };
  }
  if (targetTypes && targetTypes.length > 0)
    return targetTypes[0];
}
async function fetchResourceTypeOfProfile(medplum, profileUrl) {
  let profile = Kr(profileUrl);
  if (profile)
    return { type: profile.type, name: profile.name, title: profile.title };
  let query = `{
      StructureDefinitionList(url: "${profileUrl}", _sort: "_lastUpdated", _count: 1) {
        type,
        name,
        title,
      }
    }`.replace(/\s+/g, " ");
  return (await medplum.graphql(query)).data.StructureDefinitionList[0];
}
function shouldFetchResourceType(targetType) {
  return targetType.type === "profile" && !(targetType == null ? void 0 : targetType.error) && S(targetType.resourceType);
}
function ArrayAddButton({ propertyDisplayName, onClick, testId }) {
  let text = propertyDisplayName ? `Add ${propertyDisplayName}` : "Add";
  return propertyDisplayName ? (0, import_jsx_runtime60.jsx)(Button, { title: text, size: "sm", color: "green.6", variant: "subtle", "data-testid": testId, leftSection: (0, import_jsx_runtime60.jsx)(IconCirclePlus, { size: "1.25rem" }), onClick, children: text }) : (0, import_jsx_runtime60.jsx)(ActionIcon, { title: text, color: "green.6", "data-testid": testId, onClick, children: (0, import_jsx_runtime60.jsx)(IconCirclePlus, { size: "1.25rem" }) });
}
function ArrayRemoveButton({ propertyDisplayName, onClick, testId }) {
  return (0, import_jsx_runtime61.jsx)(ActionIcon, { title: propertyDisplayName ? `Remove ${propertyDisplayName}` : "Remove", color: "red.5", "data-testid": testId, variant: "subtle", onClick, children: (0, import_jsx_runtime61.jsx)(IconCircleMinus, { size: "1.25rem" }) });
}
var ResourceArrayInput_default = { indented: "ResourceArrayInput_indented" };
function SliceInput(props) {
  var _a, _b;
  let { slice, property } = props, [values2, setValues] = (0, import_react57.useState)(props.defaultValue), sliceElements = ((_a = slice.typeSchema) == null ? void 0 : _a.elements) ?? slice.elements, parentElementsContextValue = (0, import_react57.useContext)(ElementsContext), contextValue = (0, import_react57.useMemo)(() => {
    var _a2;
    if (G(sliceElements))
      return Tr({ parentContext: parentElementsContextValue, elements: sliceElements, path: props.path, profileUrl: (_a2 = slice.typeSchema) == null ? void 0 : _a2.url });
  }, [parentElementsContextValue, props.path, (_b = slice.typeSchema) == null ? void 0 : _b.url, sliceElements]);
  function setValuesWrapper(newValues) {
    setValues(newValues), props.onChange && props.onChange(newValues);
  }
  let required = slice.min > 0, indentedStack = S(slice.elements), propertyDisplayName = ro(slice.name);
  return maybeWrapWithContext(ElementsContext.Provider, contextValue, (0, import_jsx_runtime62.jsx)(FormSection, { title: propertyDisplayName, description: slice.definition, withAsterisk: required, fhirPath: `${property.path}:${slice.name}`, testId: props.testId, children: (0, import_jsx_runtime62.jsxs)(Stack, { className: indentedStack ? ResourceArrayInput_default.indented : void 0, children: [values2.map((value, valueIndex) => (0, import_jsx_runtime62.jsxs)(Group, { wrap: "nowrap", children: [(0, import_jsx_runtime62.jsx)("div", { style: { flexGrow: 1 }, "data-testid": props.testId && `${props.testId}-elements-${valueIndex}`, children: (0, import_jsx_runtime62.jsx)(ElementDefinitionTypeInput, { elementDefinitionType: slice.type[0], name: slice.name, defaultValue: value, onChange: (newValue) => {
    let newValues = [...values2];
    newValues[valueIndex] = newValue, setValuesWrapper(newValues);
  }, outcome: props.outcome, min: slice.min, max: slice.max, binding: slice.binding, path: props.path }) }), values2.length > slice.min && (0, import_jsx_runtime62.jsx)(ArrayRemoveButton, { propertyDisplayName, testId: props.testId && `${props.testId}-remove-${valueIndex}`, onClick: (e) => {
    killEvent(e);
    let newValues = [...values2];
    newValues.splice(valueIndex, 1), setValuesWrapper(newValues);
  } })] }, `${valueIndex}-${values2.length}`)), values2.length < slice.max && (0, import_jsx_runtime62.jsx)(Group, { wrap: "nowrap", style: { justifyContent: "flex-start" }, children: (0, import_jsx_runtime62.jsx)(ArrayAddButton, { propertyDisplayName, onClick: (e) => {
    killEvent(e);
    let newValues = [...values2, void 0];
    setValuesWrapper(newValues);
  }, testId: props.testId && `${props.testId}-add` }) })] }) }));
}
function ResourceArrayInput(props) {
  var _a;
  let { property } = props, medplum = a(), [loading, setLoading] = (0, import_react56.useState)(true), [slices, setSlices] = (0, import_react56.useState)([]), [defaultValue2] = (0, import_react56.useState)(() => Array.isArray(props.defaultValue) ? props.defaultValue : []), [slicedValues, setSlicedValues] = (0, import_react56.useState)(() => [defaultValue2]), ctx = (0, import_react56.useContext)(ElementsContext), propertyTypeCode = (_a = property.type[0]) == null ? void 0 : _a.code;
  (0, import_react56.useEffect)(() => {
    prepareSlices({ medplum, property }).then((slices2) => {
      setSlices(slices2);
      let slicedValues2 = assignValuesIntoSlices(defaultValue2, slices2, property.slicing, ctx.profileUrl);
      addPlaceholderValues(slicedValues2, slices2), setSlicedValues(slicedValues2), setLoading(false);
    }).catch((reason) => {
      console.error(reason), setLoading(false);
    });
  }, [medplum, property, defaultValue2, ctx.profileUrl, setSlicedValues]);
  function setValuesWrapper(newValues, sliceIndex) {
    let newSlicedValues = [...slicedValues];
    if (newSlicedValues[sliceIndex] = newValues, setSlicedValues(newSlicedValues), props.onChange) {
      let cleaned = newSlicedValues.flat().filter((val) => val !== void 0);
      props.onChange(cleaned);
    }
  }
  if (loading)
    return (0, import_jsx_runtime63.jsx)("div", { children: "Loading..." });
  let nonSliceIndex = slices.length, nonSliceValues = slicedValues[nonSliceIndex], showNonSliceValues = !(props.hideNonSliceValues ?? (propertyTypeCode === "Extension" && slices.length > 0)), propertyDisplayName = eu(property.path);
  return (0, import_jsx_runtime63.jsxs)(Stack, { className: props.indent ? ResourceArrayInput_default.indented : void 0, children: [slices.map((slice, sliceIndex) => (0, import_jsx_runtime63.jsx)(SliceInput, { slice, path: props.path, property, defaultValue: slicedValues[sliceIndex], onChange: (newValue) => {
    setValuesWrapper(newValue, sliceIndex);
  }, testId: `slice-${slice.name}` }, slice.name)), showNonSliceValues && nonSliceValues.map((value, valueIndex) => (0, import_jsx_runtime63.jsxs)(Group, { wrap: "nowrap", style: { flexGrow: 1 }, children: [(0, import_jsx_runtime63.jsx)("div", { style: { flexGrow: 1 }, children: (0, import_jsx_runtime63.jsx)(ResourcePropertyInput, { arrayElement: true, property: props.property, name: props.name + "." + valueIndex, path: props.path, defaultValue: value, onChange: (newValue) => {
    let newNonSliceValues = [...nonSliceValues];
    newNonSliceValues[valueIndex] = newValue, setValuesWrapper(newNonSliceValues, nonSliceIndex);
  }, defaultPropertyType: void 0, outcome: props.outcome }) }), (0, import_jsx_runtime63.jsx)(ArrayRemoveButton, { propertyDisplayName, testId: `nonsliced-remove-${valueIndex}`, onClick: (e) => {
    killEvent(e);
    let newNonSliceValues = [...nonSliceValues];
    newNonSliceValues.splice(valueIndex, 1), setValuesWrapper(newNonSliceValues, nonSliceIndex);
  } })] }, `${valueIndex}-${nonSliceValues.length}`)), showNonSliceValues && slicedValues.flat().length < property.max && (0, import_jsx_runtime63.jsx)(Group, { wrap: "nowrap", style: { justifyContent: "flex-start" }, children: (0, import_jsx_runtime63.jsx)(ArrayAddButton, { propertyDisplayName, onClick: (e) => {
    killEvent(e);
    let newNonSliceValues = [...nonSliceValues];
    newNonSliceValues.push(void 0), setValuesWrapper(newNonSliceValues, nonSliceIndex);
  }, testId: "nonsliced-add" }) })] });
}
function addPlaceholderValues(slicedValues, slices) {
  for (let sliceIndex = 0; sliceIndex < slices.length; sliceIndex++) {
    let slice = slices[sliceIndex], sliceValues = slicedValues[sliceIndex];
    for (; sliceValues.length < slice.min; )
      sliceValues.push(void 0);
  }
}
function SensitiveTextarea(props) {
  let [revealed, setRevealed] = (0, import_react58.useState)(false), clipboard = useClipboard(), ref = (0, import_react58.useRef)(null), styles = { ...props.styles };
  return revealed || (styles.input || (styles.input = {}), styles.input.WebkitTextSecurity = "disc"), (0, import_jsx_runtime64.jsxs)(Flex, { gap: "xs", children: [(0, import_jsx_runtime64.jsx)(Textarea, { ...props, styles: { ...styles, root: { ...styles.root ?? {}, flexGrow: 1 } }, ref, autosize: true, minRows: 1, onFocus: () => setRevealed(true), onBlur: () => setRevealed(false) }), (0, import_jsx_runtime64.jsx)(ActionIcon, { title: "Copy secret", onClick: () => {
    var _a;
    clipboard.copy((_a = ref.current) == null ? void 0 : _a.value), showNotification({ color: "green", message: "Copied" });
  }, children: (0, import_jsx_runtime64.jsx)(IconCopy, {}) })] });
}
var daysOfWeek = ["sun", "mon", "tue", "wed", "thu", "fri", "sat"];
function TimingInput(props) {
  let [value, setValue] = (0, import_react59.useState)(props.defaultValue), [open, setOpen] = (0, import_react59.useState)(false), valueRef = (0, import_react59.useRef)();
  return valueRef.current = value, (0, import_jsx_runtime65.jsxs)(import_jsx_runtime65.Fragment, { children: [(0, import_jsx_runtime65.jsxs)(Group, { gap: "xs", grow: true, wrap: "nowrap", children: [(0, import_jsx_runtime65.jsx)("span", { children: qc(valueRef.current) || "No repeat" }), (0, import_jsx_runtime65.jsx)(Button, { onClick: () => setOpen(true), children: "Edit" })] }), (0, import_jsx_runtime65.jsx)(TimingEditorDialog, { visible: open, defaultValue: valueRef.current, onOk: (newValue) => {
    props.onChange && props.onChange(newValue), setValue(newValue), setOpen(false);
  }, onCancel: () => setOpen(false) })] });
}
var defaultValue = { repeat: { period: 1, periodUnit: "d" } };
function TimingEditorDialog(props) {
  let [value, setValue] = (0, import_react59.useState)(props.defaultValue || defaultValue), valueRef = (0, import_react59.useRef)();
  valueRef.current = value;
  function setStart(newStart) {
    setValue({ ...valueRef.current, event: [newStart] });
  }
  function setRepeat(repeat) {
    setValue({ ...valueRef.current, repeat });
  }
  function setPeriod(newPeriod) {
    var _a;
    setRepeat({ ...(_a = valueRef.current) == null ? void 0 : _a.repeat, period: newPeriod });
  }
  function setPeriodUnit(newPeriodUnit) {
    var _a;
    setRepeat({ ...(_a = valueRef.current) == null ? void 0 : _a.repeat, periodUnit: newPeriodUnit });
  }
  function setDaysOfWeek(newDaysOfWeek) {
    var _a;
    setRepeat({ ...(_a = valueRef.current) == null ? void 0 : _a.repeat, dayOfWeek: newDaysOfWeek });
  }
  return (0, import_jsx_runtime65.jsx)(Modal, { title: "Timing", closeButtonProps: { "aria-label": "Close" }, opened: props.visible, onClose: () => props.onCancel(), children: (0, import_jsx_runtime65.jsxs)(Stack, { children: [(0, import_jsx_runtime65.jsx)(FormSection, { title: "Starts on", htmlFor: "timing-dialog-start", children: (0, import_jsx_runtime65.jsx)(DateTimeInput, { name: "timing-dialog-start", onChange: (newValue) => setStart(newValue) }) }), (0, import_jsx_runtime65.jsx)(Switch, { label: "Repeat", checked: !!value.repeat, onChange: (e) => setRepeat(e.currentTarget.checked ? defaultValue.repeat : void 0) }), value.repeat && (0, import_jsx_runtime65.jsxs)(import_jsx_runtime65.Fragment, { children: [(0, import_jsx_runtime65.jsx)(FormSection, { title: "Repeat every", htmlFor: "timing-dialog-period", children: (0, import_jsx_runtime65.jsxs)(Group, { gap: "xs", grow: true, wrap: "nowrap", children: [(0, import_jsx_runtime65.jsx)(TextInput, { type: "number", step: 1, id: "timing-dialog-period", name: "timing-dialog-period", defaultValue: value.repeat.period || 1, onChange: (e) => setPeriod(parseInt(e.currentTarget.value, 10) || 1) }), (0, import_jsx_runtime65.jsx)(NativeSelect, { id: "timing-dialog-periodUnit", name: "timing-dialog-periodUnit", defaultValue: value.repeat.periodUnit, onChange: (e) => setPeriodUnit(e.currentTarget.value), data: [{ label: "second", value: "s" }, { label: "minute", value: "min" }, { label: "hour", value: "h" }, { label: "day", value: "d" }, { label: "week", value: "wk" }, { label: "month", value: "mo" }, { label: "year", value: "a" }] })] }) }), value.repeat.periodUnit === "wk" && (0, import_jsx_runtime65.jsx)(FormSection, { title: "Repeat on", children: (0, import_jsx_runtime65.jsx)(Chip.Group, { multiple: true, onChange: setDaysOfWeek, children: (0, import_jsx_runtime65.jsx)(Group, { justify: "space-between", mt: "md", gap: "xs", children: daysOfWeek.map((day) => (0, import_jsx_runtime65.jsx)(Chip, { value: day, size: "xs", radius: "xl", children: day.charAt(0).toUpperCase() }, day)) }) }) })] }), (0, import_jsx_runtime65.jsx)(Group, { justify: "flex-end", children: (0, import_jsx_runtime65.jsx)(Button, { onClick: () => props.onOk(value), children: "OK" }) })] }) });
}
function ResourcePropertyInput(props) {
  var _a;
  let { property, name, onChange, defaultValue: defaultValue2 } = props, defaultPropertyType = props.defaultPropertyType && props.defaultPropertyType !== "undefined" ? props.defaultPropertyType : property.type[0].code, propertyTypes = property.type;
  if ((property.isArray || property.max > 1) && !props.arrayElement) {
    if (defaultPropertyType === l.Attachment)
      return (0, import_jsx_runtime66.jsx)(AttachmentArrayInput, { name, defaultValue: defaultValue2, onChange });
    let indent = ((_a = propertyTypes[0]) == null ? void 0 : _a.code) !== l.Extension;
    return (0, import_jsx_runtime66.jsx)(ResourceArrayInput, { property, name, path: props.path, defaultValue: defaultValue2, indent, onChange, outcome: props.outcome });
  } else
    return propertyTypes.length > 1 ? (0, import_jsx_runtime66.jsx)(ElementDefinitionInputSelector, { elementDefinitionTypes: propertyTypes, ...props }) : (0, import_jsx_runtime66.jsx)(ElementDefinitionTypeInput, { name, defaultValue: defaultValue2, onChange: (newValue) => {
      if (props.onChange) {
        let newPropName = props.name.replace("[x]", C(propertyTypes[0].code));
        props.onChange(newValue, newPropName);
      }
    }, outcome: props.outcome, elementDefinitionType: propertyTypes[0], min: property.min, max: property.min, binding: property.binding, path: props.path });
}
function ElementDefinitionInputSelector(props) {
  let propertyTypes = props.elementDefinitionTypes, initialPropertyType;
  props.defaultPropertyType && (initialPropertyType = propertyTypes.find((t) => t.code === props.defaultPropertyType)), initialPropertyType || (initialPropertyType = propertyTypes[0]);
  let [selectedType, setSelectedType] = (0, import_react41.useState)(initialPropertyType);
  return (0, import_jsx_runtime66.jsxs)(Group, { gap: "xs", grow: true, wrap: "nowrap", align: "flex-start", children: [(0, import_jsx_runtime66.jsx)(NativeSelect, { style: { width: "200px" }, defaultValue: selectedType.code, "data-testid": props.name && props.name + "-selector", onChange: (e) => {
    setSelectedType(propertyTypes.find((type) => type.code === e.currentTarget.value));
  }, data: propertyTypes.map((type) => ({ value: type.code, label: type.code })) }), (0, import_jsx_runtime66.jsx)(ElementDefinitionTypeInput, { name: props.name, defaultValue: props.defaultValue, outcome: props.outcome, elementDefinitionType: selectedType, onChange: (newValue) => {
    props.onChange && props.onChange(newValue, props.name.replace("[x]", C(selectedType.code)));
  }, min: props.property.min, max: props.property.max, binding: props.property.binding, path: props.property.path })] });
}
function ElementDefinitionTypeInput(props) {
  let { name, onChange, outcome, binding, path } = props, required = props.min !== void 0 && props.min > 0, propertyType = props.elementDefinitionType.code, elementsContext = (0, import_react41.useContext)(ElementsContext), defaultValue2 = (0, import_react41.useMemo)(() => {
    if (!tr(propertyType) || !S(props.defaultValue))
      return props.defaultValue;
    let withDefaults = /* @__PURE__ */ Object.create(null);
    if (elementsContext.path === props.path)
      Mp(withDefaults, elementsContext.elements);
    else {
      let key = de(elementsContext.path, props.path);
      if (key === void 0)
        return props.defaultValue;
      Mp(withDefaults, elementsContext.elements, key);
    }
    return G(withDefaults) ? withDefaults : props.defaultValue;
  }, [propertyType, elementsContext.path, elementsContext.elements, props.path, props.defaultValue]);
  if (!propertyType)
    return (0, import_jsx_runtime66.jsx)("div", { children: "Property type not specified " });
  let properties = { name, defaultValue: defaultValue2, onChange, outcome, path };
  switch (propertyType) {
    case l.SystemString:
    case l.canonical:
    case l.string:
    case l.time:
    case l.uri:
    case l.url:
      return props.path === "Project.secret.value[x]" ? (0, import_jsx_runtime66.jsx)(SensitiveTextarea, { id: name, name, "data-testid": name, defaultValue: defaultValue2, required, onChange: (e) => {
        props.onChange && props.onChange(e.currentTarget.value);
      }, error: getErrorsForInput(props.outcome, name) }) : (0, import_jsx_runtime66.jsx)(TextInput, { id: name, name, "data-testid": name, defaultValue: defaultValue2, required, onChange: (e) => {
        onChange && onChange(e.currentTarget.value);
      }, error: getErrorsForInput(outcome, name) });
    case l.date:
      return (0, import_jsx_runtime66.jsx)(TextInput, { type: "date", id: name, name, "data-testid": name, defaultValue: defaultValue2, required, onChange: (e) => {
        onChange && onChange(e.currentTarget.value);
      }, error: getErrorsForInput(outcome, name) });
    case l.dateTime:
    case l.instant:
      return (0, import_jsx_runtime66.jsx)(DateTimeInput, { name, defaultValue: defaultValue2, onChange, outcome });
    case l.decimal:
    case l.integer:
    case l.positiveInt:
    case l.unsignedInt:
      return (0, import_jsx_runtime66.jsx)(TextInput, { type: "number", step: propertyType === l.decimal ? "any" : "1", id: name, name, "data-testid": name, defaultValue: defaultValue2, required, onChange: (e) => {
        onChange && onChange(e.currentTarget.valueAsNumber);
      } });
    case l.code:
      return (0, import_jsx_runtime66.jsx)(CodeInput, { ...properties, binding: binding == null ? void 0 : binding.valueSet });
    case l.boolean:
      return (0, import_jsx_runtime66.jsx)(Checkbox, { id: name, name, "data-testid": name, defaultChecked: !!defaultValue2, onChange: (e) => {
        onChange && onChange(e.currentTarget.checked);
      } });
    case l.base64Binary:
    case l.markdown:
      return (0, import_jsx_runtime66.jsx)(Textarea, { id: name, spellCheck: propertyType !== l.base64Binary, name, "data-testid": name, defaultValue: defaultValue2, required, onChange: (e) => {
        onChange && onChange(e.currentTarget.value);
      } });
    case l.Address:
      return (0, import_jsx_runtime66.jsx)(AddressInput, { ...properties });
    case l.Annotation:
      return (0, import_jsx_runtime66.jsx)(AnnotationInput, { ...properties });
    case l.Attachment:
      return (0, import_jsx_runtime66.jsx)(AttachmentInput, { ...properties });
    case l.CodeableConcept:
      return (0, import_jsx_runtime66.jsx)(CodeableConceptInput, { binding: binding == null ? void 0 : binding.valueSet, ...properties });
    case l.Coding:
      return (0, import_jsx_runtime66.jsx)(CodingInput, { binding: binding == null ? void 0 : binding.valueSet, ...properties });
    case l.ContactDetail:
      return (0, import_jsx_runtime66.jsx)(ContactDetailInput, { ...properties });
    case l.ContactPoint:
      return (0, import_jsx_runtime66.jsx)(ContactPointInput, { ...properties });
    case l.Extension:
      return (0, import_jsx_runtime66.jsx)(ExtensionInput, { ...properties, propertyType: props.elementDefinitionType });
    case l.HumanName:
      return (0, import_jsx_runtime66.jsx)(HumanNameInput, { ...properties });
    case l.Identifier:
      return (0, import_jsx_runtime66.jsx)(IdentifierInput, { ...properties });
    case l.Money:
      return (0, import_jsx_runtime66.jsx)(MoneyInput, { ...properties });
    case l.Period:
      return (0, import_jsx_runtime66.jsx)(PeriodInput, { ...properties });
    case l.Duration:
    case l.Quantity:
      return (0, import_jsx_runtime66.jsx)(QuantityInput, { ...properties });
    case l.Range:
      return (0, import_jsx_runtime66.jsx)(RangeInput, { ...properties });
    case l.Ratio:
      return (0, import_jsx_runtime66.jsx)(RatioInput, { ...properties });
    case l.Reference:
      return (0, import_jsx_runtime66.jsx)(ReferenceInput, { ...properties, targetTypes: getTargetTypes(props.elementDefinitionType) });
    case l.Timing:
      return (0, import_jsx_runtime66.jsx)(TimingInput, { ...properties });
    case l.Dosage:
    case l.UsageContext:
    default:
      return (0, import_jsx_runtime66.jsx)(BackboneElementInput, { typeName: propertyType, path: properties.path, defaultValue: defaultValue2, onChange, outcome });
  }
}
var RESOURCE_TYPE_URL_PREFIXES = [`${wr}/fhir/StructureDefinition/`, "https://medplum.com/fhir/StructureDefinition/"];
function getTargetTypes(elementDefinitionType) {
  var _a;
  return (_a = elementDefinitionType == null ? void 0 : elementDefinitionType.targetProfile) == null ? void 0 : _a.map((p) => {
    let resourceTypePrefix = RESOURCE_TYPE_URL_PREFIXES.find((prefix) => p.startsWith(prefix));
    return resourceTypePrefix ? p.slice(resourceTypePrefix.length) : p;
  });
}
var EXTENSION_KEYS2 = ["extension", "modifierExtension"];
var IGNORED_PROPERTIES2 = ["id", ...DEFAULT_IGNORED_PROPERTIES].filter((prop) => !EXTENSION_KEYS2.includes(prop));
function ElementsInput(props) {
  let [value, setValue] = (0, import_react38.useState)(props.defaultValue ?? {}), elementsContext = (0, import_react38.useContext)(ElementsContext), elementsToRender = (0, import_react38.useMemo)(() => getElementsToRender(elementsContext.elements), [elementsContext.elements]);
  function setValueWrapper(newValue) {
    setValue(newValue), props.onChange && props.onChange(newValue);
  }
  let typedValue = { type: props.type, value };
  return (0, import_jsx_runtime67.jsx)(Stack, { style: { flexGrow: 1 }, "data-testid": props.testId, children: elementsToRender.map(([key, element]) => {
    let [propertyValue, propertyType] = getValueAndTypeFromElement(typedValue, key, element), required = element.min !== void 0 && element.min > 0, resourcePropertyInput = (0, import_jsx_runtime67.jsx)(ResourcePropertyInput, { property: element, name: key, path: props.path + "." + key, defaultValue: propertyValue, defaultPropertyType: propertyType, onChange: (newValue, propName) => {
      setValueWrapper(setPropertyValue({ ...value }, key, propName ?? key, element, newValue));
    }, arrayElement: void 0, outcome: props.outcome }, key);
    return props.type === "Extension" || EXTENSION_KEYS2.includes(key) ? resourcePropertyInput : element.type.length === 1 && element.type[0].code === "boolean" ? (0, import_jsx_runtime67.jsx)(CheckboxFormSection, { title: eu(key), description: element.description, htmlFor: key, fhirPath: element.path, withAsterisk: required, children: resourcePropertyInput }, key) : (0, import_jsx_runtime67.jsx)(FormSection, { title: eu(key), description: element.description, withAsterisk: required, htmlFor: key, outcome: props.outcome, fhirPath: element.path, children: resourcePropertyInput }, key);
  }) });
}
function getElementsToRender(inputElements) {
  return Object.entries(inputElements).filter(([key, element]) => {
    var _a;
    return !G(element.type) || element.max === 0 || element.path.toLowerCase().endsWith("extension.url") && element.fixed || EXTENSION_KEYS2.includes(key) && !G((_a = element.slicing) == null ? void 0 : _a.slices) || IGNORED_PROPERTIES2.includes(key) ? false : !(DEFAULT_IGNORED_NON_NESTED_PROPERTIES.includes(key) && element.path.split(".").length === 2 || key.includes("."));
  });
}
function BackboneElementInput(props) {
  let [defaultValue2] = (0, import_react37.useState)(() => props.defaultValue ?? {}), parentElementsContext = (0, import_react37.useContext)(ElementsContext), profileUrl = props.profileUrl ?? (parentElementsContext == null ? void 0 : parentElementsContext.profileUrl), typeSchema = (0, import_react37.useMemo)(() => be(props.typeName, profileUrl), [props.typeName, profileUrl]), type = (typeSchema == null ? void 0 : typeSchema.type) ?? props.typeName, contextValue = (0, import_react37.useMemo)(() => {
    if (typeSchema)
      return Tr({ parentContext: parentElementsContext, elements: typeSchema.elements, path: props.path, profileUrl: typeSchema.url });
  }, [typeSchema, props.path, parentElementsContext]);
  return typeSchema ? maybeWrapWithContext(ElementsContext.Provider, contextValue, (0, import_jsx_runtime68.jsx)(ElementsInput, { path: props.path, type, defaultValue: defaultValue2, onChange: props.onChange, outcome: props.outcome })) : (0, import_jsx_runtime68.jsxs)("div", { children: [type, "not implemented"] });
}
var CalendarInput_default = { table: "CalendarInput_table" };
function getMonthString(date) {
  return date.toLocaleString("default", { month: "long" }) + " " + date.getFullYear();
}
function getStartMonth() {
  let result = /* @__PURE__ */ new Date();
  return result.setDate(1), result.setHours(0, 0, 0, 0), result;
}
function CalendarInput(props) {
  let { onChangeMonth, onClick } = props, [month, setMonth] = (0, import_react60.useState)(getStartMonth);
  function moveMonth(delta) {
    setMonth((currMonth) => {
      let newMonth = new Date(currMonth.getTime());
      return newMonth.setMonth(currMonth.getMonth() + delta), onChangeMonth(newMonth), newMonth;
    });
  }
  let grid = (0, import_react60.useMemo)(() => buildGrid(month, props.slots), [month, props.slots]);
  return (0, import_jsx_runtime69.jsxs)("div", { children: [(0, import_jsx_runtime69.jsxs)(Group, { justify: "space-between", gap: "xs", grow: true, wrap: "nowrap", children: [(0, import_jsx_runtime69.jsx)("p", { style: { flex: 1 }, children: getMonthString(month) }), (0, import_jsx_runtime69.jsxs)(Group, { justify: "flex-end", gap: "xs", children: [(0, import_jsx_runtime69.jsx)(Button, { variant: "outline", "aria-label": "Previous month", onClick: () => moveMonth(-1), children: "<" }), (0, import_jsx_runtime69.jsx)(Button, { variant: "outline", "aria-label": "Next month", onClick: () => moveMonth(1), children: ">" })] })] }), (0, import_jsx_runtime69.jsxs)("table", { className: CalendarInput_default.table, children: [(0, import_jsx_runtime69.jsx)("thead", { children: (0, import_jsx_runtime69.jsxs)("tr", { children: [(0, import_jsx_runtime69.jsx)("th", { children: "SUN" }), (0, import_jsx_runtime69.jsx)("th", { children: "MON" }), (0, import_jsx_runtime69.jsx)("th", { children: "TUE" }), (0, import_jsx_runtime69.jsx)("th", { children: "WED" }), (0, import_jsx_runtime69.jsx)("th", { children: "THU" }), (0, import_jsx_runtime69.jsx)("th", { children: "FRI" }), (0, import_jsx_runtime69.jsx)("th", { children: "SAT" })] }) }), (0, import_jsx_runtime69.jsx)("tbody", { children: grid.map((week, weekIndex) => (0, import_jsx_runtime69.jsx)("tr", { children: week.map((day, dayIndex) => (0, import_jsx_runtime69.jsx)("td", { children: day && (0, import_jsx_runtime69.jsx)(Button, { variant: "light", disabled: !day.available, onClick: () => onClick(day.date), children: day.date.getDate() }) }, "day-" + dayIndex)) }, "week-" + weekIndex)) })] })] });
}
function buildGrid(startDate, slots) {
  let d = new Date(startDate.getFullYear(), startDate.getMonth()), grid = [], row = [];
  for (let i = 0; i < d.getDay(); i++)
    row.push(void 0);
  for (; d.getMonth() === startDate.getMonth(); )
    row.push({ date: new Date(d.getTime()), available: isDayAvailable(d, slots) }), d.getDay() === 6 && (grid.push(row), row = []), d.setDate(d.getDate() + 1);
  if (d.getDay() !== 0) {
    for (let i = d.getDay(); i < 7; i++)
      row.push(void 0);
    grid.push(row);
  }
  return grid;
}
function isDayAvailable(day, slots) {
  for (let slot of slots) {
    let slotStart = new Date(slot.start);
    if (slotStart.getFullYear() === day.getFullYear() && slotStart.getMonth() === day.getMonth() && slotStart.getDate() === day.getDate())
      return true;
  }
  return false;
}
var Container_default = { root: "Container_root" };
function Container2(props) {
  let { children: children2, ...others } = props;
  return (0, import_jsx_runtime70.jsx)(Container, { className: Container_default.root, ...others, children: children2 });
}
var NoteDisplay_default = { noteBody: "NoteDisplay_noteBody", noteCite: "NoteDisplay_noteCite", noteRoot: "NoteDisplay_noteRoot" };
function NoteDisplay({ value }) {
  return value ? (0, import_jsx_runtime71.jsx)(Stack, { justify: "flex-start", gap: "xs", children: value.map((note) => {
    var _a;
    return note.text && (0, import_jsx_runtime71.jsx)(Blockquote, { classNames: { cite: NoteDisplay_default.noteCite, root: NoteDisplay_default.noteRoot }, cite: ((_a = note.authorReference) == null ? void 0 : _a.display) || note.authorString, icon: null, children: note.text }, `note-${note.text}`);
  }) }) : null;
}
function ResourceName(props) {
  let { value, link, ...rest } = props, [outcome, setOutcome] = (0, import_react63.useState)(), resource = ce(value, setOutcome), text;
  if (outcome && !Mt(outcome))
    text = `[${di(outcome)}]`;
  else if (resource)
    text = Oi(resource);
  else
    return null;
  return link ? (0, import_jsx_runtime72.jsx)(MedplumLink, { to: value, ...rest, children: text }) : (0, import_jsx_runtime72.jsx)(Text, { component: "span", ...rest, children: text });
}
function ResourceBadge(props) {
  return (0, import_jsx_runtime73.jsxs)(Group, { gap: "xs", children: [(0, import_jsx_runtime73.jsx)(ResourceAvatar, { size: 24, radius: 12, value: props.value, link: props.link }), (0, import_jsx_runtime73.jsx)(ResourceName, { value: props.value, link: props.link })] });
}
var statusToColor = { draft: "blue", active: "blue", "on-hold": "yellow", revoked: "red", completed: "green", "entered-in-error": "red", unknown: "gray", retired: "gray", registered: "blue", preliminary: "blue", final: "green", amended: "yellow", corrected: "yellow", cancelled: "red", requested: "blue", received: "blue", accepted: "blue", rejected: "red", ready: "blue", "in-progress": "blue", failed: "red", proposed: "blue", pending: "blue", booked: "blue", arrived: "blue", fulfilled: "green", noshow: "red", "checked-in": "blue", waitlist: "gray", routine: "gray", urgent: "red", asap: "red", stat: "red", "not-done": "red", connected: "green", disconnected: "red" };
function StatusBadge(props) {
  return (0, import_jsx_runtime74.jsx)(Badge, { color: statusToColor[props.status], children: props.status });
}
var DiagnosticReportDisplay_default = { table: "DiagnosticReportDisplay_table", criticalRow: "DiagnosticReportDisplay_criticalRow", noteBody: "DiagnosticReportDisplay_noteBody", noteCite: "DiagnosticReportDisplay_noteCite", noteRoot: "DiagnosticReportDisplay_noteRoot" };
DiagnosticReportDisplay.defaultProps = { hideObservationNotes: false, hideSpecimenInfo: false };
function DiagnosticReportDisplay(props) {
  var _a;
  let medplum = a(), diagnosticReport = ce(props.value), [specimens, setSpecimens] = (0, import_react62.useState)();
  if ((0, import_react62.useEffect)(() => {
    (diagnosticReport == null ? void 0 : diagnosticReport.specimen) && Promise.allSettled(diagnosticReport.specimen.map((ref) => medplum.readReference(ref))).then((outcomes) => outcomes.filter((outcome) => outcome.status === "fulfilled").map((outcome) => outcome.value)).then(setSpecimens).catch(console.error);
  }, [medplum, diagnosticReport]), !diagnosticReport)
    return null;
  let specimenNotes = (specimens == null ? void 0 : specimens.flatMap((spec) => spec.note || [])) || [];
  if (diagnosticReport.presentedForm && diagnosticReport.presentedForm.length > 0) {
    let pf = diagnosticReport.presentedForm[0];
    ((_a = pf.contentType) == null ? void 0 : _a.startsWith("text/plain")) && pf.data && specimenNotes.push({ text: window.atob(pf.data) });
  }
  return (0, import_jsx_runtime75.jsxs)(Stack, { children: [(0, import_jsx_runtime75.jsx)(Title, { children: "Diagnostic Report" }), (0, import_jsx_runtime75.jsx)(DiagnosticReportHeader, { value: diagnosticReport }), specimens && !props.hideSpecimenInfo && SpecimenInfo(specimens), diagnosticReport.result && (0, import_jsx_runtime75.jsx)(ObservationTable, { hideObservationNotes: props.hideObservationNotes, value: diagnosticReport.result }), specimenNotes.length > 0 && (0, import_jsx_runtime75.jsx)(NoteDisplay, { value: specimenNotes })] });
}
function DiagnosticReportHeader({ value }) {
  var _a, _b;
  return (0, import_jsx_runtime75.jsxs)(Group, { mt: "md", gap: 30, children: [value.subject && (0, import_jsx_runtime75.jsxs)("div", { children: [(0, import_jsx_runtime75.jsx)(Text, { size: "xs", tt: "uppercase", c: "dimmed", children: "Subject" }), (0, import_jsx_runtime75.jsx)(ResourceBadge, { value: value.subject, link: true })] }), (_a = value.resultsInterpreter) == null ? void 0 : _a.map((interpreter) => (0, import_jsx_runtime75.jsxs)("div", { children: [(0, import_jsx_runtime75.jsx)(Text, { size: "xs", tt: "uppercase", c: "dimmed", children: "Interpreter" }), (0, import_jsx_runtime75.jsx)(ResourceBadge, { value: interpreter, link: true })] }, interpreter.reference)), (_b = value.performer) == null ? void 0 : _b.map((performer) => (0, import_jsx_runtime75.jsxs)("div", { children: [(0, import_jsx_runtime75.jsx)(Text, { size: "xs", tt: "uppercase", c: "dimmed", children: "Performer" }), (0, import_jsx_runtime75.jsx)(ResourceBadge, { value: performer, link: true })] }, performer.reference)), value.issued && (0, import_jsx_runtime75.jsxs)("div", { children: [(0, import_jsx_runtime75.jsx)(Text, { size: "xs", tt: "uppercase", c: "dimmed", children: "Issued" }), (0, import_jsx_runtime75.jsx)(Text, { children: nr(value.issued) })] }), value.status && (0, import_jsx_runtime75.jsxs)("div", { children: [(0, import_jsx_runtime75.jsx)(Text, { size: "xs", tt: "uppercase", c: "dimmed", children: "Status" }), (0, import_jsx_runtime75.jsx)(Text, { children: C(value.status) })] })] });
}
function SpecimenInfo(specimens) {
  return (0, import_jsx_runtime75.jsxs)(Stack, { gap: "xs", children: [(0, import_jsx_runtime75.jsx)(Title, { order: 2, size: "h6", children: "Specimens" }), (0, import_jsx_runtime75.jsx)(List, { type: "ordered", children: specimens == null ? void 0 : specimens.map((specimen) => {
    var _a;
    return (0, import_jsx_runtime75.jsx)(List.Item, { ml: "sm", children: (0, import_jsx_runtime75.jsxs)(Group, { gap: 20, children: [(0, import_jsx_runtime75.jsxs)(Group, { gap: 5, children: [(0, import_jsx_runtime75.jsx)(Text, { fw: 500, children: "Collected:" }), " ", nr((_a = specimen.collection) == null ? void 0 : _a.collectedDateTime)] }), (0, import_jsx_runtime75.jsxs)(Group, { gap: 5, children: [(0, import_jsx_runtime75.jsx)(Text, { fw: 500, children: "Received:" }), " ", nr(specimen.receivedTime)] })] }) }, `specimen-${specimen.id}`);
  }) })] });
}
function ObservationTable(props) {
  return (0, import_jsx_runtime75.jsxs)("table", { className: DiagnosticReportDisplay_default.table, children: [(0, import_jsx_runtime75.jsx)("thead", { children: (0, import_jsx_runtime75.jsxs)("tr", { children: [(0, import_jsx_runtime75.jsx)("th", { children: "Test" }), (0, import_jsx_runtime75.jsx)("th", { children: "Value" }), (0, import_jsx_runtime75.jsx)("th", { children: "Reference Range" }), (0, import_jsx_runtime75.jsx)("th", { children: "Interpretation" }), (0, import_jsx_runtime75.jsx)("th", { children: "Category" }), (0, import_jsx_runtime75.jsx)("th", { children: "Performer" }), (0, import_jsx_runtime75.jsx)("th", { children: "Status" })] }) }), (0, import_jsx_runtime75.jsx)("tbody", { children: (0, import_jsx_runtime75.jsx)(ObservationRowGroup, { value: props.value, ancestorIds: props.ancestorIds, hideObservationNotes: props.hideObservationNotes }) })] });
}
function ObservationRowGroup(props) {
  var _a;
  return (0, import_jsx_runtime75.jsx)(import_jsx_runtime75.Fragment, { children: (_a = props.value) == null ? void 0 : _a.map((observation) => (0, import_jsx_runtime75.jsx)(ObservationRow, { value: observation, ancestorIds: props.ancestorIds, hideObservationNotes: props.hideObservationNotes }, `obs-${Y(observation) ? observation.reference : observation.id}`)) });
}
function ObservationRow(props) {
  var _a, _b;
  let observation = ce(props.value);
  if (!observation || ((_a = props.ancestorIds) == null ? void 0 : _a.includes(observation.id)))
    return null;
  let displayNotes = !props.hideObservationNotes && observation.note, critical = isCritical(observation);
  return (0, import_jsx_runtime75.jsxs)(import_jsx_runtime75.Fragment, { children: [(0, import_jsx_runtime75.jsxs)("tr", { className: clsx_m_default({ [DiagnosticReportDisplay_default.criticalRow]: critical }), children: [(0, import_jsx_runtime75.jsx)("td", { rowSpan: displayNotes ? 2 : 1, children: (0, import_jsx_runtime75.jsx)(MedplumLink, { to: observation, children: (0, import_jsx_runtime75.jsx)(CodeableConceptDisplay, { value: observation.code }) }) }), (0, import_jsx_runtime75.jsx)("td", { children: (0, import_jsx_runtime75.jsx)(ObservationValueDisplay, { value: observation }) }), (0, import_jsx_runtime75.jsx)("td", { children: (0, import_jsx_runtime75.jsx)(ReferenceRangeDisplay, { value: observation.referenceRange }) }), (0, import_jsx_runtime75.jsx)("td", { children: observation.interpretation && observation.interpretation.length > 0 && (0, import_jsx_runtime75.jsx)(CodeableConceptDisplay, { value: observation.interpretation[0] }) }), (0, import_jsx_runtime75.jsx)("td", { children: observation.category && observation.category.length > 0 && (0, import_jsx_runtime75.jsx)(import_jsx_runtime75.Fragment, { children: observation.category.map((concept) => (0, import_jsx_runtime75.jsx)("div", { children: (0, import_jsx_runtime75.jsx)(CodeableConceptDisplay, { value: concept }) }, `category-${Ji(concept)}`)) }) }), (0, import_jsx_runtime75.jsx)("td", { children: (_b = observation.performer) == null ? void 0 : _b.map((performer) => (0, import_jsx_runtime75.jsx)(ReferenceDisplay, { value: performer }, performer.reference)) }), (0, import_jsx_runtime75.jsx)("td", { children: observation.status && (0, import_jsx_runtime75.jsx)(StatusBadge, { status: observation.status }) })] }), observation.hasMember && (0, import_jsx_runtime75.jsx)(ObservationRowGroup, { value: observation.hasMember, ancestorIds: props.ancestorIds ? [...props.ancestorIds, observation.id] : [observation.id], hideObservationNotes: props.hideObservationNotes }), displayNotes && (0, import_jsx_runtime75.jsx)("tr", { children: (0, import_jsx_runtime75.jsx)("td", { colSpan: 6, children: (0, import_jsx_runtime75.jsx)(NoteDisplay, { value: observation.note }) }) })] });
}
function ObservationValueDisplay(props) {
  let obs = props.value;
  return (0, import_jsx_runtime75.jsx)(import_jsx_runtime75.Fragment, { children: Zi(obs) });
}
function ReferenceRangeDisplay(props) {
  let range = props.value && props.value.length > 0 && props.value[0];
  return range ? range.text ? (0, import_jsx_runtime75.jsx)(import_jsx_runtime75.Fragment, { children: range.text }) : (0, import_jsx_runtime75.jsx)(RangeDisplay, { value: range }) : null;
}
function isCritical(observation) {
  var _a, _b, _c, _d;
  let code = (_d = (_c = (_b = (_a = observation.interpretation) == null ? void 0 : _a[0]) == null ? void 0 : _b.coding) == null ? void 0 : _c[0]) == null ? void 0 : _d.code;
  return code === "AA" || code === "LL" || code === "HH" || code === "A";
}
var Panel_default = { paper: "Panel_paper", fill: "Panel_fill" };
function Panel(props) {
  let { width, fill, className, children: children2, ...rest } = props, style = width ? { maxWidth: width } : void 0;
  return (0, import_jsx_runtime76.jsx)(Paper, { className: clsx_m_default(Panel_default.paper, fill && Panel_default.fill, className), style, shadow: "sm", radius: "sm", withBorder: true, ...rest, children: children2 });
}
var import_rfc6902 = __toESM2(require_rfc6902(), 1);
var ResourceDiffTable_default = { root: "ResourceDiffTable_root", removed: "ResourceDiffTable_removed", added: "ResourceDiffTable_added" };
function ResourceDiffTable(props) {
  let medplum = a(), { original, revised } = props, [schemaLoaded, setSchemaLoaded] = (0, import_react64.useState)(false);
  (0, import_react64.useEffect)(() => {
    medplum.requestSchema(props.original.resourceType).then(() => setSchemaLoaded(true)).catch(console.log);
  }, [medplum, props.original.resourceType]);
  let diffTable = (0, import_react64.useMemo)(() => {
    if (!schemaLoaded)
      return null;
    let typedOriginal = [y(original)], typedRevised = [y(revised)], result = [], patch = mergePatchOperations((0, import_rfc6902.createPatch)(original, revised));
    for (let op of patch) {
      let path = op.path, fhirPath = jsonPathToFhirPath(path), property = tryGetElementDefinition(original.resourceType, fhirPath), originalValue = op.op === "add" ? void 0 : $(fhirPath, typedOriginal), revisedValue = op.op === "remove" ? void 0 : $(fhirPath, typedRevised);
      result.push({ key: `op-${op.op}-${op.path}`, name: `${C(op.op)} ${fhirPath}`, path: (property == null ? void 0 : property.path) ?? original.resourceType + "." + fhirPath, property, originalValue: touchUpValue(property, originalValue), revisedValue: touchUpValue(property, revisedValue) });
    }
    return result;
  }, [schemaLoaded, original, revised]);
  return diffTable ? (0, import_jsx_runtime77.jsxs)(Table, { className: ResourceDiffTable_default.root, children: [(0, import_jsx_runtime77.jsx)(Table.Thead, { children: (0, import_jsx_runtime77.jsxs)(Table.Tr, { children: [(0, import_jsx_runtime77.jsx)(Table.Th, {}), (0, import_jsx_runtime77.jsx)(Table.Th, { children: "Before" }), (0, import_jsx_runtime77.jsx)(Table.Th, { children: "After" })] }) }), (0, import_jsx_runtime77.jsx)(Table.Tbody, { children: diffTable.map((row) => (0, import_jsx_runtime77.jsxs)(Table.Tr, { children: [(0, import_jsx_runtime77.jsx)(Table.Td, { children: row.name }), (0, import_jsx_runtime77.jsx)(Table.Td, { className: ResourceDiffTable_default.removed, children: row.originalValue && (0, import_jsx_runtime77.jsx)(ResourcePropertyDisplay, { path: row.path, property: row.property, propertyType: row.originalValue.type, value: row.originalValue.value, ignoreMissingValues: true }) }), (0, import_jsx_runtime77.jsx)(Table.Td, { className: ResourceDiffTable_default.added, children: row.revisedValue && (0, import_jsx_runtime77.jsx)(ResourcePropertyDisplay, { path: row.path, property: row.property, propertyType: row.revisedValue.type, value: row.revisedValue.value, ignoreMissingValues: true }) })] }, row.key)) })] }) : null;
}
function mergePatchOperations(patch) {
  let result = [];
  for (let patchOperation of patch) {
    let { op, path } = patchOperation;
    if (path.startsWith("/meta/author") || path.startsWith("/meta/compartment") || path.startsWith("/meta/lastUpdated") || path.startsWith("/meta/versionId"))
      continue;
    let count = patch.filter((el) => el.op === op && el.path === path).length, resultOperation = { op, path };
    count > 1 && (op === "add" || op === "remove") && /\/[0-9-]+$/.test(path) && (resultOperation.op = "replace", resultOperation.path = path.replace(/\/[^/]+$/, "")), result.some((el) => el.op === resultOperation.op && el.path === resultOperation.path) || result.push(resultOperation);
  }
  return result;
}
function jsonPathToFhirPath(path) {
  let parts = path.split("/").filter(Boolean), result = "";
  for (let i = 0; i < parts.length; i++) {
    let part = parts[i];
    part === "-" ? result += ".last()" : /^\d+$/.test(part) ? result += `[${part}]` : (i > 0 && (result += "."), result += part);
  }
  return result.endsWith(".url") && (result = result.replace(/\.url$/, "")), result;
}
function tryGetElementDefinition(resourceType, fhirPath) {
  var _a, _b;
  return (_b = (_a = bn(resourceType, { resourceType: "SearchParameter", base: [resourceType], code: resourceType + "." + fhirPath, expression: resourceType + "." + fhirPath })) == null ? void 0 : _a.elementDefinitions) == null ? void 0 : _b[0];
}
function touchUpValue(property, input) {
  return input && { type: Array.isArray(input) ? input[0].type : input.type, value: fixArray(input, !!(property == null ? void 0 : property.isArray)) };
}
function fixArray(input, isArray) {
  let inputValue = je(input).flatMap((v2) => v2.value);
  return isArray ? inputValue : inputValue[0];
}
function ResourceTable(props) {
  let { profileUrl } = props, medplum = a(), value = ce(props.value), [schemaLoaded, setSchemaLoaded] = (0, import_react65.useState)();
  return (0, import_react65.useEffect)(() => {
    if (value)
      if (profileUrl)
        medplum.requestProfileSchema(profileUrl, { expandProfile: true }).then(() => {
          let profile = Kr(profileUrl);
          profile ? setSchemaLoaded(profile.name) : console.error(`Schema not found for ${profileUrl}`);
        }).catch((reason) => {
          console.error("Error in requestProfileSchema", reason);
        });
      else {
        let schemaName = value.resourceType;
        medplum.requestSchema(schemaName).then(() => {
          setSchemaLoaded(schemaName);
        }).catch(console.error);
      }
  }, [medplum, profileUrl, value]), !schemaLoaded || !value ? null : (0, import_jsx_runtime78.jsx)(BackboneElementDisplay, { path: value.resourceType, value: { type: schemaLoaded, value: props.forceUseInput ? props.value : value }, profileUrl, ignoreMissingValues: props.ignoreMissingValues });
}
function Timeline(props) {
  return (0, import_jsx_runtime79.jsx)(Container2, { children: props.children });
}
function TimelineItem(props) {
  var _a, _b;
  let { resource, profile, padding, popupMenuItems, ...others } = props, author = profile ?? ((_a = resource.meta) == null ? void 0 : _a.author), dateTime = props.dateTime ?? ((_b = resource.meta) == null ? void 0 : _b.lastUpdated);
  return (0, import_jsx_runtime79.jsxs)(Panel, { "data-testid": "timeline-item", fill: true, ...others, children: [(0, import_jsx_runtime79.jsxs)(Group, { justify: "space-between", gap: 8, mx: "xs", my: "sm", children: [(0, import_jsx_runtime79.jsx)(ResourceAvatar, { value: author, link: true, size: "md" }), (0, import_jsx_runtime79.jsxs)("div", { style: { flex: 1 }, children: [(0, import_jsx_runtime79.jsx)(Text, { size: "sm", children: (0, import_jsx_runtime79.jsx)(ResourceName, { c: "dark", fw: 500, value: author, link: true }) }), (0, import_jsx_runtime79.jsxs)(Text, { size: "xs", children: [(0, import_jsx_runtime79.jsx)(MedplumLink, { c: "dimmed", to: props.resource, children: nr(dateTime) }), (0, import_jsx_runtime79.jsx)(Text, { component: "span", c: "dimmed", mx: 8, children: "" }), (0, import_jsx_runtime79.jsx)(MedplumLink, { c: "dimmed", to: props.resource, children: props.resource.resourceType })] })] }), popupMenuItems && (0, import_jsx_runtime79.jsxs)(Menu, { position: "bottom-end", shadow: "md", width: 200, children: [(0, import_jsx_runtime79.jsx)(Menu.Target, { children: (0, import_jsx_runtime79.jsx)(ActionIcon, { color: "gray", variant: "subtle", radius: "xl", "aria-label": `Actions for ${X(props.resource)}`, children: (0, import_jsx_runtime79.jsx)(IconDots, {}) }) }), popupMenuItems] })] }), (0, import_jsx_runtime79.jsxs)(ErrorBoundary, { children: [padding && (0, import_jsx_runtime79.jsx)("div", { style: { padding: "0 16px 16px 16px" }, children: props.children }), !padding && (0, import_jsx_runtime79.jsx)(import_jsx_runtime79.Fragment, { children: props.children })] })] });
}
function sortByDateAndPriority(resources, timelineResource) {
  resources.sort((a2, b2) => {
    let priority1 = getPriorityScore(a2, timelineResource), priority2 = getPriorityScore(b2, timelineResource);
    return priority1 > priority2 ? 1 : priority1 < priority2 ? -1 : getTime(a2, timelineResource) - getTime(b2, timelineResource);
  });
}
function getPriorityScore(resource, timelineResource) {
  if (!isSameResourceType(resource, timelineResource)) {
    let priority = resource.priority;
    if (typeof priority == "string")
      return { stat: 4, asap: 3, urgent: 2 }[priority] ?? 0;
  }
  return 0;
}
function getTime(resource, timelineResource) {
  var _a;
  if (!isSameResourceType(resource, timelineResource)) {
    if (resource.resourceType === "Communication" && resource.sent)
      return new Date(resource.sent).getTime();
    if ((resource.resourceType === "DiagnosticReport" || resource.resourceType === "Media" || resource.resourceType === "Observation") && resource.issued)
      return new Date(resource.issued).getTime();
    if (resource.resourceType === "DocumentReference" && resource.date)
      return new Date(resource.date).getTime();
  }
  let dateTime = (_a = resource.meta) == null ? void 0 : _a.lastUpdated;
  return dateTime ? new Date(dateTime).getTime() : 0;
}
function isSameResourceType(a2, b2) {
  return !!b2 && a2.resourceType === b2.resourceType && a2.id === b2.id;
}
var ResourceTimeline_default = { pinnedComment: "ResourceTimeline_pinnedComment" };
function ResourceTimeline(props) {
  let medplum = a(), navigate = G2(), sender = medplum.getProfile(), inputRef = (0, import_react61.useRef)(null), resource = ce(props.value), [history, setHistory] = (0, import_react61.useState)(), [items, setItems] = (0, import_react61.useState)([]), loadTimelineResources = props.loadTimelineResources, itemsRef = (0, import_react61.useRef)(items);
  itemsRef.current = items;
  let sortAndSetItems = (0, import_react61.useCallback)((newItmes) => {
    sortByDateAndPriority(newItmes, resource), newItmes.reverse(), setItems(newItmes);
  }, [resource]), handleBatchResponse = (0, import_react61.useCallback)((batchResponse) => {
    let newItems = [];
    for (let settledResult of batchResponse) {
      if (settledResult.status !== "fulfilled")
        continue;
      let bundle = settledResult.value;
      if (bundle.type === "history" && setHistory(bundle), bundle.entry)
        for (let entry of bundle.entry)
          newItems.push(entry.resource);
    }
    sortAndSetItems(newItems);
  }, [sortAndSetItems]), addResource = (0, import_react61.useCallback)((resource2) => sortAndSetItems([...itemsRef.current, resource2]), [sortAndSetItems]), loadTimeline = (0, import_react61.useCallback)(() => {
    var _a;
    let resourceType, id;
    "resourceType" in props.value ? (resourceType = props.value.resourceType, id = props.value.id) : [resourceType, id] = (_a = props.value.reference) == null ? void 0 : _a.split("/"), loadTimelineResources(medplum, resourceType, id).then(handleBatchResponse).catch(console.log);
  }, [medplum, props.value, loadTimelineResources, handleBatchResponse]);
  (0, import_react61.useEffect)(() => loadTimeline(), [loadTimeline]);
  function createComment(contentString) {
    !resource || !props.createCommunication || medplum.createResource(props.createCommunication(resource, sender, contentString)).then((result) => addResource(result)).catch(console.log);
  }
  function createMedia(attachment) {
    !resource || !props.createMedia || medplum.createResource(props.createMedia(resource, sender, attachment)).then((result) => addResource(result)).then(() => updateNotification({ id: "upload-notification", color: "teal", title: "Upload complete", message: "", icon: (0, import_jsx_runtime80.jsx)(IconCheck, { size: 16 }), autoClose: 2e3 })).catch((reason) => updateNotification({ id: "upload-notification", color: "red", title: "Upload error", message: di(reason), icon: (0, import_jsx_runtime80.jsx)(IconFileAlert, { size: 16 }), autoClose: 2e3 }));
  }
  function setPriority(communication, priority) {
    return medplum.updateResource({ ...communication, priority });
  }
  function onPin(communication) {
    setPriority(communication, "stat").then(loadTimeline).catch(console.log);
  }
  function onUnpin(communication) {
    setPriority(communication, "routine").then(loadTimeline).catch(console.log);
  }
  function onDetails(timelineItem) {
    navigate(`/${timelineItem.resourceType}/${timelineItem.id}`);
  }
  function onEdit(timelineItem) {
    navigate(`/${timelineItem.resourceType}/${timelineItem.id}/edit`);
  }
  function onDelete(timelineItem) {
    navigate(`/${timelineItem.resourceType}/${timelineItem.id}/delete`);
  }
  function onVersionDetails(version) {
    var _a;
    navigate(`/${version.resourceType}/${version.id}/_history/${(_a = version.meta) == null ? void 0 : _a.versionId}`);
  }
  function onUploadStart() {
    showNotification({ id: "upload-notification", loading: true, title: "Initializing upload...", message: "Please wait...", autoClose: false, withCloseButton: false });
  }
  function onUploadProgress(e) {
    updateNotification({ id: "upload-notification", loading: true, title: "Uploading...", message: getProgressMessage(e), autoClose: false, withCloseButton: false });
  }
  function onUploadError(outcome) {
    updateNotification({ id: "upload-notification", color: "red", title: "Upload error", message: di(outcome), icon: (0, import_jsx_runtime80.jsx)(IconFileAlert, { size: 16 }), autoClose: 2e3 });
  }
  return resource ? (0, import_jsx_runtime80.jsxs)(Timeline, { children: [props.createCommunication && (0, import_jsx_runtime80.jsx)(Panel, { children: (0, import_jsx_runtime80.jsx)(Form, { testid: "timeline-form", onSubmit: (formData) => {
    createComment(formData.text);
    let input = inputRef.current;
    input && (input.value = "", input.focus());
  }, children: (0, import_jsx_runtime80.jsxs)(Group, { gap: "xs", wrap: "nowrap", style: { width: "100%" }, children: [(0, import_jsx_runtime80.jsx)(ResourceAvatar, { value: sender }), (0, import_jsx_runtime80.jsx)(TextInput, { name: "text", ref: inputRef, placeholder: "Add comment", style: { width: "100%", maxWidth: 300 } }), (0, import_jsx_runtime80.jsx)(ActionIcon, { type: "submit", radius: "xl", color: "blue", variant: "filled", children: (0, import_jsx_runtime80.jsx)(IconMessage, { size: 16 }) }), (0, import_jsx_runtime80.jsx)(AttachmentButton, { onUpload: createMedia, onUploadStart, onUploadProgress, onUploadError, children: (props2) => (0, import_jsx_runtime80.jsx)(ActionIcon, { ...props2, radius: "xl", color: "blue", variant: "filled", children: (0, import_jsx_runtime80.jsx)(IconCloudUpload, { size: 16 }) }) })] }) }) }), items.map((item) => {
    var _a;
    if (!item)
      return null;
    let key = `${item.resourceType}/${item.id}/${(_a = item.meta) == null ? void 0 : _a.versionId}`;
    if (item.resourceType === resource.resourceType && item.id === resource.id)
      return (0, import_jsx_runtime80.jsx)(HistoryTimelineItem, { history, resource: item, onDetails: onVersionDetails }, key);
    switch (item.resourceType) {
      case "AuditEvent":
        return (0, import_jsx_runtime80.jsx)(AuditEventTimelineItem, { resource: item, onDetails }, key);
      case "Communication":
        return (0, import_jsx_runtime80.jsx)(CommunicationTimelineItem, { resource: item, onPin: item.priority !== "stat" ? onPin : void 0, onUnpin: item.priority === "stat" ? onUnpin : void 0, onDetails, onEdit, onDelete }, key);
      case "DiagnosticReport":
        return (0, import_jsx_runtime80.jsx)(DiagnosticReportTimelineItem, { resource: item, onDetails, onEdit, onDelete }, key);
      case "Media":
        return (0, import_jsx_runtime80.jsx)(MediaTimelineItem, { resource: item, onDetails, onEdit, onDelete }, key);
      default:
        return (0, import_jsx_runtime80.jsx)(TimelineItem, { resource: item, padding: true, children: (0, import_jsx_runtime80.jsx)(ResourceTable, { value: item, ignoreMissingValues: true }) }, key);
    }
  })] }) : (0, import_jsx_runtime80.jsx)(Center, { style: { width: "100%", height: "100%" }, children: (0, import_jsx_runtime80.jsx)(Loader, {}) });
}
function TimelineItemPopupMenu(props) {
  return (0, import_jsx_runtime80.jsxs)(Menu.Dropdown, { children: [(0, import_jsx_runtime80.jsx)(Menu.Label, { children: "Resource" }), props.onPin && (0, import_jsx_runtime80.jsx)(Menu.Item, { leftSection: (0, import_jsx_runtime80.jsx)(IconPin, { size: 14 }), onClick: () => props.onPin(props.resource), "aria-label": `Pin ${X(props.resource)}`, children: "Pin" }), props.onUnpin && (0, import_jsx_runtime80.jsx)(Menu.Item, { leftSection: (0, import_jsx_runtime80.jsx)(IconPinnedOff, { size: 14 }), onClick: () => props.onUnpin(props.resource), "aria-label": `Unpin ${X(props.resource)}`, children: "Unpin" }), props.onDetails && (0, import_jsx_runtime80.jsx)(Menu.Item, { leftSection: (0, import_jsx_runtime80.jsx)(IconListDetails, { size: 14 }), onClick: () => props.onDetails(props.resource), "aria-label": `Details ${X(props.resource)}`, children: "Details" }), props.onEdit && (0, import_jsx_runtime80.jsx)(Menu.Item, { leftSection: (0, import_jsx_runtime80.jsx)(IconEdit, { size: 14 }), onClick: () => props.onEdit(props.resource), "aria-label": `Edit ${X(props.resource)}`, children: "Edit" }), props.onDelete && (0, import_jsx_runtime80.jsxs)(import_jsx_runtime80.Fragment, { children: [(0, import_jsx_runtime80.jsx)(Menu.Divider, {}), (0, import_jsx_runtime80.jsx)(Menu.Label, { children: "Danger zone" }), (0, import_jsx_runtime80.jsx)(Menu.Item, { color: "red", leftSection: (0, import_jsx_runtime80.jsx)(IconTrash, { size: 14 }), onClick: () => props.onDelete(props.resource), "aria-label": `Delete ${X(props.resource)}`, children: "Delete" })] })] });
}
function HistoryTimelineItem(props) {
  let previous = getPrevious(props.history, props.resource);
  return previous ? (0, import_jsx_runtime80.jsx)(TimelineItem, { resource: props.resource, padding: true, popupMenuItems: (0, import_jsx_runtime80.jsx)(TimelineItemPopupMenu, { ...props }), children: (0, import_jsx_runtime80.jsx)(ResourceDiffTable, { original: previous, revised: props.resource }) }) : (0, import_jsx_runtime80.jsxs)(TimelineItem, { resource: props.resource, padding: true, popupMenuItems: (0, import_jsx_runtime80.jsx)(TimelineItemPopupMenu, { ...props }), children: [(0, import_jsx_runtime80.jsx)("h3", { children: "Created" }), (0, import_jsx_runtime80.jsx)(ResourceTable, { value: props.resource, ignoreMissingValues: true, forceUseInput: true })] });
}
function getPrevious(history, version) {
  let entries = history.entry, index = entries.findIndex((entry) => {
    var _a, _b, _c;
    return ((_b = (_a = entry.resource) == null ? void 0 : _a.meta) == null ? void 0 : _b.versionId) === ((_c = version.meta) == null ? void 0 : _c.versionId);
  });
  if (!(index >= entries.length - 1))
    return entries[index + 1].resource;
}
function CommunicationTimelineItem(props) {
  var _a, _b;
  let className = !props.resource.priority || props.resource.priority === "routine" ? void 0 : ResourceTimeline_default.pinnedComment;
  return (0, import_jsx_runtime80.jsx)(TimelineItem, { resource: props.resource, profile: props.resource.sender, dateTime: props.resource.sent, padding: true, className, popupMenuItems: (0, import_jsx_runtime80.jsx)(TimelineItemPopupMenu, { ...props }), children: (0, import_jsx_runtime80.jsx)("p", { children: (_b = (_a = props.resource.payload) == null ? void 0 : _a[0]) == null ? void 0 : _b.contentString }) });
}
function MediaTimelineItem(props) {
  var _a;
  let contentType = (_a = props.resource.content) == null ? void 0 : _a.contentType, padding = contentType && !contentType.startsWith("image/") && !contentType.startsWith("video/") && contentType !== "application/pdf";
  return (0, import_jsx_runtime80.jsx)(TimelineItem, { resource: props.resource, padding: !!padding, popupMenuItems: (0, import_jsx_runtime80.jsx)(TimelineItemPopupMenu, { ...props }), children: (0, import_jsx_runtime80.jsx)(AttachmentDisplay, { value: props.resource.content }) });
}
function AuditEventTimelineItem(props) {
  return (0, import_jsx_runtime80.jsx)(TimelineItem, { resource: props.resource, padding: true, popupMenuItems: (0, import_jsx_runtime80.jsx)(TimelineItemPopupMenu, { ...props }), children: (0, import_jsx_runtime80.jsx)(ScrollArea, { children: (0, import_jsx_runtime80.jsx)("pre", { children: props.resource.outcomeDesc }) }) });
}
function DiagnosticReportTimelineItem(props) {
  return (0, import_jsx_runtime80.jsx)(TimelineItem, { resource: props.resource, padding: true, popupMenuItems: (0, import_jsx_runtime80.jsx)(TimelineItemPopupMenu, { ...props }), children: (0, import_jsx_runtime80.jsx)(DiagnosticReportDisplay, { value: props.resource }) });
}
function getProgressMessage(e) {
  if (e.lengthComputable) {
    let percent = 100 * e.loaded / e.total;
    return `Uploaded: ${formatFileSize(e.loaded)} / ${formatFileSize(e.total)} ${percent.toFixed(2)}%`;
  }
  return `Uploaded: ${formatFileSize(e.loaded)}`;
}
function formatFileSize(bytes) {
  if (bytes === 0)
    return "0.00 B";
  let e = Math.floor(Math.log(bytes) / Math.log(1024));
  return (bytes / Math.pow(1024, e)).toFixed(2) + " " + " KMGTP".charAt(e) + "B";
}
function DefaultResourceTimeline(props) {
  return (0, import_jsx_runtime81.jsx)(ResourceTimeline, { value: props.resource, loadTimelineResources: async (medplum, resourceType, id) => {
    let ref = `${resourceType}/${id}`;
    return Promise.allSettled([medplum.readHistory(resourceType, id), medplum.search("Task", { _filter: `based-on eq ${ref} or focus eq ${ref} or subject eq ${ref}`, _count: 100 })]);
  } });
}
function Document(props) {
  let { children: children2, ...others } = props;
  return (0, import_jsx_runtime82.jsx)(Container2, { children: (0, import_jsx_runtime82.jsx)(Panel, { ...others, children: children2 }) });
}
function EncounterTimeline(props) {
  return (0, import_jsx_runtime83.jsx)(ResourceTimeline, { value: props.encounter, loadTimelineResources: async (medplum, _resourceType, id) => Promise.allSettled([medplum.readHistory("Encounter", id), medplum.search("Communication", "encounter=Encounter/" + id), medplum.search("Media", "encounter=Encounter/" + id)]), createCommunication: (resource, sender, text) => ({ resourceType: "Communication", status: "completed", encounter: Z(resource), subject: resource.subject, sender: Z(sender), sent: (/* @__PURE__ */ new Date()).toISOString(), payload: [{ contentString: text }] }), createMedia: (resource, operator, content) => ({ resourceType: "Media", status: "completed", encounter: Z(resource), subject: resource.subject, operator: Z(operator), issued: (/* @__PURE__ */ new Date()).toISOString(), content }) });
}
function FhirPathDisplay(props) {
  let value;
  try {
    value = ge(props.path, props.resource);
  } catch (err) {
    return console.warn("FhirPathDisplay:", err), null;
  }
  if (value.length > 1)
    throw new Error(`Component "path" for "FhirPathDisplay" must resolve to a single element.        Received ${value.length} elements        [${JSON.stringify(value, null, 2)}]`);
  return (0, import_jsx_runtime84.jsx)(ResourcePropertyDisplay, { value: value[0] || "", propertyType: props.propertyType });
}
function SearchExportDialog(props) {
  return (0, import_jsx_runtime85.jsxs)(Modal, { title: "Export", closeButtonProps: { "aria-label": "Close" }, opened: props.visible, onClose: props.onCancel, children: [(0, import_jsx_runtime85.jsxs)(Box, { display: "flex", style: { justifyContent: "space-between" }, children: [props.exportCsv && (0, import_jsx_runtime85.jsx)(ExportButton, { text: "CSV", exportLogic: props.exportCsv, onCancel: props.onCancel }), props.exportTransactionBundle && (0, import_jsx_runtime85.jsx)(ExportButton, { text: "Transaction Bundle", exportLogic: props.exportTransactionBundle, onCancel: props.onCancel })] }), (0, import_jsx_runtime85.jsx)(Text, { style: { marginTop: "10px", marginLeft: "2px" }, children: "Limited to 1000 records" })] });
}
function ExportButton(props) {
  return (0, import_jsx_runtime85.jsx)(Button, { onClick: () => {
    props.exportLogic(), props.onCancel();
  }, children: `Export as ${props.text}` });
}
var searchParamToOperators = { string: [To.EQUALS, To.NOT, To.CONTAINS, To.EXACT], fulltext: [To.EQUALS, To.NOT, To.CONTAINS, To.EXACT], token: [To.EQUALS, To.NOT], reference: [To.EQUALS, To.NOT], numeric: [To.EQUALS, To.NOT_EQUALS, To.GREATER_THAN, To.LESS_THAN, To.GREATER_THAN_OR_EQUALS, To.LESS_THAN_OR_EQUALS], quantity: [To.EQUALS, To.NOT_EQUALS, To.GREATER_THAN, To.LESS_THAN, To.GREATER_THAN_OR_EQUALS, To.LESS_THAN_OR_EQUALS], date: [To.EQUALS, To.NOT_EQUALS, To.GREATER_THAN, To.LESS_THAN, To.GREATER_THAN_OR_EQUALS, To.LESS_THAN_OR_EQUALS, To.STARTS_AFTER, To.ENDS_BEFORE, To.APPROXIMATELY], datetime: [To.EQUALS, To.NOT_EQUALS, To.GREATER_THAN, To.LESS_THAN, To.GREATER_THAN_OR_EQUALS, To.LESS_THAN_OR_EQUALS, To.STARTS_AFTER, To.ENDS_BEFORE, To.APPROXIMATELY] };
var operatorNames = { eq: "equals", ne: "not equals", gt: "greater than", lt: "less than", ge: "greater than or equals", le: "less than or equals", sa: "starts after", eb: "ends before", ap: "approximately", contains: "contains", exact: "exact", text: "text", not: "not", above: "above", below: "below", in: "in", "not-in": "not in", "of-type": "of type", missing: "missing", identifier: "identifier", iterate: "iterate" };
function setFilters(definition, filters) {
  return { ...definition, filters, offset: 0, name: void 0 };
}
function clearFilters(definition) {
  return setFilters(definition, []);
}
function clearFiltersOnField(definition, code) {
  return setFilters(definition, (definition.filters ?? []).filter((f2) => f2.code !== code));
}
function addFilter(definition, field, op, value, opt_clear) {
  opt_clear && (definition = clearFiltersOnField(definition, field));
  let nextFilters = [];
  return definition.filters && nextFilters.push(...definition.filters), nextFilters.push({ code: field, operator: op, value: value ?? "" }), setFilters(definition, nextFilters);
}
function addField(definition, field) {
  var _a;
  if ((_a = definition.fields) == null ? void 0 : _a.includes(field))
    return definition;
  let newFields = [];
  return definition.fields && newFields.push(...definition.fields), newFields.push(field), { ...definition, fields: newFields, name: void 0 };
}
function deleteFilter(definition, index) {
  if (!definition.filters)
    return definition;
  let newFilters = [...definition.filters];
  return newFilters.splice(index, 1), { ...definition, filters: newFilters, name: void 0 };
}
function addYesterdayFilter(definition, field) {
  return addDayFilter(definition, field, -1);
}
function addTodayFilter(definition, field) {
  return addDayFilter(definition, field, 0);
}
function addTomorrowFilter(definition, field) {
  return addDayFilter(definition, field, 1);
}
function addDayFilter(definition, field, delta) {
  let startTime = /* @__PURE__ */ new Date();
  startTime.setDate(startTime.getDate() + delta), startTime.setHours(0, 0, 0, 0);
  let endTime = new Date(startTime.getTime());
  return endTime.setDate(endTime.getDate() + 1), endTime.setTime(endTime.getTime() - 1), addDateFilterBetween(definition, field, startTime, endTime);
}
function addLastMonthFilter(definition, field) {
  return addMonthFilter(definition, field, -1);
}
function addThisMonthFilter(definition, field) {
  return addMonthFilter(definition, field, 0);
}
function addNextMonthFilter(definition, field) {
  return addMonthFilter(definition, field, 1);
}
function addMonthFilter(definition, field, delta) {
  let startTime = /* @__PURE__ */ new Date();
  startTime.setMonth(startTime.getMonth() + delta), startTime.setDate(1), startTime.setHours(0, 0, 0, 0);
  let endTime = new Date(startTime.getTime());
  return endTime.setMonth(endTime.getMonth() + 1), endTime.setDate(1), endTime.setHours(0, 0, 0, 0), endTime.setTime(endTime.getTime() - 1), addDateFilterBetween(definition, field, startTime, endTime);
}
function addYearToDateFilter(definition, field) {
  let startTime = /* @__PURE__ */ new Date();
  return startTime.setMonth(0), startTime.setDate(1), startTime.setHours(0, 0, 0, 0), addDateFilterBetween(definition, field, startTime, /* @__PURE__ */ new Date());
}
function addDateFilterBetween(definition, field, d1, d2) {
  return definition = clearFiltersOnField(definition, field), definition = addDateFilterImpl(definition, field, To.GREATER_THAN_OR_EQUALS, d1), definition = addDateFilterImpl(definition, field, To.LESS_THAN_OR_EQUALS, d2), definition;
}
function addDateFilterImpl(definition, field, op, value) {
  return addFilter(definition, field, op, value.toISOString());
}
function addMissingFilter(definition, field, value = true) {
  return addFilter(definition, field, To.MISSING, value.toString());
}
function setOffset(definition, offset) {
  return definition.offset === offset ? definition : { ...definition, offset, name: void 0 };
}
function setPage(definition, page) {
  let count = definition.count ?? Qu, newOffset = (page - 1) * count;
  return setOffset(definition, newOffset);
}
function setSort(definition, sort, desc) {
  return sort === getSortField(definition) && desc !== void 0 && desc === isSortDescending(definition) ? definition : { ...definition, sortRules: [{ code: sort, descending: !!desc }], name: void 0 };
}
function toggleSort(definition, key) {
  let desc = false;
  return getSortField(definition) === key && (desc = !isSortDescending(definition)), setSort(definition, key, desc);
}
function getSortField(definition) {
  let sortRules = definition.sortRules;
  if (!sortRules || sortRules.length === 0)
    return;
  let field = sortRules[0].code;
  return field.startsWith("-") ? field.substr(1) : field;
}
function isSortDescending(definition) {
  let sortRules = definition.sortRules;
  return !sortRules || sortRules.length === 0 ? false : !!sortRules[0].descending;
}
function getSearchOperators(searchParam) {
  return searchParamToOperators[searchParam.type];
}
function getOpString(op) {
  return operatorNames[op] ?? "";
}
function buildFieldNameString(key) {
  let tmp = key;
  return tmp.includes(".") && (tmp = tmp.split(".").pop()), tmp === "versionId" ? "Version ID" : (tmp = tmp.replace("[x]", ""), tmp = tmp.replace(/([A-Z])/g, " $1"), tmp = tmp.replace(/[-_]/g, " "), tmp = tmp.replace(/\s+/g, " "), tmp = tmp.trim(), tmp.toLowerCase() === "id" ? "ID" : tmp.split(/\s/).map(C).join(" "));
}
function renderValue(resource, field) {
  var _a, _b;
  let key = field.name;
  return key === "id" ? resource.id : key === "meta.versionId" ? (_a = resource.meta) == null ? void 0 : _a.versionId : key === "_lastUpdated" ? nr((_b = resource.meta) == null ? void 0 : _b.lastUpdated) : field.elementDefinition && `${resource.resourceType}.${field.name}` === field.elementDefinition.path ? renderPropertyValue(resource, field.elementDefinition) : field.searchParams && field.searchParams.length === 1 && field.name === field.searchParams[0].code ? renderSearchParameterValue(resource, field.searchParams[0]) : null;
}
function renderPropertyValue(resource, elementDefinition) {
  var _a, _b, _c;
  let path = ((_c = (_b = (_a = elementDefinition.path) == null ? void 0 : _a.split(".")) == null ? void 0 : _b.pop()) == null ? void 0 : _c.replaceAll("[x]", "")) ?? "", [value, propertyType] = getValueAndType({ type: resource.resourceType, value: resource }, path);
  return value ? (0, import_jsx_runtime86.jsx)(ResourcePropertyDisplay, { path: elementDefinition.path, property: elementDefinition, propertyType, value, maxWidth: 200, ignoreMissingValues: true, link: false }) : null;
}
function renderSearchParameterValue(resource, searchParam) {
  let value = $(searchParam.expression, [{ type: resource.resourceType, value: resource }]);
  return !value || value.length === 0 ? null : (0, import_jsx_runtime86.jsx)(import_jsx_runtime86.Fragment, { children: value.map((v2, index) => (0, import_jsx_runtime86.jsx)(ResourcePropertyDisplay, { propertyType: v2.type, value: v2.value, maxWidth: 200, ignoreMissingValues: true, link: false }, `${index}-${value.length}`)) });
}
function SearchFieldEditor(props) {
  let wasDropdownOpen = (0, import_react68.useRef)(false), [state, setState] = (0, import_react68.useState)({ search: JSON.parse(ln(props.search)) }), [isDropdownOpen, setIsDropdownOpen] = (0, import_react68.useState)(false);
  (0, import_react68.useEffect)(() => {
    setState({ search: props.search });
  }, [props.search]);
  let allFields = (0, import_react68.useMemo)(() => {
    if (!props.visible)
      return [];
    let resourceType = props.search.resourceType, typeSchema = pe(resourceType), searchParams = Zc(resourceType);
    return getFieldsList(typeSchema, searchParams).sort((a2, b2) => a2.localeCompare(b2)).map((field) => ({ value: field, label: buildFieldNameString(field) }));
  }, [props.visible, props.search.resourceType]);
  if (!props.visible)
    return null;
  function handleChange(newFields) {
    setState({ search: { ...state.search, fields: newFields } });
  }
  return (0, import_jsx_runtime87.jsx)(Modal, { title: "Fields", closeButtonProps: { "aria-label": "Close" }, opened: props.visible, onClose: () => {
    props.onCancel();
  }, size: "auto", withOverlay: true, closeOnClickOutside: false, overlayProps: { onMouseDownCapture: () => {
    wasDropdownOpen.current = isDropdownOpen;
  }, onClick: () => {
    wasDropdownOpen.current || props.onCancel(), wasDropdownOpen.current = false;
  }, children: (0, import_jsx_runtime87.jsx)("div", { "data-testid": "overlay-child" }) }, children: (0, import_jsx_runtime87.jsxs)(Stack, { children: [(0, import_jsx_runtime87.jsx)(MultiSelect, { style: { width: 550 }, placeholder: "Select fields to display", data: allFields, value: state.search.fields ?? [], onChange: handleChange, onDropdownOpen: () => setIsDropdownOpen(true), onDropdownClose: () => setIsDropdownOpen(false), maxDropdownHeight: "250px", clearButtonProps: { "aria-label": "Clear selection" }, clearable: true, searchable: true }), (0, import_jsx_runtime87.jsx)(Group, { justify: "flex-end", children: (0, import_jsx_runtime87.jsx)(Button, { onClick: () => props.onOk(state.search), children: "OK" }) })] }) });
}
function getFieldsList(typeSchema, searchParams) {
  let result = [], keys = /* @__PURE__ */ new Set(), names = /* @__PURE__ */ new Set();
  for (let key of Object.keys(typeSchema.elements))
    result.push(key), keys.add(key.toLowerCase()), names.add(buildFieldNameString(key));
  if (searchParams)
    for (let code of Object.keys(searchParams)) {
      let name = buildFieldNameString(code);
      !keys.has(code) && !names.has(name) && (result.push(code), keys.add(code), names.add(name));
    }
  return result;
}
function SearchFilterValueDisplay(props) {
  var _a;
  let { resourceType, filter } = props, searchParam = (_a = F.types[resourceType].searchParams) == null ? void 0 : _a[filter.code];
  if (searchParam) {
    if (searchParam.type === "reference" && (filter.operator === To.EQUALS || filter.operator === To.NOT_EQUALS))
      return (0, import_jsx_runtime88.jsx)(ResourceName, { value: { reference: filter.value } });
    let searchParamDetails = bn(resourceType, searchParam);
    if (filter.code === "_lastUpdated" || searchParamDetails.type === En.DATETIME)
      return (0, import_jsx_runtime88.jsx)(import_jsx_runtime88.Fragment, { children: nr(filter.value) });
  }
  return (0, import_jsx_runtime88.jsx)(import_jsx_runtime88.Fragment, { children: filter.value });
}
function SearchFilterValueInput(props) {
  let details = bn(props.resourceType, props.searchParam), name = "filter-value";
  switch (details.type) {
    case En.REFERENCE:
      return (0, import_jsx_runtime89.jsx)(ReferenceInput, { name, defaultValue: props.defaultValue ? { reference: props.defaultValue } : void 0, targetTypes: props.searchParam.target, autoFocus: props.autoFocus, onChange: (newReference) => {
        newReference ? props.onChange(newReference.reference) : props.onChange("");
      } });
    case En.BOOLEAN:
      return (0, import_jsx_runtime89.jsx)(Checkbox, { name, "data-autofocus": props.autoFocus, "data-testid": name, defaultChecked: props.defaultValue === "true", autoFocus: props.autoFocus, onChange: (e) => props.onChange(e.currentTarget.checked.toString()) });
    case En.DATE:
      return (0, import_jsx_runtime89.jsx)(TextInput, { type: "date", name, "data-autofocus": props.autoFocus, "data-testid": name, defaultValue: props.defaultValue, autoFocus: props.autoFocus, onChange: (e) => props.onChange(e.currentTarget.value) });
    case En.DATETIME:
      return (0, import_jsx_runtime89.jsx)(DateTimeInput, { name, defaultValue: props.defaultValue, autoFocus: props.autoFocus, onChange: props.onChange });
    case En.NUMBER:
      return (0, import_jsx_runtime89.jsx)(TextInput, { type: "number", name, "data-autofocus": props.autoFocus, "data-testid": name, defaultValue: props.defaultValue, autoFocus: props.autoFocus, onChange: (e) => props.onChange(e.currentTarget.value) });
    case En.QUANTITY:
      return (0, import_jsx_runtime89.jsx)(QuantityInput, { name, defaultValue: tryParseQuantity(props.defaultValue), autoFocus: props.autoFocus, onChange: (newQuantity) => {
        newQuantity ? props.onChange(`${newQuantity.value}`) : props.onChange("");
      } });
    default:
      return (0, import_jsx_runtime89.jsx)(TextInput, { name, "data-autofocus": props.autoFocus, "data-testid": name, defaultValue: props.defaultValue, autoFocus: props.autoFocus, onChange: (e) => props.onChange(e.currentTarget.value), placeholder: "Search value" });
  }
}
function tryParseQuantity(value) {
  if (value) {
    let [valueString, systemString, unitString] = value.split("|");
    if (valueString)
      return { value: parseFloat(valueString), system: systemString, unit: unitString };
  }
}
function SearchFilterEditor(props) {
  let [search, setSearch] = (0, import_react69.useState)(JSON.parse(ln(props.search))), [editingIndex, setEditingIndex] = (0, import_react69.useState)(-1), searchRef = (0, import_react69.useRef)(search);
  searchRef.current = search, (0, import_react69.useEffect)(() => {
    setSearch(JSON.parse(ln(props.search)));
  }, [props.search]);
  function onAddFilter(filter) {
    setSearch(addFilter(searchRef.current, filter.code, filter.operator, filter.value));
  }
  if (!props.visible)
    return null;
  let resourceType = props.search.resourceType, searchParams = Zc(resourceType) ?? {}, filters = search.filters || [];
  return (0, import_jsx_runtime90.jsxs)(Modal, { title: "Filters", closeButtonProps: { "aria-label": "Close" }, size: 900, opened: props.visible, onClose: props.onCancel, children: [(0, import_jsx_runtime90.jsx)("div", { children: (0, import_jsx_runtime90.jsxs)("table", { children: [(0, import_jsx_runtime90.jsxs)("colgroup", { children: [(0, import_jsx_runtime90.jsx)("col", { style: { width: 200 } }), (0, import_jsx_runtime90.jsx)("col", { style: { width: 200 } }), (0, import_jsx_runtime90.jsx)("col", { style: { width: 380 } }), (0, import_jsx_runtime90.jsx)("col", { style: { width: 120 } })] }), (0, import_jsx_runtime90.jsx)("thead", { children: (0, import_jsx_runtime90.jsxs)("tr", { children: [(0, import_jsx_runtime90.jsx)("th", { children: "Field" }), (0, import_jsx_runtime90.jsx)("th", { children: "Operation" }), (0, import_jsx_runtime90.jsx)("th", { children: "Value" }), (0, import_jsx_runtime90.jsx)("th", { children: "Actions" })] }) }), (0, import_jsx_runtime90.jsxs)("tbody", { children: [filters.map((filter, index) => index === editingIndex ? (0, import_jsx_runtime90.jsx)(FilterRowInput, { resourceType, searchParams, defaultValue: filter, okText: "Save", onOk: (newFilter) => {
    let newFilters = [...filters];
    newFilters[index] = newFilter, setSearch(setFilters(searchRef.current, newFilters)), setEditingIndex(-1);
  }, onCancel: () => setEditingIndex(-1) }, `filter-${filter.code}-${filter.operator}-${filter.value}-input`) : (0, import_jsx_runtime90.jsx)(FilterRowDisplay, { resourceType, filter, onEdit: () => setEditingIndex(index), onDelete: () => setSearch(deleteFilter(searchRef.current, index)) }, `filter-${filter.code}-${filter.operator}-${filter.value}-display`)), (0, import_jsx_runtime90.jsx)(FilterRowInput, { resourceType, searchParams, okText: "Add", onOk: onAddFilter })] })] }) }), (0, import_jsx_runtime90.jsx)(Group, { justify: "flex-end", mt: "xl", children: (0, import_jsx_runtime90.jsx)(Button, { onClick: () => props.onOk(searchRef.current), children: "OK" }) })] });
}
function FilterRowDisplay(props) {
  let { filter } = props;
  return (0, import_jsx_runtime90.jsxs)("tr", { children: [(0, import_jsx_runtime90.jsx)("td", { children: buildFieldNameString(filter.code) }), (0, import_jsx_runtime90.jsx)("td", { children: getOpString(filter.operator) }), (0, import_jsx_runtime90.jsx)("td", { children: (0, import_jsx_runtime90.jsx)(SearchFilterValueDisplay, { resourceType: props.resourceType, filter }) }), (0, import_jsx_runtime90.jsxs)("td", { children: [(0, import_jsx_runtime90.jsx)(Button, { size: "compact-md", variant: "outline", onClick: props.onEdit, children: "Edit" }), (0, import_jsx_runtime90.jsx)(Button, { size: "compact-md", variant: "outline", onClick: props.onDelete, children: "Delete" })] })] });
}
function FilterRowInput(props) {
  let [value, setValue] = (0, import_react69.useState)(props.defaultValue ?? {}), valueRef = (0, import_react69.useRef)(value);
  valueRef.current = value;
  function setFilterCode(newCode) {
    setValue({ ...valueRef.current, code: newCode });
  }
  function setFilterOperator(newOperator) {
    setValue({ ...valueRef.current, operator: newOperator });
  }
  function setFilterValue(newFilterValue) {
    setValue({ ...valueRef.current, value: newFilterValue });
  }
  let searchParam = props.searchParams[value.code], operators = searchParam && getSearchOperators(searchParam);
  return (0, import_jsx_runtime90.jsxs)("tr", { children: [(0, import_jsx_runtime90.jsx)("td", { children: (0, import_jsx_runtime90.jsx)(NativeSelect, { "data-testid": "filter-field", defaultValue: valueRef.current.code, onChange: (e) => setFilterCode(e.currentTarget.value), data: ["", ...Object.keys(props.searchParams).map((param) => ({ value: param, label: buildFieldNameString(param) }))] }) }), (0, import_jsx_runtime90.jsx)("td", { children: operators && (0, import_jsx_runtime90.jsx)(NativeSelect, { "data-testid": "filter-operation", defaultValue: value.operator, onChange: (e) => setFilterOperator(e.currentTarget.value), data: ["", ...operators.map((op) => ({ value: op, label: getOpString(op) }))] }) }), (0, import_jsx_runtime90.jsx)("td", { children: searchParam && value.operator && (0, import_jsx_runtime90.jsx)(SearchFilterValueInput, { resourceType: props.resourceType, searchParam, defaultValue: value.value, onChange: setFilterValue }) }), (0, import_jsx_runtime90.jsxs)("td", { children: [value.code && value.operator && (0, import_jsx_runtime90.jsx)(Button, { size: "compact-md", variant: "outline", onClick: () => {
    props.onOk(valueRef.current), setValue({});
  }, children: props.okText }), props.onCancel && (0, import_jsx_runtime90.jsx)(Button, { size: "compact-md", variant: "outline", onClick: props.onCancel, children: "Cancel" })] })] });
}
function SearchFilterValueDialog(props) {
  let [value, setValue] = (0, import_react70.useState)(props.defaultValue ?? "");
  if (!props.visible || !props.searchParam || !props.filter)
    return null;
  function onOk() {
    props.onOk({ ...props.filter, value });
  }
  return (0, import_jsx_runtime91.jsx)(Modal, { title: props.title, size: "xl", opened: props.visible, onClose: props.onCancel, children: (0, import_jsx_runtime91.jsx)(Form, { onSubmit: onOk, children: (0, import_jsx_runtime91.jsxs)(Grid, { children: [(0, import_jsx_runtime91.jsx)(Grid.Col, { span: 10, children: (0, import_jsx_runtime91.jsx)(SearchFilterValueInput, { resourceType: props.resourceType, searchParam: props.searchParam, defaultValue: value, autoFocus: true, onChange: setValue }) }), (0, import_jsx_runtime91.jsx)(Grid.Col, { span: 2, children: (0, import_jsx_runtime91.jsx)(Button, { onClick: onOk, fullWidth: true, children: "OK" }) })] }) }) });
}
function SearchPopupMenu(props) {
  if (!props.searchParams)
    return null;
  function onSort(searchParam, desc) {
    onChange(setSort(props.search, searchParam.code, desc));
  }
  function onClear(searchParam) {
    onChange(clearFiltersOnField(props.search, searchParam.code));
  }
  function onPrompt(searchParam, operator) {
    props.onPrompt(searchParam, { code: searchParam.code, operator, value: "" });
  }
  function onChange(definition) {
    props.onChange(definition);
  }
  return props.searchParams.length === 1 ? (0, import_jsx_runtime92.jsx)(SearchParameterSubMenu, { search: props.search, searchParam: props.searchParams[0], onSort, onPrompt, onChange, onClear }) : (0, import_jsx_runtime92.jsx)(Menu.Dropdown, { children: props.searchParams.map((searchParam) => (0, import_jsx_runtime92.jsx)(Menu.Item, { children: buildFieldNameString(searchParam.code) }, searchParam.code)) });
}
function SearchParameterSubMenu(props) {
  switch (props.searchParam.type) {
    case "date":
      return (0, import_jsx_runtime92.jsx)(DateFilterSubMenu, { ...props });
    case "number":
    case "quantity":
      return (0, import_jsx_runtime92.jsx)(NumericFilterSubMenu, { ...props });
    case "reference":
      return (0, import_jsx_runtime92.jsx)(ReferenceFilterSubMenu, { ...props });
    case "string":
      return (0, import_jsx_runtime92.jsx)(TextFilterSubMenu, { ...props });
    case "token":
    case "uri":
      return (0, import_jsx_runtime92.jsx)(TokenFilterSubMenu, { ...props });
    default:
      return (0, import_jsx_runtime92.jsxs)(import_jsx_runtime92.Fragment, { children: ["Unknown search param type: ", props.searchParam.type] });
  }
}
function DateFilterSubMenu(props) {
  let { searchParam } = props, code = searchParam.code;
  return (0, import_jsx_runtime92.jsxs)(Menu.Dropdown, { children: [(0, import_jsx_runtime92.jsx)(Menu.Item, { leftSection: (0, import_jsx_runtime92.jsx)(IconSortAscending, { size: 14 }), onClick: () => props.onSort(searchParam, false), children: "Sort Oldest to Newest" }), (0, import_jsx_runtime92.jsx)(Menu.Item, { leftSection: (0, import_jsx_runtime92.jsx)(IconSortDescending, { size: 14 }), onClick: () => props.onSort(searchParam, true), children: "Sort Newest to Oldest" }), (0, import_jsx_runtime92.jsx)(Menu.Divider, {}), (0, import_jsx_runtime92.jsx)(Menu.Item, { leftSection: (0, import_jsx_runtime92.jsx)(IconEqual, { size: 14 }), onClick: () => props.onPrompt(searchParam, To.EQUALS), children: "Equals..." }), (0, import_jsx_runtime92.jsx)(Menu.Item, { leftSection: (0, import_jsx_runtime92.jsx)(IconEqualNot, { size: 14 }), onClick: () => props.onPrompt(searchParam, To.NOT_EQUALS), children: "Does not equal..." }), (0, import_jsx_runtime92.jsx)(Menu.Divider, {}), (0, import_jsx_runtime92.jsx)(Menu.Item, { leftSection: (0, import_jsx_runtime92.jsx)(IconMathLower, { size: 14 }), onClick: () => props.onPrompt(searchParam, To.ENDS_BEFORE), children: "Before..." }), (0, import_jsx_runtime92.jsx)(Menu.Item, { leftSection: (0, import_jsx_runtime92.jsx)(IconMathGreater, { size: 14 }), onClick: () => props.onPrompt(searchParam, To.STARTS_AFTER), children: "After..." }), (0, import_jsx_runtime92.jsx)(Menu.Item, { leftSection: (0, import_jsx_runtime92.jsx)(IconBracketsContain, { size: 14 }), onClick: () => props.onPrompt(searchParam, To.EQUALS), children: "Between..." }), (0, import_jsx_runtime92.jsx)(Menu.Divider, {}), (0, import_jsx_runtime92.jsx)(Menu.Item, { leftSection: (0, import_jsx_runtime92.jsx)(IconCalendar, { size: 14 }), onClick: () => props.onChange(addTomorrowFilter(props.search, code)), children: "Tomorrow" }), (0, import_jsx_runtime92.jsx)(Menu.Item, { leftSection: (0, import_jsx_runtime92.jsx)(IconCalendar, { size: 14 }), onClick: () => props.onChange(addTodayFilter(props.search, code)), children: "Today" }), (0, import_jsx_runtime92.jsx)(Menu.Item, { leftSection: (0, import_jsx_runtime92.jsx)(IconCalendar, { size: 14 }), onClick: () => props.onChange(addYesterdayFilter(props.search, code)), children: "Yesterday" }), (0, import_jsx_runtime92.jsx)(Menu.Divider, {}), (0, import_jsx_runtime92.jsx)(Menu.Item, { leftSection: (0, import_jsx_runtime92.jsx)(IconCalendar, { size: 14 }), onClick: () => props.onChange(addNextMonthFilter(props.search, code)), children: "Next Month" }), (0, import_jsx_runtime92.jsx)(Menu.Item, { leftSection: (0, import_jsx_runtime92.jsx)(IconCalendar, { size: 14 }), onClick: () => props.onChange(addThisMonthFilter(props.search, code)), children: "This Month" }), (0, import_jsx_runtime92.jsx)(Menu.Item, { leftSection: (0, import_jsx_runtime92.jsx)(IconCalendar, { size: 14 }), onClick: () => props.onChange(addLastMonthFilter(props.search, code)), children: "Last Month" }), (0, import_jsx_runtime92.jsx)(Menu.Divider, {}), (0, import_jsx_runtime92.jsx)(Menu.Item, { leftSection: (0, import_jsx_runtime92.jsx)(IconCalendar, { size: 14 }), onClick: () => props.onChange(addYearToDateFilter(props.search, code)), children: "Year to date" }), (0, import_jsx_runtime92.jsx)(CommonMenuItems, { ...props })] });
}
function NumericFilterSubMenu(props) {
  let { searchParam } = props;
  return (0, import_jsx_runtime92.jsxs)(Menu.Dropdown, { children: [(0, import_jsx_runtime92.jsx)(Menu.Item, { leftSection: (0, import_jsx_runtime92.jsx)(IconSortAscending, { size: 14 }), onClick: () => props.onSort(searchParam, false), children: "Sort Smallest to Largest" }), (0, import_jsx_runtime92.jsx)(Menu.Item, { leftSection: (0, import_jsx_runtime92.jsx)(IconSortDescending, { size: 14 }), onClick: () => props.onSort(searchParam, true), children: "Sort Largest to Smallest" }), (0, import_jsx_runtime92.jsx)(Menu.Divider, {}), (0, import_jsx_runtime92.jsx)(Menu.Item, { leftSection: (0, import_jsx_runtime92.jsx)(IconEqual, { size: 14 }), onClick: () => props.onPrompt(searchParam, To.EQUALS), children: "Equals..." }), (0, import_jsx_runtime92.jsx)(Menu.Item, { leftSection: (0, import_jsx_runtime92.jsx)(IconEqualNot, { size: 14 }), onClick: () => props.onPrompt(searchParam, To.NOT_EQUALS), children: "Does not equal..." }), (0, import_jsx_runtime92.jsx)(Menu.Divider, {}), (0, import_jsx_runtime92.jsx)(Menu.Item, { leftSection: (0, import_jsx_runtime92.jsx)(IconMathGreater, { size: 14 }), onClick: () => props.onPrompt(searchParam, To.GREATER_THAN), children: "Greater than..." }), (0, import_jsx_runtime92.jsx)(Menu.Item, { leftSection: (0, import_jsx_runtime92.jsx)(IconSettings, { size: 14 }), onClick: () => props.onPrompt(searchParam, To.GREATER_THAN_OR_EQUALS), children: "Greater than or equal to..." }), (0, import_jsx_runtime92.jsx)(Menu.Item, { leftSection: (0, import_jsx_runtime92.jsx)(IconMathLower, { size: 14 }), onClick: () => props.onPrompt(searchParam, To.LESS_THAN), children: "Less than..." }), (0, import_jsx_runtime92.jsx)(Menu.Item, { leftSection: (0, import_jsx_runtime92.jsx)(IconSettings, { size: 14 }), onClick: () => props.onPrompt(searchParam, To.LESS_THAN_OR_EQUALS), children: "Less than or equal to..." }), (0, import_jsx_runtime92.jsx)(CommonMenuItems, { ...props })] });
}
function ReferenceFilterSubMenu(props) {
  let { searchParam } = props;
  return (0, import_jsx_runtime92.jsxs)(Menu.Dropdown, { children: [(0, import_jsx_runtime92.jsx)(Menu.Item, { leftSection: (0, import_jsx_runtime92.jsx)(IconEqual, { size: 14 }), onClick: () => props.onPrompt(searchParam, To.EQUALS), children: "Equals..." }), (0, import_jsx_runtime92.jsx)(Menu.Item, { leftSection: (0, import_jsx_runtime92.jsx)(IconEqualNot, { size: 14 }), onClick: () => props.onPrompt(searchParam, To.NOT), children: "Does not equal..." }), (0, import_jsx_runtime92.jsx)(CommonMenuItems, { ...props })] });
}
function TextFilterSubMenu(props) {
  let { searchParam } = props;
  return (0, import_jsx_runtime92.jsxs)(Menu.Dropdown, { children: [(0, import_jsx_runtime92.jsx)(Menu.Item, { leftSection: (0, import_jsx_runtime92.jsx)(IconSortAscending, { size: 14 }), onClick: () => props.onSort(searchParam, false), children: "Sort A to Z" }), (0, import_jsx_runtime92.jsx)(Menu.Item, { leftSection: (0, import_jsx_runtime92.jsx)(IconSortDescending, { size: 14 }), onClick: () => props.onSort(searchParam, true), children: "Sort Z to A" }), (0, import_jsx_runtime92.jsx)(Menu.Divider, {}), (0, import_jsx_runtime92.jsx)(Menu.Item, { leftSection: (0, import_jsx_runtime92.jsx)(IconEqual, { size: 14 }), onClick: () => props.onPrompt(searchParam, To.EQUALS), children: "Equals..." }), (0, import_jsx_runtime92.jsx)(Menu.Item, { leftSection: (0, import_jsx_runtime92.jsx)(IconEqualNot, { size: 14 }), onClick: () => props.onPrompt(searchParam, To.NOT), children: "Does not equal..." }), (0, import_jsx_runtime92.jsx)(Menu.Divider, {}), (0, import_jsx_runtime92.jsx)(Menu.Item, { leftSection: (0, import_jsx_runtime92.jsx)(IconBucket, { size: 14 }), onClick: () => props.onPrompt(searchParam, To.CONTAINS), children: "Contains..." }), (0, import_jsx_runtime92.jsx)(Menu.Item, { leftSection: (0, import_jsx_runtime92.jsx)(IconBucketOff, { size: 14 }), onClick: () => props.onPrompt(searchParam, To.EQUALS), children: "Does not contain..." }), (0, import_jsx_runtime92.jsx)(CommonMenuItems, { ...props })] });
}
function TokenFilterSubMenu(props) {
  let { searchParam } = props;
  return (0, import_jsx_runtime92.jsxs)(Menu.Dropdown, { children: [(0, import_jsx_runtime92.jsx)(Menu.Item, { leftSection: (0, import_jsx_runtime92.jsx)(IconEqual, { size: 14 }), onClick: () => props.onPrompt(searchParam, To.EQUALS), children: "Equals..." }), (0, import_jsx_runtime92.jsx)(Menu.Item, { leftSection: (0, import_jsx_runtime92.jsx)(IconEqualNot, { size: 14 }), onClick: () => props.onPrompt(searchParam, To.NOT), children: "Does not equal..." }), (0, import_jsx_runtime92.jsx)(CommonMenuItems, { ...props })] });
}
function CommonMenuItems(props) {
  let { searchParam } = props, code = searchParam.code;
  return (0, import_jsx_runtime92.jsxs)(import_jsx_runtime92.Fragment, { children: [(0, import_jsx_runtime92.jsx)(Menu.Divider, {}), (0, import_jsx_runtime92.jsx)(Menu.Item, { leftSection: (0, import_jsx_runtime92.jsx)(IconBleach, { size: 14 }), onClick: () => props.onChange(addMissingFilter(props.search, code)), children: "Missing" }), (0, import_jsx_runtime92.jsx)(Menu.Item, { leftSection: (0, import_jsx_runtime92.jsx)(IconBleachOff, { size: 14 }), onClick: () => props.onChange(addMissingFilter(props.search, code, false)), children: "Not missing" }), (0, import_jsx_runtime92.jsx)(Menu.Divider, {}), (0, import_jsx_runtime92.jsx)(Menu.Item, { leftSection: (0, import_jsx_runtime92.jsx)(IconX, { size: 14 }), onClick: () => props.onClear(searchParam), children: "Clear filters" })] });
}
var SearchControl_default = { root: "SearchControl_root", table: "SearchControl_table", tr: "SearchControl_tr", th: "SearchControl_th", control: "SearchControl_control", icon: "SearchControl_icon" };
function getFieldDefinitions(search) {
  let resourceType = search.resourceType, fields = [];
  for (let name of search.fields || ["id", "_lastUpdated"])
    fields.push(getFieldDefinition(resourceType, name));
  return fields;
}
function getFieldDefinition(resourceType, name) {
  var _a;
  if (name === "_lastUpdated")
    return { name: "_lastUpdated", searchParams: [{ resourceType: "SearchParameter", base: ["Resource"], code: "_lastUpdated", name: "_lastUpdated", type: "date", expression: "Resource.meta.lastUpdated" }] };
  if (name === "meta.versionId")
    return { name: "meta.versionId", searchParams: [{ resourceType: "SearchParameter", base: ["Resource"], code: "_versionId", name: "_versionId", type: "token", expression: "Resource.meta.versionId" }] };
  let exactElementDefinition = ze(resourceType, name), exactSearchParam = Xc(resourceType, name.toLowerCase());
  if (exactElementDefinition && exactSearchParam)
    return { name, elementDefinition: exactElementDefinition, searchParams: [exactSearchParam] };
  if (exactElementDefinition) {
    let allSearchParams = Zc(resourceType), searchParams;
    if (allSearchParams) {
      let pathRegex = new RegExp(`${resourceType}\\.${name.replaceAll("[x]", "")}([^\\w-]|$)`);
      searchParams = Object.values(allSearchParams).filter((p) => !!p.expression && pathRegex.test(p == null ? void 0 : p.expression)), searchParams.length === 0 && (searchParams = void 0);
    }
    return { name, elementDefinition: exactElementDefinition, searchParams };
  }
  if (exactSearchParam) {
    let details = bn(resourceType, exactSearchParam);
    return { name, elementDefinition: (_a = details.elementDefinitions) == null ? void 0 : _a[0], searchParams: [exactSearchParam] };
  }
  return { name };
}
var SearchChangeEvent = class extends Event {
  constructor(definition) {
    super("change"), this.definition = definition;
  }
};
var SearchLoadEvent = class extends Event {
  constructor(response) {
    super("load"), this.response = response;
  }
};
var SearchClickEvent = class extends Event {
  constructor(resource, browserEvent) {
    super("click"), this.resource = resource, this.browserEvent = browserEvent;
  }
};
function SearchControl(props) {
  var _a, _b, _c, _d;
  let medplum = a(), [loadingSchema, setLoadingSchema] = (0, import_react67.useState)(), [outcome, setOutcome] = (0, import_react67.useState)(), { search, onLoad } = props, [state, setState] = (0, import_react67.useState)({ selected: {}, fieldEditorVisible: false, filterEditorVisible: false, exportDialogVisible: false, filterDialogVisible: false }), stateRef = (0, import_react67.useRef)(state);
  stateRef.current = state;
  let loadResults = (0, import_react67.useCallback)((options) => {
    setOutcome(void 0), medplum.search(search.resourceType, Ju({ ...search, fields: void 0 }), options).then((response) => {
      setState({ ...stateRef.current, searchResponse: response }), onLoad && onLoad(new SearchLoadEvent(response));
    }).catch((reason) => {
      setState({ ...stateRef.current, searchResponse: void 0 }), setOutcome(reason);
    });
  }, [medplum, search, onLoad]), refreshResults = (0, import_react67.useCallback)(() => {
    setState({ ...stateRef.current, searchResponse: void 0 }), loadResults({ cache: "reload" });
  }, [loadResults]);
  (0, import_react67.useEffect)(() => {
    loadResults();
  }, [loadResults]);
  function handleSingleCheckboxClick(e, id) {
    e.stopPropagation();
    let checked = e.target.checked, newSelected = { ...stateRef.current.selected };
    checked ? newSelected[id] = true : delete newSelected[id], setState({ ...stateRef.current, selected: newSelected });
  }
  function handleAllCheckboxClick(e) {
    e.stopPropagation();
    let checked = e.target.checked, newSelected = {}, searchResponse = stateRef.current.searchResponse;
    checked && (searchResponse == null ? void 0 : searchResponse.entry) && searchResponse.entry.forEach((entry) => {
      var _a2;
      ((_a2 = entry.resource) == null ? void 0 : _a2.id) && (newSelected[entry.resource.id] = true);
    }), setState({ ...stateRef.current, selected: newSelected });
  }
  function isAllSelected() {
    var _a2, _b2;
    let state2 = stateRef.current;
    if (!((_a2 = state2.searchResponse) == null ? void 0 : _a2.entry) || state2.searchResponse.entry.length === 0)
      return false;
    for (let e of state2.searchResponse.entry)
      if (((_b2 = e.resource) == null ? void 0 : _b2.id) && !state2.selected[e.resource.id])
        return false;
    return true;
  }
  function emitSearchChange(newSearch) {
    props.onChange && props.onChange(new SearchChangeEvent(newSearch));
  }
  function handleRowClick(e, resource) {
    if (isCheckboxCell(e.target) || e.button === 2)
      return;
    killEvent(e);
    let isAux = e.button === 1 || e.ctrlKey || e.metaKey;
    !isAux && props.onClick && props.onClick(new SearchClickEvent(resource, e)), isAux && props.onAuxClick && props.onAuxClick(new SearchClickEvent(resource, e));
  }
  function isExportPassed() {
    return !!(props.onExport ?? props.onExportCsv ?? props.onExportTransactionBundle);
  }
  if ((0, import_react67.useEffect)(() => {
    setLoadingSchema(props.search.resourceType), medplum.requestSchema(props.search.resourceType).catch(console.error).finally(() => setLoadingSchema(void 0));
  }, [medplum, props.search.resourceType]), !Qr(props.search.resourceType) || loadingSchema === props.search.resourceType)
    return (0, import_jsx_runtime93.jsx)(Center, { style: { width: "100%", height: "100%" }, children: (0, import_jsx_runtime93.jsx)(Loader, {}) });
  let checkboxColumn = props.checkboxesEnabled, fields = getFieldDefinitions(search), resourceType = search.resourceType, lastResult = state.searchResponse, resources = (_a = lastResult == null ? void 0 : lastResult.entry) == null ? void 0 : _a.map((e) => e.resource), buttonVariant = "subtle", buttonColor = "gray", iconSize = 16, isMobile = window.innerWidth < 768;
  return (0, import_jsx_runtime93.jsxs)("div", { className: SearchControl_default.root, "data-testid": "search-control", children: [!props.hideToolbar && (0, import_jsx_runtime93.jsxs)(Group, { justify: "space-between", mb: "xl", children: [(0, import_jsx_runtime93.jsxs)(Group, { gap: 2, children: [(0, import_jsx_runtime93.jsx)(Button, { size: "compact-md", variant: buttonVariant, color: buttonColor, leftSection: (0, import_jsx_runtime93.jsx)(IconColumns, { size: iconSize }), onClick: () => setState({ ...stateRef.current, fieldEditorVisible: true }), children: "Fields" }), (0, import_jsx_runtime93.jsx)(Button, { size: "compact-md", variant: buttonVariant, color: buttonColor, leftSection: (0, import_jsx_runtime93.jsx)(IconFilter, { size: iconSize }), onClick: () => setState({ ...stateRef.current, filterEditorVisible: true }), children: "Filters" }), props.onNew && (0, import_jsx_runtime93.jsx)(Button, { size: "compact-md", variant: buttonVariant, color: buttonColor, leftSection: (0, import_jsx_runtime93.jsx)(IconFilePlus, { size: iconSize }), onClick: props.onNew, children: "New..." }), !isMobile && isExportPassed() && (0, import_jsx_runtime93.jsx)(Button, { size: "compact-md", variant: buttonVariant, color: buttonColor, leftSection: (0, import_jsx_runtime93.jsx)(IconTableExport, { size: iconSize }), onClick: props.onExport ? props.onExport : () => setState({ ...stateRef.current, exportDialogVisible: true }), children: "Export..." }), !isMobile && props.onDelete && (0, import_jsx_runtime93.jsx)(Button, { size: "compact-md", variant: buttonVariant, color: buttonColor, leftSection: (0, import_jsx_runtime93.jsx)(IconTrash, { size: iconSize }), onClick: () => props.onDelete(Object.keys(state.selected)), children: "Delete..." }), !isMobile && props.onBulk && (0, import_jsx_runtime93.jsx)(Button, { size: "compact-md", variant: buttonVariant, color: buttonColor, leftSection: (0, import_jsx_runtime93.jsx)(IconBoxMultiple, { size: iconSize }), onClick: () => props.onBulk(Object.keys(state.selected)), children: "Bulk..." })] }), (0, import_jsx_runtime93.jsxs)(Group, { gap: 2, children: [lastResult && (0, import_jsx_runtime93.jsxs)(Text, { size: "xs", c: "dimmed", "data-testid": "count-display", children: [getStart(search, lastResult).toLocaleString(), "-", getEnd(search, lastResult).toLocaleString(), lastResult.total !== void 0 && ` of ${search.total === "estimate" ? "~" : ""}${(_b = lastResult.total) == null ? void 0 : _b.toLocaleString()}`] }), (0, import_jsx_runtime93.jsx)(ActionIcon, { variant: buttonVariant, color: buttonColor, title: "Refresh", onClick: refreshResults, children: (0, import_jsx_runtime93.jsx)(IconRefresh, { size: iconSize }) })] })] }), (0, import_jsx_runtime93.jsxs)(Table, { className: SearchControl_default.table, children: [(0, import_jsx_runtime93.jsxs)(Table.Thead, { children: [(0, import_jsx_runtime93.jsxs)(Table.Tr, { children: [checkboxColumn && (0, import_jsx_runtime93.jsx)(Table.Th, { children: (0, import_jsx_runtime93.jsx)("input", { type: "checkbox", value: "checked", "aria-label": "all-checkbox", "data-testid": "all-checkbox", checked: isAllSelected(), onChange: (e) => handleAllCheckboxClick(e) }) }), fields.map((field) => (0, import_jsx_runtime93.jsx)(Table.Th, { children: (0, import_jsx_runtime93.jsxs)(Menu, { shadow: "md", width: 240, position: "bottom-end", children: [(0, import_jsx_runtime93.jsx)(Menu.Target, { children: (0, import_jsx_runtime93.jsx)(UnstyledButton, { className: SearchControl_default.control, p: 2, children: (0, import_jsx_runtime93.jsxs)(Group, { justify: "space-between", wrap: "nowrap", children: [(0, import_jsx_runtime93.jsx)(Text, { fw: 500, children: buildFieldNameString(field.name) }), (0, import_jsx_runtime93.jsx)(Center, { className: SearchControl_default.icon, children: (0, import_jsx_runtime93.jsx)(IconAdjustmentsHorizontal, { size: 14, stroke: 1.5 }) })] }) }) }), (0, import_jsx_runtime93.jsx)(SearchPopupMenu, { search: props.search, searchParams: field.searchParams, onPrompt: (searchParam, filter) => {
    setState({ ...stateRef.current, filterDialogVisible: true, filterDialogSearchParam: searchParam, filterDialogFilter: filter });
  }, onChange: (result) => {
    emitSearchChange(result);
  } })] }) }, field.name))] }), !props.hideFilters && (0, import_jsx_runtime93.jsxs)(Table.Tr, { children: [checkboxColumn && (0, import_jsx_runtime93.jsx)(Table.Th, {}), fields.map((field) => (0, import_jsx_runtime93.jsx)(Table.Th, { children: field.searchParams && (0, import_jsx_runtime93.jsx)(FilterDescription, { resourceType, searchParams: field.searchParams, filters: props.search.filters }) }, field.name))] })] }), (0, import_jsx_runtime93.jsx)(Table.Tbody, { children: resources == null ? void 0 : resources.map((resource) => resource && (0, import_jsx_runtime93.jsxs)(Table.Tr, { className: SearchControl_default.tr, "data-testid": "search-control-row", onClick: (e) => handleRowClick(e, resource), onAuxClick: (e) => handleRowClick(e, resource), children: [checkboxColumn && (0, import_jsx_runtime93.jsx)(Table.Td, { children: (0, import_jsx_runtime93.jsx)("input", { type: "checkbox", value: "checked", "data-testid": "row-checkbox", "aria-label": `Checkbox for ${resource.id}`, checked: !!state.selected[resource.id], onChange: (e) => handleSingleCheckboxClick(e, resource.id) }) }), fields.map((field) => (0, import_jsx_runtime93.jsx)(Table.Td, { children: renderValue(resource, field) }, field.name))] }, resource.id)) })] }), (resources == null ? void 0 : resources.length) === 0 && (0, import_jsx_runtime93.jsx)(Container2, { children: (0, import_jsx_runtime93.jsx)(Center, { style: { height: 150 }, children: (0, import_jsx_runtime93.jsx)(Text, { size: "xl", c: "dimmed", children: "No results" }) }) }), lastResult && (0, import_jsx_runtime93.jsx)(Center, { m: "md", p: "md", children: (0, import_jsx_runtime93.jsx)(Pagination, { value: getPage(search), total: getTotalPages(search, lastResult), onChange: (newPage) => emitSearchChange(setPage(search, newPage)), getControlProps: (control) => {
    switch (control) {
      case "previous":
        return { "aria-label": "Previous page" };
      case "next":
        return { "aria-label": "Next page" };
      default:
        return {};
    }
  } }) }), outcome && (0, import_jsx_runtime93.jsx)("div", { "data-testid": "search-error", children: (0, import_jsx_runtime93.jsx)("pre", { style: { textAlign: "left" }, children: JSON.stringify(outcome, void 0, 2) }) }), (0, import_jsx_runtime93.jsx)(SearchFieldEditor, { search: props.search, visible: stateRef.current.fieldEditorVisible, onOk: (result) => {
    emitSearchChange(result), setState({ ...stateRef.current, fieldEditorVisible: false });
  }, onCancel: () => {
    setState({ ...stateRef.current, fieldEditorVisible: false });
  } }), (0, import_jsx_runtime93.jsx)(SearchFilterEditor, { search: props.search, visible: stateRef.current.filterEditorVisible, onOk: (result) => {
    emitSearchChange(result), setState({ ...stateRef.current, filterEditorVisible: false });
  }, onCancel: () => {
    setState({ ...stateRef.current, filterEditorVisible: false });
  } }), (0, import_jsx_runtime93.jsx)(SearchExportDialog, { visible: stateRef.current.exportDialogVisible, exportCsv: props.onExportCsv, exportTransactionBundle: props.onExportTransactionBundle, onCancel: () => {
    setState({ ...stateRef.current, exportDialogVisible: false });
  } }), (0, import_jsx_runtime93.jsx)(SearchFilterValueDialog, { visible: stateRef.current.filterDialogVisible, title: ((_c = state.filterDialogSearchParam) == null ? void 0 : _c.code) ? buildFieldNameString(state.filterDialogSearchParam.code) : "", resourceType, searchParam: state.filterDialogSearchParam, filter: state.filterDialogFilter, defaultValue: "", onOk: (filter) => {
    emitSearchChange(addFilter(props.search, filter.code, filter.operator, filter.value)), setState({ ...stateRef.current, filterDialogVisible: false });
  }, onCancel: () => {
    setState({ ...stateRef.current, filterDialogVisible: false });
  } }, (_d = state.filterDialogSearchParam) == null ? void 0 : _d.code)] });
}
var MemoizedSearchControl = (0, import_react67.memo)(SearchControl);
function FilterDescription(props) {
  let filters = (props.filters ?? []).filter((f2) => props.searchParams.find((p) => p.code === f2.code));
  return filters.length === 0 ? (0, import_jsx_runtime93.jsx)("span", { children: "no filters" }) : (0, import_jsx_runtime93.jsx)(import_jsx_runtime93.Fragment, { children: filters.map((filter) => (0, import_jsx_runtime93.jsxs)("div", { children: [getOpString(filter.operator), "", (0, import_jsx_runtime93.jsx)(SearchFilterValueDisplay, { resourceType: props.resourceType, filter })] }, `filter-${filter.code}-${filter.operator}-${filter.value}`)) });
}
function getPage(search) {
  return Math.floor((search.offset ?? 0) / (search.count ?? Qu)) + 1;
}
function getTotalPages(search, lastResult) {
  let pageSize = search.count ?? Qu, total = getTotal(search, lastResult);
  return Math.ceil(total / pageSize);
}
function getStart(search, lastResult) {
  return Math.min(getTotal(search, lastResult), (search.offset ?? 0) + 1);
}
function getEnd(search, lastResult) {
  var _a;
  return getStart(search, lastResult) + (((_a = lastResult.entry) == null ? void 0 : _a.length) ?? 0) - 1;
}
function getTotal(search, lastResult) {
  var _a, _b;
  let total = lastResult.total;
  return total === void 0 && (total = (search.offset ?? 0) + (((_a = lastResult.entry) == null ? void 0 : _a.length) ?? 0) + (((_b = lastResult.link) == null ? void 0 : _b.some((l2) => l2.relation === "next")) ? 1 : 0)), total;
}
function FhirPathTable(props) {
  let medplum = a(), [schemaLoaded, setSchemaLoaded] = (0, import_react66.useState)(false), [outcome, setOutcome] = (0, import_react66.useState)(), { query, fields } = props, [response, setResponse] = (0, import_react66.useState)(), [selected, setSelected] = (0, import_react66.useState)({}), responseRef = (0, import_react66.useRef)();
  responseRef.current = response;
  let selectedRef = (0, import_react66.useRef)({});
  selectedRef.current = selected, (0, import_react66.useEffect)(() => {
    setOutcome(void 0), medplum.graphql(query).then(setResponse).catch((err) => setOutcome(Be(err)));
  }, [medplum, query]);
  function handleSingleCheckboxClick(e, id) {
    e.stopPropagation();
    let checked = e.target.checked, newSelected = { ...selectedRef.current };
    checked ? newSelected[id] = true : delete newSelected[id], setSelected(newSelected);
  }
  function handleAllCheckboxClick(e) {
    var _a;
    e.stopPropagation();
    let checked = e.target.checked, newSelected = {}, resources = (_a = responseRef.current) == null ? void 0 : _a.data.ResourceList;
    checked && resources && resources.forEach((resource) => {
      resource.id && (newSelected[resource.id] = true);
    }), setSelected(newSelected);
  }
  function isAllSelected() {
    var _a;
    let resources = (_a = responseRef.current) == null ? void 0 : _a.data.ResourceList;
    if (!resources || resources.length === 0)
      return false;
    for (let resource of resources)
      if (resource.id && !selectedRef.current[resource.id])
        return false;
    return true;
  }
  function handleRowClick(e, resource) {
    isCheckboxCell(e.target) || (killEvent(e), e.button !== 1 && props.onClick && props.onClick(new SearchClickEvent(resource, e)), e.button === 1 && props.onAuxClick && props.onAuxClick(new SearchClickEvent(resource, e)));
  }
  if ((0, import_react66.useEffect)(() => {
    medplum.requestSchema(props.resourceType).then(() => setSchemaLoaded(true)).catch(console.log);
  }, [medplum, props.resourceType]), !schemaLoaded)
    return (0, import_jsx_runtime94.jsx)(Loader, {});
  let checkboxColumn = props.checkboxesEnabled;
  return (0, import_jsx_runtime94.jsxs)("div", { onContextMenu: (e) => killEvent(e), "data-testid": "search-control", children: [(0, import_jsx_runtime94.jsxs)(Table, { children: [(0, import_jsx_runtime94.jsx)(Table.Thead, { children: (0, import_jsx_runtime94.jsxs)(Table.Tr, { children: [checkboxColumn && (0, import_jsx_runtime94.jsx)(Table.Th, { children: (0, import_jsx_runtime94.jsx)("input", { type: "checkbox", value: "checked", "aria-label": "all-checkbox", "data-testid": "all-checkbox", checked: isAllSelected(), onChange: (e) => handleAllCheckboxClick(e) }) }), fields.map((field) => (0, import_jsx_runtime94.jsx)(Table.Th, { children: field.name }, field.name))] }) }), (0, import_jsx_runtime94.jsx)(Table.Tbody, { children: response == null ? void 0 : response.data.ResourceList.map((resource) => resource && (0, import_jsx_runtime94.jsxs)(Table.Tr, { "data-testid": "search-control-row", onClick: (e) => handleRowClick(e, resource), onAuxClick: (e) => handleRowClick(e, resource), children: [checkboxColumn && (0, import_jsx_runtime94.jsx)(Table.Td, { children: (0, import_jsx_runtime94.jsx)("input", { type: "checkbox", value: "checked", "data-testid": "row-checkbox", "aria-label": `Checkbox for ${resource.id}`, checked: !!selected[resource.id], onChange: (e) => handleSingleCheckboxClick(e, resource.id) }) }), fields.map((field) => (0, import_jsx_runtime94.jsx)(Table.Td, { children: (0, import_jsx_runtime94.jsx)(FhirPathDisplay, { propertyType: field.propertyType, path: field.fhirPath, resource }) }, field.name))] }, resource.id)) })] }), (response == null ? void 0 : response.data.ResourceList.length) === 0 && (0, import_jsx_runtime94.jsx)("div", { "data-testid": "empty-search", children: "No results" }), outcome && (0, import_jsx_runtime94.jsx)("div", { "data-testid": "search-error", children: (0, import_jsx_runtime94.jsx)("pre", { style: { textAlign: "left" }, children: JSON.stringify(outcome, void 0, 2) }) }), props.onBulk && (0, import_jsx_runtime94.jsx)(Button, { onClick: () => props.onBulk(Object.keys(selectedRef.current)), children: "Bulk..." })] });
}
var MemoizedFhirPathTable = (0, import_react66.memo)(FhirPathTable);
function Logo(props) {
  return (0, import_jsx_runtime95.jsxs)("svg", { xmlns: "http://www.w3.org/2000/svg", viewBox: "0 0 491 491", style: { width: props.size, height: props.size }, children: [(0, import_jsx_runtime95.jsx)("title", { children: "Medplum Logo" }), (0, import_jsx_runtime95.jsx)("path", { fill: props.fill ?? "#ad7136", d: "M282 67c6-16 16-29 29-40L289 0c-22 17-37 41-43 68l17 23 19-24z" }), (0, import_jsx_runtime95.jsx)("path", { fill: props.fill ?? "#946af9", d: "M311 63c-17 0-33 4-48 11-16-7-32-11-49-11-87 0-158 96-158 214s71 214 158 214c17 0 33-4 49-11 15 7 31 11 48 11 87 0 158-96 158-214S398 63 311 63z" }), (0, import_jsx_runtime95.jsx)("path", { fill: props.fill ?? "#7857c5", d: "M231 489l-17 2c-87 0-158-96-158-214S127 63 214 63l17 1c-39 12-70 102-70 213s31 201 70 212z" }), (0, import_jsx_runtime95.jsx)("path", { fill: props.fill ?? "#40bc26", d: "M207 220a176 176 0 01-177 43A176 176 0 01251 43l1 5c17 59 2 125-45 172z" }), (0, import_jsx_runtime95.jsx)("path", { fill: props.fill ?? "#33961e", d: "M252 48A421 421 0 0057 270l-27-7A176 176 0 01251 43l1 5z" })] });
}
function MeasureReportGroupDisplay(props) {
  let { group } = props;
  return (0, import_jsx_runtime96.jsx)(Paper, { withBorder: true, radius: "md", p: "xs", display: "flex", style: { alignItems: "center", justifyContent: "center" }, children: (0, import_jsx_runtime96.jsxs)(Group, { children: [group.measureScore && (0, import_jsx_runtime96.jsx)(MeasureScore, { group }), !group.measureScore && (0, import_jsx_runtime96.jsx)(MeasureReportPopulation, { group })] }) });
}
function MeasureTitle(props) {
  let { measure } = props;
  return (0, import_jsx_runtime96.jsxs)(import_jsx_runtime96.Fragment, { children: [(0, import_jsx_runtime96.jsx)(Text, { fz: "md", fw: 500, mb: 8, children: measure.title }), (0, import_jsx_runtime96.jsx)(Text, { fz: "xs", c: "dimmed", mb: 8, children: measure.subtitle })] });
}
function MeasureReportPopulation(props) {
  let { group } = props, populations = group.population, numerator = populations == null ? void 0 : populations.find((p) => Ji(p.code) === "numerator"), denominator = populations == null ? void 0 : populations.find((p) => Ji(p.code) === "denominator"), numeratorCount = numerator == null ? void 0 : numerator.count, denominatorCount = denominator == null ? void 0 : denominator.count;
  if (denominatorCount === 0)
    return (0, import_jsx_runtime96.jsxs)(Box, { children: [(0, import_jsx_runtime96.jsx)(Title, { order: 3, children: "Not Applicable" }), (0, import_jsx_runtime96.jsx)(Text, { children: `Denominator: ${denominatorCount}` })] });
  if (numeratorCount === void 0 || denominatorCount === void 0)
    return (0, import_jsx_runtime96.jsxs)(Box, { children: [(0, import_jsx_runtime96.jsx)(Title, { order: 3, children: "Insufficient Data" }), (0, import_jsx_runtime96.jsx)(Text, { children: `Numerator: ${numeratorCount}` }), (0, import_jsx_runtime96.jsx)(Text, { children: `Denominator: ${denominatorCount}` })] });
  let value = numeratorCount / denominatorCount * 100;
  return (0, import_jsx_runtime96.jsx)(RingProgress, { size: 120, thickness: 12, roundCaps: true, sections: [{ value, color: groupColor(value) }], label: (0, import_jsx_runtime96.jsx)(Flex, { justify: "center", children: (0, import_jsx_runtime96.jsxs)(Text, { fw: 700, fz: 18, children: [numeratorCount, " / ", denominatorCount] }) }) });
}
function MeasureScore(props) {
  var _a, _b, _c;
  let { group } = props, unit = ((_a = group.measureScore) == null ? void 0 : _a.unit) ?? ((_b = group.measureScore) == null ? void 0 : _b.code);
  return (0, import_jsx_runtime96.jsx)(import_jsx_runtime96.Fragment, { children: unit === "%" ? (0, import_jsx_runtime96.jsx)(RingProgress, { size: 120, thickness: 12, roundCaps: true, sections: [{ value: groupValue(group), color: groupColor(((_c = group == null ? void 0 : group.measureScore) == null ? void 0 : _c.value) ?? 0) }], label: (0, import_jsx_runtime96.jsx)(Flex, { justify: "center", children: (0, import_jsx_runtime96.jsx)(Text, { fw: 700, fz: 18, children: (0, import_jsx_runtime96.jsx)(QuantityDisplay, { value: group.measureScore }) }) }) }) : (0, import_jsx_runtime96.jsx)(Flex, { h: 120, align: "center", children: (0, import_jsx_runtime96.jsx)(Title, { order: 3, children: (0, import_jsx_runtime96.jsx)(QuantityDisplay, { value: group.measureScore }) }) }) });
}
function groupValue(group) {
  var _a, _b;
  let score = (_a = group.measureScore) == null ? void 0 : _a.value, unit = (_b = group.measureScore) == null ? void 0 : _b.unit;
  return score ? score <= 1 && unit === "%" ? score * 100 : score : 0;
}
function groupColor(score) {
  return score <= 33 ? "red" : score <= 67 ? "yellow" : "green";
}
function MeasureReportDisplay(props) {
  var _a;
  let report = ce(props.measureReport), [measure] = xe("Measure", { url: report == null ? void 0 : report.measure });
  return report ? (0, import_jsx_runtime97.jsxs)(Box, { children: [measure && (0, import_jsx_runtime97.jsx)(MeasureTitle, { measure }), (0, import_jsx_runtime97.jsx)(SimpleGrid, { cols: { base: 3, sm: 1 }, spacing: { base: "md", sm: "sm" }, children: (_a = report.group) == null ? void 0 : _a.map((group, idx) => (0, import_jsx_runtime97.jsx)(MeasureReportGroupDisplay, { group }, group.id ?? idx)) })] }) : null;
}
function NotificationIcon(props) {
  let medplum = a(), { label, resourceType, countCriteria, subscriptionCriteria, onClick } = props, [unreadCount, setUnreadCount] = (0, import_react71.useState)(0), updateCount = (0, import_react71.useCallback)((cache) => {
    medplum.search(resourceType, countCriteria, { cache }).then((result) => setUnreadCount(result.total)).catch(console.error);
  }, [medplum, resourceType, countCriteria]);
  (0, import_react71.useEffect)(() => {
    updateCount("default");
  }, [updateCount]), Ce(subscriptionCriteria, () => {
    updateCount("reload");
  });
  let icon = (0, import_jsx_runtime98.jsx)(Tooltip, { label, children: (0, import_jsx_runtime98.jsx)(ActionIcon, { variant: "subtle", color: "gray", size: "lg", "aria-label": label, onClick, children: props.iconComponent }) });
  return unreadCount > 0 ? (0, import_jsx_runtime98.jsx)(Indicator, { inline: true, label: unreadCount.toLocaleString(), size: 16, offset: 2, position: "bottom-end", color: "red", children: icon }) : icon;
}
function OperationOutcomeAlert(props) {
  var _a;
  let issues = ((_a = props.outcome) == null ? void 0 : _a.issue) || props.issues;
  return !issues || issues.length === 0 ? null : (0, import_jsx_runtime99.jsx)(Alert, { icon: (0, import_jsx_runtime99.jsx)(IconAlertCircle, { size: 16 }), color: "red", children: issues.map((issue) => {
    var _a2;
    return (0, import_jsx_runtime99.jsx)("div", { "data-testid": "text-field-error", children: fi(issue) }, (_a2 = issue.details) == null ? void 0 : _a2.text);
  }) });
}
function Allergies(props) {
  let medplum = a(), { patient, encounter } = props, [allergies, setAllergies] = (0, import_react73.useState)(props.allergies), [opened, { open, close }] = useDisclosure(false), [code, setCode] = (0, import_react73.useState)(), handleSubmit = (0, import_react73.useCallback)((formData) => {
    medplum.createResource({ resourceType: "AllergyIntolerance", patient: Z(patient), encounter: encounter ? Z(encounter) : void 0, code, onsetDateTime: formData.onset ? formData.onset : void 0, reaction: formData.reaction ? [{ manifestation: [{ text: formData.reaction }] }] : void 0 }).then((newAllergy) => {
      setAllergies([...allergies, newAllergy]), close();
    }).catch(console.error);
  }, [medplum, patient, encounter, allergies, close, code]);
  return (0, import_jsx_runtime100.jsxs)(import_jsx_runtime100.Fragment, { children: [(0, import_jsx_runtime100.jsxs)(Group, { justify: "space-between", children: [(0, import_jsx_runtime100.jsx)(Text, { fz: "md", fw: 700, children: "Allergies" }), (0, import_jsx_runtime100.jsx)(Anchor, { href: "#", onClick: (e) => {
    killEvent(e), open();
  }, children: "+ Add" })] }), allergies.length > 0 ? (0, import_jsx_runtime100.jsx)(Box, { children: allergies.map((allergy) => (0, import_jsx_runtime100.jsx)(Badge, { variant: "light", maw: "100%", children: (0, import_jsx_runtime100.jsx)(CodeableConceptDisplay, { value: allergy.code }) }, allergy.id)) }) : (0, import_jsx_runtime100.jsx)(Text, { children: "(none)" }), (0, import_jsx_runtime100.jsx)(Modal, { opened, onClose: close, title: "Add Allergy", children: (0, import_jsx_runtime100.jsx)(Form, { onSubmit: handleSubmit, children: (0, import_jsx_runtime100.jsxs)(Stack, { children: [(0, import_jsx_runtime100.jsx)(CodeableConceptInput, { name: "allergy", path: "AllergyIntolerance.code", "data-autofocus": true, binding: "http://hl7.org/fhir/us/core/ValueSet/us-core-allergy-substance", onChange: (allergy) => setCode(allergy), outcome: void 0 }), (0, import_jsx_runtime100.jsx)(TextInput, { name: "reaction", label: "Reaction" }), (0, import_jsx_runtime100.jsx)(NativeSelect, { name: "status", label: "Status", data: ["active"] }), (0, import_jsx_runtime100.jsx)(TextInput, { name: "onset", label: "Onset", type: "date" }), (0, import_jsx_runtime100.jsx)(Group, { justify: "flex-end", gap: 4, mt: "md", children: (0, import_jsx_runtime100.jsx)(Button, { type: "submit", children: "Save" }) })] }) }) })] });
}
function Medications(props) {
  let medplum = a(), [medicationRequests, setMedicationRequests] = (0, import_react74.useState)(props.medicationRequests), [opened, { open, close }] = useDisclosure(false), [code, setCode] = (0, import_react74.useState)(), handleSubmit = (0, import_react74.useCallback)((formData) => {
    let status = formData.status;
    medplum.createResource({ resourceType: "MedicationRequest", status, intent: "order", encounter: props.encounter ? Z(props.encounter) : void 0, medicationCodeableConcept: code, subject: Z(props.patient) }).then((newRequest) => {
      setMedicationRequests([newRequest, ...medicationRequests]), close();
    }).catch(console.error);
  }, [medplum, props.patient, props.encounter, medicationRequests, close, code]);
  return (0, import_jsx_runtime101.jsxs)(import_jsx_runtime101.Fragment, { children: [(0, import_jsx_runtime101.jsxs)(Group, { justify: "space-between", children: [(0, import_jsx_runtime101.jsx)(Text, { fz: "md", fw: 700, children: "Medications" }), (0, import_jsx_runtime101.jsx)(Anchor, { href: "#", onClick: (e) => {
    killEvent(e), open();
  }, children: "+ Add" })] }), medicationRequests.length > 0 ? (0, import_jsx_runtime101.jsx)(Box, { children: medicationRequests.map((request) => (0, import_jsx_runtime101.jsx)(Badge, { mt: 4, variant: "light", maw: "50%", color: request.status === "active" ? "blue" : "gray", children: (0, import_jsx_runtime101.jsx)(CodeableConceptDisplay, { value: request.medicationCodeableConcept }) }, request.id)) }) : (0, import_jsx_runtime101.jsx)(Text, { children: "(none)" }), (0, import_jsx_runtime101.jsx)(Modal, { opened, onClose: close, title: "Add Medication Request", children: (0, import_jsx_runtime101.jsx)(Form, { onSubmit: handleSubmit, children: (0, import_jsx_runtime101.jsxs)(Stack, { h: 275, children: [(0, import_jsx_runtime101.jsx)(CodeableConceptInput, { name: "request", path: "MedicationRequest.medication[x]", "data-autofocus": true, binding: "https://app.medplum.com/ValueSet/16d6f7b7-7eeb-4d0e-a83b-83be082aa10b", onChange: (request) => setCode(request), outcome: void 0 }), (0, import_jsx_runtime101.jsxs)(Radio.Group, { mt: 32, name: "status", label: "Request Status", required: true, children: [(0, import_jsx_runtime101.jsx)(Radio, { value: "active", label: "active", my: "xs" }, "active"), (0, import_jsx_runtime101.jsx)(Radio, { value: "stopped", label: "stopped", my: "xs" }, "stopped")] }), (0, import_jsx_runtime101.jsx)(Group, { justify: "flex-end", gap: 4, mt: "md", children: (0, import_jsx_runtime101.jsx)(Button, { type: "submit", children: "Save" }) })] }) }) })] });
}
function ProblemList(props) {
  let medplum = a(), { patient, encounter } = props, [problems, setProblems] = (0, import_react75.useState)(props.problems), [opened, { open, close }] = useDisclosure(false), handleSubmit = (0, import_react75.useCallback)((formData) => {
    medplum.createResource({ resourceType: "Condition", subject: Z(patient), encounter: encounter ? Z(encounter) : void 0, code: { coding: [{ code: formData.problem, display: formData.problem }] }, onsetDateTime: formData.onset ? formData.onset : void 0 }).then((newProblem) => {
      setProblems([...problems, newProblem]), close();
    }).catch(console.error);
  }, [medplum, patient, encounter, problems, close]);
  return (0, import_jsx_runtime102.jsxs)(import_jsx_runtime102.Fragment, { children: [(0, import_jsx_runtime102.jsxs)(Group, { justify: "space-between", children: [(0, import_jsx_runtime102.jsx)(Text, { fz: "md", fw: 700, children: "Problem List" }), (0, import_jsx_runtime102.jsx)(Anchor, { href: "#", onClick: (e) => {
    killEvent(e), open();
  }, children: "+ Add" })] }), problems.length > 0 ? (0, import_jsx_runtime102.jsx)(Grid, { gutter: "xs", children: problems.map((problem) => {
    var _a;
    return (0, import_jsx_runtime102.jsxs)(import_react75.Fragment, { children: [(0, import_jsx_runtime102.jsx)(Grid.Col, { span: 2, children: (_a = problem.onsetDateTime) == null ? void 0 : _a.substring(0, 4) }), (0, import_jsx_runtime102.jsx)(Grid.Col, { span: 10, children: (0, import_jsx_runtime102.jsx)(Badge, { variant: "light", maw: "100%", children: (0, import_jsx_runtime102.jsx)(CodeableConceptDisplay, { value: problem.code }) }, problem.id) })] }, problem.id);
  }) }) : (0, import_jsx_runtime102.jsx)(Text, { children: "(none)" }), (0, import_jsx_runtime102.jsx)(Modal, { opened, onClose: close, title: "Add Problem", children: (0, import_jsx_runtime102.jsx)(Form, { onSubmit: handleSubmit, children: (0, import_jsx_runtime102.jsxs)(Stack, { children: [(0, import_jsx_runtime102.jsx)(TextInput, { name: "problem", label: "Problem", "data-autofocus": true, autoFocus: true, required: true }), (0, import_jsx_runtime102.jsx)(TextInput, { name: "onset", label: "Dx Date", type: "date", required: true }), (0, import_jsx_runtime102.jsx)(NativeSelect, { name: "status", label: "Status", data: ["active"] }), (0, import_jsx_runtime102.jsx)(Textarea, { name: "notes", label: "Notes" }), (0, import_jsx_runtime102.jsx)(Group, { justify: "flex-end", gap: 4, mt: "md", children: (0, import_jsx_runtime102.jsx)(Button, { type: "submit", children: "Save" }) })] }) }) })] });
}
var smokingStatusOptions = { 266919005: "Never smoked tobacco", 266927001: "Tobacco smoking consumption unknown", "428041000124106": "Occasional tobacco smoker", "428061000124105": "Light tobacco smoker", "428071000124103": "Heavy tobacco smoker", 449868002: "Smokes tobacco daily", 77176002: "Smoker", 8517006: "Ex-smoker" };
function SmokingStatus(props) {
  let medplum = a(), { patient, encounter } = props, [smokingStatus, setSmokingStatus] = (0, import_react76.useState)(props.smokingStatus), [opened, { open, close }] = useDisclosure(false), handleSubmit = (0, import_react76.useCallback)((formData) => {
    medplum.createResource({ resourceType: "Observation", meta: { profile: [wr + "/fhir/us/core/StructureDefinition/us-core-smokingstatus"] }, status: "final", category: [{ coding: [{ system: "http://terminology.hl7.org/CodeSystem/observation-category", code: "social-history", display: "Social History" }], text: "Social History" }], code: { coding: [{ system: Ys, code: "72166-2", display: "Tobacco smoking status" }], text: "Tobacco smoking status" }, subject: Z(patient), encounter: encounter ? Z(encounter) : void 0, effectiveDateTime: (/* @__PURE__ */ new Date()).toISOString(), valueCodeableConcept: { coding: [{ system: Zs, version: Zs + "/731000124108", code: formData.smokingStatus }], text: smokingStatusOptions[formData.smokingStatus] } }).then((newSmokingStatus) => {
      setSmokingStatus(newSmokingStatus), close();
    }).catch(console.error);
  }, [medplum, patient, encounter, close]);
  return (0, import_jsx_runtime103.jsxs)(import_jsx_runtime103.Fragment, { children: [(0, import_jsx_runtime103.jsxs)(Group, { justify: "space-between", children: [(0, import_jsx_runtime103.jsx)(Text, { fz: "md", fw: 700, children: "Smoking Status" }), (0, import_jsx_runtime103.jsx)(Anchor, { href: "#", onClick: (e) => {
    killEvent(e), open();
  }, children: "+ Edit" })] }), (smokingStatus == null ? void 0 : smokingStatus.valueCodeableConcept) ? (0, import_jsx_runtime103.jsx)(Box, { children: (0, import_jsx_runtime103.jsx)(Badge, { variant: "light", children: (0, import_jsx_runtime103.jsx)(CodeableConceptDisplay, { value: smokingStatus.valueCodeableConcept }) }) }) : (0, import_jsx_runtime103.jsx)(Text, { children: "(none)" }), (0, import_jsx_runtime103.jsx)(Modal, { opened, onClose: close, title: "Set Smoking Status", children: (0, import_jsx_runtime103.jsx)(Form, { onSubmit: handleSubmit, children: (0, import_jsx_runtime103.jsxs)(Stack, { children: [(0, import_jsx_runtime103.jsx)(Radio.Group, { name: "smokingStatus", label: "Smoking Status", required: true, children: Object.entries(smokingStatusOptions).map(([code, text]) => (0, import_jsx_runtime103.jsx)(Radio, { value: code, label: text, my: "xs" }, code)) }), (0, import_jsx_runtime103.jsx)(Group, { justify: "flex-end", gap: 4, mt: "md", children: (0, import_jsx_runtime103.jsx)(Button, { type: "submit", children: "Save" }) })] }) }) })] });
}
function getObservationValue(observations, code) {
  var _a;
  return (_a = observations.find((o) => {
    var _a2, _b;
    return ((_b = (_a2 = o.code) == null ? void 0 : _a2.coding) == null ? void 0 : _b[0].code) === code;
  })) == null ? void 0 : _a.valueQuantity;
}
function getCompoundObservationValue(observations, code, innerCode) {
  var _a, _b, _c;
  return (_c = (_b = (_a = observations.find((o) => {
    var _a2, _b2;
    return ((_b2 = (_a2 = o.code) == null ? void 0 : _a2.coding) == null ? void 0 : _b2[0].code) === code;
  })) == null ? void 0 : _a.component) == null ? void 0 : _b.find((c) => {
    var _a2, _b2;
    return ((_b2 = (_a2 = c.code) == null ? void 0 : _a2.coding) == null ? void 0 : _b2[0].code) === innerCode;
  })) == null ? void 0 : _c.valueQuantity;
}
function createObservation(patient, encounter, code, title, valueQuantity) {
  if (isValidNumber(valueQuantity.value))
    return { ...createBaseObservation(patient, encounter, code, title), valueQuantity };
}
function createCompoundObservation(patient, encounter, code, title, components) {
  let component = components.filter((c) => {
    var _a;
    return isValidNumber((_a = c.valueQuantity) == null ? void 0 : _a.value);
  });
  if (component.length !== 0)
    return { ...createBaseObservation(patient, encounter, code, title), component };
}
function createBaseObservation(patient, encounter, code, title) {
  return { resourceType: "Observation", status: "preliminary", subject: Z(patient), encounter: encounter ? Z(encounter) : void 0, effectiveDateTime: (/* @__PURE__ */ new Date()).toISOString(), category: [{ coding: [{ system: "http://terminology.hl7.org/CodeSystem/observation-category", code: "vital-signs", display: "Vital Signs" }] }], code: createLoincCode(code, title) };
}
function createLoincCode(code, display) {
  return { coding: [{ code, display, system: Ys }], text: display };
}
function createQuantity(value, unit) {
  return { value, system: Pr, unit, code: unit };
}
function isValidNumber(value) {
  return value !== void 0 && !isNaN(value) && isFinite(value);
}
var LOINC_CODES = { bloodPressure: { code: "85354-9", title: "Blood Pressure", unit: "mm[Hg]" }, heartRate: { code: "8867-4", title: "Heart Rate", unit: "/min" }, bodyTemperature: { code: "8310-5", title: "Body Temperature", unit: "Cel" }, respiratoryRate: { code: "9279-1", title: "Respiratory Rate", unit: "/min" }, height: { code: "8302-2", title: "height", unit: "cm" }, weight: { code: "29463-7", title: "weight", unit: "kg" }, bmi: { code: "39156-5", title: "BMI", unit: "kg/m2" }, oxygen: { code: "2708-6", title: "Oxygen", unit: "%" }, headCircumference: { code: "9843-4", title: "Head Circumference", unit: "cm" } };
var SYSTOLIC = "8480-6";
var DIASTOLIC = "8462-4";
function Vitals(props) {
  let medplum = a(), { patient, encounter } = props, [vitals, setVitals] = (0, import_react77.useState)(props.vitals), [opened, { open, close }] = useDisclosure(false), handleSubmit = (0, import_react77.useCallback)((formData) => {
    let newObservations = Object.entries(LOINC_CODES).map(([name, meta]) => name === "bloodPressure" ? createCompoundObservation(patient, encounter, meta.code, meta.title, [{ code: createLoincCode(SYSTOLIC, "Systolic blood pressure"), valueQuantity: createQuantity(parseFloat(formData.systolic), "mm[Hg]") }, { code: createLoincCode(DIASTOLIC, "Diastolic blood pressure"), valueQuantity: createQuantity(parseFloat(formData.diastolic), "mm[Hg]") }]) : createObservation(patient, encounter, meta.code, meta.title, createQuantity(parseFloat(formData[name]), meta.unit))).filter(Boolean);
    Promise.all(newObservations.map((obs) => medplum.createResource(obs))).then((newVitals) => setVitals([...newVitals, ...vitals])).catch(console.error), close();
  }, [medplum, patient, encounter, vitals, close]);
  return (0, import_jsx_runtime104.jsxs)(import_jsx_runtime104.Fragment, { children: [(0, import_jsx_runtime104.jsxs)(Group, { justify: "space-between", children: [(0, import_jsx_runtime104.jsx)(Text, { fz: "md", fw: 700, children: "Vitals" }), (0, import_jsx_runtime104.jsx)(Anchor, { href: "#", onClick: (e) => {
    killEvent(e), open();
  }, children: "+ Add" })] }), (0, import_jsx_runtime104.jsxs)(Grid, { children: [(0, import_jsx_runtime104.jsx)(Grid.Col, { span: 3, ta: "right", c: "dimmed", children: "BP Sys" }), (0, import_jsx_runtime104.jsx)(Grid.Col, { span: 3, children: (0, import_jsx_runtime104.jsx)(QuantityDisplay, { value: getCompoundObservationValue(vitals, LOINC_CODES.bloodPressure.code, SYSTOLIC) }) }), (0, import_jsx_runtime104.jsx)(Grid.Col, { span: 3, ta: "right", c: "dimmed", children: "BP Dias" }), (0, import_jsx_runtime104.jsx)(Grid.Col, { span: 3, children: (0, import_jsx_runtime104.jsx)(QuantityDisplay, { value: getCompoundObservationValue(vitals, LOINC_CODES.bloodPressure.code, DIASTOLIC) }) }), (0, import_jsx_runtime104.jsx)(Grid.Col, { span: 3, ta: "right", c: "dimmed", children: "HR" }), (0, import_jsx_runtime104.jsx)(Grid.Col, { span: 3, children: (0, import_jsx_runtime104.jsx)(QuantityDisplay, { value: getObservationValue(vitals, LOINC_CODES.heartRate.code) }) }), (0, import_jsx_runtime104.jsx)(Grid.Col, { span: 3, ta: "right", c: "dimmed", children: "Temp" }), (0, import_jsx_runtime104.jsx)(Grid.Col, { span: 3, children: (0, import_jsx_runtime104.jsx)(QuantityDisplay, { value: getObservationValue(vitals, LOINC_CODES.bodyTemperature.code) }) }), (0, import_jsx_runtime104.jsx)(Grid.Col, { span: 3, ta: "right", c: "dimmed", children: "RR" }), (0, import_jsx_runtime104.jsx)(Grid.Col, { span: 3, children: (0, import_jsx_runtime104.jsx)(QuantityDisplay, { value: getObservationValue(vitals, LOINC_CODES.respiratoryRate.code) }) }), (0, import_jsx_runtime104.jsx)(Grid.Col, { span: 3, ta: "right", c: "dimmed", children: "Height" }), (0, import_jsx_runtime104.jsx)(Grid.Col, { span: 3, children: (0, import_jsx_runtime104.jsx)(QuantityDisplay, { value: getObservationValue(vitals, LOINC_CODES.height.code) }) }), (0, import_jsx_runtime104.jsx)(Grid.Col, { span: 3, ta: "right", c: "dimmed", children: "Weight" }), (0, import_jsx_runtime104.jsx)(Grid.Col, { span: 3, children: (0, import_jsx_runtime104.jsx)(QuantityDisplay, { value: getObservationValue(vitals, LOINC_CODES.weight.code) }) }), (0, import_jsx_runtime104.jsx)(Grid.Col, { span: 3, ta: "right", c: "dimmed", children: "BMI" }), (0, import_jsx_runtime104.jsx)(Grid.Col, { span: 3, children: (0, import_jsx_runtime104.jsx)(QuantityDisplay, { value: getObservationValue(vitals, LOINC_CODES.bmi.code) }) }), (0, import_jsx_runtime104.jsx)(Grid.Col, { span: 3, ta: "right", c: "dimmed", children: "O2" }), (0, import_jsx_runtime104.jsx)(Grid.Col, { span: 3, children: (0, import_jsx_runtime104.jsx)(QuantityDisplay, { value: getObservationValue(vitals, LOINC_CODES.oxygen.code) }) }), (0, import_jsx_runtime104.jsx)(Grid.Col, { span: 3, ta: "right", c: "dimmed", children: "HC" }), (0, import_jsx_runtime104.jsx)(Grid.Col, { span: 3, children: (0, import_jsx_runtime104.jsx)(QuantityDisplay, { value: getObservationValue(vitals, LOINC_CODES.headCircumference.code) }) })] }), (0, import_jsx_runtime104.jsx)(Modal, { opened, onClose: close, title: "Add Vitals", children: (0, import_jsx_runtime104.jsxs)(Form, { onSubmit: handleSubmit, children: [(0, import_jsx_runtime104.jsxs)(Stack, { children: [(0, import_jsx_runtime104.jsxs)(Group, { grow: true, children: [(0, import_jsx_runtime104.jsx)(TextInput, { name: "systolic", label: "BP Sys", "data-autofocus": true, autoFocus: true }), (0, import_jsx_runtime104.jsx)(TextInput, { name: "diastolic", label: "BP Dias" })] }), (0, import_jsx_runtime104.jsxs)(Group, { grow: true, children: [(0, import_jsx_runtime104.jsx)(TextInput, { name: "heartRate", label: "HR" }), (0, import_jsx_runtime104.jsx)(TextInput, { name: "bodyTemperature", label: "Temp" })] }), (0, import_jsx_runtime104.jsxs)(Group, { grow: true, children: [(0, import_jsx_runtime104.jsx)(TextInput, { name: "respiratoryRate", label: "RR" }), (0, import_jsx_runtime104.jsx)(TextInput, { name: "height", label: "height" })] }), (0, import_jsx_runtime104.jsxs)(Group, { grow: true, children: [(0, import_jsx_runtime104.jsx)(TextInput, { name: "weight", label: "Wt" }), (0, import_jsx_runtime104.jsx)(TextInput, { name: "bmi", label: "BMI" })] }), (0, import_jsx_runtime104.jsxs)(Group, { grow: true, children: [(0, import_jsx_runtime104.jsx)(TextInput, { name: "oxygen", label: "O2" }), (0, import_jsx_runtime104.jsx)(TextInput, { name: "headCircumference", label: "HC" })] }), (0, import_jsx_runtime104.jsx)(Textarea, { name: "notes", label: "Notes" })] }), (0, import_jsx_runtime104.jsx)(Group, { justify: "flex-end", gap: 4, mt: "md", children: (0, import_jsx_runtime104.jsx)(Button, { type: "submit", children: "Save" }) })] }) })] });
}
function PatientSummary(props) {
  var _a, _b, _c;
  let medplum = a(), { patient: propsPatient, background, ...rest } = props, [patient, setPatient] = (0, import_react72.useState)(), [allergies, setAllergies] = (0, import_react72.useState)(), [problems, setProblems] = (0, import_react72.useState)(), [smokingStatus, setSmokingStatus] = (0, import_react72.useState)(), [vitals, setVitals] = (0, import_react72.useState)(), [medicationRequest, setMedicationRequest] = (0, import_react72.useState)();
  return (0, import_react72.useEffect)(() => {
    let id = Je(propsPatient), ref = `Patient/${id}`, searchMeta = { _count: 100, _sort: "-_lastUpdated" };
    Promise.all([medplum.readResource("Patient", id), medplum.searchResources("AllergyIntolerance", { patient: ref, ...searchMeta }), medplum.searchResources("Condition", { patient: ref, ...searchMeta }), medplum.searchResources("MedicationRequest", { subject: ref, ...searchMeta }), medplum.searchResources("Observation", { subject: ref, ...searchMeta })]).then((results) => {
      setPatient(results[0]), setAllergies(results[1]), setProblems(results[2]), setMedicationRequest(results[3]);
      let observations = results[4];
      setSmokingStatus(observations.find((obs) => {
        var _a2, _b2;
        return ((_b2 = (_a2 = obs.code) == null ? void 0 : _a2.coding) == null ? void 0 : _b2[0].code) === "72166-2";
      })), setVitals(observations.filter((obs) => {
        var _a2, _b2, _c2;
        return ((_c2 = (_b2 = (_a2 = obs.category) == null ? void 0 : _a2[0]) == null ? void 0 : _b2.coding) == null ? void 0 : _c2[0].code) === "vital-signs";
      }));
    }).catch(console.error);
  }, [medplum, propsPatient]), patient ? (0, import_jsx_runtime105.jsxs)(Card, { ...rest, children: [(0, import_jsx_runtime105.jsx)(Card.Section, { h: 100, style: { background } }), (0, import_jsx_runtime105.jsx)(ResourceAvatar, { value: patient, size: 80, radius: 80, mx: "auto", mt: -50, style: { border: "2px solid white" } }), (0, import_jsx_runtime105.jsx)(Text, { ta: "center", fz: "lg", fw: 500, children: Ze((_a = patient.name) == null ? void 0 : _a[0]) }), (0, import_jsx_runtime105.jsxs)(Text, { ta: "center", fz: "xs", color: "dimmed", children: [patient.birthDate, " (", gc(patient.birthDate), ")"] }), (0, import_jsx_runtime105.jsx)(Paper, { withBorder: true, p: "md", my: "md", children: (0, import_jsx_runtime105.jsxs)(Group, { grow: true, children: [(0, import_jsx_runtime105.jsxs)(Flex, { justify: "center", align: "center", direction: "column", gap: 0, maw: "33%", children: [(0, import_jsx_runtime105.jsx)(IconUserSquare, { size: 24, color: "gray" }), (0, import_jsx_runtime105.jsx)(Text, { fz: "xs", ta: "center", style: { whiteSpace: "nowrap" }, children: "Self" })] }), (0, import_jsx_runtime105.jsxs)(Flex, { justify: "center", align: "center", direction: "column", gap: 0, children: [(0, import_jsx_runtime105.jsx)(IconStethoscope, { size: 24, color: "gray" }), (0, import_jsx_runtime105.jsx)(Text, { fz: "xs", style: { whiteSpace: "nowrap" }, children: ((_c = (_b = patient == null ? void 0 : patient.generalPractitioner) == null ? void 0 : _b[0]) == null ? void 0 : _c.display) ?? "No provider" })] }), (0, import_jsx_runtime105.jsxs)(Flex, { justify: "center", align: "center", direction: "column", gap: 0, children: [(0, import_jsx_runtime105.jsx)(IconGenderFemale, { size: 24, color: "gray" }), (0, import_jsx_runtime105.jsx)(Text, { fz: "xs", style: { whiteSpace: "nowrap" }, children: patient.gender })] })] }) }), (0, import_jsx_runtime105.jsxs)(Stack, { gap: "xs", children: [(0, import_jsx_runtime105.jsx)(Anchor, { href: "#", children: "No upcoming appointments" }), (0, import_jsx_runtime105.jsx)(Anchor, { href: "#", children: "No documented visits" }), (0, import_jsx_runtime105.jsx)(Divider, {}), (0, import_jsx_runtime105.jsx)(Allergies, { patient, allergies }), (0, import_jsx_runtime105.jsx)(Divider, {}), (0, import_jsx_runtime105.jsx)(ProblemList, { patient, problems }), (0, import_jsx_runtime105.jsx)(Divider, {}), (0, import_jsx_runtime105.jsx)(Medications, { patient, medicationRequests: medicationRequest }), (0, import_jsx_runtime105.jsx)(Divider, {}), (0, import_jsx_runtime105.jsx)(SmokingStatus, { patient, smokingStatus }), (0, import_jsx_runtime105.jsx)(Divider, {}), (0, import_jsx_runtime105.jsx)(Vitals, { patient, vitals })] })] }) : null;
}
function PatientTimeline(props) {
  let loadTimelineResources = (0, import_react78.useCallback)((medplum, resourceType, id) => {
    let ref = `${resourceType}/${id}`, _count = 100;
    return Promise.allSettled([medplum.readHistory("Patient", id), medplum.search("Communication", { subject: ref, _count }), medplum.search("Device", { patient: ref, _count }), medplum.search("DeviceRequest", { patient: ref, _count }), medplum.search("DiagnosticReport", { subject: ref, _count }), medplum.search("Media", { subject: ref, _count }), medplum.search("ServiceRequest", { subject: ref, _count }), medplum.search("Task", { subject: ref, _count })]);
  }, []);
  return (0, import_jsx_runtime106.jsx)(ResourceTimeline, { value: props.patient, loadTimelineResources, createCommunication: (resource, sender, text) => ({ resourceType: "Communication", status: "completed", subject: Z(resource), sender: Z(sender), sent: (/* @__PURE__ */ new Date()).toISOString(), payload: [{ contentString: text }] }), createMedia: (resource, operator, content) => ({ resourceType: "Media", status: "completed", subject: Z(resource), operator: Z(operator), issued: (/* @__PURE__ */ new Date()).toISOString(), content }) });
}
var PlanDefinitionBuilder_default = { section: "PlanDefinitionBuilder_section", hovering: "PlanDefinitionBuilder_hovering", editing: "PlanDefinitionBuilder_editing", bottomActions: "PlanDefinitionBuilder_bottomActions" };
function PlanDefinitionBuilder(props) {
  let medplum = a(), defaultValue2 = ce(props.value), [schemaLoaded, setSchemaLoaded] = (0, import_react79.useState)(false), [selectedKey, setSelectedKey] = (0, import_react79.useState)(), [hoverKey, setHoverKey] = (0, import_react79.useState)(), [value, setValue] = (0, import_react79.useState)();
  function handleDocumentMouseOver() {
    setHoverKey(void 0);
  }
  function handleDocumentClick() {
    setSelectedKey(void 0);
  }
  let valueRef = (0, import_react79.useRef)();
  if (valueRef.current = value, (0, import_react79.useEffect)(() => {
    medplum.requestSchema("PlanDefinition").then(() => setSchemaLoaded(true)).catch(console.log);
  }, [medplum]), (0, import_react79.useEffect)(() => (setValue(ensurePlanDefinitionKeys(defaultValue2 ?? { resourceType: "PlanDefinition", status: "active" })), document.addEventListener("mouseover", handleDocumentMouseOver), document.addEventListener("click", handleDocumentClick), () => {
    document.removeEventListener("mouseover", handleDocumentMouseOver), document.removeEventListener("click", handleDocumentClick);
  }), [defaultValue2]), !schemaLoaded || !value)
    return null;
  function changeProperty(property, newValue) {
    setValue({ ...valueRef.current, [property]: newValue });
  }
  return (0, import_jsx_runtime107.jsx)("div", { children: (0, import_jsx_runtime107.jsxs)(Form, { testid: "questionnaire-form", onSubmit: () => props.onSubmit(value), children: [(0, import_jsx_runtime107.jsx)(TextInput, { label: "Plan Title", defaultValue: value.title, onChange: (e) => changeProperty("title", e.currentTarget.value) }), (0, import_jsx_runtime107.jsx)(ActionArrayBuilder, { actions: value.action || [], selectedKey, setSelectedKey, hoverKey, setHoverKey, onChange: (x2) => changeProperty("action", x2) }), (0, import_jsx_runtime107.jsx)(Button, { type: "submit", children: "Save" })] }) });
}
function ActionArrayBuilder(props) {
  let actionsRef = (0, import_react79.useRef)();
  actionsRef.current = props.actions;
  function changeAction(changedAction) {
    props.onChange(actionsRef.current.map((i) => i.id === changedAction.id ? changedAction : i));
  }
  function addAction(addedAction) {
    props.onChange([...actionsRef.current, addedAction]), props.setSelectedKey(addedAction.id);
  }
  function removeAction(removedAction) {
    props.onChange(actionsRef.current.filter((i) => i !== removedAction));
  }
  return (0, import_jsx_runtime107.jsxs)("div", { className: PlanDefinitionBuilder_default.section, children: [props.actions.map((action) => (0, import_jsx_runtime107.jsx)("div", { children: (0, import_jsx_runtime107.jsx)(ActionBuilder, { action, selectedKey: props.selectedKey, setSelectedKey: props.setSelectedKey, hoverKey: props.hoverKey, setHoverKey: props.setHoverKey, onChange: changeAction, onRemove: () => removeAction(action) }) }, action.id)), (0, import_jsx_runtime107.jsx)("div", { className: PlanDefinitionBuilder_default.bottomActions, children: (0, import_jsx_runtime107.jsx)(Anchor, { href: "#", onClick: (e) => {
    killEvent(e), addAction({ id: generateId() });
  }, children: "Add action" }) })] });
}
function ActionBuilder(props) {
  let { action } = props, actionType = getInitialActionType(action), editing = props.selectedKey === props.action.id, hovering = props.hoverKey === props.action.id;
  function onClick(e) {
    e.stopPropagation(), props.setSelectedKey(props.action.id);
  }
  function onHover(e) {
    killEvent(e), props.setHoverKey(props.action.id);
  }
  let className = clsx_m_default(PlanDefinitionBuilder_default.section, { [PlanDefinitionBuilder_default.editing]: editing, [PlanDefinitionBuilder_default.hovering]: hovering && !editing });
  return (0, import_jsx_runtime107.jsxs)("div", { "data-testid": action.id, className, onClick, onMouseOver: onHover, onFocus: onHover, children: [editing ? (0, import_jsx_runtime107.jsx)(ActionEditor, { action, actionType, onChange: props.onChange, selectedKey: props.selectedKey, setSelectedKey: props.setSelectedKey, hoverKey: props.hoverKey, setHoverKey: props.setHoverKey, onRemove: props.onRemove }) : (0, import_jsx_runtime107.jsx)(ActionDisplay, { action, actionType }), (0, import_jsx_runtime107.jsx)("div", { className: PlanDefinitionBuilder_default.bottomActions, children: (0, import_jsx_runtime107.jsx)(Anchor, { href: "#", onClick: (e) => {
    e.preventDefault(), props.onRemove();
  }, children: "Remove" }) })] });
}
var timingProperty = { path: "PlanDefinition.action.timing[x]", min: 0, max: 1, description: "", isArray: false, constraints: [], type: ["dateTime", "Period", "Range", "Timing"].map((t) => ({ code: t })) };
function ActionDisplay(props) {
  let { action, actionType } = props, [propertyValue, propertyType] = getActionTiming(action);
  return (0, import_jsx_runtime107.jsxs)("div", { children: [(0, import_jsx_runtime107.jsxs)("div", { children: [action.title || "Untitled", " ", actionType && `(${actionType})`] }), action.definitionCanonical && (0, import_jsx_runtime107.jsx)("div", { children: (0, import_jsx_runtime107.jsx)(ReferenceDisplay, { value: { reference: action.definitionCanonical } }) }), propertyValue && (0, import_jsx_runtime107.jsx)("div", { children: (0, import_jsx_runtime107.jsx)(ResourcePropertyDisplay, { property: timingProperty, propertyType, value: propertyValue }) })] });
}
function ActionEditor(props) {
  let { action } = props, [actionType, setActionType] = (0, import_react79.useState)(props.actionType);
  function changeProperty(property, value) {
    props.onChange({ ...action, [property]: value });
  }
  return (0, import_jsx_runtime107.jsxs)(Stack, { gap: "xl", children: [(0, import_jsx_runtime107.jsx)(TextInput, { name: `actionTitle-${action.id}`, label: "Title", defaultValue: action.title, onChange: (e) => changeProperty("title", e.currentTarget.value) }), (0, import_jsx_runtime107.jsx)(TextInput, { name: `actionDescription-${action.id}`, label: "Description", defaultValue: action.description, onChange: (e) => changeProperty("description", e.currentTarget.value) }), (0, import_jsx_runtime107.jsx)(NativeSelect, { label: "Type of Action", description: "The type of the action to be performed.", name: `actionType-${action.id}`, defaultValue: actionType, onChange: (e) => setActionType(e.currentTarget.value), data: ["", "appointment", "lab", "questionnaire", "task"] }), action.action && action.action.length > 0 && (0, import_jsx_runtime107.jsx)(ActionArrayBuilder, { actions: action.action, selectedKey: props.selectedKey, setSelectedKey: props.setSelectedKey, hoverKey: props.hoverKey, setHoverKey: props.setHoverKey, onChange: (x2) => changeProperty("action", x2) }), (() => {
    switch (actionType) {
      case "appointment":
        return (0, import_jsx_runtime107.jsx)(ActionResourceTypeBuilder, { title: "Appointment", description: "The subject must schedule an appointment from the schedule.", resourceType: "Schedule", action, onChange: props.onChange });
      case "lab":
        return (0, import_jsx_runtime107.jsx)(ActionResourceTypeBuilder, { title: "Lab", description: "The subject must complete the following lab panel.", resourceType: "ActivityDefinition", action, onChange: props.onChange });
      case "questionnaire":
        return (0, import_jsx_runtime107.jsx)(ActionResourceTypeBuilder, { title: "Questionnaire", description: "The subject must complete the selected questionnaire.", resourceType: "Questionnaire", action, onChange: props.onChange });
      case "task":
        return (0, import_jsx_runtime107.jsx)(ActionResourceTypeBuilder, { title: "Task", description: "The subject must complete the following task.", resourceType: "ActivityDefinition", action, onChange: props.onChange });
      default:
        return null;
    }
  })(), (0, import_jsx_runtime107.jsx)(FormSection, { title: "Timing", description: "When the action should take place.", children: (0, import_jsx_runtime107.jsx)(ActionTimingInput, { name: "timing-" + action.id, action, onChange: props.onChange }) })] });
}
function ActionResourceTypeBuilder(props) {
  let { id, definitionCanonical } = props.action, reference = (definitionCanonical == null ? void 0 : definitionCanonical.startsWith(props.resourceType + "/")) ? { reference: definitionCanonical } : void 0;
  return (0, import_jsx_runtime107.jsx)(ResourceInput, { name: id, resourceType: props.resourceType, defaultValue: reference, loadOnFocus: true, onChange: (newValue) => {
    newValue ? props.onChange({ ...props.action, definitionCanonical: X(newValue) }) : props.onChange({ ...props.action, definitionCanonical: void 0 });
  } });
}
function ActionTimingInput(props) {
  let value = props.action, key = "timing", [propertyValue, propertyType] = getActionTiming(value);
  return (0, import_jsx_runtime107.jsx)(ResourcePropertyInput, { property: timingProperty, name: "timing[x]", path: "PlanDefinition.timing[x]", defaultValue: propertyValue, defaultPropertyType: propertyType, onChange: (newValue, propName) => {
    props.onChange(setPropertyValue(value, key, propName ?? key, timingProperty, newValue));
  }, outcome: void 0 });
}
function getInitialActionType(action) {
  var _a, _b, _c;
  if ((_a = action.definitionCanonical) == null ? void 0 : _a.startsWith("Schedule"))
    return "appointment";
  if ((_b = action.definitionCanonical) == null ? void 0 : _b.startsWith("Questionnaire/"))
    return "questionnaire";
  if ((_c = action.definitionCanonical) == null ? void 0 : _c.startsWith("ActivityDefinition/"))
    return "task";
}
function getActionTiming(action) {
  return getValueAndType({ type: "PlanDefinitionAction", value: action }, "timing");
}
var nextId = 1;
function generateId(existing) {
  if (existing) {
    if (existing.startsWith("id-")) {
      let existingNum = parseInt(existing.substring(3), 10);
      isNaN(existingNum) || (nextId = Math.max(nextId, existingNum + 1));
    }
    return existing;
  }
  return "id-" + nextId++;
}
function ensurePlanDefinitionKeys(planDefinition) {
  return { ...planDefinition, action: ensurePlanDefinitionActionKeys(planDefinition.action) };
}
function ensurePlanDefinitionActionKeys(actions) {
  if (actions)
    return actions.map((action) => ({ ...action, id: generateId(action.id), action: ensurePlanDefinitionActionKeys(action.action) }));
}
var QuestionnaireItemType = ((QuestionnaireItemType2) => (QuestionnaireItemType2.group = "group", QuestionnaireItemType2.display = "display", QuestionnaireItemType2.question = "question", QuestionnaireItemType2.boolean = "boolean", QuestionnaireItemType2.decimal = "decimal", QuestionnaireItemType2.integer = "integer", QuestionnaireItemType2.date = "date", QuestionnaireItemType2.dateTime = "dateTime", QuestionnaireItemType2.time = "time", QuestionnaireItemType2.string = "string", QuestionnaireItemType2.text = "text", QuestionnaireItemType2.url = "url", QuestionnaireItemType2.choice = "choice", QuestionnaireItemType2.openChoice = "open-choice", QuestionnaireItemType2.attachment = "attachment", QuestionnaireItemType2.reference = "reference", QuestionnaireItemType2.quantity = "quantity", QuestionnaireItemType2))(QuestionnaireItemType || {});
function isChoiceQuestion(item) {
  return item.type === "choice" || item.type === "open-choice";
}
function isQuestionEnabled(item, responseItems) {
  if (!item.enableWhen)
    return true;
  let enableBehavior = item.enableBehavior ?? "any";
  for (let enableWhen of item.enableWhen) {
    let actualAnswers = getByLinkId(responseItems, enableWhen.question);
    if (enableWhen.operator === "exists" && !enableWhen.answerBoolean && !(actualAnswers == null ? void 0 : actualAnswers.length)) {
      if (enableBehavior === "any")
        return true;
      continue;
    }
    let { anyMatch, allMatch } = checkAnswers(enableWhen, actualAnswers, enableBehavior);
    if (enableBehavior === "any" && anyMatch)
      return true;
    if (enableBehavior === "all" && !allMatch)
      return false;
  }
  return enableBehavior !== "any";
}
function getNewMultiSelectValues(selected, propertyName, item) {
  return selected.map((o) => {
    var _a;
    let option = (_a = item.answerOption) == null ? void 0 : _a.find((option2) => Yi(option2.valueCoding) === o || option2[propertyName] === o), optionValue = P({ type: "QuestionnaireItemAnswerOption", value: option }, "value");
    return { [propertyName]: optionValue == null ? void 0 : optionValue.value };
  });
}
function getByLinkId(responseItems, linkId) {
  if (responseItems)
    for (let response of responseItems) {
      if (response.linkId === linkId)
        return response.answer;
      if (response.item) {
        let nestedAnswer = getByLinkId(response.item, linkId);
        if (nestedAnswer)
          return nestedAnswer;
      }
    }
}
function evaluateMatch(actualAnswer, expectedAnswer, operator) {
  if (operator === "exists")
    return !!actualAnswer === expectedAnswer.value;
  if (actualAnswer) {
    let fhirPathOperator = operator === "=" || operator === "!=" ? operator == null ? void 0 : operator.replace("=", "~") : operator, [{ value }] = $(`%actualAnswer ${fhirPathOperator} %expectedAnswer`, [actualAnswer], { "%actualAnswer": actualAnswer, "%expectedAnswer": expectedAnswer });
    return value;
  } else
    return false;
}
function checkAnswers(enableWhen, answers, enableBehavior) {
  let actualAnswers = answers || [], expectedAnswer = P({ type: "QuestionnaireItemEnableWhen", value: enableWhen }, "answer[x]"), anyMatch = false, allMatch = true;
  for (let actualAnswerValue of actualAnswers) {
    let actualAnswer = P({ type: "QuestionnaireResponseItemAnswer", value: actualAnswerValue }, "value[x]"), { operator } = enableWhen;
    if (evaluateMatch(actualAnswer, expectedAnswer, operator) ? anyMatch = true : allMatch = false, enableBehavior === "any" && anyMatch)
      break;
  }
  return { anyMatch, allMatch };
}
function getQuestionnaireItemReferenceTargetTypes(item) {
  var _a, _b;
  let extension = $t(item, "http://hl7.org/fhir/StructureDefinition/questionnaire-referenceResource");
  if (extension) {
    if (extension.valueCode !== void 0)
      return [extension.valueCode];
    if (extension.valueCodeableConcept)
      return (_b = (_a = extension.valueCodeableConcept) == null ? void 0 : _a.coding) == null ? void 0 : _b.map((c) => c.code);
  }
}
function setQuestionnaireItemReferenceTargetTypes(item, targetTypes) {
  var _a;
  let result = ee(item), extension = $t(result, "http://hl7.org/fhir/StructureDefinition/questionnaire-referenceResource");
  return !targetTypes || targetTypes.length === 0 ? (extension && (result.extension = (_a = result.extension) == null ? void 0 : _a.filter((e) => e !== extension)), result) : (extension || (result.extension || (result.extension = []), extension = { url: "http://hl7.org/fhir/StructureDefinition/questionnaire-referenceResource" }, result.extension.push(extension)), targetTypes.length === 1 ? (extension.valueCode = targetTypes[0], delete extension.valueCodeableConcept) : (extension.valueCodeableConcept = { coding: targetTypes.map((t) => ({ code: t })) }, delete extension.valueCode), result);
}
function getQuestionnaireItemReferenceFilter(item, subject, encounter) {
  let extension = $t(item, "http://hl7.org/fhir/StructureDefinition/questionnaire-referenceFilter");
  if (!(extension == null ? void 0 : extension.valueString))
    return;
  let filter = extension.valueString;
  (subject == null ? void 0 : subject.reference) && (filter = filter.replaceAll("$subj", subject.reference)), (encounter == null ? void 0 : encounter.reference) && (filter = filter.replaceAll("$encounter", encounter.reference));
  let result = {}, parts = filter.split("&");
  for (let part of parts) {
    let [key, value] = Vc(part, "=", 2);
    result[key] = value;
  }
  return result;
}
function buildInitialResponse(questionnaire) {
  return { resourceType: "QuestionnaireResponse", questionnaire: X(questionnaire), item: buildInitialResponseItems(questionnaire.item), status: "in-progress" };
}
function buildInitialResponseItems(items) {
  return (items == null ? void 0 : items.map(buildInitialResponseItem)) ?? [];
}
function buildInitialResponseItem(item) {
  var _a;
  return { id: generateId2(), linkId: item.linkId, text: item.text, item: buildInitialResponseItems(item.item), answer: ((_a = item.initial) == null ? void 0 : _a.map(buildInitialResponseAnswer)) ?? [] };
}
var nextId2 = 1;
function generateId2() {
  return "id-" + nextId2++;
}
function buildInitialResponseAnswer(answer) {
  return { ...answer };
}
function formatReferenceString(typedValue) {
  return typedValue.value.display || typedValue.value.reference || ln(typedValue.value);
}
function getNumberOfPages(questionnaire) {
  var _a, _b, _c, _d, _e;
  let firstItem = (_a = questionnaire == null ? void 0 : questionnaire.item) == null ? void 0 : _a[0];
  return firstItem && ((_e = (_d = (_c = (_b = $t(firstItem, "http://hl7.org/fhir/StructureDefinition/questionnaire-itemControl")) == null ? void 0 : _b.valueCodeableConcept) == null ? void 0 : _c.coding) == null ? void 0 : _d[0]) == null ? void 0 : _e.code) === "page" ? questionnaire.item.length : 1;
}
var QuestionnaireFormContext = (0, import_react82.createContext)({});
function QuestionnaireFormItem(props) {
  let context = (0, import_react81.useContext)(QuestionnaireFormContext), item = props.item, response = props.response;
  function onChangeAnswer(newResponseAnswer) {
    var _a, _b, _c, _d;
    let updatedAnswers;
    Array.isArray(newResponseAnswer) ? updatedAnswers = newResponseAnswer : props.index >= (((_b = (_a = props.response) == null ? void 0 : _a.answer) == null ? void 0 : _b.length) ?? 0) ? updatedAnswers = (((_c = props.response) == null ? void 0 : _c.answer) ?? []).concat([newResponseAnswer]) : updatedAnswers = (((_d = props.response) == null ? void 0 : _d.answer) ?? []).map((a2, idx) => idx === props.index ? newResponseAnswer : a2) ?? [], props.onChange({ id: response == null ? void 0 : response.id, linkId: response == null ? void 0 : response.linkId, text: item.text, answer: updatedAnswers });
  }
  let type = item.type;
  if (!type)
    return null;
  let name = item.linkId;
  if (!name)
    return null;
  let initial = item.initial && item.initial.length > 0 ? item.initial[0] : void 0, defaultValue2 = getCurrentAnswer(response, props.index) ?? P({ type: "QuestionnaireItemInitial", value: initial }, "value");
  switch (type) {
    case "display":
      return (0, import_jsx_runtime108.jsx)("p", { children: props.item.text }, props.item.linkId);
    case "boolean":
      return (0, import_jsx_runtime108.jsx)(CheckboxFormSection, { title: props.item.text, htmlFor: props.item.linkId, children: (0, import_jsx_runtime108.jsx)(Checkbox, { id: props.item.linkId, name: props.item.linkId, defaultChecked: defaultValue2 == null ? void 0 : defaultValue2.value, onChange: (e) => onChangeAnswer({ valueBoolean: e.currentTarget.checked }) }) }, props.item.linkId);
    case "decimal":
      return (0, import_jsx_runtime108.jsx)(TextInput, { type: "number", step: "any", id: name, name, required: item.required, defaultValue: defaultValue2 == null ? void 0 : defaultValue2.value, onChange: (e) => onChangeAnswer({ valueDecimal: e.currentTarget.valueAsNumber }) });
    case "integer":
      return (0, import_jsx_runtime108.jsx)(TextInput, { type: "number", step: 1, id: name, name, required: item.required, defaultValue: defaultValue2 == null ? void 0 : defaultValue2.value, onChange: (e) => onChangeAnswer({ valueInteger: e.currentTarget.valueAsNumber }) });
    case "date":
      return (0, import_jsx_runtime108.jsx)(TextInput, { type: "date", id: name, name, required: item.required, defaultValue: defaultValue2 == null ? void 0 : defaultValue2.value, onChange: (e) => onChangeAnswer({ valueDate: e.currentTarget.value }) });
    case "dateTime":
      return (0, import_jsx_runtime108.jsx)(DateTimeInput, { name, required: item.required, defaultValue: defaultValue2 == null ? void 0 : defaultValue2.value, onChange: (newValue) => onChangeAnswer({ valueDateTime: newValue }) });
    case "time":
      return (0, import_jsx_runtime108.jsx)(TextInput, { type: "time", id: name, name, required: item.required, defaultValue: defaultValue2 == null ? void 0 : defaultValue2.value, onChange: (e) => onChangeAnswer({ valueTime: e.currentTarget.value }) });
    case "string":
    case "url":
      return (0, import_jsx_runtime108.jsx)(TextInput, { id: name, name, required: item.required, defaultValue: defaultValue2 == null ? void 0 : defaultValue2.value, onChange: (e) => onChangeAnswer({ valueString: e.currentTarget.value }) });
    case "text":
      return (0, import_jsx_runtime108.jsx)(Textarea, { id: name, name, required: item.required, defaultValue: defaultValue2 == null ? void 0 : defaultValue2.value, onChange: (e) => onChangeAnswer({ valueString: e.currentTarget.value }) });
    case "attachment":
      return (0, import_jsx_runtime108.jsx)(Group, { py: 4, children: (0, import_jsx_runtime108.jsx)(AttachmentInput, { name, defaultValue: defaultValue2 == null ? void 0 : defaultValue2.value, onChange: (newValue) => onChangeAnswer({ valueAttachment: newValue }) }) });
    case "reference":
      return (0, import_jsx_runtime108.jsx)(ReferenceInput, { name, required: item.required, targetTypes: getQuestionnaireItemReferenceTargetTypes(item), searchCriteria: getQuestionnaireItemReferenceFilter(item, context.subject, context.encounter), defaultValue: defaultValue2 == null ? void 0 : defaultValue2.value, onChange: (newValue) => onChangeAnswer({ valueReference: newValue }) });
    case "quantity":
      return (0, import_jsx_runtime108.jsx)(QuantityInput, { name, required: item.required, defaultValue: defaultValue2 == null ? void 0 : defaultValue2.value, onChange: (newValue) => onChangeAnswer({ valueQuantity: newValue }), disableWheel: true });
    case "choice":
    case "open-choice":
      return isDropDownChoice(item) && !item.answerValueSet ? (0, import_jsx_runtime108.jsx)(QuestionnaireChoiceDropDownInput, { name, item, initial, response, onChangeAnswer: (e) => onChangeAnswer(e) }) : (0, import_jsx_runtime108.jsx)(QuestionnaireChoiceSetInput, { name, item, initial, response, onChangeAnswer: (e) => onChangeAnswer(e) });
    default:
      return null;
  }
}
function QuestionnaireChoiceDropDownInput(props) {
  var _a;
  let { name, item, initial, response } = props;
  if (!((_a = item.answerOption) == null ? void 0 : _a.length))
    return (0, import_jsx_runtime108.jsx)(NoAnswerDisplay, {});
  let initialValue = P({ type: "QuestionnaireItemInitial", value: initial }, "value"), data2 = [""];
  for (let option of item.answerOption) {
    let optionValue = P({ type: "QuestionnaireItemAnswerOption", value: option }, "value");
    data2.push(typedValueToString(optionValue));
  }
  let defaultValue2 = getCurrentAnswer(response) ?? initialValue;
  if (item.repeats) {
    let { propertyName, data: data3 } = formatSelectData(props.item), currentAnswer = getCurrentMultiSelectAnswer(response);
    return (0, import_jsx_runtime108.jsx)(MultiSelect, { data: data3, placeholder: "Select items", searchable: true, defaultValue: currentAnswer || [typedValueToString(initialValue)], onChange: (selected) => {
      let values2 = getNewMultiSelectValues(selected, propertyName, item);
      props.onChangeAnswer(values2);
    } });
  }
  return (0, import_jsx_runtime108.jsx)(NativeSelect, { id: name, name, onChange: (e) => {
    let index = e.currentTarget.selectedIndex;
    if (index === 0) {
      props.onChangeAnswer({});
      return;
    }
    let option = item.answerOption[index - 1], optionValue = P({ type: "QuestionnaireItemAnswerOption", value: option }, "value"), propertyName = "value" + C(optionValue.type);
    props.onChangeAnswer({ [propertyName]: optionValue.value });
  }, defaultValue: Yi(defaultValue2 == null ? void 0 : defaultValue2.value) || (defaultValue2 == null ? void 0 : defaultValue2.value), data: data2 });
}
function QuestionnaireChoiceSetInput(props) {
  var _a;
  let { name, item, initial, onChangeAnswer, response } = props;
  return !((_a = item.answerOption) == null ? void 0 : _a.length) && !item.answerValueSet ? (0, import_jsx_runtime108.jsx)(NoAnswerDisplay, {}) : item.answerValueSet ? (0, import_jsx_runtime108.jsx)(CodingInput, { name, binding: item.answerValueSet, onChange: (code) => onChangeAnswer({ valueCoding: code }), creatable: item.type === "open-choice" }) : (0, import_jsx_runtime108.jsx)(QuestionnaireChoiceRadioInput, { name: (response == null ? void 0 : response.id) ?? name, item, initial, response, onChangeAnswer });
}
function QuestionnaireChoiceRadioInput(props) {
  let { name, item, initial, onChangeAnswer, response } = props, valueElementDefinition = ze("QuestionnaireItemAnswerOption", "value[x]"), initialValue = P({ type: "QuestionnaireItemInitial", value: initial }, "value"), options = [], defaultValue2;
  if (item.answerOption)
    for (let i = 0; i < item.answerOption.length; i++) {
      let option = item.answerOption[i], optionName = `${name}-option-${i}`, optionValue = P({ type: "QuestionnaireItemAnswerOption", value: option }, "value");
      (optionValue == null ? void 0 : optionValue.value) && (initialValue && ln(optionValue) === ln(initialValue) && (defaultValue2 = optionName), options.push([optionName, optionValue]));
    }
  let defaultAnswer = getCurrentAnswer(response), answerLinkId = getCurrentRadioAnswer(options, defaultAnswer);
  return (0, import_jsx_runtime108.jsx)(Radio.Group, { name, value: answerLinkId ?? defaultValue2, onChange: (newValue) => {
    let option = options.find((option2) => option2[0] === newValue);
    if (option) {
      let optionValue = option[1], propertyName = "value" + C(optionValue.type);
      onChangeAnswer({ [propertyName]: optionValue.value });
    }
  }, children: options.map(([optionName, optionValue]) => (0, import_jsx_runtime108.jsx)(Radio, { id: optionName, value: optionName, py: 4, label: (0, import_jsx_runtime108.jsx)(ResourcePropertyDisplay, { property: valueElementDefinition, propertyType: optionValue.type, value: optionValue.value }) }, optionName)) });
}
function NoAnswerDisplay() {
  return (0, import_jsx_runtime108.jsx)(TextInput, { disabled: true, placeholder: "No Answers Defined" });
}
function getItemValue(answer) {
  return P({ type: "QuestionnaireItemAnswer", value: answer }, "value");
}
function getCurrentAnswer(response, index = 0) {
  let results = response.answer;
  return getItemValue((results == null ? void 0 : results[index]) ?? {});
}
function getCurrentMultiSelectAnswer(response) {
  let results = response.answer;
  return results ? results.map((a2) => getItemValue(a2)).map((type) => Yi(type == null ? void 0 : type.value) || (type == null ? void 0 : type.value)) : [];
}
function getCurrentRadioAnswer(options, defaultAnswer) {
  var _a;
  return (_a = options.find((option) => Ge(option[1].value, defaultAnswer == null ? void 0 : defaultAnswer.value))) == null ? void 0 : _a[0];
}
function typedValueToString(typedValue) {
  if (typedValue)
    return typedValue.type === "CodeableConcept" ? Ji(typedValue.value) : typedValue.type === "Coding" ? Yi(typedValue.value) : typedValue.type === "Reference" ? formatReferenceString(typedValue) : typedValue.value.toString();
}
function isDropDownChoice(item) {
  var _a;
  return !!((_a = item.extension) == null ? void 0 : _a.some((e) => {
    var _a2, _b, _c;
    return e.url === "http://hl7.org/fhir/StructureDefinition/questionnaire-itemControl" && ((_c = (_b = (_a2 = e.valueCodeableConcept) == null ? void 0 : _a2.coding) == null ? void 0 : _b[0]) == null ? void 0 : _c.code) === "drop-down";
  }));
}
function formatSelectData(item) {
  var _a;
  if (((_a = item.answerOption) == null ? void 0 : _a.length) === 0)
    return { propertyName: "", data: [] };
  let option = item.answerOption[0], optionValue = P({ type: "QuestionnaireItemAnswerOption", value: option }, "value"), propertyName = "value" + C(optionValue.type), data2 = (item.answerOption ?? []).map((a2) => ({ value: getValueAndLabel(a2, propertyName), label: getValueAndLabel(a2, propertyName) }));
  return { propertyName, data: data2 };
}
function getValueAndLabel(option, propertyName) {
  var _a;
  return Yi(option.valueCoding) || ((_a = option[propertyName]) == null ? void 0 : _a.toString());
}
var QuestionnaireBuilder_default = { section: "QuestionnaireBuilder_section", hovering: "QuestionnaireBuilder_hovering", editing: "QuestionnaireBuilder_editing", questionBody: "QuestionnaireBuilder_questionBody", topActions: "QuestionnaireBuilder_topActions", bottomActions: "QuestionnaireBuilder_bottomActions", movementActions: "QuestionnaireBuilder_movementActions", movementIcons: "QuestionnaireBuilder_movementIcons", columnAlignment: "QuestionnaireBuilder_columnAlignment", linkIdInput: "QuestionnaireBuilder_linkIdInput", typeSelect: "QuestionnaireBuilder_typeSelect" };
function QuestionnaireBuilder(props) {
  let medplum = a(), defaultValue2 = ce(props.questionnaire), [schemaLoaded, setSchemaLoaded] = (0, import_react80.useState)(false), [value, setValue] = (0, import_react80.useState)(), [selectedKey, setSelectedKey] = (0, import_react80.useState)(), [hoverKey, setHoverKey] = (0, import_react80.useState)();
  function handleDocumentMouseOver() {
    setHoverKey(void 0);
  }
  function handleDocumentClick() {
    setSelectedKey(void 0);
  }
  (0, import_react80.useEffect)(() => {
    medplum.requestSchema("Questionnaire").then(() => setSchemaLoaded(true)).catch(console.log);
  }, [medplum]), (0, import_react80.useEffect)(() => (setValue(ensureQuestionnaireKeys(defaultValue2 ?? { resourceType: "Questionnaire", status: "active" })), document.addEventListener("mouseover", handleDocumentMouseOver), document.addEventListener("click", handleDocumentClick), () => {
    document.removeEventListener("mouseover", handleDocumentMouseOver), document.removeEventListener("click", handleDocumentClick);
  }), [defaultValue2]);
  let handleChange = (questionnaire, disableSubmit) => {
    setValue(questionnaire), props.autoSave && !disableSubmit && props.onSubmit && props.onSubmit(questionnaire);
  };
  return !schemaLoaded || !value ? null : (0, import_jsx_runtime109.jsx)("div", { children: (0, import_jsx_runtime109.jsxs)(Form, { testid: "questionnaire-form", onSubmit: () => props.onSubmit(value), children: [(0, import_jsx_runtime109.jsx)(ItemBuilder, { item: value, selectedKey, setSelectedKey, hoverKey, setHoverKey, onChange: handleChange }), (0, import_jsx_runtime109.jsx)(Button, { type: "submit", children: "Save" })] }) });
}
function ItemBuilder(props) {
  var _a;
  let resource = props.item, item = props.item, isResource2 = _(props.item), isContainer = isResource2 || item.type === "group", linkId = item.linkId ?? "[untitled]", editing = props.selectedKey === props.item.id, hovering = props.hoverKey === props.item.id, itemRef = (0, import_react80.useRef)();
  itemRef.current = props.item;
  function onClick(e) {
    killEvent(e), props.setSelectedKey(props.item.id);
  }
  function onHover(e) {
    killEvent(e), props.setHoverKey(props.item.id);
  }
  function changeItem(changedItem) {
    var _a2;
    let curr = itemRef.current;
    props.onChange({ ...curr, item: (_a2 = curr.item) == null ? void 0 : _a2.map((i) => i.id === changedItem.id ? changedItem : i) });
  }
  function addItem(addedItem, disableSubmit) {
    props.onChange({ ...props.item, item: [...props.item.item ?? [], addedItem] }, disableSubmit);
  }
  function removeItem(removedItem) {
    var _a2;
    props.onChange({ ...props.item, item: (_a2 = props.item.item) == null ? void 0 : _a2.filter((i) => i !== removedItem) });
  }
  function changeProperty(property, value) {
    props.onChange({ ...itemRef.current, [property]: value });
  }
  function updateItem(updatedItem) {
    props.onChange({ ...props.item, ...updatedItem });
  }
  function toggleRepeatable(item2) {
    var _a2;
    props.onChange({ ...props.item, item: (_a2 = props.item.item) == null ? void 0 : _a2.map((i) => i === item2 ? { ...i, repeats: !i.repeats } : i) });
  }
  function moveItem(itemIndex, delta) {
    let updatedItems = reorderItems(props.item.item, itemIndex, delta);
    props.onChange({ ...props.item, item: updatedItems });
  }
  let className = clsx_m_default(QuestionnaireBuilder_default.section, { [QuestionnaireBuilder_default.editing]: editing, [QuestionnaireBuilder_default.hovering]: hovering && !editing });
  return (0, import_jsx_runtime109.jsxs)("div", { "data-testid": item.linkId, className, onClick, onMouseOver: onHover, onFocus: onHover, children: [(0, import_jsx_runtime109.jsx)("div", { className: QuestionnaireBuilder_default.questionBody, children: editing ? (0, import_jsx_runtime109.jsxs)(import_jsx_runtime109.Fragment, { children: [isResource2 && (0, import_jsx_runtime109.jsx)(TextInput, { size: "xl", defaultValue: resource.title, onBlur: (e) => changeProperty("title", e.currentTarget.value) }), !isResource2 && (0, import_jsx_runtime109.jsx)(Textarea, { autosize: true, minRows: 2, defaultValue: item.text, onBlur: (e) => changeProperty("text", e.currentTarget.value) }), item.type === "reference" && (0, import_jsx_runtime109.jsx)(ReferenceProfiles, { item, onChange: updateItem }), isChoiceQuestion(item) && (0, import_jsx_runtime109.jsx)(AnswerBuilder, { item, onChange: (item2) => updateItem(item2) })] }) : (0, import_jsx_runtime109.jsxs)(import_jsx_runtime109.Fragment, { children: [resource.title && (0, import_jsx_runtime109.jsx)(Title, { children: resource.title }), item.text && (0, import_jsx_runtime109.jsx)("div", { children: item.text }), !isContainer && (0, import_jsx_runtime109.jsx)(QuestionnaireFormItem, { item, index: 0, onChange: () => {
  }, response: { linkId: item.linkId } })] }) }), (_a = item.item) == null ? void 0 : _a.map((item2, i) => (0, import_jsx_runtime109.jsx)("div", { children: (0, import_jsx_runtime109.jsx)(ItemBuilder, { item: item2, selectedKey: props.selectedKey, setSelectedKey: props.setSelectedKey, hoverKey: props.hoverKey, isFirst: i === 0, isLast: i === (props.item.item ?? []).length - 1, setHoverKey: props.setHoverKey, onChange: changeItem, onRemove: () => removeItem(item2), onRepeatable: toggleRepeatable, onMoveUp: () => moveItem(i, -1), onMoveDown: () => moveItem(i, 1) }) }, item2.id)), !isContainer && (0, import_jsx_runtime109.jsx)("div", { className: QuestionnaireBuilder_default.topActions, children: editing ? (0, import_jsx_runtime109.jsxs)(import_jsx_runtime109.Fragment, { children: [(0, import_jsx_runtime109.jsx)(TextInput, { size: "xs", className: QuestionnaireBuilder_default.linkIdInput, defaultValue: item.linkId, onBlur: (e) => changeProperty("linkId", e.currentTarget.value) }), !isContainer && (0, import_jsx_runtime109.jsx)(NativeSelect, { size: "xs", className: QuestionnaireBuilder_default.typeSelect, defaultValue: item.type, onChange: (e) => changeProperty("type", e.currentTarget.value), data: [{ value: "display", label: "Display" }, { value: "boolean", label: "Boolean" }, { value: "decimal", label: "Decimal" }, { value: "integer", label: "Integer" }, { value: "date", label: "Date" }, { value: "dateTime", label: "Date/Time" }, { value: "time", label: "Time" }, { value: "string", label: "String" }, { value: "text", label: "Text" }, { value: "url", label: "URL" }, { value: "choice", label: "Choice" }, { value: "open-choice", label: "Open Choice" }, { value: "attachment", label: "Attachment" }, { value: "reference", label: "Reference" }, { value: "quantity", label: "Quantity" }] })] }) : (0, import_jsx_runtime109.jsx)("div", { children: linkId }) }), !isResource2 && (0, import_jsx_runtime109.jsx)(Box, { className: QuestionnaireBuilder_default.movementActions, children: (0, import_jsx_runtime109.jsxs)(Box, { className: QuestionnaireBuilder_default.columnAlignment, children: [!props.isFirst && (0, import_jsx_runtime109.jsx)(Anchor, { href: "#", onClick: (e) => {
    e.preventDefault(), props.onMoveUp && props.onMoveUp();
  }, children: (0, import_jsx_runtime109.jsx)(IconArrowUp, { "data-testid": "up-button", size: 15, className: QuestionnaireBuilder_default.movementIcons }) }), !props.isLast && (0, import_jsx_runtime109.jsx)(Anchor, { href: "#", onClick: (e) => {
    e.preventDefault(), props.onMoveDown && props.onMoveDown();
  }, children: (0, import_jsx_runtime109.jsx)(IconArrowDown, { "data-testid": "down-button", size: 15, className: QuestionnaireBuilder_default.movementIcons }) })] }) }), (0, import_jsx_runtime109.jsxs)("div", { className: QuestionnaireBuilder_default.bottomActions, children: [isContainer && (0, import_jsx_runtime109.jsxs)(import_jsx_runtime109.Fragment, { children: [(0, import_jsx_runtime109.jsx)(Anchor, { href: "#", onClick: (e) => {
    e.preventDefault(), addItem({ id: generateId3(), linkId: generateLinkId("q"), type: "string", text: "Question" });
  }, children: "Add item" }), (0, import_jsx_runtime109.jsx)(Anchor, { href: "#", onClick: (e) => {
    e.preventDefault(), addItem({ id: generateId3(), linkId: generateLinkId("g"), type: "group", text: "Group" }, true);
  }, children: "Add group" })] }), isResource2 && (0, import_jsx_runtime109.jsx)(Anchor, { href: "#", onClick: (e) => {
    e.preventDefault(), addItem(createPage(), true);
  }, children: "Add Page" }), editing && !isResource2 && (0, import_jsx_runtime109.jsxs)(import_jsx_runtime109.Fragment, { children: [(0, import_jsx_runtime109.jsx)(Anchor, { href: "#", onClick: (e) => {
    e.preventDefault(), props.onRepeatable && props.onRepeatable(item);
  }, children: item.repeats ? "Remove Repeatable" : "Make Repeatable" }), (0, import_jsx_runtime109.jsx)(Anchor, { href: "#", onClick: (e) => {
    e.preventDefault(), props.onRemove && props.onRemove();
  }, children: "Remove" })] })] })] });
}
function AnswerBuilder(props) {
  let property = ze("QuestionnaireItemAnswerOption", "value[x]"), options = props.item.answerOption ?? [];
  return (0, import_jsx_runtime109.jsxs)("div", { children: [props.item.answerValueSet !== void 0 ? (0, import_jsx_runtime109.jsx)(TextInput, { placeholder: "Enter Value Set", defaultValue: props.item.answerValueSet, onChange: (e) => props.onChange({ ...props.item, answerValueSet: e.target.value }) }) : (0, import_jsx_runtime109.jsx)(AnswerOptionsInput, { options, property, item: props.item, onChange: props.onChange }), (0, import_jsx_runtime109.jsxs)(Box, { display: "flex", children: [(0, import_jsx_runtime109.jsx)(Anchor, { href: "#", onClick: (e) => {
    killEvent(e), props.onChange({ ...props.item, answerValueSet: void 0, answerOption: [...options, { id: generateId3() }] });
  }, children: "Add choice" }), (0, import_jsx_runtime109.jsx)(Space, { w: "lg" }), (0, import_jsx_runtime109.jsx)(Anchor, { href: "#", onClick: (e) => {
    killEvent(e), props.onChange({ ...props.item, answerOption: [], answerValueSet: "" });
  }, children: "Add value set" })] })] });
}
function AnswerOptionsInput(props) {
  return (0, import_jsx_runtime109.jsx)("div", { children: props.options.map((option) => {
    let [propertyValue, propertyType] = getValueAndType({ type: "QuestionnaireItemAnswerOption", value: option }, "value");
    return (0, import_jsx_runtime109.jsxs)("div", { style: { display: "flex", flexDirection: "row", justifyContent: "space-between", alignItems: "center", width: "80%" }, children: [(0, import_jsx_runtime109.jsx)("div", { children: (0, import_jsx_runtime109.jsx)(ResourcePropertyInput, { name: "value[x]", path: "Questionnaire.answerOption.value[x]", property: props.property, defaultPropertyType: propertyType, defaultValue: propertyValue, onChange: (newValue, propName) => {
      let newOptions = [...props.options], index = newOptions.findIndex((o) => o.id === option.id);
      newOptions[index] = { id: option.id, [propName]: newValue }, props.onChange({ ...props.item, answerOption: newOptions });
    }, outcome: void 0 }, option.id) }), (0, import_jsx_runtime109.jsx)("div", { children: (0, import_jsx_runtime109.jsx)(Anchor, { href: "#", onClick: (e) => {
      killEvent(e), props.onChange({ ...props.item, answerOption: props.options.filter((o) => o.id !== option.id) });
    }, children: "Remove" }) })] }, option.id);
  }) });
}
function ReferenceProfiles(props) {
  let targetTypes = getQuestionnaireItemReferenceTargetTypes(props.item) ?? [];
  return (0, import_jsx_runtime109.jsxs)(import_jsx_runtime109.Fragment, { children: [targetTypes.map((targetType, index) => (0, import_jsx_runtime109.jsxs)(Group, { children: [(0, import_jsx_runtime109.jsx)(ResourceTypeInput, { name: "resourceType", placeholder: "Resource Type", defaultValue: targetType, onChange: (newValue) => {
    props.onChange(setQuestionnaireItemReferenceTargetTypes(props.item, targetTypes.map((t) => t === targetType ? newValue : t)));
  } }), (0, import_jsx_runtime109.jsx)(Anchor, { href: "#", onClick: (e) => {
    killEvent(e), props.onChange(setQuestionnaireItemReferenceTargetTypes(props.item, targetTypes.filter((t) => t !== targetType)));
  }, children: "Remove" })] }, `${targetType}-${index}`)), (0, import_jsx_runtime109.jsx)(Anchor, { href: "#", onClick: (e) => {
    killEvent(e), props.onChange(setQuestionnaireItemReferenceTargetTypes(props.item, [...targetTypes, ""]));
  }, children: "Add Resource Type" })] });
}
var nextLinkId = 1;
var nextId3 = 1;
function generateLinkId(prefix) {
  return prefix + nextLinkId++;
}
function generateId3() {
  return "id-" + nextId3++;
}
function ensureQuestionnaireKeys(questionnaire) {
  return { ...questionnaire, id: questionnaire.id || generateId3(), item: ensureQuestionnaireItemKeys(questionnaire.item) };
}
function ensureQuestionnaireItemKeys(items) {
  if (items)
    return items.forEach((item) => {
      var _a, _b;
      ((_a = item.id) == null ? void 0 : _a.match(/^id-\d+$/)) && (nextId3 = Math.max(nextId3, parseInt(item.id.substring(3), 10) + 1)), ((_b = item.linkId) == null ? void 0 : _b.match(/^q\d+$/)) && (nextLinkId = Math.max(nextLinkId, parseInt(item.linkId.substring(1), 10) + 1));
    }), items.map((item) => ({ ...item, id: item.id || generateId3(), item: ensureQuestionnaireItemKeys(item.item), answerOption: ensureQuestionnaireOptionKeys(item.answerOption) }));
}
function ensureQuestionnaireOptionKeys(options) {
  if (options)
    return options.map((option) => ({ ...option, id: option.id || generateId3() }));
}
function createPage() {
  return { id: generateId3(), linkId: generateLinkId("s"), type: "group", text: "New Page", extension: [{ url: "http://hl7.org/fhir/StructureDefinition/questionnaire-itemControl", valueCodeableConcept: { coding: [{ system: "http://hl7.org/fhir/questionnaire-item-control", code: "page" }] } }] };
}
function reorderItems(items, itemIndex, delta) {
  let currentItems = items ?? [], newIndex = itemIndex + delta;
  if (newIndex < 0 || newIndex >= currentItems.length)
    return currentItems;
  let updatedItems = [...currentItems];
  return [updatedItems[itemIndex], updatedItems[newIndex]] = [updatedItems[newIndex], updatedItems[itemIndex]], updatedItems;
}
function QuestionnaireRepeatableItem(props) {
  let { item, response, onChange } = props, [number, setNumber] = (0, import_react84.useState)(getNumberOfRepeats(item, response ?? { linkId: item.linkId }));
  if (!props.checkForQuestionEnabled(item) || !response)
    return null;
  if (item.type === "display")
    return (0, import_jsx_runtime110.jsx)("p", { children: item.text }, item.linkId);
  let showAddButton = (item == null ? void 0 : item.repeats) && item.type !== "choice" && item.type !== "open-choice";
  return item.type === "boolean" ? (0, import_jsx_runtime110.jsx)(QuestionnaireFormItem, { item, response, onChange: (r2) => onChange([r2]), index: 0 }, item.linkId) : (0, import_jsx_runtime110.jsxs)(FormSection, { htmlFor: props.item.linkId, title: props.item.text, withAsterisk: props.item.required, children: [[...Array(number)].map((_22, index) => (0, import_jsx_runtime110.jsx)(QuestionnaireFormItem, { item, response, onChange: (r2) => onChange([r2]), index }, `${item.linkId}-${index}`)), showAddButton && (0, import_jsx_runtime110.jsx)(Anchor, { onClick: () => setNumber((n) => n + 1), children: "Add Item" })] }, props.item.linkId);
}
function getNumberOfRepeats(item, response) {
  if (item.type === "choice" || item.type === "open-choice")
    return 1;
  let answers = response.answer;
  return (answers == null ? void 0 : answers.length) ? answers.length : 1;
}
function QuestionnaireRepeatedGroup(props) {
  let [responses, setResponses] = (0, import_react85.useState)(props.response);
  if (responses.length === 0)
    return null;
  function handleRepeatableGroup(newResponseItems, index) {
    let newResponses = responses.map((responses2, idx) => idx === index ? newResponseItems[0] : responses2);
    setResponses(newResponses), props.onChange(newResponses);
  }
  function insertNewGroup() {
    let newResponse = buildInitialResponseItem(props.item);
    setResponses([...responses, newResponse]);
  }
  return (0, import_jsx_runtime111.jsxs)(import_jsx_runtime111.Fragment, { children: [responses.map((response, idx) => (0, import_jsx_runtime111.jsx)(QuestionnaireGroup, { item: props.item, response, checkForQuestionEnabled: props.checkForQuestionEnabled, onChange: (r2) => handleRepeatableGroup(r2, idx) }, response.id)), props.item.repeats && (0, import_jsx_runtime111.jsx)(Anchor, { onClick: insertNewGroup, children: `Add Group: ${props.item.text}` })] });
}
function QuestionnaireGroup(props) {
  var _a;
  let { response, checkForQuestionEnabled, onChange } = props;
  function onSetGroup(newResponseItem) {
    var _a2, _b;
    let mergedResponse = (_b = (_a2 = response.item) == null ? void 0 : _a2.map((current) => newResponseItem.find((newResponse2) => newResponse2.id === current.id) ?? current)) == null ? void 0 : _b.concat(newResponseItem.slice(1)), groupResponse = { ...response, item: mergedResponse };
    onChange([groupResponse]);
  }
  return props.checkForQuestionEnabled(props.item) ? (0, import_jsx_runtime111.jsxs)("div", { children: [props.item.text && (0, import_jsx_runtime111.jsx)(Title, { order: 3, mb: "md", children: props.item.text }), (0, import_jsx_runtime111.jsx)(Stack, { children: (_a = props.item.item) == null ? void 0 : _a.map((item) => {
    var _a2, _b, _c;
    return item.type === "group" ? item.repeats ? (0, import_jsx_runtime111.jsx)(QuestionnaireRepeatedGroup, { item, response: ((_a2 = response.item) == null ? void 0 : _a2.filter((i) => i.linkId === item.linkId)) ?? [], checkForQuestionEnabled, onChange: onSetGroup }, item.linkId) : (0, import_jsx_runtime111.jsx)(QuestionnaireGroup, { item, checkForQuestionEnabled, response: ((_b = response.item) == null ? void 0 : _b.find((i) => i.linkId === item.linkId)) ?? { linkId: item.linkId }, onChange: onSetGroup }, item.linkId) : (0, import_jsx_runtime111.jsx)(QuestionnaireRepeatableItem, { item, response: (_c = response.item) == null ? void 0 : _c.find((i) => i.linkId === item.linkId), onChange: onSetGroup, checkForQuestionEnabled }, item.linkId);
  }) })] }, props.item.linkId) : null;
}
function QuestionnairePageSequence(props) {
  let { items, response, activePage, onChange, nextStep, prevStep, numberOfPages, renderPages, submitButtonText, checkForQuestionEnabled } = props, form = items.map((item) => {
    var _a;
    let itemResponse = ((_a = response == null ? void 0 : response.item) == null ? void 0 : _a.filter((i) => i.linkId === item.linkId)) ?? [], repeatedItem = item.type === "group" ? (0, import_jsx_runtime112.jsx)(QuestionnaireRepeatedGroup, { item, response: itemResponse, onChange, checkForQuestionEnabled }, item.linkId) : (0, import_jsx_runtime112.jsx)(QuestionnaireRepeatableItem, { item, response: itemResponse == null ? void 0 : itemResponse[0], onChange, checkForQuestionEnabled }, item.linkId);
    return renderPages ? (0, import_jsx_runtime112.jsx)(Stepper.Step, { label: item.text, children: repeatedItem }, item.linkId) : repeatedItem;
  });
  return (0, import_jsx_runtime112.jsxs)(import_jsx_runtime112.Fragment, { children: [renderPages && (0, import_jsx_runtime112.jsx)(Stepper, { active: activePage ?? 0, allowNextStepsSelect: false, p: 6, children: form }), !renderPages && (0, import_jsx_runtime112.jsx)(Stack, { children: form }), (0, import_jsx_runtime112.jsx)(ButtonGroup, { activePage: activePage ?? 0, numberOfPages, nextStep, prevStep, submitButtonText })] });
}
function ButtonGroup(props) {
  let showBackButton = props.activePage > 0, showNextButton = props.activePage < props.numberOfPages - 1, showSubmitButton = props.activePage === props.numberOfPages - 1;
  return (0, import_jsx_runtime112.jsxs)(Group, { justify: "flex-end", mt: "xl", gap: "xs", children: [showBackButton && (0, import_jsx_runtime112.jsx)(Button, { onClick: props.prevStep, children: "Back" }), showNextButton && (0, import_jsx_runtime112.jsx)(Button, { onClick: (e) => {
    e.currentTarget.closest("form").reportValidity() && props.nextStep();
  }, children: "Next" }), showSubmitButton && (0, import_jsx_runtime112.jsx)(Button, { type: "submit", children: props.submitButtonText ?? "Submit" })] });
}
function QuestionnaireForm(props) {
  let medplum = a(), source = medplum.getProfile(), [schemaLoaded, setSchemaLoaded] = (0, import_react83.useState)(false), questionnaire = ce(props.questionnaire), [response, setResponse] = (0, import_react83.useState)(), [activePage, setActivePage] = (0, import_react83.useState)(0);
  (0, import_react83.useEffect)(() => {
    medplum.requestSchema("Questionnaire").then(() => medplum.requestSchema("QuestionnaireResponse")).then(() => setSchemaLoaded(true)).catch(console.log);
  }, [medplum]), (0, import_react83.useEffect)(() => {
    setResponse(questionnaire ? buildInitialResponse(questionnaire) : void 0);
  }, [questionnaire]);
  function setItems(newResponseItems) {
    let currentItems = (response == null ? void 0 : response.item) ?? [], newResponse = { resourceType: "QuestionnaireResponse", status: "in-progress", item: mergeItems(currentItems, Array.isArray(newResponseItems) ? newResponseItems : [newResponseItems]) };
    setResponse(newResponse);
  }
  function checkForQuestionEnabled(item) {
    return isQuestionEnabled(item, (response == null ? void 0 : response.item) ?? []);
  }
  if (!schemaLoaded || !questionnaire || !response)
    return null;
  let numberOfPages = getNumberOfPages(questionnaire), nextStep = () => setActivePage((current) => current + 1), prevStep = () => setActivePage((current) => current - 1);
  return (0, import_jsx_runtime113.jsx)(QuestionnaireFormContext.Provider, { value: { subject: props.subject, encounter: props.encounter }, children: (0, import_jsx_runtime113.jsxs)(Form, { testid: "questionnaire-form", onSubmit: () => {
    props.onSubmit && response && props.onSubmit({ ...response, questionnaire: X(questionnaire), subject: props.subject, source: Z(source), authored: (/* @__PURE__ */ new Date()).toISOString(), status: "completed" });
  }, children: [questionnaire.title && (0, import_jsx_runtime113.jsx)(Title, { children: questionnaire.title }), (0, import_jsx_runtime113.jsx)(QuestionnairePageSequence, { items: questionnaire.item ?? [], response, onChange: setItems, renderPages: numberOfPages > 1, activePage, numberOfPages, submitButtonText: props.submitButtonText, checkForQuestionEnabled, nextStep, prevStep })] }) });
}
function mergeIndividualItems(prevItem, newItem) {
  let mergedNestedItems = mergeItems(prevItem.item ?? [], newItem.item ?? []);
  return { ...newItem, item: mergedNestedItems.length > 0 ? mergedNestedItems : void 0, answer: newItem.answer && newItem.answer.length > 0 ? newItem.answer : prevItem.answer };
}
function mergeItems(prevItems, newItems) {
  let result = [], usedIds = /* @__PURE__ */ new Set();
  for (let prevItem of prevItems) {
    let itemId = prevItem.id, newItem = newItems.find((item) => item.id === itemId);
    newItem ? (result.push(mergeIndividualItems(prevItem, newItem)), usedIds.add(newItem.id)) : result.push(prevItem);
  }
  for (let newItem of newItems)
    usedIds.has(newItem.id) || result.push(newItem);
  return result;
}
var ReferenceRangeEditor_default = { section: "ReferenceRangeEditor_section" };
var intervalFilters = ["gender", "age", "gestationalAge", "context", "appliesTo", "category"];
var defaultProps3 = { definition: { resourceType: "ObservationDefinition", code: { text: "" } }, onSubmit: () => {
} };
function ReferenceRangeEditor(props) {
  props = Object.assign(defaultProps3, props);
  let defaultDefinition = props.definition, [intervalGroups, setIntervalGroups] = (0, import_react86.useState)([]), [groupId, setGroupId] = (0, import_react86.useState)(1), [intervalId, setIntervalId] = (0, import_react86.useState)(1);
  return (0, import_react86.useEffect)(() => {
    let definition = ensureQualifiedIntervalKeys(defaultDefinition, setIntervalId);
    setIntervalGroups(groupQualifiedIntervals(definition.qualifiedInterval || [], setGroupId));
  }, [defaultDefinition]), (0, import_jsx_runtime114.jsxs)(Form, { testid: "reference-range-editor", onSubmit: submitDefinition, children: [(0, import_jsx_runtime114.jsx)(Stack, { children: intervalGroups.map((intervalGroup) => {
    var _a;
    return (0, import_jsx_runtime114.jsx)(ReferenceRangeGroupEditor, { unit: getUnitString((_a = defaultDefinition.quantitativeDetails) == null ? void 0 : _a.unit), onChange: changeInterval, onAdd: addInterval, onRemove: removeInterval, onRemoveGroup: removeGroup, intervalGroup }, `group-${intervalGroup.id}`);
  }) }), (0, import_jsx_runtime114.jsx)(ActionIcon, { title: "Add Group", variant: "subtle", size: "sm", onClick: (e) => {
    killEvent(e), addGroup({ id: `group-id-${groupId}`, filters: {}, intervals: [] }), setGroupId((id) => id + 1);
  }, children: (0, import_jsx_runtime114.jsx)(IconCirclePlus, {}) }), (0, import_jsx_runtime114.jsx)(Group, { justify: "flex-end", children: (0, import_jsx_runtime114.jsx)(Button, { type: "submit", children: "Save" }) })] });
  function submitDefinition() {
    let qualifiedInterval = intervalGroups.flatMap((group) => group.intervals).filter((interval) => !isEmptyInterval(interval));
    props.onSubmit({ ...defaultDefinition, qualifiedInterval });
  }
  function addGroup(addedGroup) {
    setIntervalGroups((currentGroups) => [...currentGroups, addedGroup]);
  }
  function removeGroup(removedGroup) {
    setIntervalGroups((currentGroups) => currentGroups.filter((group) => group.id !== removedGroup.id));
  }
  function changeInterval(groupId2, changedInterval) {
    setIntervalGroups((groups) => {
      groups = [...groups];
      let currentGroup = groups.find((g2) => g2.id === groupId2), index = currentGroup == null ? void 0 : currentGroup.intervals.findIndex((interval) => interval.id === changedInterval.id);
      return index !== void 0 && (currentGroup == null ? void 0 : currentGroup.intervals[index]) && (currentGroup.intervals[index] = changedInterval), groups;
    });
  }
  function addInterval(groupId2, addedInterval) {
    addedInterval.id === void 0 && (addedInterval.id = `id-${intervalId}`, setIntervalId((id) => id + 1)), setIntervalGroups((groups) => {
      groups = [...groups];
      let currentGroupIndex = groups.findIndex((g2) => g2.id === groupId2);
      if (currentGroupIndex !== -1) {
        let currentGroup = { ...groups[currentGroupIndex] };
        addedInterval = { ...addedInterval, ...currentGroup.filters }, currentGroup.intervals = [...currentGroup.intervals, addedInterval], groups[currentGroupIndex] = currentGroup;
      }
      return groups;
    });
  }
  function removeInterval(groupId2, removedInterval) {
    setIntervalGroups((groups) => {
      groups = [...groups];
      let currentGroup = groups.find((g2) => g2.id === groupId2);
      return currentGroup && (currentGroup.intervals = currentGroup.intervals.filter((interval) => interval.id !== removedInterval.id)), groups;
    });
  }
}
function ReferenceRangeGroupEditor(props) {
  let { intervalGroup, unit } = props;
  return (0, import_jsx_runtime114.jsx)(Container2, { "data-testid": intervalGroup.id, className: ReferenceRangeEditor_default.section, children: (0, import_jsx_runtime114.jsxs)(Stack, { gap: "lg", children: [(0, import_jsx_runtime114.jsx)(Group, { justify: "flex-end", children: (0, import_jsx_runtime114.jsx)(ActionIcon, { title: "Remove Group", variant: "subtle", "data-testid": `remove-group-button-${intervalGroup.id}`, size: "sm", onClick: (e) => {
    killEvent(e), props.onRemoveGroup(intervalGroup);
  }, children: (0, import_jsx_runtime114.jsx)(IconCircleMinus, {}) }, `remove-group-button-${intervalGroup.id}`) }), (0, import_jsx_runtime114.jsx)(ReferenceRangeGroupFilters, { intervalGroup, onChange: props.onChange }), (0, import_jsx_runtime114.jsx)(Divider, {}), intervalGroup.intervals.map((interval) => (0, import_jsx_runtime114.jsxs)(Stack, { gap: "xs", children: [(0, import_jsx_runtime114.jsxs)(Group, { children: [(0, import_jsx_runtime114.jsx)(TextInput, { "data-testid": `condition-${interval.id}`, defaultValue: interval.condition, label: "Condition: ", size: "sm", onChange: (e) => {
    killEvent(e), props.onChange(intervalGroup.id, { ...interval, condition: e.currentTarget.value.trim() });
  } }, `condition-${interval.id}`), (0, import_jsx_runtime114.jsx)(ActionIcon, { title: "Remove Interval", variant: "subtle", size: "sm", "data-testid": `remove-interval-${interval.id}`, onClick: (e) => {
    killEvent(e), props.onRemove(intervalGroup.id, interval);
  }, children: (0, import_jsx_runtime114.jsx)(IconCircleMinus, {}) }, `remove-interval-${interval.id}`)] }), (0, import_jsx_runtime114.jsx)(RangeInput, { onChange: (range) => {
    props.onChange(intervalGroup.id, { ...interval, range });
  }, name: `range-${interval.id}`, defaultValue: interval.range }, `range-${interval.id}`)] }, `interval-${interval.id}`)), (0, import_jsx_runtime114.jsx)(ActionIcon, { title: "Add Interval", variant: "subtle", size: "sm", onClick: (e) => {
    killEvent(e), props.onAdd(intervalGroup.id, { range: { low: { unit }, high: { unit } } });
  }, children: (0, import_jsx_runtime114.jsx)(IconCirclePlus, {}) })] }) });
}
function ReferenceRangeGroupFilters(props) {
  var _a, _b;
  let { intervalGroup, onChange } = props;
  intervalGroup.filters.age || (intervalGroup.filters.age = {});
  for (let key of ["low", "high"])
    ((_a = intervalGroup.filters.age[key]) == null ? void 0 : _a.unit) || (intervalGroup.filters.age[key] = { ...intervalGroup.filters.age[key], unit: "years", system: "http://unitsofmeasure.org" });
  return (0, import_jsx_runtime114.jsxs)(Stack, { style: { maxWidth: "50%" }, children: [(0, import_jsx_runtime114.jsx)(Group, { children: (0, import_jsx_runtime114.jsx)(NativeSelect, { data: ["", "male", "female"], label: "Gender:", defaultValue: intervalGroup.filters.gender || "", onChange: (e) => {
    for (let interval of intervalGroup.intervals) {
      let newGender = e.currentTarget.value;
      newGender === "" && (newGender = void 0), onChange(intervalGroup.id, { ...interval, gender: newGender });
    }
  } }) }), (0, import_jsx_runtime114.jsxs)(Group, { gap: "xs", children: [(0, import_jsx_runtime114.jsx)(Text, { component: "label", htmlFor: `div-age-${intervalGroup.id}`, children: "Age:" }), (0, import_jsx_runtime114.jsx)("div", { id: `div-age-${intervalGroup.id}`, children: (0, import_jsx_runtime114.jsx)(RangeInput, { name: `age-${intervalGroup.id}`, defaultValue: intervalGroup.filters.age, onChange: (ageRange) => {
    for (let interval of intervalGroup.intervals)
      onChange(intervalGroup.id, { ...interval, age: ageRange });
  } }, `age-${intervalGroup.id}`) })] }), (0, import_jsx_runtime114.jsx)(NativeSelect, { data: ["", "pre-puberty", "follicular", "midcycle", "luteal", "postmenopausal"], label: "Endocrine:", defaultValue: ((_b = intervalGroup.filters.context) == null ? void 0 : _b.text) || "", onChange: (e) => {
    for (let interval of intervalGroup.intervals) {
      let newEndocrine = e.currentTarget.value;
      newEndocrine === "" ? (newEndocrine = void 0, onChange(intervalGroup.id, { ...interval, context: void 0 })) : onChange(intervalGroup.id, { ...interval, context: { text: newEndocrine, coding: [{ code: newEndocrine, system: "http://terminology.hl7.org/CodeSystem/referencerange-meaning" }] } });
    }
  } }), (0, import_jsx_runtime114.jsx)(NativeSelect, { data: ["", "reference", "critical", "absolute"], label: "Category: ", defaultValue: intervalGroup.filters.category, onChange: (e) => {
    for (let interval of intervalGroup.intervals) {
      let newCategory = e.currentTarget.value;
      newCategory === "" ? onChange(intervalGroup.id, { ...interval, category: void 0 }) : onChange(intervalGroup.id, { ...interval, category: newCategory });
    }
  } })] });
}
function ensureQualifiedIntervalKeys(definition, setIntervalId) {
  let intervals = definition.qualifiedInterval || [], nextId4 = Math.max(...intervals.map((interval) => {
    var _a;
    let existingNum = parseInt(((_a = interval.id) == null ? void 0 : _a.substring(3)) || "", 10);
    return isNaN(existingNum) ? Number.NEGATIVE_INFINITY : existingNum;
  })) + 1;
  return Number.isFinite(nextId4) || (nextId4 = 1), definition = { ...definition, qualifiedInterval: intervals.map((interval) => ({ ...interval, id: interval.id || `id-${nextId4++}` })) }, setIntervalId(nextId4), definition;
}
function groupQualifiedIntervals(intervals, setGroupId) {
  let groupId = 1, groups = {};
  for (let interval of intervals) {
    let groupKey = generateGroupKey(interval);
    groupKey in groups || (groups[groupKey] = { id: `group-id-${groupId++}`, filters: Object.fromEntries(intervalFilters.map((f2) => [f2, interval[f2]])), intervals: [] }), groups[groupKey].intervals.push(interval);
  }
  return setGroupId(groupId), Object.values(groups);
}
function generateGroupKey(interval) {
  var _a, _b;
  return [`gender=${interval.gender}`, `age=${jc(interval.age)}`, `gestationalAge=${jc(interval.gestationalAge)}`, `context=${(_a = interval.context) == null ? void 0 : _a.text}`, `appliesTo=${(_b = interval.appliesTo) == null ? void 0 : _b.map((c) => c.text).join("+")}`, `category=${interval.category}`].join(":");
}
function getUnitString(unit) {
  return unit && (er(unit, "http://unitsofmeasure.org") || unit.text);
}
function isEmptyInterval(interval) {
  var _a, _b, _c, _d;
  return ((_b = (_a = interval.range) == null ? void 0 : _a.low) == null ? void 0 : _b.value) === void 0 && ((_d = (_c = interval.range) == null ? void 0 : _c.high) == null ? void 0 : _d.value) === void 0;
}
function RequestGroupDisplay(props) {
  var _a;
  let medplum = a(), requestGroup = ce(props.value), [startedLoading, setStartedLoading] = (0, import_react87.useState)(false), [responseBundle, setResponseBundle] = (0, import_react87.useState)();
  if ((0, import_react87.useEffect)(() => {
    requestGroup && !startedLoading && (medplum.executeBatch(buildBatchRequest(requestGroup)).then(setResponseBundle).catch(console.log), setStartedLoading(true));
  }, [medplum, requestGroup, startedLoading]), !requestGroup || !responseBundle)
    return null;
  return (0, import_jsx_runtime115.jsx)(Grid, { children: (_a = requestGroup.action) == null ? void 0 : _a.map((action, index) => {
    var _a2, _b, _c, _d, _e, _f;
    let task = action.resource && findBundleEntry(action.resource), taskInput = (_b = (_a2 = task == null ? void 0 : task.input) == null ? void 0 : _a2[0]) == null ? void 0 : _b.valueReference, taskOutput = (_d = (_c = task == null ? void 0 : task.output) == null ? void 0 : _c[0]) == null ? void 0 : _d.valueReference;
    return (0, import_jsx_runtime115.jsxs)(import_react87.Fragment, { children: [(0, import_jsx_runtime115.jsx)(Grid.Col, { span: 1, p: "md", children: (task == null ? void 0 : task.status) === "completed" ? (0, import_jsx_runtime115.jsx)(IconCheckbox, {}) : (0, import_jsx_runtime115.jsx)(IconSquare, { color: "gray" }) }), (0, import_jsx_runtime115.jsxs)(Grid.Col, { span: 9, p: "xs", children: [(0, import_jsx_runtime115.jsx)(Text, { fw: 500, children: action.title }), action.description && (0, import_jsx_runtime115.jsx)("div", { children: action.description }), (0, import_jsx_runtime115.jsxs)("div", { children: ["Last edited by", (0, import_jsx_runtime115.jsx)(ResourceName, { value: (_e = task == null ? void 0 : task.meta) == null ? void 0 : _e.author }), "on", nr((_f = task == null ? void 0 : task.meta) == null ? void 0 : _f.lastUpdated)] }), (0, import_jsx_runtime115.jsxs)("div", { children: ["Status: ", (0, import_jsx_runtime115.jsx)(StatusBadge, { status: (task == null ? void 0 : task.status) || "unknown" })] })] }), (0, import_jsx_runtime115.jsxs)(Grid.Col, { span: 2, p: "md", children: [taskInput && !taskOutput && (0, import_jsx_runtime115.jsx)(Button, { onClick: () => props.onStart(task, taskInput), children: "Start" }), taskInput && taskOutput && (0, import_jsx_runtime115.jsx)(Button, { onClick: () => props.onEdit(task, taskInput, taskOutput), children: "Edit" })] })] }, `action-${index}`);
  }) });
  function buildBatchRequest(request) {
    var _a2;
    let batchEntries = [];
    if (request.action)
      for (let action of request.action)
        ((_a2 = action.resource) == null ? void 0 : _a2.reference) && batchEntries.push({ request: { method: "GET", url: action.resource.reference } });
    return { resourceType: "Bundle", type: "batch", entry: batchEntries };
  }
  function findBundleEntry(reference) {
    for (let entry of responseBundle == null ? void 0 : responseBundle.entry)
      if (entry.resource && reference.reference === X(entry.resource))
        return entry.resource;
  }
}
function diff(original, revised) {
  let path = buildPath(original, revised);
  return buildRevisions(path, original, revised);
}
function buildPath(orig, rev) {
  let N2 = orig.length, M = rev.length, MAX = N2 + M + 1, size = 1 + 2 * MAX, middle = size / 2 | 0, diagonal = new Array(size);
  diagonal[middle + 1] = { i: 0, j: -1, prev: void 0, snake: true };
  for (let d = 0; d < MAX; d++) {
    for (let k2 = -d; k2 <= d; k2 += 2) {
      let kmiddle = middle + k2, kplus = kmiddle + 1, kminus = kmiddle - 1, kplusNode = diagonal[kplus], kminusNode = diagonal[kminus], prev, i = 0;
      k2 === -d || k2 !== d && kminusNode.i < kplusNode.i ? (i = kplusNode.i, prev = kplusNode) : (i = kminusNode.i + 1, prev = kminusNode), diagonal[kminus] = void 0;
      let j2 = i - k2, node = { i, j: j2, prev: previousSnake(prev), snake: false };
      for (; i < N2 && j2 < M && orig[i] === rev[j2]; )
        i++, j2++;
      if (i > node.i && (node = { i, j: j2, prev: node, snake: true }), diagonal[kmiddle] = node, i >= N2 && j2 >= M)
        return diagonal[kmiddle];
    }
    diagonal[middle + d - 1] = void 0;
  }
}
function buildRevisions(startNode, orig, rev) {
  let deltas = [], path = startNode;
  for (path.snake && (path = path.prev); (path == null ? void 0 : path.prev) && path.prev.j >= 0; ) {
    let i = path.i, j2 = path.j;
    path = path.prev;
    let ianchor = path.i, janchor = path.j, original = { position: ianchor, lines: orig.slice(ianchor, i) }, revised = { position: janchor, lines: rev.slice(janchor, j2) }, type;
    original.lines.length === 0 && revised.lines.length > 0 ? type = "insert" : original.lines.length > 0 && revised.lines.length === 0 ? type = "delete" : type = "change", deltas.push({ original, revised, type }), path.snake && (path = path.prev);
  }
  return deltas;
}
function previousSnake(node) {
  return node && !node.snake && node.prev ? node.prev : node;
}
function blame(history) {
  let versions = history.entry.filter((entry) => !!entry.resource).map((entry) => {
    var _a;
    return { meta: (_a = entry.resource) == null ? void 0 : _a.meta, lines: ln(entry.resource, true).match(/[^\r\n]+/g) };
  }).sort((a2, b2) => a2.meta.lastUpdated.localeCompare(b2.meta.lastUpdated)), table = versions[0].lines.map((line) => ({ id: versions[0].meta.versionId, meta: versions[0].meta, value: line, span: 1 }));
  return compareVersions(table, versions), combineSpans(table), table;
}
function compareVersions(table, versions) {
  for (let i = 1; i < versions.length; i++) {
    let revisions = diff(versions[i - 1].lines, versions[i].lines);
    for (let revision of revisions) {
      let position = revision.original.position, oldLines = revision.original.lines, newLines = revision.revised.lines;
      if ((revision.type === "delete" || revision.type === "change") && table.splice(position, oldLines.length), revision.type === "insert" || revision.type === "change")
        for (let k2 = 0; k2 < revision.revised.lines.length; k2++)
          table.splice(position + k2, 0, { id: versions[i].meta.versionId, meta: versions[i].meta, value: newLines[k2], span: 1 });
    }
  }
}
function combineSpans(table) {
  let start = 0;
  for (; start < table.length; ) {
    let curr = start;
    for (; curr < table.length && table[curr].id === table[start].id; )
      table[curr].span = -1, curr++;
    table[start].span = curr - start, start = curr;
  }
}
var ResourceBlame_default = { container: "ResourceBlame_container", root: "ResourceBlame_root", startRow: "ResourceBlame_startRow", normalRow: "ResourceBlame_normalRow", author: "ResourceBlame_author", dateTime: "ResourceBlame_dateTime", lineNumber: "ResourceBlame_lineNumber", line: "ResourceBlame_line", pre: "ResourceBlame_pre" };
function getVersionUrl(resource, versionId) {
  return `/${resource.resourceType}/${resource.id}/_history/${versionId}`;
}
function getTimeString(lastUpdated) {
  let seconds = Math.floor((Date.now() - Date.parse(lastUpdated)) / 1e3), years = Math.floor(seconds / 31536e3);
  if (years > 0)
    return pluralizeTime(years, "year");
  let months = Math.floor(seconds / 2592e3);
  if (months > 0)
    return pluralizeTime(months, "month");
  let days = Math.floor(seconds / 86400);
  if (days > 0)
    return pluralizeTime(days, "day");
  let hours = Math.floor(seconds / 3600);
  if (hours > 0)
    return pluralizeTime(hours, "hour");
  let minutes = Math.floor(seconds / 60);
  return minutes > 0 ? pluralizeTime(minutes, "minute") : pluralizeTime(seconds, "second");
}
function pluralizeTime(count, noun) {
  return `${count} ${count === 1 ? noun : noun + "s"} ago`;
}
function ResourceBlame(props) {
  var _a, _b;
  let medplum = a(), [value, setValue] = (0, import_react88.useState)(props.history);
  if ((0, import_react88.useEffect)(() => {
    !props.history && props.resourceType && props.id && medplum.readHistory(props.resourceType, props.id).then(setValue).catch(console.log);
  }, [medplum, props.history, props.resourceType, props.id]), !value)
    return (0, import_jsx_runtime116.jsx)("div", { children: "Loading..." });
  let resource = (_b = (_a = value.entry) == null ? void 0 : _a[0]) == null ? void 0 : _b.resource;
  if (!resource)
    return null;
  let table = blame(value);
  return (0, import_jsx_runtime116.jsx)("div", { className: ResourceBlame_default.container, children: (0, import_jsx_runtime116.jsx)("table", { className: ResourceBlame_default.root, children: (0, import_jsx_runtime116.jsx)("tbody", { children: table.map((row, index) => (0, import_jsx_runtime116.jsxs)("tr", { className: row.span > 0 ? ResourceBlame_default.startRow : ResourceBlame_default.normalRow, children: [row.span > 0 && (0, import_jsx_runtime116.jsxs)(import_jsx_runtime116.Fragment, { children: [(0, import_jsx_runtime116.jsx)("td", { className: ResourceBlame_default.author, rowSpan: row.span, children: (0, import_jsx_runtime116.jsx)(ResourceBadge, { value: row.meta.author, link: true }) }), (0, import_jsx_runtime116.jsx)("td", { className: ResourceBlame_default.dateTime, rowSpan: row.span, children: (0, import_jsx_runtime116.jsx)(MedplumLink, { to: getVersionUrl(resource, row.meta.versionId), children: getTimeString(row.meta.lastUpdated) }) })] }), (0, import_jsx_runtime116.jsx)("td", { className: ResourceBlame_default.lineNumber, children: index + 1 }), (0, import_jsx_runtime116.jsx)("td", { className: ResourceBlame_default.line, children: (0, import_jsx_runtime116.jsx)("pre", { className: ResourceBlame_default.pre, children: row.value }) })] }, "row-" + index)) }) }) });
}
var ResourceDiff_default = { removed: "ResourceDiff_removed", added: "ResourceDiff_added" };
function ResourceDiff(props) {
  let originalResource = props.original, revisedResource = props.revised;
  props.ignoreMeta && (originalResource = { ...originalResource, meta: void 0 }, revisedResource = { ...revisedResource, meta: void 0 });
  let original = ln(originalResource, true).match(/[^\r\n]+/g), revised = ln(revisedResource, true).match(/[^\r\n]+/g), deltas = diff(original, revised);
  return (0, import_jsx_runtime117.jsx)("pre", { style: { color: "gray" }, children: deltas.map((delta, index) => (0, import_jsx_runtime117.jsx)(ChangeDiff, { delta }, "delta" + index)) });
}
function ChangeDiff(props) {
  return (0, import_jsx_runtime117.jsxs)(import_jsx_runtime117.Fragment, { children: ["...", (0, import_jsx_runtime117.jsx)("br", {}), props.delta.original.lines.length > 0 && (0, import_jsx_runtime117.jsx)("div", { className: ResourceDiff_default.removed, children: props.delta.original.lines.join(`
`) }), props.delta.revised.lines.length > 0 && (0, import_jsx_runtime117.jsx)("div", { className: ResourceDiff_default.added, children: props.delta.revised.lines.join(`
`) }), "...", (0, import_jsx_runtime117.jsx)("br", {})] });
}
function ResourceForm(props) {
  let { outcome } = props, medplum = a(), defaultValue2 = ce(props.defaultValue), [schemaLoaded, setSchemaLoaded] = (0, import_react89.useState)(), [value, setValue] = (0, import_react89.useState)();
  return (0, import_react89.useEffect)(() => {
    if (defaultValue2)
      if (props.profileUrl) {
        let profileUrl = props.profileUrl;
        medplum.requestProfileSchema(props.profileUrl, { expandProfile: true }).then(() => {
          let profile = Kr(profileUrl);
          if (profile) {
            setSchemaLoaded(profile.name);
            let modifiedDefaultValue = Dp(defaultValue2, profile);
            setValue(modifiedDefaultValue);
          } else
            console.error(`Schema not found for ${profileUrl}`);
        }).catch((reason) => {
          console.error("Error in requestProfileSchema", reason);
        });
      } else {
        let schemaName = props.schemaName ?? (defaultValue2 == null ? void 0 : defaultValue2.resourceType);
        medplum.requestSchema(schemaName).then(() => {
          setValue(defaultValue2), setSchemaLoaded(schemaName);
        }).catch(console.log);
      }
  }, [medplum, defaultValue2, props.schemaName, props.profileUrl]), !schemaLoaded || !value ? (0, import_jsx_runtime118.jsx)("div", { children: "Loading..." }) : (0, import_jsx_runtime118.jsxs)("form", { noValidate: true, autoComplete: "off", onSubmit: (e) => {
    e.preventDefault(), props.onSubmit && props.onSubmit(value);
  }, children: [(0, import_jsx_runtime118.jsxs)(Stack, { mb: "xl", children: [(0, import_jsx_runtime118.jsx)(FormSection, { title: "Resource Type", htmlFor: "resourceType", outcome, children: (0, import_jsx_runtime118.jsx)(TextInput, { name: "resourceType", defaultValue: value.resourceType, disabled: true }) }), (0, import_jsx_runtime118.jsx)(FormSection, { title: "ID", htmlFor: "id", outcome, children: (0, import_jsx_runtime118.jsx)(TextInput, { name: "id", defaultValue: value.id, disabled: true }) })] }), (0, import_jsx_runtime118.jsx)(BackboneElementInput, { path: value.resourceType, typeName: schemaLoaded, defaultValue: value, outcome, onChange: setValue, profileUrl: props.profileUrl }), (0, import_jsx_runtime118.jsxs)(Group, { justify: "flex-end", mt: "xl", children: [(0, import_jsx_runtime118.jsx)(Button, { type: "submit", children: "OK" }), props.onDelete && (0, import_jsx_runtime118.jsx)(Button, { variant: "outline", color: "red", type: "button", onClick: () => {
    props.onDelete(value);
  }, children: "Delete" })] })] });
}
function ResourceHistoryTable(props) {
  var _a;
  let medplum = a(), [value, setValue] = (0, import_react90.useState)(props.history);
  return (0, import_react90.useEffect)(() => {
    !props.history && props.resourceType && props.id && medplum.readHistory(props.resourceType, props.id).then(setValue).catch(console.log);
  }, [medplum, props.history, props.resourceType, props.id]), value ? (0, import_jsx_runtime119.jsxs)(Table, { withTableBorder: true, withRowBorders: true, withColumnBorders: true, children: [(0, import_jsx_runtime119.jsx)(Table.Thead, { children: (0, import_jsx_runtime119.jsxs)(Table.Tr, { children: [(0, import_jsx_runtime119.jsx)(Table.Th, { children: "Author" }), (0, import_jsx_runtime119.jsx)(Table.Th, { children: "Date" }), (0, import_jsx_runtime119.jsx)(Table.Th, { children: "Version" })] }) }), (0, import_jsx_runtime119.jsx)(Table.Tbody, { children: (_a = value.entry) == null ? void 0 : _a.map((entry, index) => (0, import_jsx_runtime119.jsx)(HistoryRow, { entry }, "entry-" + index)) })] }) : (0, import_jsx_runtime119.jsx)("div", { children: "Loading..." });
}
function HistoryRow(props) {
  var _a, _b, _c;
  let { response, resource } = props.entry;
  return resource ? (0, import_jsx_runtime119.jsxs)(Table.Tr, { children: [(0, import_jsx_runtime119.jsx)(Table.Td, { children: (0, import_jsx_runtime119.jsx)(ResourceBadge, { value: (_a = resource.meta) == null ? void 0 : _a.author, link: true }) }), (0, import_jsx_runtime119.jsx)(Table.Td, { children: nr((_b = resource.meta) == null ? void 0 : _b.lastUpdated) }), (0, import_jsx_runtime119.jsx)(Table.Td, { children: (0, import_jsx_runtime119.jsx)(MedplumLink, { to: getVersionUrl2(resource), children: (_c = resource.meta) == null ? void 0 : _c.versionId }) })] }) : (0, import_jsx_runtime119.jsx)(Table.Tr, { children: (0, import_jsx_runtime119.jsx)(Table.Td, { colSpan: 3, children: di(response == null ? void 0 : response.outcome) }) });
}
function getVersionUrl2(resource) {
  var _a;
  return `/${resource.resourceType}/${resource.id}/_history/${(_a = resource.meta) == null ? void 0 : _a.versionId}`;
}
var Scheduler_default = { container: "Scheduler_container", info: "Scheduler_info", selection: "Scheduler_selection" };
function Scheduler(props) {
  var _a;
  let schedule = ce(props.schedule), questionnaire = ce(props.questionnaire), [month, setMonth] = (0, import_react91.useState)(getStartMonth()), [date, setDate] = (0, import_react91.useState)(), [slot, setSlot] = (0, import_react91.useState)(), [response, setResponse] = (0, import_react91.useState)(), [slots] = ge2("Slot", new URLSearchParams([["_count", (30 * 24).toString()], ["schedule", Y(props.schedule) ? props.schedule.reference : X(props.schedule)], ["start", "gt" + getStart2(month)], ["start", "lt" + getEnd2(month)]]));
  if (!schedule || !slots || !questionnaire)
    return null;
  let actor = (_a = schedule.actor) == null ? void 0 : _a[0];
  return (0, import_jsx_runtime120.jsxs)("div", { className: Scheduler_default.container, "data-testid": "scheduler", children: [(0, import_jsx_runtime120.jsxs)("div", { className: Scheduler_default.info, children: [actor && (0, import_jsx_runtime120.jsx)(ResourceAvatar, { value: actor, size: "xl" }), actor && (0, import_jsx_runtime120.jsx)(Text, { size: "xl", fw: 500, children: (0, import_jsx_runtime120.jsx)(ResourceName, { value: actor }) }), (0, import_jsx_runtime120.jsx)("p", { children: "1 hour" }), date && (0, import_jsx_runtime120.jsx)("p", { children: date.toLocaleDateString() }), slot && (0, import_jsx_runtime120.jsx)("p", { children: formatTime(new Date(slot.start)) })] }), (0, import_jsx_runtime120.jsxs)("div", { className: Scheduler_default.selection, children: [!date && (0, import_jsx_runtime120.jsxs)("div", { children: [(0, import_jsx_runtime120.jsx)("h3", { children: "Select date" }), (0, import_jsx_runtime120.jsx)(CalendarInput, { slots, onChangeMonth: setMonth, onClick: setDate })] }), date && !slot && (0, import_jsx_runtime120.jsxs)("div", { children: [(0, import_jsx_runtime120.jsx)("h3", { children: "Select time" }), (0, import_jsx_runtime120.jsx)(Stack, { children: slots.map((s) => {
    let slotStart = new Date(s.start);
    return slotStart.getTime() > date.getTime() && slotStart.getTime() < date.getTime() + 24 * 3600 * 1e3 && (0, import_jsx_runtime120.jsx)("div", { children: (0, import_jsx_runtime120.jsx)(Button, { variant: "outline", style: { width: 150 }, onClick: () => setSlot(s), children: formatTime(slotStart) }) }, s.id);
  }) })] }), date && slot && !response && (0, import_jsx_runtime120.jsx)(QuestionnaireForm, { questionnaire, submitButtonText: "Next", onSubmit: setResponse }), date && slot && response && (0, import_jsx_runtime120.jsxs)("div", { children: [(0, import_jsx_runtime120.jsx)("h3", { children: "You're all set!" }), (0, import_jsx_runtime120.jsx)("p", { children: "Check your email for a calendar invite." })] })] })] });
}
function getStart2(month) {
  return formatSlotInstant(month.getTime());
}
function getEnd2(month) {
  return formatSlotInstant(month.getTime() + 31 * 24 * 60 * 60 * 1e3);
}
function formatSlotInstant(time) {
  let date = new Date(Math.max(Date.now(), time));
  return date.setHours(0, 0, 0, 0), date.toISOString();
}
function formatTime(date) {
  return date.toLocaleTimeString([], { hour: "numeric", minute: "2-digit" });
}
function ServiceRequestTimeline(props) {
  return (0, import_jsx_runtime121.jsx)(ResourceTimeline, { value: props.serviceRequest, loadTimelineResources: async (medplum, resourceType, id) => {
    let ref = `${resourceType}/${id}`, _count = 100;
    return Promise.allSettled([medplum.readHistory("ServiceRequest", id), medplum.search("Communication", { "based-on": ref, _count }), medplum.search("DiagnosticReport", { "based-on": ref, _count }), medplum.search("Media", { "based-on": ref, _count }), medplum.search("DocumentReference", { related: ref, _count }), medplum.search("Task", { _filter: `based-on eq ${ref} or focus eq ${ref} or subject eq ${ref}`, _count })]);
  }, createCommunication: (resource, sender, text) => ({ resourceType: "Communication", status: "completed", basedOn: [Z(resource)], subject: resource.subject, sender: Z(sender), sent: (/* @__PURE__ */ new Date()).toISOString(), payload: [{ contentString: text }] }), createMedia: (resource, operator, content) => ({ resourceType: "Media", status: "completed", basedOn: [Z(resource)], subject: resource.subject, operator: Z(operator), issued: (/* @__PURE__ */ new Date()).toISOString(), content }) });
}
function SmartAppLaunchLink(props) {
  let medplum = a(), { client, patient, encounter, children: children2, ...rest } = props;
  function launchApp() {
    medplum.createResource({ resourceType: "SmartAppLaunch", patient, encounter }).then((result) => {
      let url = new URL(client.launchUri);
      url.searchParams.set("iss", medplum.getBaseUrl() + "fhir/R4"), url.searchParams.set("launch", result.id), window.location.assign(url.toString());
    }).catch((err) => showNotification({ color: "red", message: di(err), autoClose: false }));
  }
  return (0, import_jsx_runtime122.jsx)(Anchor, { onClick: () => launchApp(), ...rest, children: children2 });
}
function NewProjectForm(props) {
  let medplum = a(), [outcome, setOutcome] = (0, import_react93.useState)();
  return (0, import_jsx_runtime123.jsxs)(Form, { style: { maxWidth: 400 }, onSubmit: async (formData) => {
    try {
      props.handleAuthResponse(await medplum.startNewProject({ login: props.login, projectName: formData.projectName }));
    } catch (err) {
      setOutcome(Be(err));
    }
  }, children: [(0, import_jsx_runtime123.jsxs)(Center, { style: { flexDirection: "column" }, children: [(0, import_jsx_runtime123.jsx)(Logo, { size: 32 }), (0, import_jsx_runtime123.jsx)(Title, { children: "Create project" })] }), (0, import_jsx_runtime123.jsxs)(Stack, { gap: "xl", children: [(0, import_jsx_runtime123.jsx)(TextInput, { name: "projectName", label: "Project Name", placeholder: "My Project", required: true, autoFocus: true, error: getErrorsForInput(outcome, "firstName") }), (0, import_jsx_runtime123.jsxs)(Text, { c: "dimmed", size: "xs", children: ["By clicking submit you agree to the Medplum", " ", (0, import_jsx_runtime123.jsx)(Anchor, { href: "https://www.medplum.com/privacy", children: "PrivacyPolicy" }), " and ", (0, import_jsx_runtime123.jsx)(Anchor, { href: "https://www.medplum.com/terms", children: "TermsofService" }), "."] })] }), (0, import_jsx_runtime123.jsx)(Group, { justify: "flex-end", mt: "xl", wrap: "nowrap", children: (0, import_jsx_runtime123.jsx)(Button, { type: "submit", children: "Create project" }) })] });
}
function createScriptTag(src, onload) {
  let head = document.getElementsByTagName("head")[0], script = document.createElement("script");
  script.async = true, script.src = src, script.onload = onload ?? null, head.appendChild(script);
}
function GoogleButton(props) {
  let medplum = a(), { googleClientId, handleGoogleCredential } = props, parentRef = (0, import_react95.useRef)(null), [scriptLoaded, setScriptLoaded] = (0, import_react95.useState)(typeof google < "u"), [initialized, setInitialized] = (0, import_react95.useState)(false), [buttonRendered, setButtonRendered] = (0, import_react95.useState)(false);
  return (0, import_react95.useEffect)(() => {
    if (typeof google > "u") {
      createScriptTag("https://accounts.google.com/gsi/client", () => setScriptLoaded(true));
      return;
    }
    initialized || (google.accounts.id.initialize({ client_id: googleClientId, callback: handleGoogleCredential }), setInitialized(true)), parentRef.current && !buttonRendered && (google.accounts.id.renderButton(parentRef.current, {}), setButtonRendered(true));
  }, [medplum, googleClientId, initialized, scriptLoaded, parentRef, buttonRendered, handleGoogleCredential]), googleClientId ? (0, import_jsx_runtime124.jsx)("div", { ref: parentRef }) : null;
}
function getGoogleClientId(clientId) {
  if (clientId)
    return clientId;
  if (typeof window < "u") {
    let origin = window.location.protocol + "//" + window.location.host;
    if ((("undefined" == null ? void 0 : "undefined".split(",")) ?? []).includes(origin))
      return "__GOOGLE_CLIENT_ID__";
  }
}
function initRecaptcha(siteKey) {
  typeof grecaptcha > "u" && createScriptTag("https://www.google.com/recaptcha/api.js?render=" + siteKey);
}
function getRecaptcha(siteKey) {
  return new Promise((resolve, reject) => {
    grecaptcha.ready(async () => {
      try {
        resolve(await grecaptcha.execute(siteKey, { action: "submit" }));
      } catch (err) {
        reject(err);
      }
    });
  });
}
function NewUserForm(props) {
  let googleClientId = getGoogleClientId(props.googleClientId), recaptchaSiteKey = props.recaptchaSiteKey, medplum = a(), [outcome, setOutcome] = (0, import_react94.useState)(), issues = getIssuesForExpression(outcome, void 0);
  return (0, import_react94.useEffect)(() => {
    recaptchaSiteKey && initRecaptcha(recaptchaSiteKey);
  }, [recaptchaSiteKey]), (0, import_jsx_runtime125.jsxs)(Form, { style: { maxWidth: 400 }, onSubmit: async (formData) => {
    try {
      let recaptchaToken = "";
      recaptchaSiteKey && (recaptchaToken = await getRecaptcha(recaptchaSiteKey)), props.handleAuthResponse(await medplum.startNewUser({ projectId: props.projectId, clientId: props.clientId, firstName: formData.firstName, lastName: formData.lastName, email: formData.email, password: formData.password, remember: formData.remember === "true", recaptchaSiteKey, recaptchaToken }));
    } catch (err) {
      setOutcome(Be(err));
    }
  }, children: [(0, import_jsx_runtime125.jsx)(Center, { style: { flexDirection: "column" }, children: props.children }), (0, import_jsx_runtime125.jsx)(OperationOutcomeAlert, { issues }), googleClientId && (0, import_jsx_runtime125.jsxs)(import_jsx_runtime125.Fragment, { children: [(0, import_jsx_runtime125.jsx)(Group, { justify: "center", p: "xl", style: { height: 70 }, children: (0, import_jsx_runtime125.jsx)(GoogleButton, { googleClientId, handleGoogleCredential: async (response) => {
    try {
      props.handleAuthResponse(await medplum.startGoogleLogin({ googleClientId: response.clientId, googleCredential: response.credential, createUser: true }));
    } catch (err) {
      setOutcome(Be(err));
    }
  } }) }), (0, import_jsx_runtime125.jsx)(Divider, { label: "or", labelPosition: "center", my: "lg" })] }), (0, import_jsx_runtime125.jsxs)(Stack, { gap: "xl", children: [(0, import_jsx_runtime125.jsx)(TextInput, { name: "firstName", type: "text", label: "First name", placeholder: "First name", required: true, autoFocus: true, error: getErrorsForInput(outcome, "firstName") }), (0, import_jsx_runtime125.jsx)(TextInput, { name: "lastName", type: "text", label: "Last name", placeholder: "Last name", required: true, error: getErrorsForInput(outcome, "lastName") }), (0, import_jsx_runtime125.jsx)(TextInput, { name: "email", type: "email", label: "Email", placeholder: "name@domain.com", required: true, error: getErrorsForInput(outcome, "email") }), (0, import_jsx_runtime125.jsx)(PasswordInput, { name: "password", label: "Password", autoComplete: "off", required: true, error: getErrorsForInput(outcome, "password") }), (0, import_jsx_runtime125.jsxs)(Text, { c: "dimmed", size: "xs", children: ["By clicking submit you agree to the Medplum", " ", (0, import_jsx_runtime125.jsx)(Anchor, { href: "https://www.medplum.com/privacy", children: "PrivacyPolicy" }), " and ", (0, import_jsx_runtime125.jsx)(Anchor, { href: "https://www.medplum.com/terms", children: "TermsofService" }), "."] }), (0, import_jsx_runtime125.jsxs)(Text, { c: "dimmed", size: "xs", children: ["This site is protected by reCAPTCHA and the Google", " ", (0, import_jsx_runtime125.jsx)(Anchor, { href: "https://policies.google.com/privacy", children: "PrivacyPolicy" }), " and ", (0, import_jsx_runtime125.jsx)(Anchor, { href: "https://policies.google.com/terms", children: "TermsofService" }), " apply."] })] }), (0, import_jsx_runtime125.jsxs)(Group, { justify: "space-between", mt: "xl", wrap: "nowrap", children: [(0, import_jsx_runtime125.jsx)(Checkbox, { name: "remember", label: "Remember me", size: "xs" }), (0, import_jsx_runtime125.jsx)(Button, { type: "submit", children: "Create account" })] })] });
}
function RegisterForm(props) {
  let { type, projectId, clientId, googleClientId, recaptchaSiteKey, onSuccess } = props, medplum = a(), [login, setLogin] = (0, import_react92.useState)(), [outcome, setOutcome] = (0, import_react92.useState)();
  (0, import_react92.useEffect)(() => {
    type === "patient" && login && medplum.startNewPatient({ login, projectId }).then((response) => medplum.processCode(response.code)).then(() => onSuccess()).catch((err) => setOutcome(Be(err)));
  }, [medplum, type, projectId, login, onSuccess]);
  function handleAuthResponse(response) {
    response.code ? medplum.processCode(response.code).then(() => onSuccess()).catch(console.log) : response.login && setLogin(response.login);
  }
  return (0, import_jsx_runtime126.jsxs)(Document, { width: 450, children: [outcome && (0, import_jsx_runtime126.jsx)("pre", { children: JSON.stringify(outcome, null, 2) }), !login && (0, import_jsx_runtime126.jsx)(NewUserForm, { projectId, clientId, googleClientId, recaptchaSiteKey, handleAuthResponse, children: props.children }), login && type === "project" && (0, import_jsx_runtime126.jsx)(NewProjectForm, { login, handleAuthResponse })] });
}
function AuthenticationForm(props) {
  let [email, setEmail] = (0, import_react97.useState)();
  return email ? (0, import_jsx_runtime127.jsx)(PasswordForm, { email, ...props }) : (0, import_jsx_runtime127.jsx)(EmailForm, { setEmail, ...props });
}
function EmailForm(props) {
  let { setEmail, onRegister, handleAuthResponse, children: children2, disableEmailAuth, ...baseLoginRequest } = props, medplum = a(), googleClientId = !props.disableGoogleAuth && getGoogleClientId(props.googleClientId), [outcome, setOutcome] = (0, import_react97.useState)(), issues = getIssuesForExpression(outcome, void 0), isExternalAuth = (0, import_react97.useCallback)(async (authMethod) => {
    if (!authMethod.authorizeUrl)
      return false;
    let state = JSON.stringify({ ...await medplum.ensureCodeChallenge(baseLoginRequest), domain: authMethod.domain }), url = new URL(authMethod.authorizeUrl);
    return url.searchParams.set("state", state), window.location.assign(url.toString()), true;
  }, [medplum, baseLoginRequest]), handleSubmit = (0, import_react97.useCallback)(async (formData) => {
    let authMethod = await medplum.post("auth/method", { email: formData.email });
    await isExternalAuth(authMethod) || setEmail(formData.email);
  }, [medplum, isExternalAuth, setEmail]), handleGoogleCredential = (0, import_react97.useCallback)(async (response) => {
    try {
      let authResponse = await medplum.startGoogleLogin({ ...baseLoginRequest, googleCredential: response.credential });
      await isExternalAuth(authResponse) || handleAuthResponse(authResponse);
    } catch (err) {
      setOutcome(Be(err));
    }
  }, [medplum, baseLoginRequest, isExternalAuth, handleAuthResponse]);
  return (0, import_jsx_runtime127.jsxs)(Form, { onSubmit: handleSubmit, children: [(0, import_jsx_runtime127.jsx)(Center, { style: { flexDirection: "column" }, children: children2 }), (0, import_jsx_runtime127.jsx)(OperationOutcomeAlert, { issues }), googleClientId && (0, import_jsx_runtime127.jsxs)(import_jsx_runtime127.Fragment, { children: [(0, import_jsx_runtime127.jsx)(Group, { justify: "center", p: "xl", style: { height: 70 }, children: (0, import_jsx_runtime127.jsx)(GoogleButton, { googleClientId, handleGoogleCredential }) }), !disableEmailAuth && (0, import_jsx_runtime127.jsx)(Divider, { label: "or", labelPosition: "center", my: "lg" })] }), !disableEmailAuth && (0, import_jsx_runtime127.jsx)(TextInput, { name: "email", type: "email", label: "Email", placeholder: "name@domain.com", required: true, autoFocus: true, error: getErrorsForInput(outcome, "email") }), (0, import_jsx_runtime127.jsxs)(Group, { justify: "space-between", mt: "xl", gap: 0, wrap: "nowrap", children: [(0, import_jsx_runtime127.jsx)("div", { children: onRegister && (0, import_jsx_runtime127.jsx)(Anchor, { component: "button", type: "button", color: "dimmed", onClick: onRegister, size: "xs", children: "Register" }) }), !disableEmailAuth && (0, import_jsx_runtime127.jsx)(Button, { type: "submit", children: "Next" })] })] });
}
function PasswordForm(props) {
  let { onForgotPassword, handleAuthResponse, children: children2, ...baseLoginRequest } = props, medplum = a(), [outcome, setOutcome] = (0, import_react97.useState)(), issues = getIssuesForExpression(outcome, void 0), handleSubmit = (0, import_react97.useCallback)((formData) => {
    medplum.startLogin({ ...baseLoginRequest, password: formData.password, remember: formData.remember === "on" }).then(handleAuthResponse).catch((err) => setOutcome(Be(err)));
  }, [medplum, baseLoginRequest, handleAuthResponse]);
  return (0, import_jsx_runtime127.jsxs)(Form, { style: { maxWidth: 400 }, onSubmit: handleSubmit, children: [(0, import_jsx_runtime127.jsx)(Center, { style: { flexDirection: "column" }, children: children2 }), (0, import_jsx_runtime127.jsx)(OperationOutcomeAlert, { issues }), (0, import_jsx_runtime127.jsx)(Stack, { gap: "xl", children: (0, import_jsx_runtime127.jsx)(PasswordInput, { name: "password", label: "Password", autoComplete: "off", required: true, autoFocus: true, error: getErrorsForInput(outcome, "password") }) }), (0, import_jsx_runtime127.jsxs)(Group, { justify: "space-between", mt: "xl", gap: 0, wrap: "nowrap", children: [onForgotPassword && (0, import_jsx_runtime127.jsx)(Anchor, { component: "button", type: "button", c: "dimmed", onClick: onForgotPassword, size: "xs", children: "Forgot password" }), (0, import_jsx_runtime127.jsx)(Checkbox, { id: "remember", name: "remember", label: "Remember me", size: "xs", style: { lineHeight: 1 } }), (0, import_jsx_runtime127.jsx)(Button, { type: "submit", children: "Sign in" })] })] });
}
function ChooseProfileForm(props) {
  let medplum = a(), combobox = useCombobox(), [search, setSearch] = (0, import_react98.useState)(""), [outcome, setOutcome] = (0, import_react98.useState)();
  function filterDisplay(display) {
    var _a;
    return !!((_a = display == null ? void 0 : display.toLowerCase()) == null ? void 0 : _a.includes(search.toLowerCase()));
  }
  function filterMembership(membership) {
    var _a, _b;
    return filterDisplay((_a = membership.profile) == null ? void 0 : _a.display) || filterDisplay((_b = membership.project) == null ? void 0 : _b.display);
  }
  function handleValueSelect(membershipId) {
    medplum.post("auth/profile", { login: props.login, profile: membershipId }).then(props.handleAuthResponse).catch((err) => setOutcome(Be(err)));
  }
  let options = props.memberships.filter(filterMembership).slice(0, 10).map((item) => (0, import_jsx_runtime128.jsx)(Combobox.Option, { value: item.id, children: (0, import_jsx_runtime128.jsx)(SelectOption, { ...item }) }, item.id));
  return (0, import_jsx_runtime128.jsxs)(Stack, { children: [(0, import_jsx_runtime128.jsxs)(Flex, { gap: "md", mb: "md", justify: "center", align: "center", direction: "column", wrap: "nowrap", children: [(0, import_jsx_runtime128.jsx)(Logo, { size: 32 }), (0, import_jsx_runtime128.jsx)(Title, { order: 3, children: "Choose profile" })] }), (0, import_jsx_runtime128.jsx)(OperationOutcomeAlert, { outcome }), (0, import_jsx_runtime128.jsxs)(Combobox, { store: combobox, onOptionSubmit: handleValueSelect, children: [(0, import_jsx_runtime128.jsx)(Combobox.EventsTarget, { children: (0, import_jsx_runtime128.jsx)(TextInput, { placeholder: "Search", value: search, onChange: (event) => {
    setSearch(event.currentTarget.value), combobox.updateSelectedOptionIndex();
  } }) }), (0, import_jsx_runtime128.jsx)("div", { children: (0, import_jsx_runtime128.jsx)(Combobox.Options, { children: options.length > 0 ? options : (0, import_jsx_runtime128.jsx)(Combobox.Empty, { children: "Nothing found..." }) }) })] })] });
}
function SelectOption(membership) {
  var _a, _b;
  return (0, import_jsx_runtime128.jsxs)(Group, { children: [(0, import_jsx_runtime128.jsx)(Avatar, { radius: "xl" }), (0, import_jsx_runtime128.jsxs)("div", { children: [(0, import_jsx_runtime128.jsx)(Text, { fz: "sm", fw: 500, children: (_a = membership.profile) == null ? void 0 : _a.display }), (0, import_jsx_runtime128.jsx)(Text, { fz: "xs", opacity: 0.6, children: (_b = membership.project) == null ? void 0 : _b.display })] })] });
}
function ChooseScopeForm(props) {
  let medplum = a();
  return (0, import_jsx_runtime129.jsx)(Form, { style: { maxWidth: 400 }, onSubmit: (formData) => {
    medplum.post("auth/scope", { login: props.login, scope: Object.keys(formData).join(" ") }).then(props.handleAuthResponse).catch(console.log);
  }, children: (0, import_jsx_runtime129.jsxs)(Stack, { children: [(0, import_jsx_runtime129.jsxs)(Center, { style: { flexDirection: "column" }, children: [(0, import_jsx_runtime129.jsx)(Logo, { size: 32 }), (0, import_jsx_runtime129.jsx)(Title, { children: "Choose scope" })] }), (0, import_jsx_runtime129.jsx)(Stack, { children: (props.scope ?? "openid").split(" ").map((scopeName) => (0, import_jsx_runtime129.jsx)(Checkbox, { id: scopeName, name: scopeName, label: scopeName, defaultChecked: true }, scopeName)) }), (0, import_jsx_runtime129.jsx)(Group, { justify: "flex-end", mt: "xl", children: (0, import_jsx_runtime129.jsx)(Button, { type: "submit", children: "Set scope" }) })] }) });
}
function MfaForm(props) {
  let medplum = a(), [errorMessage, setErrorMessage] = (0, import_react99.useState)();
  return (0, import_jsx_runtime130.jsx)(Form, { style: { maxWidth: 400 }, onSubmit: (formData) => {
    setErrorMessage(void 0), medplum.post("auth/mfa/verify", { login: props.login, token: formData.token }).then(props.handleAuthResponse).catch((err) => setErrorMessage(di(err)));
  }, children: (0, import_jsx_runtime130.jsxs)(Stack, { children: [(0, import_jsx_runtime130.jsxs)(Center, { style: { flexDirection: "column" }, children: [(0, import_jsx_runtime130.jsx)(Logo, { size: 32 }), (0, import_jsx_runtime130.jsx)(Title, { children: "Enter MFA code" })] }), errorMessage && (0, import_jsx_runtime130.jsx)(Alert, { icon: (0, import_jsx_runtime130.jsx)(IconAlertCircle, { size: 16 }), title: "Error", color: "red", children: errorMessage }), (0, import_jsx_runtime130.jsx)(Stack, { children: (0, import_jsx_runtime130.jsx)(TextInput, { name: "token", label: "MFA code", required: true }) }), (0, import_jsx_runtime130.jsx)(Group, { justify: "flex-end", mt: "xl", children: (0, import_jsx_runtime130.jsx)(Button, { type: "submit", children: "Submit code" }) })] }) });
}
function SignInForm(props) {
  let { login: loginCode, chooseScopes, onSuccess, onForgotPassword, onRegister, onCode, ...baseLoginRequest } = props, medplum = a(), [login, setLogin] = (0, import_react96.useState)(), [mfaRequired, setAuthenticatorRequired] = (0, import_react96.useState)(false), [memberships, setMemberships] = (0, import_react96.useState)(), handleCode = (0, import_react96.useCallback)((code) => {
    onCode ? onCode(code) : medplum.processCode(code).then(() => {
      onSuccess && onSuccess();
    }).catch((err) => showNotification({ color: "red", message: di(err) }));
  }, [medplum, onCode, onSuccess]), handleAuthResponse = (0, import_react96.useCallback)((response) => {
    setAuthenticatorRequired(!!response.mfaRequired), response.login && setLogin(response.login), response.memberships && setMemberships(response.memberships), response.code && (chooseScopes ? setMemberships(void 0) : handleCode(response.code));
  }, [chooseScopes, handleCode]), handleScopeResponse = (0, import_react96.useCallback)((response) => {
    handleCode(response.code);
  }, [handleCode]);
  return (0, import_react96.useEffect)(() => {
    loginCode && !login && medplum.get("auth/login/" + loginCode).then(handleAuthResponse).catch((err) => showNotification({ color: "red", message: di(err) }));
  }, [medplum, loginCode, login, handleAuthResponse]), (0, import_jsx_runtime131.jsx)(Document, { width: 450, px: "sm", py: "md", children: login ? mfaRequired ? (0, import_jsx_runtime131.jsx)(MfaForm, { login, handleAuthResponse }) : memberships ? (0, import_jsx_runtime131.jsx)(ChooseProfileForm, { login, memberships, handleAuthResponse }) : props.projectId === "new" ? (0, import_jsx_runtime131.jsx)(NewProjectForm, { login, handleAuthResponse }) : props.chooseScopes ? (0, import_jsx_runtime131.jsx)(ChooseScopeForm, { login, scope: props.scope, handleAuthResponse: handleScopeResponse }) : (0, import_jsx_runtime131.jsx)("div", { children: "Success" }) : (0, import_jsx_runtime131.jsx)(AuthenticationForm, { onForgotPassword, onRegister, handleAuthResponse, disableGoogleAuth: props.disableGoogleAuth, disableEmailAuth: props.disableEmailAuth, ...baseLoginRequest, children: props.children }) });
}
export {
  AddressDisplay,
  AddressInput,
  AnnotationInput,
  AppShell2 as AppShell,
  AsyncAutocomplete,
  AttachmentArrayDisplay,
  AttachmentArrayInput,
  AttachmentButton,
  AttachmentDisplay,
  AttachmentInput,
  BackboneElementDisplay,
  BackboneElementInput,
  CalendarInput,
  CheckboxFormSection,
  CodeInput,
  CodeableConceptDisplay,
  CodeableConceptInput,
  CodingDisplay,
  CodingInput,
  ContactDetailDisplay,
  ContactDetailInput,
  ContactPointDisplay,
  ContactPointInput,
  Container2 as Container,
  DateTimeInput,
  DefaultResourceTimeline,
  DescriptionList,
  DescriptionListEntry,
  DiagnosticReportDisplay,
  Document,
  ElementDefinitionInputSelector,
  ElementDefinitionTypeInput,
  EncounterTimeline,
  ErrorBoundary,
  FhirPathTable,
  Form,
  FormSection,
  Header,
  HumanNameDisplay,
  HumanNameInput,
  IdentifierDisplay,
  IdentifierInput,
  Loading,
  Logo,
  MeasureReportDisplay,
  MedplumLink,
  j as MedplumProvider,
  MemoizedFhirPathTable,
  MemoizedSearchControl,
  MoneyDisplay,
  MoneyInput,
  Navbar,
  NoteDisplay,
  NotificationIcon,
  ObservationTable,
  OperationOutcomeAlert,
  Panel,
  PatientSummary,
  PatientTimeline,
  PlanDefinitionBuilder,
  QuantityDisplay,
  QuantityInput,
  QuestionnaireBuilder,
  QuestionnaireForm,
  QuestionnaireItemType,
  RangeDisplay,
  RangeInput,
  ReferenceDisplay,
  ReferenceInput,
  ReferenceRangeEditor,
  ReferenceRangeGroupEditor,
  RegisterForm,
  RequestGroupDisplay,
  ResourceArrayDisplay,
  ResourceArrayInput,
  ResourceAvatar,
  ResourceBadge,
  ResourceBlame,
  ResourceDiff,
  ResourceForm,
  ResourceHistoryTable,
  ResourceInput,
  ResourceName,
  ResourcePropertyDisplay,
  ResourcePropertyInput,
  ResourceTable,
  ResourceTimeline,
  Scheduler,
  SearchChangeEvent,
  SearchClickEvent,
  SearchControl,
  SearchFieldEditor,
  SearchFilterEditor,
  SearchLoadEvent,
  ServiceRequestTimeline,
  SignInForm,
  SmartAppLaunchLink,
  StatusBadge,
  Timeline,
  TimelineItem,
  TimingInput,
  ValueSetAutocomplete,
  addDateFilterBetween,
  addField,
  addFilter,
  addLastMonthFilter,
  addMissingFilter,
  addNextMonthFilter,
  addThisMonthFilter,
  addTodayFilter,
  addTomorrowFilter,
  addYearToDateFilter,
  addYesterdayFilter,
  buildFieldNameString,
  buildInitialResponse,
  buildInitialResponseItem,
  clearFilters,
  clearFiltersOnField,
  convertIsoToLocal,
  convertLocalToIso,
  createScriptTag,
  deleteFilter,
  formatReferenceString,
  getErrorsForInput,
  getFieldDefinitions,
  getIssuesForExpression,
  getNewMultiSelectValues,
  getNumberOfPages,
  getOpString,
  getQuestionnaireItemReferenceFilter,
  getQuestionnaireItemReferenceTargetTypes,
  getRecaptcha,
  getSearchOperators,
  getSortField,
  initRecaptcha,
  isChoiceQuestion,
  isQuestionEnabled,
  isSortDescending,
  isSupportedProfileStructureDefinition,
  parseForm,
  R as reactContext,
  renderValue,
  setFilters,
  setOffset,
  setPage,
  setPropertyValue,
  setQuestionnaireItemReferenceTargetTypes,
  setSort,
  sortByDateAndPriority,
  toggleSort,
  re as useCachedBinaryUrl,
  a as useMedplum,
  x as useMedplumContext,
  G2 as useMedplumNavigate,
  H as useMedplumProfile,
  ce as useResource,
  Re as useSearch,
  xe as useSearchOne,
  ge2 as useSearchResources,
  Ce as useSubscription
};
//# sourceMappingURL=@medplum_react.js.map
